<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5 Horas • MiniApps</title>
    <link rel="stylesheet" href="./styles/tokens.css" />
    <link rel="stylesheet" href="./styles/main.css" />
    <link rel="stylesheet" href="./styles/auth.css" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#f29f05" />
    <meta name="application-name" content="5 Horas MiniApps" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="MiniApps" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link
      rel="icon"
      type="image/png"
      sizes="500x500"
      href="https://5horas.com.br/wp-content/uploads/2025/10/Icone-Light-Claro-500x500px.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="500x500"
      href="https://5horas.com.br/wp-content/uploads/2025/10/Icone-Light-Claro-500x500px.png"
    />
  </head>
<body class="auth-only">
  <header class="auth-shell__header" aria-label="Identidade do MiniApp"></header>

  <main id="app" class="auth-screen">
    <section class="auth-card" aria-labelledby="authWelcomeTitle">
      <header class="auth-header">
        <h1 id="authWelcomeTitle" data-i18n="auth.welcome">Bem-vindo</h1>
        <p class="auth-sub" data-i18n="auth.subtitle">
          Crie um novo cadastro ou explore imediatamente como convidado
        </p>
      </header>

      <div class="auth-selector" role="tablist" aria-label="Modos de acesso">
        <button
          id="btnRegister"
          class="auth-selector__button"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="false"
          tabindex="-1"
          data-view="register"
          data-i18n="auth.register"
        >
          Criar conta
        </button>
        <button
          id="btnGuest"
          class="auth-selector__button is-active"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="true"
          tabindex="0"
          data-view="guest"
          data-i18n="auth.guest"
        >
          Convidado
        </button>
      </div>

      <div class="auth-card__body">
        <section id="authViewRoot" class="auth-card__view" aria-live="polite"></section>
      </div>

      <div class="auth-footer" role="note">
        <small id="statusHint" data-i18n="auth.hint">
          Use os botões acima para criar uma conta ou continuar explorando como convidado.
        </small>
      </div>
    </section>
  </main>

  <footer class="auth-shell__footer">
    <nav class="auth-shell__footer-nav" aria-label="Menu principal">
      <button
        type="button"
        class="auth-shell__menu-button"
        aria-label="Abrir menu principal"
        aria-haspopup="true"
        aria-controls="authFooterMenu"
        aria-expanded="false"
      >
        <span class="auth-shell__menu-icon" aria-hidden="true">
          <span></span>
          <span></span>
          <span></span>
        </span>
        <span class="sr-only" data-menu-button-label>Menu principal</span>
      </button>

      <div
        id="authFooterMenu"
        class="auth-shell__menu-panel"
        role="region"
        aria-labelledby="authFooterMenuTitle"
        hidden
      >
        <p id="authFooterMenuTitle" class="auth-shell__menu-title">Painéis do aplicativo</p>
        <ul class="auth-shell__menu-list" data-menu-group="views"></ul>
        <div class="auth-shell__menu-divider" role="presentation" aria-hidden="true"></div>
        <p
          id="authFooterMiniAppsTitle"
          class="auth-shell__menu-section-title"
          data-menu-title="miniapps"
          hidden
        >
          MiniApps ativos
        </p>
        <p class="auth-shell__menu-empty" data-menu-empty="miniapps" hidden>
          Nenhum MiniApp ativo disponível no momento.
        </p>
        <ul class="auth-shell__menu-list" data-menu-group="miniapps"></ul>
      </div>
    </nav>

    <small class="auth-shell__footer-text">
      <span>© <span data-current-year></span> 5 Horas</span>
      <span class="auth-shell__footer-divider" aria-hidden="true">•</span>
      <span>MiniApps</span>
      <span class="auth-shell__footer-divider" aria-hidden="true">•</span>
      <span>Versão <strong data-app-version>carregando…</strong></span>
    </small>
  </footer>


  <script type="module">
    import eventBus from './scripts/events/event-bus.js';
    import { registerServiceWorker } from './scripts/pwa/register-service-worker.js';
    import { renderRegisterPanel } from './scripts/views/register.js';
    import { renderMiniAppStore } from './scripts/views/miniapp-store.js';
    import { getMiniAppsSnapshot, subscribeMiniApps } from './scripts/data/miniapp-store.js';

    const viewRoot = document.getElementById('authViewRoot');
    const authCard = document.querySelector('.auth-card');
    const selector = document.querySelector('.auth-selector');
    const selectorButtons = Array.from(document.querySelectorAll('.auth-selector__button'));
    const statusHint = document.getElementById('statusHint');
    const footerMenu = document.querySelector('.auth-shell__footer-nav');
    const footerMenuButton = document.querySelector('.auth-shell__menu-button');
    const footerMenuPanel = document.getElementById('authFooterMenu');
    const footerMenuLabel = footerMenuButton?.querySelector('[data-menu-button-label]');
    const footerMenuViewsList = footerMenuPanel?.querySelector('[data-menu-group="views"]');
    const footerMenuMiniAppsTitle = footerMenuPanel?.querySelector('[data-menu-title="miniapps"]');
    const footerMenuMiniAppsEmpty = footerMenuPanel?.querySelector('[data-menu-empty="miniapps"]');
    const footerMenuMiniAppsList = footerMenuPanel?.querySelector('[data-menu-group="miniapps"]');
    const footerMenuMiniAppsDivider = footerMenuPanel?.querySelector('.auth-shell__menu-divider');
    let footerMenuOpen = false;
    let removeFooterMenuListeners = null;

    function getFooterMenuItems() {
      if (!(footerMenuPanel instanceof HTMLElement)) {
        return [];
      }

      return Array.from(footerMenuPanel.querySelectorAll('.auth-shell__menu-item')).filter(
        (item) => item instanceof HTMLElement && !item.disabled
      );
    }

    function setFooterMenuState(isOpen) {
      if (footerMenu instanceof HTMLElement) {
        footerMenu.dataset.state = isOpen ? 'open' : 'closed';
      }

      if (footerMenuButton instanceof HTMLElement) {
        footerMenuButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      }

      if (footerMenuPanel instanceof HTMLElement) {
        footerMenuPanel.hidden = !isOpen;
      }
    }

    function focusWithoutScreenShift(element) {
      if (!(element instanceof HTMLElement)) {
        return;
      }

      const scrollTarget = document.scrollingElement;
      const previousScrollTop = scrollTarget ? scrollTarget.scrollTop : window.scrollY;
      const previousScrollLeft = scrollTarget ? scrollTarget.scrollLeft : window.scrollX;

      try {
        element.focus({ preventScroll: true });
      } catch (error) {
        element.focus();
      }

      const nextScrollTop = scrollTarget ? scrollTarget.scrollTop : window.scrollY;
      const nextScrollLeft = scrollTarget ? scrollTarget.scrollLeft : window.scrollX;

      if (nextScrollTop !== previousScrollTop || nextScrollLeft !== previousScrollLeft) {
        if (scrollTarget) {
          scrollTarget.scrollTo({ top: previousScrollTop, left: previousScrollLeft });
        } else {
          window.scrollTo(previousScrollLeft, previousScrollTop);
        }
      }
    }

    function closeFooterMenu({ focusToggle = false } = {}) {
      if (!footerMenuOpen) {
        return;
      }

      footerMenuOpen = false;
      setFooterMenuState(false);

      if (typeof removeFooterMenuListeners === 'function') {
        removeFooterMenuListeners();
        removeFooterMenuListeners = null;
      }

      if (focusToggle && footerMenuButton instanceof HTMLElement) {
        focusWithoutScreenShift(footerMenuButton);
      }
    }

    function focusFooterMenuItemByOffset(currentIndex, offset) {
      const items = getFooterMenuItems();

      if (!items.length) {
        closeFooterMenu();
        return;
      }

      const normalizedIndex = currentIndex >= 0 ? currentIndex : 0;
      const nextIndex = (normalizedIndex + offset + items.length) % items.length;
      const nextItem = items[nextIndex];

      focusWithoutScreenShift(nextItem);
    }

    function handleFooterMenuItemKeydown(event) {
      if (!(event instanceof KeyboardEvent)) {
        return;
      }

      const target = event.target instanceof HTMLElement ? event.target.closest('.auth-shell__menu-item') : null;

      if (!(target instanceof HTMLElement)) {
        return;
      }

      const items = getFooterMenuItems();
      const currentIndex = items.indexOf(target);

      if (event.key === 'ArrowDown') {
        event.preventDefault();
        focusFooterMenuItemByOffset(currentIndex, 1);
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        focusFooterMenuItemByOffset(currentIndex, -1);
      } else if (event.key === 'Home') {
        event.preventDefault();
        focusFooterMenuItemByOffset(0, 0);
      } else if (event.key === 'End') {
        event.preventDefault();
        focusFooterMenuItemByOffset(items.length - 1, 0);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        closeFooterMenu({ focusToggle: true });
      }
    }

    function openFooterMenu({ focus = 'first' } = {}) {
      if (footerMenuOpen) {
        return;
      }

      footerMenuOpen = true;
      setFooterMenuState(true);

      const handlePointerDown = (event) => {
        if (!(event.target instanceof Node)) {
          return;
        }

        const isInsidePanel =
          footerMenuPanel instanceof HTMLElement && footerMenuPanel.contains(event.target);
        const isToggle =
          footerMenuButton instanceof HTMLElement && footerMenuButton.contains(event.target);

        if (!isInsidePanel && !isToggle) {
          closeFooterMenu();
        }
      };

      const handleFocusIn = (event) => {
        if (!(event.target instanceof Node)) {
          return;
        }

        const isInsidePanel =
          footerMenuPanel instanceof HTMLElement && footerMenuPanel.contains(event.target);
        const isToggle =
          footerMenuButton instanceof HTMLElement && footerMenuButton.contains(event.target);

        if (!isInsidePanel && !isToggle) {
          closeFooterMenu();
        }
      };

      const handleKeydown = (event) => {
        if (event instanceof KeyboardEvent && event.key === 'Escape') {
          event.preventDefault();
          closeFooterMenu({ focusToggle: true });
        }
      };

      document.addEventListener('pointerdown', handlePointerDown);
      document.addEventListener('focusin', handleFocusIn);
      document.addEventListener('keydown', handleKeydown);

      removeFooterMenuListeners = () => {
        document.removeEventListener('pointerdown', handlePointerDown);
        document.removeEventListener('focusin', handleFocusIn);
        document.removeEventListener('keydown', handleKeydown);
      };

      const items = getFooterMenuItems();

      if (!items.length) {
        closeFooterMenu();
        return;
      }

      let targetItem = items[0];

      if (focus === 'last') {
        targetItem = items[items.length - 1];
      }

      focusWithoutScreenShift(targetItem);
    }

    function toggleFooterMenu() {
      if (footerMenuOpen) {
        closeFooterMenu({ focusToggle: true });
      } else {
        openFooterMenu();
      }
    }

    function setActiveFooterMenuItem(viewName) {
      const items = getFooterMenuItems();
      let activeLabel = '';

      items.forEach((item) => {
        if (!(item instanceof HTMLElement)) {
          return;
        }

        const isActive = item.dataset.view === viewName;
        item.classList.toggle('is-active', isActive);
        item.setAttribute('aria-current', isActive ? 'page' : 'false');

        if (isActive) {
          activeLabel = item.textContent?.trim() || '';
        }
      });

      if (footerMenuLabel instanceof HTMLElement) {
        footerMenuLabel.textContent = activeLabel
          ? `Menu principal — painel atual: ${activeLabel}`
          : 'Menu principal';
      }

      if (footerMenuButton instanceof HTMLElement) {
        footerMenuButton.setAttribute(
          'aria-label',
          activeLabel
            ? `Abrir menu principal. Painel atual: ${activeLabel}`
            : 'Abrir menu principal'
        );
      }
    }

    const APP_DOC_BASE_PATH = './docs/miniapps';
    const APP_QUERY_PARAM = 'app';

    function normalizeMiniAppId(value) {
      if (typeof value !== 'string') {
        return '';
      }

      return value.trim().toLowerCase();
    }

    function buildMiniAppDocPath(id) {
      const normalized = normalizeMiniAppId(id);
      return normalized ? `${APP_DOC_BASE_PATH}/${normalized}.md` : '';
    }

    function findMiniAppById(id) {
      const normalized = normalizeMiniAppId(id);
      if (!normalized) {
        return null;
      }

      return (
        getMiniAppsSnapshot().find((app) => normalizeMiniAppId(app?.id) === normalized) ?? null
      );
    }

    function openMiniAppShortcut(id) {
      const normalized = normalizeMiniAppId(id);
      if (!normalized) {
        return false;
      }

      const target = findMiniAppById(normalized);
      if (!target) {
        return false;
      }

      const docPath = buildMiniAppDocPath(normalized);
      if (!docPath) {
        return false;
      }

      window.location.replace(docPath);
      return true;
    }

    function renderGuestAccessPanel(root, options = {}) {
      if (!(root instanceof HTMLElement)) {
        return;
      }

      root.className = 'card view auth-view view--guest';
      root.dataset.view = 'guest';

      const panel = document.createElement('section');
      panel.className = 'auth-panel__form guest-panel';

      const highlightAppId = normalizeMiniAppId(options.highlightAppId);
      let highlightedLink = null;
      let highlightedApp = null;

      const title = document.createElement('h2');
      title.className = 'auth-panel__title guest-panel__title';
      title.textContent = 'MiniApps gratuitos';

      const intro = document.createElement('p');
      intro.className = 'auth-panel__intro guest-panel__intro';
      intro.textContent =
        'Explore uma seleção de MiniApps liberados sem cadastro. Você pode abrir e testar imediatamente.';

      const list = document.createElement('ul');
      list.className = 'guest-panel__list';

      const apps = getMiniAppsSnapshot()
        .filter((app) => Array.isArray(app?.access) && app.access.includes('usuario'))
        .sort((a, b) => {
          const aName = typeof a?.name === 'string' ? a.name : '';
          const bName = typeof b?.name === 'string' ? b.name : '';
          return aName.localeCompare(bName, 'pt-BR');
        });

      if (apps.length === 0) {
        const emptyState = document.createElement('p');
        emptyState.className = 'guest-panel__empty';
        emptyState.textContent =
          'No momento não há MiniApps gratuitos disponíveis. Volte em breve para conferir as novidades.';
        panel.append(title, intro, emptyState);
        root.replaceChildren(panel);
        return;
      }

      apps.forEach((app) => {
        const item = document.createElement('li');
        item.className = 'guest-panel__item';

        const appTitle = document.createElement('h3');
        appTitle.className = 'guest-panel__item-title';
        appTitle.textContent = app?.name?.trim() || 'MiniApp disponível';

        const description = document.createElement('p');
        description.className = 'guest-panel__item-description';
        description.textContent =
          app?.description?.trim() || 'Abra o MiniApp para conhecer as funcionalidades liberadas ao convidado.';

        const link = document.createElement('a');
        link.className = 'guest-panel__link';
        link.target = '_blank';
        link.rel = 'noreferrer noopener';
        const appId = typeof app?.id === 'string' ? app.id.trim() : '';
        const normalizedId = normalizeMiniAppId(appId) || 'miniapp';
        item.dataset.appId = normalizedId;
        link.href = buildMiniAppDocPath(normalizedId) || '#';
        link.textContent = 'Abrir documentação do MiniApp';
        link.title = `Ver detalhes do MiniApp ${appTitle.textContent}`;

        if (normalizedId === highlightAppId) {
          item.classList.add('guest-panel__item--active');
          highlightedLink = link;
          highlightedApp = app;
        }

        item.append(appTitle, description, link);
        list.append(item);
      });

      const note = document.createElement('p');
      note.className = 'guest-panel__note';
      note.textContent =
        'Para salvar progresso e sincronizar preferências entre dispositivos, crie uma conta quando estiver pronto.';

      panel.append(title, intro, list, note);
      root.replaceChildren(panel);

      if (highlightedLink) {
        queueMicrotask(() => {
          try {
            highlightedLink.focus();
          } catch (error) {
            console.warn('Não foi possível focar o atalho solicitado.', error);
          }
        });

        if (typeof options.onHighlight === 'function') {
          options.onHighlight({ app: highlightedApp, link: highlightedLink, id: highlightAppId });
        }
      }
    }

    const VIEW_RENDERERS = {
      register: {
        render: renderRegisterPanel,
        hint: 'Preencha os dados abaixo para criar sua conta com segurança.',
      },
      guest: {
        render: renderGuestAccessPanel,
        hint: 'Conheça os MiniApps liberados para convidados sem precisar de credenciais.',
      },
      miniapps: {
        render: renderMiniAppStore,
        hint: 'Explore o catálogo completo de MiniApps e abra as documentações disponíveis.',
      },
    };

    let currentView = null;

    const footerViewEntries = [
      { view: 'guest', label: 'Explorar como convidado' },
      { view: 'register', label: 'Criar uma nova conta' },
      { view: 'miniapps', label: 'MiniApp Store' },
    ];

    function renderFooterViewItems() {
      if (!(footerMenuViewsList instanceof HTMLElement)) {
        return;
      }

      const items = footerViewEntries.map((entry) => {
        const listItem = document.createElement('li');
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'auth-shell__menu-item';
        button.dataset.view = entry.view;
        button.textContent = entry.label;
        listItem.append(button);
        return listItem;
      });

      footerMenuViewsList.replaceChildren(...items);
    }

    function renderFooterMiniAppItems(apps) {
      if (!(footerMenuMiniAppsList instanceof HTMLElement)) {
        return;
      }

      footerMenuMiniAppsList.replaceChildren();

      const normalized = Array.isArray(apps)
        ? apps
            .filter(
              (app) =>
                app &&
                Array.isArray(app.access) &&
                app.access.includes('usuario') &&
                String(app.status ?? '').trim().toLowerCase() === 'active'
            )
            .map((app) => ({
              id: normalizeMiniAppId(app.id),
              name: typeof app.name === 'string' && app.name.trim() ? app.name.trim() : 'MiniApp ativo',
            }))
            .filter((entry) => entry.id)
            .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'))
        : [];

      if (footerMenuMiniAppsTitle instanceof HTMLElement) {
        footerMenuMiniAppsTitle.hidden = normalized.length === 0;
      }

      if (footerMenuMiniAppsEmpty instanceof HTMLElement) {
        footerMenuMiniAppsEmpty.hidden = normalized.length > 0;
      }

      if (footerMenuMiniAppsList instanceof HTMLElement) {
        footerMenuMiniAppsList.hidden = normalized.length === 0;
      }

      if (footerMenuMiniAppsDivider instanceof HTMLElement) {
        footerMenuMiniAppsDivider.hidden = normalized.length === 0;
      }

      if (normalized.length === 0) {
        return;
      }

      const items = normalized.map((entry) => {
        const listItem = document.createElement('li');
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'auth-shell__menu-item auth-shell__menu-item--miniapp';
        button.dataset.miniappId = entry.id;
        button.textContent = entry.name;
        button.title = `Abrir destaque para o MiniApp ${entry.name}`;
        listItem.append(button);
        return listItem;
      });

      footerMenuMiniAppsList.append(...items);
    }

    function refreshFooterMenuItems() {
      renderFooterViewItems();
      renderFooterMiniAppItems(getMiniAppsSnapshot());
    }

    if (footerMenuButton instanceof HTMLElement) {
      footerMenuButton.addEventListener('click', () => {
        toggleFooterMenu();
      });

      footerMenuButton.addEventListener('keydown', (event) => {
        if (!(event instanceof KeyboardEvent)) {
          return;
        }

        if (event.key === 'ArrowDown') {
          event.preventDefault();
          openFooterMenu({ focus: 'first' });
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          openFooterMenu({ focus: 'last' });
        } else if (event.key === 'Escape' && footerMenuOpen) {
          event.preventDefault();
          closeFooterMenu({ focusToggle: true });
        }
      });
    }

    function handleFooterMenuItemAction(item) {
      if (!(item instanceof HTMLElement)) {
        return;
      }

      const viewName = item.dataset.view;
      const highlightAppId = item.dataset.highlightAppId || item.dataset.miniappId;

      if (viewName) {
        closeFooterMenu();
        renderAuthView(viewName, {
          shouldFocus: true,
          viewProps: highlightAppId ? { highlightAppId } : {},
        });
        return;
      }

      if (item.dataset.miniappId) {
        closeFooterMenu();
        renderAuthView('miniapps', {
          shouldFocus: true,
          viewProps: { highlightAppId },
        });
      }
    }

    if (footerMenuPanel instanceof HTMLElement) {
      footerMenuPanel.addEventListener('click', (event) => {
        const target = event.target instanceof HTMLElement ? event.target.closest('.auth-shell__menu-item') : null;
        if (!target) {
          return;
        }

        event.preventDefault();
        handleFooterMenuItemAction(target);
      });

      footerMenuPanel.addEventListener('keydown', (event) => {
        handleFooterMenuItemKeydown(event);
      });
    }

    refreshFooterMenuItems();

    subscribeMiniApps((apps) => {
      renderFooterMiniAppItems(apps);
    });

    function focusFirstInteractiveElement(root) {
      if (!(root instanceof HTMLElement)) {
        return;
      }

      const focusable = root.querySelector(
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );

      focusWithoutScreenShift(focusable);
    }

    function updateHint(viewName) {
      if (!(statusHint instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (viewConfig?.hint) {
        statusHint.textContent = viewConfig.hint;
      }
    }

    function setActiveButton(viewName) {
      selectorButtons.forEach((button) => {
        if (!(button instanceof HTMLElement)) {
          return;
        }

        const isActive = button.dataset.view === viewName;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-selected', String(isActive));
        button.tabIndex = isActive ? 0 : -1;
      });
    }

    function renderAuthView(viewName, { shouldFocus = true, viewProps = {} } = {}) {
      closeFooterMenu();

      if (!(viewRoot instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (!viewConfig) {
        return;
      }

      viewRoot.replaceChildren();
      viewConfig.render(viewRoot, viewProps);
      currentView = viewName;

      setActiveButton(viewName);
      setActiveFooterMenuItem(viewName);
      updateHint(viewName);

      if (authCard instanceof HTMLElement) {
        authCard.setAttribute('data-active-view', viewName);
      }

      if (shouldFocus) {
        queueMicrotask(() => focusFirstInteractiveElement(viewRoot));
      }
    }

    function handleAppNavigate(payload) {
      if (!payload || typeof payload !== 'object') {
        return;
      }

      const { view, viewProps, shouldFocus = true } = payload;
      if (typeof view !== 'string') {
        return;
      }

      if (Object.prototype.hasOwnProperty.call(VIEW_RENDERERS, view)) {
        renderAuthView(view, { shouldFocus, viewProps });
      }
    }

    selectorButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const viewName = button.dataset.view;
        if (viewName) {
          renderAuthView(viewName, { shouldFocus: true });
        }
      });
    });

    selector?.addEventListener('keydown', (event) => {
      if (!(event instanceof KeyboardEvent)) {
        return;
      }

      const views = selectorButtons.map((button) => button.dataset.view).filter(Boolean);
      if (!views.length) {
        return;
      }

      const currentIndex = views.indexOf(currentView ?? '');
      const lastIndex = views.length - 1;

      if (event.key === 'ArrowRight' || event.key === 'ArrowDown') {
        event.preventDefault();
        const nextIndex = currentIndex < 0 ? 0 : Math.min(currentIndex + 1, lastIndex);
        const nextButton = selectorButtons[nextIndex];
        if (nextButton) {
          nextButton.click();
        }
      } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {
        event.preventDefault();
        const prevIndex = currentIndex > 0 ? currentIndex - 1 : 0;
        const prevButton = selectorButtons[prevIndex];
        if (prevButton) {
          prevButton.click();
        }
      }
    });

    eventBus.on('app:navigate', handleAppNavigate);

    renderAuthView('guest', { shouldFocus: false });

    const versionTarget = document.querySelector('[data-app-version]');
    const currentYearTarget = document.querySelector('[data-current-year]');

    if (currentYearTarget instanceof HTMLElement) {
      currentYearTarget.textContent = String(new Date().getFullYear());
    }

    async function loadAppVersion() {
      try {
        const response = await fetch('./package.json', { cache: 'no-store' });

        if (!response.ok) {
          if (versionTarget instanceof HTMLElement) {
            versionTarget.textContent = 'indisponível';
          }
          return null;
        }

        const packageInfo = await response.json();
        const version = typeof packageInfo?.version === 'string' ? packageInfo.version.trim() : '';

        if (versionTarget instanceof HTMLElement) {
          if (version) {
            versionTarget.textContent = `v${version}`;
          } else {
            versionTarget.textContent = 'em desenvolvimento';
          }
        }

        return version || null;
      } catch (error) {
        console.warn('Não foi possível carregar a versão do aplicativo.', error);
        if (versionTarget instanceof HTMLElement) {
          versionTarget.textContent = 'indisponível';
        }
        return null;
      }
    }

    async function setupPwaSupport() {
      const version = await loadAppVersion();
      await registerServiceWorker(version);
    }

    setupPwaSupport().catch((error) => {
      console.error('Falha ao configurar os recursos PWA.', error);
    });

    const currentUrl = new URL(window.location.href);
    const requestedMiniApp = normalizeMiniAppId(currentUrl.searchParams.get(APP_QUERY_PARAM));

    if (requestedMiniApp) {
      const redirected = openMiniAppShortcut(requestedMiniApp);

      if (!redirected) {
        renderAuthView('miniapps', {
          shouldFocus: true,
          viewProps: {
            highlightAppId: requestedMiniApp,
            onHighlight({ app }) {
              if (statusHint instanceof HTMLElement && app) {
                statusHint.textContent = `MiniApp "${app.name}" destacado. Use o atalho para abrir a documentação oficial.`;
              }
            },
          },
        });
      }
    }
  </script>

</body>
</html>
