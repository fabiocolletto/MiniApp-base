<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5 Horas • MiniApps</title>
    <link rel="stylesheet" href="./styles/tokens.css" />
    <link rel="stylesheet" href="./styles/main.css" />
    <link rel="manifest" href="./public/manifest.json" />
    <meta name="theme-color" content="#f29f05" />
    <meta name="application-name" content="5 Horas MiniApps" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="MiniApps" />
    <meta name="mobile-web-app-capable" content="yes" />
    <script src="./public/env.js"></script>
    <link
      rel="icon"
      href="https://5horas.com.br/wp-content/uploads/2025/10/Icone-Light-Transparente-500x500px.webp"
      type="image/webp"
      sizes="500x500"
    />
    <link rel="apple-touch-icon" sizes="192x192" href="./public/icons/miniapp-icon-192.svg" />
    <link rel="icon" type="image/svg+xml" sizes="192x192" href="./public/icons/miniapp-icon-192.svg" />
    <link rel="icon" type="image/svg+xml" sizes="512x512" href="./public/icons/miniapp-icon-512.svg" />
  </head>
<body class="auth-only">
  <header class="auth-shell__header" aria-label="Identidade do MiniApp">
    <div class="auth-shell__brand">
      <span class="auth-shell__brand-label">5 Horas</span>
      <span class="auth-shell__brand-divider" aria-hidden="true">•</span>
      <span class="auth-shell__brand-product">MiniApps</span>
    </div>
    <p class="auth-shell__context">Acesso unificado para todos os serviços</p>
  </header>

  <main id="app" class="auth-screen">
    <section class="auth-card" aria-labelledby="authWelcomeTitle">
      <header class="auth-header">
        <h1 id="authWelcomeTitle" data-i18n="auth.welcome">Bem-vindo</h1>
        <p class="auth-sub" data-i18n="auth.subtitle">
          Acesse sua conta, crie um novo cadastro ou explore como convidado
        </p>
      </header>

      <div class="auth-selector" role="tablist" aria-label="Modos de acesso">
        <button
          id="btnLogin"
          class="auth-selector__button is-active"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="true"
          tabindex="0"
          data-view="login"
          data-i18n="auth.login"
        >
          Entrar
        </button>
        <button
          id="btnRegister"
          class="auth-selector__button"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="false"
          tabindex="-1"
          data-view="register"
          data-i18n="auth.register"
        >
          Criar conta
        </button>
        <button
          id="btnGuest"
          class="auth-selector__button"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="false"
          tabindex="-1"
          data-view="guest"
          data-i18n="auth.guest"
        >
          Convidado
        </button>
      </div>

      <div class="auth-card__body">
        <section id="authViewRoot" class="auth-card__view" aria-live="polite"></section>
      </div>

      <div class="auth-footer" role="note">
        <small id="statusHint" data-i18n="auth.hint">
          Use os botões acima para escolher entre entrar, criar conta ou explorar como convidado.
        </small>
      </div>
    </section>
  </main>

  <footer class="auth-shell__footer">
    <small class="auth-shell__footer-text">
      <span>© <span data-current-year></span> 5 Horas</span>
      <span class="auth-shell__footer-divider" aria-hidden="true">•</span>
      <span>MiniApps</span>
      <span class="auth-shell__footer-divider" aria-hidden="true">•</span>
      <span>Versão <strong data-app-version>carregando…</strong></span>
    </small>
  </footer>

  <style>
    :root {
      --p: var(--ac-primary, #2e7d32);
      --p-soft: rgba(46, 125, 50, 0.12);
      --p-strong: #1f5a2a;
      --txt: var(--ac-text, #1a1a1a);
      --muted: #6b7280;
      --bd: var(--ac-border, #e5e7eb);
      --bg: var(--ac-surface, #ffffff);
      --shell-surface: rgba(255, 255, 255, 0.9);
      --shell-border: rgba(15, 23, 42, 0.08);
      --shell-blur: 18px;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body.auth-only {
      --layout-header-offset: 0px;
      --layout-footer-offset: 0px;
      --content-padding-block-start: 0px;
      --content-padding-block-end: 0px;
      --view-max-block-size: auto;
      background: var(--ac-bg, #f8fafc);
      display: flex;
      flex-direction: column;
    }

    .auth-shell__header,
    .auth-shell__footer {
      position: sticky;
      z-index: 10;
      top: 0;
      backdrop-filter: blur(var(--shell-blur));
      background: var(--shell-surface);
      border-block: 1px solid var(--shell-border);
      padding: clamp(1rem, 3vw, 1.5rem) clamp(1.5rem, 4vw, 3rem);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: clamp(0.75rem, 2vw, 1.5rem);
    }

    .auth-shell__footer {
      bottom: 0;
      top: auto;
      justify-content: center;
    }

    .auth-shell__brand {
      display: inline-flex;
      align-items: baseline;
      gap: clamp(0.35rem, 1.2vw, 0.65rem);
      font: 700 clamp(1.1rem, 2.8vw, 1.5rem) / 1.1 system-ui, sans-serif;
      color: var(--txt);
      text-transform: uppercase;
      letter-spacing: clamp(0.08rem, 0.4vw, 0.18rem);
    }

    .auth-shell__brand-label,
    .auth-shell__brand-product {
      white-space: nowrap;
    }

    .auth-shell__brand-divider {
      color: var(--p-strong);
      font-weight: 400;
    }

    .auth-shell__context {
      margin: 0;
      font: 500 clamp(0.9rem, 2.2vw, 1.05rem) / 1.4 system-ui, sans-serif;
      color: var(--muted);
      text-align: right;
    }

    .auth-shell__footer-text {
      display: inline-flex;
      align-items: center;
      gap: clamp(0.35rem, 1.5vw, 0.75rem);
      color: var(--muted);
      font: 500 clamp(0.85rem, 2vw, 1rem) / 1.4 system-ui, sans-serif;
    }

    .auth-shell__footer-divider {
      color: rgba(15, 23, 42, 0.18);
    }

    .auth-shell__footer-text strong {
      font-weight: 700;
      color: var(--p-strong);
    }

    .auth-screen {
      flex: 1;
      display: grid;
      place-items: center;
      background: var(--ac-bg, #f8fafc);
      padding: clamp(1.5rem, 4vw, 2.5rem);
      min-height: 0;
    }

    .auth-card {
      width: min(520px, 95vw);
      display: grid;
      gap: clamp(1.1rem, 3vw, 1.75rem);
      background: var(--bg);
      border: 1px solid var(--bd);
      border-radius: 20px;
      padding: clamp(1.5rem, 3.8vw, 2.25rem);
      box-shadow: 0 18px 42px rgba(15, 23, 42, 0.08);
      overflow: hidden;
    }

    .auth-header h1 {
      margin: 0;
      font: 700 clamp(1.5rem, 3vw, 2rem) / 1.2 system-ui, sans-serif;
      color: var(--txt);
      letter-spacing: normal;
      text-transform: none;
    }

    .auth-sub {
      margin: 0;
      color: var(--muted);
      font: 500 clamp(1rem, 2.4vw, 1.125rem) / 1.5 system-ui, sans-serif;
    }

    .auth-selector {
      display: inline-flex;
      gap: 0.5rem;
      padding: 0.35rem;
      border-radius: 999px;
      background: var(--p-soft);
      border: 1px solid rgba(46, 125, 50, 0.22);
      align-self: center;
    }

    .auth-selector__button {
      flex: 1 1 auto;
      padding: 0.55rem 1.25rem;
      border: none;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      font: 600 clamp(0.95rem, 2.4vw, 1.05rem) / 1 system-ui, sans-serif;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .auth-selector__button.is-active {
      background: linear-gradient(130deg, var(--p), var(--p-strong));
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(46, 125, 50, 0.28);
    }

    .auth-selector__button:focus-visible {
      outline: 3px solid rgba(46, 125, 50, 0.35);
      outline-offset: 2px;
    }

    .auth-card__body {
      display: flex;
      justify-content: center;
    }

    .auth-card__view {
      width: 100%;
      display: grid;
      justify-items: center;
    }

    .auth-card__view > .card.auth-view {
      width: 100%;
      max-width: none;
      background: transparent;
      box-shadow: none;
      min-height: auto;
      max-height: none;
      overflow: visible;
      padding: 0;
    }

    .auth-card__view > .card.auth-view > * {
      width: 100%;
    }

    .auth-panel__actions {
      display: grid;
      gap: clamp(0.5rem, 2vw, 0.75rem);
    }

    .auth-panel__action {
      width: 100%;
    }

    .auth-panel__action--guest {
      --button-text-color: var(--p-strong);
      --button-hover-text-color: var(--p-strong);
    }

    .guest-panel {
      display: grid;
      gap: clamp(1rem, 3vw, 1.5rem);
    }

    .guest-panel__title {
      margin: 0;
      font: 700 clamp(1.15rem, 3vw, 1.45rem) / 1.2 system-ui, sans-serif;
      color: var(--txt);
    }

    .guest-panel__intro,
    .guest-panel__note,
    .guest-panel__item-description,
    .guest-panel__empty {
      margin: 0;
      font: 500 clamp(0.9rem, 2.2vw, 1rem) / 1.6 system-ui, sans-serif;
      color: var(--muted);
    }

    .guest-panel__list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: clamp(0.75rem, 2.5vw, 1rem);
    }

    .guest-panel__item {
      display: grid;
      gap: clamp(0.5rem, 1.6vw, 0.75rem);
      padding: clamp(1rem, 3vw, 1.25rem);
      border: 1px solid var(--bd);
      border-radius: 16px;
      background: var(--p-soft);
    }

    .guest-panel__item-title {
      margin: 0;
      font: 600 clamp(1rem, 2.4vw, 1.2rem) / 1.3 system-ui, sans-serif;
      color: var(--txt);
    }

    .guest-panel__link {
      justify-self: start;
      font: 600 clamp(0.95rem, 2.2vw, 1.05rem) / 1.2 system-ui, sans-serif;
      color: var(--p-strong);
      text-decoration: none;
    }

    .guest-panel__link:focus-visible,
    .guest-panel__link:hover {
      text-decoration: underline;
    }

    .guest-panel__note {
      padding-block-start: clamp(0.25rem, 1vw, 0.5rem);
    }

    .auth-footer {
      color: var(--muted);
      font: 500 0.9rem/1.4 system-ui, sans-serif;
      text-align: center;
      padding: 0;
      background: transparent;
      border: 0;
    }

    .auth-footer small {
      display: block;
      padding: 0.5rem 0;
    }

    @media (max-width: 768px) {
      .auth-shell__header,
      .auth-shell__footer {
        flex-direction: column;
        text-align: center;
      }

      .auth-shell__context {
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .auth-card {
        padding: clamp(1.25rem, 6vw, 1.75rem);
        border-radius: 16px;
      }

      .auth-selector {
        width: 100%;
      }
    }
  </style>

  <script type="module">
    import eventBus from './scripts/events/event-bus.js';
    import { registerServiceWorker } from './scripts/pwa/register-service-worker.js';
    import { renderLoginPanel } from './scripts/views/login.js';
    import { renderRegisterPanel } from './scripts/views/register.js';
    import { getMiniAppsSnapshot } from './scripts/data/miniapp-store.js';

    const viewRoot = document.getElementById('authViewRoot');
    const authCard = document.querySelector('.auth-card');
    const selector = document.querySelector('.auth-selector');
    const selectorButtons = Array.from(document.querySelectorAll('.auth-selector__button'));
    const statusHint = document.getElementById('statusHint');

    function renderGuestAccessPanel(root) {
      if (!(root instanceof HTMLElement)) {
        return;
      }

      root.className = 'card view auth-view view--guest';
      root.dataset.view = 'guest';

      const panel = document.createElement('section');
      panel.className = 'auth-panel__form guest-panel';

      const title = document.createElement('h2');
      title.className = 'auth-panel__title guest-panel__title';
      title.textContent = 'MiniApps gratuitos';

      const intro = document.createElement('p');
      intro.className = 'auth-panel__intro guest-panel__intro';
      intro.textContent =
        'Explore uma seleção de MiniApps liberados sem cadastro. Você pode abrir e testar imediatamente.';

      const list = document.createElement('ul');
      list.className = 'guest-panel__list';

      const apps = getMiniAppsSnapshot()
        .filter((app) => Array.isArray(app?.access) && app.access.includes('usuario'))
        .sort((a, b) => {
          const aName = typeof a?.name === 'string' ? a.name : '';
          const bName = typeof b?.name === 'string' ? b.name : '';
          return aName.localeCompare(bName, 'pt-BR');
        });

      if (apps.length === 0) {
        const emptyState = document.createElement('p');
        emptyState.className = 'guest-panel__empty';
        emptyState.textContent =
          'No momento não há MiniApps gratuitos disponíveis. Volte em breve para conferir as novidades.';
        panel.append(title, intro, emptyState);
        root.replaceChildren(panel);
        return;
      }

      apps.forEach((app) => {
        const item = document.createElement('li');
        item.className = 'guest-panel__item';

        const appTitle = document.createElement('h3');
        appTitle.className = 'guest-panel__item-title';
        appTitle.textContent = app?.name?.trim() || 'MiniApp disponível';

        const description = document.createElement('p');
        description.className = 'guest-panel__item-description';
        description.textContent =
          app?.description?.trim() || 'Abra o MiniApp para conhecer as funcionalidades liberadas ao convidado.';

        const link = document.createElement('a');
        link.className = 'guest-panel__link';
        link.target = '_blank';
        link.rel = 'noreferrer noopener';
        const appId = typeof app?.id === 'string' ? app.id.trim() : '';
        const normalizedId = appId || 'miniapp';
        link.href = `./MiniApps/${normalizedId}/README.md`;
        link.textContent = 'Abrir MiniApp';
        link.title = `Abrir documentação do MiniApp ${appTitle.textContent}`;

        item.append(appTitle, description, link);
        list.append(item);
      });

      const note = document.createElement('p');
      note.className = 'guest-panel__note';
      note.textContent =
        'Para salvar progresso e sincronizar preferências entre dispositivos, faça login ou crie uma conta a qualquer momento.';

      panel.append(title, intro, list, note);
      root.replaceChildren(panel);
    }

    const VIEW_RENDERERS = {
      login: {
        render: renderLoginPanel,
        hint: 'Informe seu telefone e senha ou selecione o modo convidado para explorar o MiniApp.',
      },
      register: {
        render: renderRegisterPanel,
        hint: 'Preencha os dados abaixo para criar sua conta com segurança.',
      },
      guest: {
        render: renderGuestAccessPanel,
        hint: 'Conheça os MiniApps liberados para convidados sem precisar de cadastro.',
      },
    };

    let currentView = null;

    function focusFirstInteractiveElement(root) {
      if (!(root instanceof HTMLElement)) {
        return;
      }

      const focusable = root.querySelector(
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );

      if (focusable instanceof HTMLElement) {
        focusable.focus({ preventScroll: true });
      }
    }

    function updateHint(viewName) {
      if (!(statusHint instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (viewConfig?.hint) {
        statusHint.textContent = viewConfig.hint;
      }
    }

    function setActiveButton(viewName) {
      selectorButtons.forEach((button) => {
        if (!(button instanceof HTMLElement)) {
          return;
        }

        const isActive = button.dataset.view === viewName;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-selected', String(isActive));
        button.tabIndex = isActive ? 0 : -1;
      });
    }

    function renderAuthView(viewName, { shouldFocus = true } = {}) {
      if (!(viewRoot instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (!viewConfig) {
        return;
      }

      viewRoot.replaceChildren();
      viewConfig.render(viewRoot);
      currentView = viewName;

      setActiveButton(viewName);
      updateHint(viewName);

      if (authCard instanceof HTMLElement) {
        authCard.setAttribute('data-active-view', viewName);
      }

      if (shouldFocus) {
        queueMicrotask(() => focusFirstInteractiveElement(viewRoot));
      }
    }

    function handleAppNavigate(payload) {
      if (!payload || typeof payload !== 'object') {
        return;
      }

      const { view } = payload;
      if (view === 'login' || view === 'register' || view === 'guest') {
        renderAuthView(view, { shouldFocus: true });
      }
    }

    selectorButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const viewName = button.dataset.view;
        if (viewName) {
          renderAuthView(viewName, { shouldFocus: true });
        }
      });
    });

    selector?.addEventListener('keydown', (event) => {
      if (!(event instanceof KeyboardEvent)) {
        return;
      }

      const views = selectorButtons.map((button) => button.dataset.view).filter(Boolean);
      if (!views.length) {
        return;
      }

      const currentIndex = views.indexOf(currentView ?? '');
      const lastIndex = views.length - 1;

      if (event.key === 'ArrowRight' || event.key === 'ArrowDown') {
        event.preventDefault();
        const nextIndex = currentIndex < 0 ? 0 : Math.min(currentIndex + 1, lastIndex);
        const nextButton = selectorButtons[nextIndex];
        if (nextButton) {
          nextButton.click();
        }
      } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {
        event.preventDefault();
        const prevIndex = currentIndex > 0 ? currentIndex - 1 : 0;
        const prevButton = selectorButtons[prevIndex];
        if (prevButton) {
          prevButton.click();
        }
      }
    });

    eventBus.on('app:navigate', handleAppNavigate);

    renderAuthView('login', { shouldFocus: false });

    const versionTarget = document.querySelector('[data-app-version]');
    const currentYearTarget = document.querySelector('[data-current-year]');

    if (currentYearTarget instanceof HTMLElement) {
      currentYearTarget.textContent = String(new Date().getFullYear());
    }

    async function loadAppVersion() {
      try {
        const response = await fetch('./package.json', { cache: 'no-store' });

        if (!response.ok) {
          if (versionTarget instanceof HTMLElement) {
            versionTarget.textContent = 'indisponível';
          }
          return null;
        }

        const packageInfo = await response.json();
        const version = typeof packageInfo?.version === 'string' ? packageInfo.version.trim() : '';

        if (versionTarget instanceof HTMLElement) {
          if (version) {
            versionTarget.textContent = `v${version}`;
          } else {
            versionTarget.textContent = 'em desenvolvimento';
          }
        }

        return version || null;
      } catch (error) {
        console.warn('Não foi possível carregar a versão do aplicativo.', error);
        if (versionTarget instanceof HTMLElement) {
          versionTarget.textContent = 'indisponível';
        }
        return null;
      }
    }

    async function setupPwaSupport() {
      const version = await loadAppVersion();
      await registerServiceWorker(version);
    }

    setupPwaSupport().catch((error) => {
      console.error('Falha ao configurar os recursos PWA.', error);
    });
  </script>

</body>
</html>
