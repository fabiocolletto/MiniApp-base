<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MiniApps</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Dexie (Offline DB) -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.min.js"></script>

    <!-- Firebase (Compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts + Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>

    <!-- Tailwind Customization -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ["Inter", "sans-serif"] },
                    animation: { 
                        "fade-in-up": "fadeInUp .3s ease-out forwards",
                        "slide-in-left": "slideInLeft 0.5s ease-out forwards",
                        "slide-out-left": "slideOutLeft 0.5s ease-in forwards"
                    },
                    keyframes: {
                        fadeInUp: {
                            "0%": { opacity: "0", transform: "translateY(10px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        },
                        slideInLeft: {
                            "0%": { opacity: "0", transform: "translateX(-100%)" },
                            "100%": { opacity: "1", transform: "translateX(0)" }
                        },
                        slideOutLeft: {
                            "0%": { opacity: "1", transform: "translateX(0)" },
                            "100%": { opacity: "0", transform: "translateX(-100%)" }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        .hide-scrollbar { scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .slide-in { animation-name: slide-in-left; }
        .slide-out { animation-name: slide-out-left; }
    </style>
</head>

<body class="antialiased bg-slate-50 text-slate-900 selection:bg-indigo-200 flex flex-col">

<div id="root" class="flex-1 flex flex-col relative">
    <div id="initial-loader" class="fixed inset-0 flex items-center justify-center bg-slate-50 text-slate-400 animate-pulse z-50">
        <span class="material-symbols-rounded text-4xl animate-spin mr-2">donut_large</span>
        <span id="initial-loader-text" class="font-semibold"></span>
    </div>
</div>

<script>
/* ============================================
   DATABASE (DEXIE)
   ============================================ */
var db = new Dexie("MiniAppsDB");

db.version(3).stores({
    user: 'id, name, phone, email, role, schoolId, createdAt', 
    settings: 'key, value',
    students: 'id, name, classId',
    assessments: '++id, title, subject, date, type',
    results: '++id, studentId, assessmentId, score, date, synced',
    // NOVA TABELA PARA AVISOS
    alerts: '++id, timestamp, isRead, sourceAppId',
    sync_queue: '++id, table, data, action, timestamp' 
});

/* ============================================
   FIREBASE MANAGER (Din√¢mico)
   ============================================ */
let dbFirestore = null;

window.initializeFirebase = async () => {
    try {
        const configRecord = await db.settings.get('firebase_config');
        if (configRecord && configRecord.value) {
            const config = JSON.parse(configRecord.value);
            if (!firebase.apps.length) {
                firebase.initializeApp(config);
                dbFirestore = firebase.firestore();
                console.log("Firebase Conectado via Configura√ß√£o Din√¢mica.");
                return true;
            } else {
                dbFirestore = firebase.firestore();
                return true;
            }
        } else {
            console.warn("Nenhuma configura√ß√£o do Firebase encontrada no Banco Local.");
            return false;
        }
    } catch (e) {
        console.error("Erro ao inicializar Firebase:", e);
        return false;
    }
};

/* ============================================
   API DE COMUNICA√á√ÉO (BRIDGE) - ATUALIZADO
   ============================================ */
window.addEventListener('message', async (event) => {
    const { type, payload, requestId } = event.data;

    if (type === 'DB_REQUEST') {
        try {
            let result;
            if (payload.action === 'get_user') {
                const users = await db.user.toArray();
                result = users[0];
            } else if (payload.action === 'update_user') {
                if (payload.data && payload.data.id) {
                    await db.user.put(payload.data);
                    result = payload.data;
                }
            } else if (payload.action === 'push_alert') {
                // Nova a√ß√£o: Salvar novo aviso
                const newAlert = {
                    ...payload.data,
                    timestamp: new Date().toISOString(),
                    isRead: false
                };
                result = await db.alerts.add(newAlert);
            } else if (payload.action === 'get_alerts') {
                // Nova a√ß√£o: Obter todos os avisos (do mais recente para o mais antigo)
                result = await db.alerts.orderBy('timestamp').reverse().toArray();
            } else if (payload.action === 'update_alert_status') {
                // Nova a√ß√£o: Marcar aviso como lido/n√£o lido
                await db.alerts.update(payload.id, { isRead: payload.status });
                result = { success: true };
            }
            
            const iframe = document.querySelector('iframe');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'DB_RESPONSE', requestId, result }, '*');
            }
        } catch (error) {
            console.error("Erro na Bridge DB:", error);
        }
    }
});

/* ============================================
   FUN√á√ïES DE BACKUP (LOCAL E NUVEM)
   ============================================ */
window.generateHashId = async (email, phone) => {
    const data = (email.trim().toLowerCase() + phone.replace(/\D/g, '')); 
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
};

window.exportLocalBackup = async () => {
    try {
        const allData = await window.getDbDump();
        const blob = new Blob([JSON.stringify(allData, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `miniapps_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        return true;
    } catch (e) { console.error(e); return false; }
};

window.getDbDump = async () => {
    return {
        user: await db.user.toArray(),
        settings: await db.settings.toArray(),
        alerts: await db.alerts.toArray(), // Inclu√≠do na exporta√ß√£o
        assessments: await db.assessments.toArray(),
        results: await db.results.toArray(),
        timestamp: new Date().toISOString()
    };
};

window.restoreDbDump = async (data) => {
    await db.transaction('rw', db.user, db.settings, db.alerts, db.assessments, db.results, async () => {
        await db.user.clear();
        await db.settings.clear();
        await db.alerts.clear(); // Inclu√≠do na importa√ß√£o
        await db.assessments.clear();
        await db.results.clear();
        if(data.user) await db.user.bulkAdd(data.user);
        if(data.settings) await db.settings.bulkAdd(data.settings);
        if(data.alerts) await db.alerts.bulkAdd(data.alerts);
        if(data.assessments) await db.assessments.bulkAdd(data.assessments);
        if(data.results) await db.results.bulkAdd(data.results);
    });
};

window.cloudUpload = async (userHash) => {
    if (!dbFirestore) return { success: false, msg: "Sistema Offline ou Sem Configura√ß√£o de Nuvem." };
    try {
        const data = await window.getDbDump();
        await dbFirestore.collection("backups").doc(userHash).set({
            data: JSON.stringify(data),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return { success: true };
    } catch (e) {
        console.error(e);
        return { success: false, msg: e.message };
    }
};

window.cloudRestore = async (userHash) => {
    if (!dbFirestore) return { success: false, msg: "Sistema Offline ou Sem Configura√ß√£o de Nuvem." };
    try {
        const doc = await dbFirestore.collection("backups").doc(userHash).get();
        if (doc.exists) {
            const content = JSON.parse(doc.data().data);
            await window.restoreDbDump(content);
            return { success: true };
        } else {
            return { success: false, msg: "Backup n√£o encontrado." };
        }
    } catch (e) {
        console.error(e);
        return { success: false, msg: e.message };
    }
};

window.prepareMiniAppHtml = function(html, appId, basePath) {
    let cleaned = html.replace(/<header[\s\S]*?<\/header>/gi, "");
    const inject = `
        <base href="${basePath}">
        <script>window.__app_id = "${appId}"<\/script>
        <style>
            html, body { background: transparent !important; padding-bottom: 32px !important; }
            main { background: transparent !important; padding: 1rem !important; }
        </style>
    `;
    return cleaned.includes("<head>") ? cleaned.replace("<head>", "<head>" + inject) : inject + cleaned;
};

const LANG_REPO_BASE = "https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/language/";
const SUPPORTED_LANGUAGES = ['pt-BR', 'en-US', 'es-ES'];
const FALLBACK_I18N = {
    "pt-BR": {
        app_title_portfolio: "Portf√≥lio",
        app_title_language_select: "Selecione o Idioma",
        loading_label: "Carregando...",
        system_initializing: "A iniciar o sistema...",
        back_to: "Voltar",
        action_back: "Voltar",
        action_home: "In√≠cio",
        action_close: "Fechar",
        action_understood: "Entendido",
        coming_soon: "Em breve",
        home_choose_app: "Escolha um MiniApp",
        error_route_not_found: "Erro: Rota n√£o encontrada.",

        // Menu Principal
        menu_education: "Educa√ß√£o",
        menu_finance: "Financeiro",
        menu_health: "Sa√∫de",
        menu_tasks: "Tarefas",
        menu_settings: "Configura√ß√µes",
        menu_alerts: "Avisos",
        
        // NOVO - Bem-Vindo
        menu_welcome: "Boas-Vindas",
        welcome_title: "Seja Bem-Vindo(a)!",
        welcome_subtitle: "Para salvar seu progresso e sincronizar dados, fa√ßa seu cadastro √∫nico.",
        welcome_action_register: "Fazer Cadastro / Login",
        welcome_action_continue: "Continuar como Visitante",
        
        // Apps
        edu_student_profile: "Matr√≠cula",
        edu_simulados: "Simulados",
        
        // Avisos
        alerts_title: "Central de Avisos",
        alerts_none: "Nenhum aviso novo. Tudo lido!",
        alerts_read: "Marcado como Lido",
        alerts_mark_all: "Marcar todos como lido",
        alerts_unread_section: "Avisos N√£o Lidos",
        alerts_read_section: "Avisos Lidos",

        // Configura√ß√µes
        settings_title: "Configura√ß√µes",
        section_profile: "Perfil",
        action_open_data_panel: "Painel de Dados",
        section_backup: "Backup e Sincroniza√ß√£o",
        section_system: "Sistema",
        section_admin: "√Årea Admin & Dev",
        section_accessibility: "Acessibilidade",
        settings_profile_visitor: "Visitante",
        action_manage_account: "Gerir Conta",
        auth_login: "Entrar",
        auth_register: "Cadastrar",
        auth_name_placeholder: "Nome Completo",
        auth_email_placeholder: "Seu E-mail",
        auth_phone_placeholder: "Telefone (ex: +55...)",
        auth_switch_to_login: "J√° tem backup? Restaurar.",
        auth_switch_to_register: "Novo? Criar conta.",
        auth_welcome: "Bem-vindo!",
        auth_welcome_subtitle: "Seus dados de acesso geram sua chave √∫nica.",
        auth_btn_restore: "Restaurar da Nuvem",
        auth_btn_login_local: "Entrar Localmente",
        settings_backup_cloud: "Backup na Nuvem",
        settings_backup_cloud_desc: "Requer configura√ß√£o Firebase.",
        settings_sync_devices: "Restaurar da Nuvem",
        settings_sync_devices_desc: "Baixar dados e substituir.",
        settings_backup_local: "Backup Local (Arquivo)",
        msg_backup_success: "Sucesso!",
        msg_backup_error: "Erro.",
        msg_cloud_success: "Sincronizado com a nuvem!",
        msg_cloud_restore_success: "Dados restaurados! Recarregando...",
        admin_firebase_config: "Configura√ß√£o Firebase (JSON)",
        admin_save_config: "Salvar Configura√ß√£o",
        admin_config_saved: "Configura√ß√£o salva! Recarregue a p√°gina.",
        admin_config_error: "JSON Inv√°lido.",
        lang_select_footer: "Novos idiomas ser√£o adicionados em breve.",
        status_active: "Ativo",
        msg_cloud_not_found: "Backup n√£o encontrado na nuvem.",
        msg_cloud_error_details: "Erro na nuvem:",
        msg_login_local_success: "Entrando com dados locais...",
        msg_user_not_found_anywhere: "Usu√°rio n√£o encontrado nem localmente, nem na nuvem. Verifique seus dados.",
        settings_large_text: "Texto Grande",
        settings_dark_mode: "Modo Escuro",
        settings_language: "Idioma",
        lang_pt_br_name: "Portugu√™s (Brasil)",
        lang_en_us_name: "English (US)",
        lang_es_es_name: "Espa√±ol (Espa√±a)",
        lang_select_description: "Escolha o idioma de exibi√ß√£o da aplica√ß√£o.",
        alert_panel_description: "O sistema de notifica√ß√µes via Planilha Google est√° ativo. Novas notifica√ß√µes aparecer√£o aqui ap√≥s o login.",
        alerts_current_user: "Usu√°rio atual:",
        status_not_logged: "N√£o Logado",
        feature_in_development_title: "Recurso em Desenvolvimento",
        feature_in_development_body: "Esta funcionalidade estar√° dispon√≠vel em breve. Agradecemos sua paci√™ncia!",
        loading_miniapp: "Carregando MiniApp...",
        error_loading_title: "Erro de Carregamento",
        error_loading_file_failure: "O arquivo {file} falhou ao carregar.",
        portfolio_title_full: "Portf√≥lio de Aplica√ß√µes",
        portfolio_subtitle: "Selecione o sistema que deseja acessar:",
        education_categories_title: "Educa√ß√£o: Categorias",
        education_categories_subtitle: "Selecione uma √°rea para iniciar.",
        finance_menu_title: "Finan√ßas: Gest√£o",
        finance_menu_subtitle: "Ferramentas para seu controle financeiro.",
        health_menu_title: "Sa√∫de: Categorias",
        health_menu_subtitle: "Ferramentas de bem-estar e monitoramento.",
        tasks_menu_title: "Tarefas e Produtividade",
        tasks_menu_subtitle: "Gerencie seus compromissos e foco.",
        student_area_title: "√Årea do Aluno",
        student_area_subtitle: "Selecione o servi√ßo desejado.",
        auth_modal_cta: "Entrar/Cadastrar",
        auth_modal_title: "Cadastro e Acesso",
        tasks_weekly_planner: "Planejamento Semanal",
        tasks_list: "Lista de Tarefas",
        tasks_monthly_calendar: "Agenda (Mensal)",
        tasks_tracking: "Acompanhamento",

        // Alerta
        alert_i18n_fallback_title: "Tradu√ß√£o Incompleta",
        alert_i18n_fallback_body: "Usando Portugu√™s (PT-BR) como recurso de seguran√ßa. Atualize o idioma no menu de Configura√ß√µes."
    },
    "en-US": {
        app_title_portfolio: "Portfolio",
        app_title_language_select: "Select Language",
        loading_label: "Loading...",
        system_initializing: "Starting the system...",
        back_to: "Back",
        action_back: "Back",
        action_home: "Home",
        action_close: "Close",
        action_understood: "Understood",
        coming_soon: "Coming Soon",
        home_choose_app: "Choose a MiniApp",
        error_route_not_found: "Error: Route not found.",

        // Menu Principal
        menu_education: "Education",
        menu_finance: "Finance",
        menu_health: "Health",
        menu_tasks: "Tasks",
        menu_settings: "Settings",
        menu_alerts: "Alerts",
        
        // NOVO - Bem-Vindo
        menu_welcome: "Welcome",
        welcome_title: "Welcome!",
        welcome_subtitle: "To save your progress and sync data, please complete your unique registration.",
        welcome_action_register: "Register / Login",
        welcome_action_continue: "Continue as Guest",

        // Apps
        edu_student_profile: "Registration",
        edu_simulados: "Simulations",
        
        // Avisos
        alerts_title: "Alert Center",
        alerts_none: "No new alerts. All clear!",
        alerts_read: "Marked as Read",
        alerts_mark_all: "Mark All as Read",
        alerts_unread_section: "Unread Alerts",
        alerts_read_section: "Read Alerts",

        // Configura√ß√µes
        settings_title: "Settings",
        section_profile: "Profile",
        action_open_data_panel: "Data Panel",
        section_backup: "Backup & Sync",
        section_system: "System",
        section_admin: "Admin & Dev Area",
        section_accessibility: "Accessibility",
        settings_profile_visitor: "Visitor",
        action_manage_account: "Manage Account",
        auth_login: "Login",
        auth_register: "Register",
        auth_name_placeholder: "Full Name",
        auth_email_placeholder: "Your Email",
        auth_phone_placeholder: "Phone (e.g., +1...)",
        auth_switch_to_login: "Have backup? Restore.",
        auth_switch_to_register: "New? Create account.",
        auth_welcome: "Welcome!",
        auth_welcome_subtitle: "Your credentials create your unique key.",
        auth_btn_restore: "Restore from Cloud",
        auth_btn_login_local: "Login Locally",
        settings_backup_cloud: "Cloud Backup",
        settings_backup_cloud_desc: "Requires Firebase config.",
        settings_sync_devices: "Restore from Cloud",
        settings_sync_devices_desc: "Download and replace.",
        settings_backup_local: "Local Backup (File)",
        msg_backup_success: "Success!",
        msg_backup_error: "Error.",
        msg_cloud_success: "Synced to cloud!",
        msg_cloud_restore_success: "Data restored! Reloading...",
        admin_firebase_config: "Firebase Config (JSON)",
        admin_save_config: "Save Config",
        admin_config_saved: "Config saved! Reload page.",
        admin_config_error: "Invalid JSON.",
        lang_select_footer: "New languages coming soon.",
        status_active: "Active",
        msg_cloud_not_found: "Backup not found in cloud.",
        msg_cloud_error_details: "Cloud error:",
        msg_login_local_success: "Logging in with local data...",
        msg_user_not_found_anywhere: "User not found locally or in cloud. Check credentials.",
        settings_large_text: "Large Text",
        settings_dark_mode: "Dark Mode",
        settings_language: "Language",
        lang_pt_br_name: "Portuguese (Brazil)",
        lang_en_us_name: "English (US)",
        lang_es_es_name: "Spanish (Spain)",
        lang_select_description: "Choose the application display language.",
        alert_panel_description: "The notification system via Google Sheets is active. New notifications will appear here after login.",
        alerts_current_user: "Current user:",
        status_not_logged: "Not Logged In",
        feature_in_development_title: "Feature in Development",
        feature_in_development_body: "This feature will be available soon. Thank you for your patience!",
        loading_miniapp: "Loading MiniApp...",
        error_loading_title: "Load Error",
        error_loading_file_failure: "The file {file} failed to load.",
        portfolio_title_full: "Application Portfolio",
        portfolio_subtitle: "Select the system you want to access:",
        education_categories_title: "Education: Categories",
        education_categories_subtitle: "Select an area to start.",
        finance_menu_title: "Finance: Management",
        finance_menu_subtitle: "Tools for your financial control.",
        health_menu_title: "Health: Categories",
        health_menu_subtitle: "Well-being and monitoring tools.",
        tasks_menu_title: "Tasks and Productivity",
        tasks_menu_subtitle: "Manage your commitments and focus.",
        student_area_title: "Student Area",
        student_area_subtitle: "Select the desired service.",
        auth_modal_cta: "Sign In / Register",
        auth_modal_title: "Sign Up and Access",
        tasks_weekly_planner: "Weekly Planner",
        tasks_list: "Task List",
        tasks_monthly_calendar: "Monthly Calendar",
        tasks_tracking: "Tracking",

        // Alerta
        alert_i18n_fallback_title: "Incomplete Translation",
        alert_i18n_fallback_body: "Using Portuguese (PT-BR) as a safety fallback. Update language in Settings menu."
    },
    "es-ES": {
        app_title_portfolio: "Portafolio",
        app_title_language_select: "Cat√°logo de Idiomas",
        loading_label: "Cargando...",
        system_initializing: "Iniciando el sistema...",
        back_to: "Volver a",
        action_back: "Volver",
        action_home: "Inicio",
        action_close: "Cerrar",
        action_understood: "Entendido",
        coming_soon: "Pr√≥ximamente",
        home_choose_app: "Elija un MiniApp",
        error_route_not_found: "Error: Ruta no encontrada.",

        // Menu Principal
        menu_education: "Educaci√≥n",
        menu_finance: "Finanzas",
        menu_health: "Salud",
        menu_tasks: "Tareas",
        menu_settings: "Configuraci√≥n",
        menu_alerts: "Avisos",

        // NOVO - Bem-Vindo
        menu_welcome: "Bienvenida",
        welcome_title: "¬°Bienvenido!",
        welcome_subtitle: "Para guardar tu progreso y sincronizar datos, realiza tu registro √∫nico.",
        welcome_action_register: "Registrarse / Iniciar sesi√≥n",
        welcome_action_continue: "Continuar como Visitante",

        // Apps
        edu_student_profile: "Perfil",
        edu_simulados: "Simulacros",

        // Avisos
        alerts_title: "Centro de Avisos",
        alerts_none: "No hay avisos nuevos. ¬°Todo listo!",
        alerts_read: "Marcado como le√≠do",
        alerts_mark_all: "Marcar todo como le√≠do",
        alerts_unread_section: "Avisos no le√≠dos",
        alerts_read_section: "Avisos le√≠dos",

        // Configura√ß√µes
        settings_title: "Configuraci√≥n",
        section_profile: "Perfil",
        action_open_data_panel: "Panel de Datos",
        section_backup: "Copia de Seguridad y Sincronizaci√≥n",
        section_system: "Sistema",
        section_admin: "√Årea de Administrador y Desarrollo",
        section_accessibility: "Accesibilidad",
        settings_profile_visitor: "Visitante",
        action_manage_account: "Gestionar Cuenta",
        auth_login: "Iniciar sesi√≥n",
        auth_register: "Registrarse",
        auth_name_placeholder: "Nombre Completo",
        auth_email_placeholder: "Tu correo electr√≥nico",
        auth_phone_placeholder: "Tel√©fono (ej.: +34...)",
        auth_switch_to_login: "¬øYa tienes copia? Restaurar.",
        auth_switch_to_register: "¬øNuevo? Crear cuenta.",
        auth_welcome: "¬°Bienvenido!",
        auth_welcome_subtitle: "Tus datos de acceso generan tu clave √∫nica.",
        auth_btn_restore: "Restaurar desde la Nube",
        auth_btn_login_local: "Iniciar localmente",
        settings_backup_cloud: "Copia de seguridad en la Nube",
        settings_backup_cloud_desc: "Requiere configuraci√≥n de Firebase.",
        settings_sync_devices: "Restaurar desde la Nube",
        settings_sync_devices_desc: "Descargar datos y sustituir.",
        settings_backup_local: "Copia de seguridad local (Archivo)",
        msg_backup_success: "¬°√âxito!",
        msg_backup_error: "Error.",
        msg_cloud_success: "¬°Sincronizado con la nube!",
        msg_cloud_restore_success: "¬°Datos restaurados! Recargando...",
        admin_firebase_config: "Configuraci√≥n de Firebase (JSON)",
        admin_save_config: "Guardar configuraci√≥n",
        admin_config_saved: "¬°Configuraci√≥n guardada! Recarga la p√°gina.",
        admin_config_error: "JSON inv√°lido.",
        lang_select_footer: "Nuevos idiomas se a√±adir√°n pronto.",
        status_active: "Activo",
        msg_cloud_not_found: "No se encontr√≥ copia en la nube.",
        msg_cloud_error_details: "Error en la nube:",
        msg_login_local_success: "Iniciando sesi√≥n con datos locales...",
        msg_user_not_found_anywhere: "Usuario no encontrado localmente ni en la nube. Verifica tus datos.",
        settings_large_text: "Texto grande",
        settings_dark_mode: "Modo oscuro",
        settings_language: "Idioma",
        lang_pt_br_name: "Portugu√©s (Brasil)",
        lang_en_us_name: "Ingl√©s (EE.UU.)",
        lang_es_es_name: "Espa√±ol (Espa√±a)",
        lang_select_description: "Elige el idioma de visualizaci√≥n de la aplicaci√≥n.",
        alert_panel_description: "El sistema de notificaciones a trav√©s de Google Sheets est√° activo. Nuevas notificaciones aparecer√°n aqu√≠ despu√©s de iniciar sesi√≥n.",
        alerts_current_user: "Usuario actual:",
        status_not_logged: "No conectado",
        feature_in_development_title: "Funci√≥n en desarrollo",
        feature_in_development_body: "Esta funci√≥n estar√° disponible pronto. ¬°Gracias por tu paciencia!",
        loading_miniapp: "Cargando MiniApp...",
        error_loading_title: "Error de carga",
        error_loading_file_failure: "El archivo {file} no se pudo cargar.",
        portfolio_title_full: "Portafolio de Aplicaciones",
        portfolio_subtitle: "Seleccione el sistema al que desea acceder:",
        education_categories_title: "Educaci√≥n: Categor√≠as",
        education_categories_subtitle: "Seleccione un √°rea para comenzar.",
        finance_menu_title: "Finanzas: Gesti√≥n",
        finance_menu_subtitle: "Herramientas para su control financiero.",
        health_menu_title: "Salud: Categor√≠as",
        health_menu_subtitle: "Herramientas de bienestar y monitoreo.",
        tasks_menu_title: "Tareas y Productividad",
        tasks_menu_subtitle: "Gestiona tus compromisos y enfoque.",
        student_area_title: "√Årea del Estudiante",
        student_area_subtitle: "Seleccione el servicio deseado.",
        auth_modal_cta: "Iniciar sesi√≥n / Registrarse",
        auth_modal_title: "Registro y Acceso",
        tasks_weekly_planner: "Planificador Semanal",
        tasks_list: "Lista de Tareas",
        tasks_monthly_calendar: "Agenda (Mensual)",
        tasks_tracking: "Seguimiento",

        // Alerta
        alert_i18n_fallback_title: "Traducci√≥n Incompleta",
        alert_i18n_fallback_body: "Usando Portugu√©s (PT-BR) como recurso de seguridad. Actualice el idioma en el men√∫ de Configuraci√≥n."
    }
};

document.getElementById('initial-loader-text').textContent = FALLBACK_I18N['pt-BR'].loading_label;

const COLOR = {
    indigo: { base:"indigo", bg50:"bg-indigo-50", bg100:"bg-indigo-100", text900:"text-indigo-900", text700:"text-indigo-700", border100:"border-indigo-100", border300:"border-indigo-300" },
    emerald:{ base:"emerald",bg50:"bg-emerald-50",bg100:"bg-emerald-100",text900:"text-emerald-900",text700:"text-emerald-700",border100:"border-emerald-100",border300:"border-emerald-300"},
    amber:{ base:"amber",bg50:"bg-amber-50",bg100:"bg-amber-100",text900:"text-amber-900",text700:"text-amber-700",border100:"border-amber-100",border300:"border-amber-300"},
    cyan:{ base:"cyan",bg50:"bg-cyan-50",bg100:"bg-cyan-100",text900:"text-cyan-900",text700:"text-cyan-700",border100:"border-cyan-100",border300:"border-cyan-300"},
    rose:{ base:"rose",bg50:"bg-rose-50",bg100:"bg-rose-100",text900:"text-rose-900",text700:"text-rose-700",border100:"border-rose-100",border300:"border-rose-300"},
    purple:{ base:"purple",bg50:"bg-purple-50",bg100:"bg-purple-100",text900:"text-purple-900",text700:"text-purple-700",border100:"border-purple-100",border300:"border-purple-300"},
    fuchsia:{ base:"fuchsia",bg50:"bg-fuchsia-50",bg100:"bg-fuchsia-100",text900:"text-fuchsia-900",text700:"text-fuchsia-700",border100:"border-fuchsia-100",border300:"border-fuchsia-300"},
    slate:{ base:"slate",bg50:"bg-slate-50",bg100:"bg-slate-100",text900:"text-slate-900",text700:"text-slate-700",border100:"border-slate-100",border300:"border-slate-300"},
};
</script>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

/* --- COMPONENTES UI REUTILIZ√ÅVEIS --- */

const BackButton = ({ onClick, color="indigo", title }) => {
    const c = COLOR[color] || COLOR.indigo;
    return (
        <button onClick={onClick} className={`h-10 w-10 flex items-center justify-center rounded-xl border ${c.border100} bg-slate-50 text-${c.base}-600 hover:bg-white hover:shadow-sm hover:scale-105 transition`} title={title}>
            <span className="material-symbols-rounded">arrow_back</span>
        </button>
    );
};

const ToggleSwitch = ({ isChecked, onChange, color = "indigo" }) => {
    const c = COLOR[color] || COLOR.indigo;
    return (
        <label className="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" checked={isChecked} onChange={onChange} className="sr-only peer" />
            <div className={`w-9 h-5 rounded-full peer bg-slate-300 peer-checked:bg-${c.base}-500 transition-colors duration-300 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4 shadow-inner`}></div>
        </label>
    );
};

const SectionTitle = ({ icon, title, color = "slate" }) => {
    const c = COLOR[color] || COLOR.slate;
    return (
        <div className="flex items-center gap-2 mb-2 mt-4 first:mt-0 px-1">
            <span className={`material-symbols-rounded text-sm text-${c.base}-500`}>{icon}</span>
            <span className={`text-xs font-bold text-${c.base}-600 uppercase tracking-widest`}>{title}</span>
        </div>
    );
};

const ConfigItem = ({ icon, title, subtitle, color = "indigo", isDisabled, onClick, children, t, isLoading }) => {
    const c = COLOR[color] || COLOR.indigo;
    const isInteractive = !!onClick && !isDisabled;
    return (
        <div className={`flex items-center justify-between w-full px-4 py-3 rounded-xl transition-all border ${isDisabled ? 'bg-slate-50 border-slate-100 text-slate-400 cursor-not-allowed' : `bg-white border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-${c.base}-200 shadow-sm hover:shadow`} ${isInteractive ? 'cursor-pointer active:scale-[0.99]' : ''}`} onClick={isInteractive ? onClick : undefined}>
            <div className="flex items-center gap-3 overflow-hidden">
                <span className={`material-symbols-rounded text-xl ${isDisabled ? 'text-slate-300' : `text-${c.base}-500`}`}>{icon}</span>
                <div className="flex flex-col overflow-hidden">
                    <span className="font-medium text-sm truncate">{title}</span>
                    {subtitle && <span className="text-[10px] text-slate-400 truncate">{subtitle}</span>}
                </div>
            </div>
            <div className="flex items-center pl-2">
                {isLoading ? <span className={`material-symbols-rounded animate-spin text-${c.base}-500`}>sync</span> : children}
                {isInteractive && !children && !isLoading && <span className="material-symbols-rounded text-slate-400">chevron_right</span>}
                {isDisabled && !children && <span className="text-[10px] uppercase font-bold tracking-wider bg-slate-100 text-slate-400 px-2 py-0.5 rounded">{t('coming_soon')}</span>}
            </div>
        </div>
    );
};

const ScreenWrapper = ({ title, children, color="indigo", onBack, t }) => {
    const c = COLOR[color] || COLOR.indigo;
    return (
        <div className="w-full h-full flex flex-col bg-white rounded-2xl border border-slate-100 animate-fade-in-up overflow-hidden">
            <div className="flex items-center gap-4 p-4 border-b border-slate-50 bg-white/50 backdrop-blur-sm sticky z-20">
                <BackButton color={color} onClick={onBack} title={t("back_to")}/>
                <h2 className={`font-bold text-xl ${c.text900}`}>{title}</h2>
            </div>
            <div className="flex-1 overflow-y-auto hide-scrollbar flex flex-col">
                {children}
            </div>
        </div>
    );
};

const LanguageFallbackAlert = ({ isVisible, t, onClose }) => {
    if (!isVisible) return null;

    // Usando slide-out-left para esconder e slide-in-left para mostrar
    return (
        <div className={`fixed bottom-4 left-4 z-50 transition-all shadow-xl rounded-xl bg-amber-50 border border-amber-200 p-4 max-w-sm slide-in ${!isVisible ? 'slide-out' : ''}`}>
            <div className="flex items-start gap-3">
                <span className="material-symbols-rounded text-amber-600 text-2xl mt-0.5">warning</span>
                <div className="flex-1">
                    <h3 className="font-bold text-sm text-amber-900 mb-1">{t('alert_i18n_fallback_title')}</h3>
                    <p className="text-xs text-amber-800">{t('alert_i18n_fallback_body')}</p>
                </div>
                <button onClick={onClose} className="text-amber-500 hover:text-amber-700 transition">
                    <span className="material-symbols-rounded text-lg">close</span>
                </button>
            </div>
        </div>
    );
};


function AppCard({ item, t, onClick }) {
    const c = COLOR[item.color] || COLOR.indigo;
    const disabled = item.action === "placeholder";
    return (
        <div onClick={!disabled ? onClick : undefined} className={`relative flex flex-col items-center justify-end w-32 h-32 rounded-2xl group cursor-pointer transition border ${c.border100} ${c.bg50} hover:shadow hover:-translate-y-1`}>
            <div className="absolute inset-0 flex items-center justify-center">
                <span className={`material-symbols-rounded text-[5rem] opacity-10 group-hover:opacity-20 text-${c.base}-600`}>{item.icon}</span>
            </div>
            <div className="relative z-10 p-2 text-center">
                <span className={`font-semibold text-sm ${c.text900}`}>{t(item.titleKey)}</span>
            </div>
        </div>
    );
}

// NOVO COMPONENTE: Ecr√£ de Boas-Vindas
const WelcomeScreen = ({ onRegister, onContinue, t }) => {
    return (
        <div className="w-full h-full flex flex-col items-center justify-center p-8 text-center bg-white rounded-2xl border border-slate-100 animate-fade-in-up max-w-lg mx-auto">
            <div className="h-24 w-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <span className="material-symbols-rounded text-6xl text-indigo-600">waving_hand</span>
            </div>
            <h1 className="text-3xl font-extrabold text-indigo-900 mb-2">{t('welcome_title')}</h1>
            <p className="text-slate-600 mb-8">{t('welcome_subtitle')}</p>

            <div className="w-full space-y-3">
                <button 
                    onClick={onRegister}
                    className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-base shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all flex justify-center items-center"
                >
                    <span className="material-symbols-rounded text-xl mr-2">person_add</span>
                    {t('welcome_action_register')}
                </button>
                <button 
                    onClick={onContinue}
                    className="w-full py-3 bg-slate-100 text-slate-700 rounded-xl font-medium text-base hover:bg-slate-200 active:scale-95 transition-all flex justify-center items-center"
                >
                    <span className="material-symbols-rounded text-xl mr-2">visibility</span>
                    {t('welcome_action_continue')}
                </button>
            </div>
        </div>
    );
};

const AuthScreen = ({ onLoginSuccess, goBack, t, currentLang }) => {
    const [isRegistering, setIsRegistering] = useState(true);
    const [formData, setFormData] = useState({ name: '', email: '', phone: '' });
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!formData.phone) {
            const prefix = currentLang === 'pt-BR' ? '+55 ' : '+1 ';
            setFormData(prev => ({ ...prev, phone: prefix }));
        }
    }, [currentLang]);

    const validateForm = () => {
        if (isRegistering) {
            if (!formData.name.trim() || formData.name.trim().split(/\s+/).length < 2) {
                alert(t('auth_error_name_invalid')); return false;
            }
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            alert(t('auth_error_email_invalid')); return false;
        }
        const cleanPhone = formData.phone.replace(/[\s-]/g, '');
        if (cleanPhone.length < 8) { 
             alert(t('auth_error_phone_invalid')); return false;
        }
        return true;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        setLoading(true);

        try {
            const secureId = await window.generateHashId(formData.email, formData.phone);
            let user;

            if (isRegistering) {
                user = {
                    id: secureId,
                    phone: formData.phone.trim(),
                    email: formData.email.trim(),
                    name: formData.name.trim(),
                    role: 'student', 
                    createdAt: new Date()
                };
                onLoginSuccess(user);
            } else {
                const result = await window.cloudRestore(secureId);
                
                if (result.success) {
                    alert(t('msg_cloud_restore_success'));
                    window.location.reload(); 
                } else {
                    const existingUser = await db.user.where('id').equals(secureId).first();
                    if(existingUser) {
                        alert(`${t('msg_cloud_not_found')} (${result.msg})\n\n${t('msg_login_local_success')}`);
                        onLoginSuccess(existingUser);
                    } else {
                        alert(`${t('msg_user_not_found_anywhere')}\n\n${t('msg_cloud_error_details')} ${result.msg}`);
                        setLoading(false);
                    }
                }
            }
        } catch (err) {
            console.error(err);
            alert("Erro inesperado: " + err.message);
            setLoading(false);
        }
    };

    return (
        <ScreenWrapper title={isRegistering ? t('auth_register') : t('auth_login')} color="purple" onBack={goBack} t={t}>
            <div className="flex flex-col items-center justify-center p-8 w-full max-w-md mx-auto flex-1">
                <div className="mb-6 text-center">
                    <div className="h-20 w-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span className="material-symbols-rounded text-4xl text-purple-600">cloud_sync</span>
                    </div>
                    <h2 className="text-2xl font-bold text-purple-900">{t('auth_welcome')}</h2>
                    <p className="text-purple-600/80 mt-1">{t('auth_welcome_subtitle')}</p>
                </div>

                <form onSubmit={handleSubmit} className="w-full space-y-4">
                    {isRegistering && (
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-slate-500 ml-1 uppercase">Nome Completo</label>
                            <input type="text" placeholder={t('auth_name_placeholder')} className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-purple-500 outline-none" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/>
                        </div>
                    )}
                    <div className="space-y-1">
                        <label className="text-xs font-bold text-slate-500 ml-1 uppercase">E-mail</label>
                        <input type="email" placeholder={t('auth_email_placeholder')} className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-purple-500 outline-none" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})}/>
                    </div>
                    <div className="space-y-1">
                        <label className="text-xs font-bold text-slate-500 ml-1 uppercase">Telefone</label>
                        <input type="tel" placeholder={t('auth_phone_placeholder')} className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-purple-500 outline-none" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})}/>
                    </div>
                    <button type="submit" disabled={loading} className={`w-full py-4 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-purple-700 transition-all mt-6 flex justify-center items-center ${loading ? 'opacity-70' : ''}`}>
                        {loading ? <span className="material-symbols-rounded animate-spin mr-2">sync</span> : null}
                        {isRegistering ? t('auth_register') : t('auth_btn_restore')}
                    </button>
                </form>

                <button onClick={() => { setIsRegistering(!isRegistering); }} className="mt-6 text-sm text-purple-600 hover:text-purple-800 font-medium underline">
                    {isRegistering ? t('auth_switch_to_login') : t('auth_switch_to_register')}
                </button>
            </div>
        </ScreenWrapper>
    );
};

const LanguageSelectionScreen = ({ goBack, currentLang, setLang, t }) => {
    const LANGUAGES = [
        { code: 'pt-BR', labelKey: 'lang_pt_br_name', flag: 'üáßüá∑' },
        { code: 'en-US', labelKey: 'lang_en_us_name', flag: 'üá∫üá∏' },
        { code: 'es-ES', labelKey: 'lang_es_es_name', flag: 'üá™üá∏' },
        { code: 'fr-FR', label: 'Fran√ßais', flag: 'üá´üá∑', disabled: true }
    ];
    return (
        <ScreenWrapper title={t('app_title_language_select')} color="cyan" onBack={goBack} t={t}>
            <div className="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-4xl mx-auto w-full">
                {LANGUAGES.map(lang => (
                    <div key={lang.code} onClick={() => !lang.disabled && setLang(lang.code)} className={`relative flex items-center p-4 rounded-xl border transition-all ${lang.disabled ? 'opacity-50 grayscale cursor-not-allowed' : 'cursor-pointer hover:shadow-md hover:border-cyan-300'} ${currentLang === lang.code ? 'ring-2 ring-cyan-500 bg-cyan-50' : 'bg-white'}`}>
                        <span className="text-4xl mr-4">{lang.flag}</span>
                        <div className="flex-1"><h3 className="font-bold text-slate-800">{lang.label || t(lang.labelKey)}</h3></div>
                    </div>
                ))}
            </div>
        </ScreenWrapper>
    );
};

const SettingsScreen = ({ userData, onAuth, onOpenProfile, goBack, t, currentLang, onOpenLanguage }) => {
    const initials = userData?.name ? userData.name.substring(0,2).toUpperCase() : 'VN';
    const [cloudLoading, setCloudLoading] = useState({ upload: false, download: false });
    const [fbConfig, setFbConfig] = useState('');
    const [showAdmin, setShowAdmin] = useState(false);

    useEffect(() => {
        db.settings.get('firebase_config').then(rec => {
            if(rec) setFbConfig(rec.value);
        });
    }, []);

    const handleSaveConfig = async () => {
        try {
            const parsed = JSON.parse(fbConfig);
            await db.settings.put({ key: 'firebase_config', value: JSON.stringify(parsed) });
            alert(t('admin_config_saved'));
            window.location.reload();
        } catch(e) {
            alert(t('admin_config_error'));
        }
    };

    const handleLocalBackup = async () => {
        const success = await window.exportLocalBackup();
        alert(success ? t('msg_backup_success') : t('msg_backup_error'));
    };

    const handleCloudUpload = async () => {
        if(!userData) return;
        setCloudLoading(prev => ({...prev, upload: true}));
        const res = await window.cloudUpload(userData.id);
        setCloudLoading(prev => ({...prev, upload: false}));
        alert(res.success ? t('msg_cloud_success') : res.msg);
    };

    const handleCloudDownload = async () => {
        if(!userData) return;
        if(!confirm("Isso substituir√° seus dados locais pelos da nuvem. Continuar?")) return;
        setCloudLoading(prev => ({...prev, download: true}));
        const res = await window.cloudRestore(userData.id);
        setCloudLoading(prev => ({...prev, download: false}));
        if(res.success) {
            alert(t('msg_cloud_restore_success'));
            window.location.reload();
        } else {
            alert(res.msg);
        }
    };

    return (
        <ScreenWrapper title={t('settings_title')} color="indigo" onBack={goBack} t={t}>
            <div className="p-6 grid gap-6 sm:grid-cols-2 max-w-5xl mx-auto w-full pb-20">
                <div className="flex flex-col gap-3">
                    <SectionTitle icon="person" title={t('section_profile')} color="purple" />
                    
                    {/* Cart√£o de Perfil */}
                    <div 
                        onClick={() => userData ? onOpenProfile() : onAuth()}
                        className={`bg-purple-50 rounded-2xl p-4 border border-purple-100 flex items-center gap-4 shadow-sm transition hover:shadow-md cursor-pointer`}
                    >
                        <div className="h-14 w-14 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-xl shadow-md">
                            {userData ? initials : <span className="material-symbols-rounded">person</span>}
                        </div>
                        <div className="flex-1">
                            <h3 className="font-bold text-purple-900 leading-tight">{userData ? userData.name : t('settings_profile_visitor')}</h3>
                            <span className="text-xs font-medium text-purple-600 mt-1 block">
                                {userData ? t('action_manage_account') : t('auth_login')}
                            </span>
                        </div>
                        {userData && <span className="material-symbols-rounded text-purple-300">chevron_right</span>}
                    </div>

                    {/* Bot√£o Extra para Abrir o Painel (Padronizado com ConfigItem) */}
                    <ConfigItem 
                        icon="dashboard" 
                        title={t('action_open_data_panel')} 
                        subtitle="Gerenciar informa√ß√µes do usu√°rio"
                        color="purple" 
                        onClick={onOpenProfile} 
                        t={t} 
                    />
                    
                    <SectionTitle icon="cloud" title={t('section_backup')} color="amber" />
                    <ConfigItem icon="cloud_upload" title={t('settings_backup_cloud')} subtitle={t('settings_backup_cloud_desc')} color="amber" isDisabled={!userData} onClick={handleCloudUpload} t={t} isLoading={cloudLoading.upload} />
                    <ConfigItem icon="cloud_download" title={t('settings_sync_devices')} subtitle={t('settings_sync_devices_desc')} color="amber" isDisabled={!userData} onClick={handleCloudDownload} t={t} isLoading={cloudLoading.download} />
                    <ConfigItem icon="download" title={t('settings_backup_local')} color="amber" isDisabled={false} onClick={handleLocalBackup} t={t} />
                </div>

                <div className="flex flex-col gap-3">
                    <SectionTitle icon="tune" title={t('section_system')} color="cyan" />
                    <ConfigItem icon="language" title={t('settings_language')} color="cyan" isDisabled={false} onClick={onOpenLanguage} t={t}>
                        <div className="flex items-center gap-2"><span className="text-sm font-bold text-cyan-600 uppercase">{currentLang.split('-')[0]}</span><span className="material-symbols-rounded text-cyan-400 text-sm">chevron_right</span></div>
                    </ConfigItem>
                    <SectionTitle icon="accessibility" title={t('section_accessibility')} color="fuchsia" />
                    <ConfigItem icon="zoom_in" title={t('settings_large_text')} color="fuchsia" isDisabled={false} t={t}><ToggleSwitch isChecked={false} onChange={() => {}} color="fuchsia" /></ConfigItem>
                    <ConfigItem icon="dark_mode" title={t('settings_dark_mode')} color="slate" isDisabled={false} t={t}><ToggleSwitch isChecked={false} onChange={() => {}} color="slate" /></ConfigItem>
                </div>
                
                {/* √ÅREA ADMIN / DEV */}
                <div className="col-span-1 sm:col-span-2 mt-4 border-t border-slate-100 pt-4">
                     <div onClick={() => setShowAdmin(!showAdmin)} className="flex items-center gap-2 cursor-pointer opacity-60 hover:opacity-100 transition">
                        <span className="material-symbols-rounded text-slate-500">terminal</span>
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">{t('section_admin')}</span>
                        <span className="material-symbols-rounded text-slate-400 text-sm ml-auto">{showAdmin ? 'expand_less' : 'expand_more'}</span>
                     </div>
                     
                     {showAdmin && (
                        <div className="mt-4 bg-slate-50 p-4 rounded-xl border border-slate-200 animate-fade-in-up">
                            <label className="block text-xs font-bold text-slate-500 mb-2">{t('admin_firebase_config')}</label>
                            <textarea 
                                className="w-full h-32 p-3 text-xs font-mono bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"
                                placeholder='{"apiKey": "...", "authDomain": "..."}'
                                value={fbConfig}
                                onChange={e => setFbConfig(e.target.value)}
                            />
                            <button onClick={handleSaveConfig} className="mt-3 px-4 py-2 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition">
                                {t('admin_save_config')}
                            </button>
                        </div>
                     )}
                </div>

            </div>
        </ScreenWrapper>
    );
};

function MiniAppScreen({ config, goBack, t }) {
    const iframeRef = useRef(null);
    const [loading, setLoading] = useState(true);
    const color = config.color || "indigo";
    const c = COLOR[color];

    useEffect(() => {
        (async () => {
            try {
                const res = await fetch(config.url);
                const text = await res.text();
                iframeRef.current.srcdoc = window.prepareMiniAppHtml(text, "APP", config.basePath || '');
                iframeRef.current.onload = () => {
                    if (iframeRef.current.contentWindow) {
                        iframeRef.current.contentWindow.__app_lang = t.getLanguage(); 
                    }
                };
            } catch(e) {
                // Se o fetch falhar, usamos a URL local como fallback para desenvolvimento
                if (config.id === 'profile_viewer' && config.url.includes("user-panel.html")) {
                    console.warn("Falha ao buscar MiniApp de Perfil via CDN. Usando src direto como fallback (para desenvolvimento local).", e);
                    // O caminho abaixo s√≥ funciona se o MiniApp de perfil estiver na mesma pasta ou subpasta relativa ao index.html
                    iframeRef.current.src = "src/components/user-panel.html"; 
                    iframeRef.current.onload = () => {
                         if (iframeRef.current.contentWindow) {
                            iframeRef.current.contentWindow.__app_lang = t.getLanguage();
                        }
                    };
                } else if (config.id === 'alerts_center') {
                    console.warn("Falha ao buscar MiniApp de Alertas via CDN.", e);
                }
            }
            setLoading(false);
        })();
    }, [config]);

    return (
        <ScreenWrapper title={t(config.titleKey)} color={color} onBack={goBack} t={t}>
            <div className="relative flex-1 flex flex-col h-full">
                {loading && (
                    <div className="absolute inset-0 flex items-center justify-center bg-white z-10">
                        <span className={`material-symbols-rounded animate-spin text-3xl ${c.text700}`}>sync</span>
                    </div>
                )}
                <iframe ref={iframeRef} className="w-full h-full border-0 flex-1 min-h-[500px]"/>
            </div>
        </ScreenWrapper>
    );
}

function App() {
    const [view, setView] = useState("loading"); // Come√ßa em loading
    const [activeApp, setActiveApp] = useState(null);
    const [userData, setUserData] = useState(null);
    const [lang, setLang] = useState("pt-BR");
    const [i18nData, setI18nData] = useState({});
    const [showLanguageAlert, setShowLanguageAlert] = useState(false);

    // Fun√ß√£o de tradu√ß√£o aprimorada para controle de fallback
    const t = (key) => {
        const repoVal = i18nData[lang]?.[key];
        const localVal = FALLBACK_I18N[lang]?.[key];
        
        if (!repoVal && !localVal && FALLBACK_I18N['pt-BR'][key]) {
            return FALLBACK_I18N['pt-BR'][key];
        }

        return repoVal || localVal || key;
    };
    
    t.getLanguage = () => lang;

    const handleLogin = async (user) => {
        await db.user.put(user);
        setUserData(user);
        setView("home"); // Volta para home ap√≥s o login
    };

    const handleOpenProfile = () => {
        const profileConfig = {
            id: "profile_viewer",
            titleKey: "section_profile", 
            color: "purple",
            url: "https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/components/user-panel.html"
        };
        setActiveApp(profileConfig);
        setView("miniapp");
    };

    const handleOpenAlerts = () => {
        const alertsConfig = {
            id: "alerts_center",
            titleKey: "alerts_title", 
            color: "rose",
            url: "https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/components/alerts-miniapp.html"
        };
        setActiveApp(alertsConfig);
        setView("miniapp");
    };


    useEffect(() => {
        let isMounted = true;
        
        const init = async () => {
            await window.initializeFirebase();
            const users = await db.user.toArray();
            
            if(users.length) {
                 setUserData(users[0]);
                 setView("home"); // Vai direto para Home se logado
            } else {
                 setView("welcome"); // Vai para o Welcome se n√£o logado
            }

            // 1. Fetch das tradu√ß√µes
            let loadedLanguages = {};
            try {
                const responses = await Promise.all(SUPPORTED_LANGUAGES.map(code =>
                    fetch(LANG_REPO_BASE + `${code}.json`).then(r => r.ok ? r.json() : null).catch(() => null)
                ));

                SUPPORTED_LANGUAGES.forEach((code, idx) => {
                    loadedLanguages[code] = responses[idx] || {};
                });
                setI18nData(loadedLanguages);

                // 2. L√≥gica de Alerta de Fallback
                if (isMounted) {
                    const currentLangKeys = Object.keys(loadedLanguages[lang] || {}).length;

                    if (lang !== 'pt-BR' && currentLangKeys < 10) {
                         setShowLanguageAlert(true);
                         setTimeout(() => setShowLanguageAlert(false), 10000);
                    } else {
                        setShowLanguageAlert(false);
                    }
                }
            } catch (e) {
                if (isMounted && lang !== 'pt-BR') {
                    setShowLanguageAlert(true);
                    setTimeout(() => setShowLanguageAlert(false), 10000);
                }
            }
        };
        init();
        
        return () => { isMounted = false; };
    }, [lang]);

    const MENU = [
        {id:"alerts", titleKey:"menu_alerts", icon:"notifications", color:"rose", action:handleOpenAlerts},
        {id:"settings", titleKey:"menu_settings", icon:"settings", color:"indigo", action:()=>{ setView("settings"); }},
        {id:"student_reg", titleKey:"edu_student_profile", icon:"person_add", color:"emerald", url:"https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@mainsrc/components/user-panel.html", basePath:"https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/components/", action:(item)=>{setActiveApp(item); setView("home");}},
        {id:"simulados", titleKey:"edu_simulados", icon:"edit_note", color:"amber", url:"products/educacao/app-quiz/index.html", basePath:"products/educacao/app-quiz/", action:(item)=>{setActiveApp(item); setView("miniapp");}}
    ];

    // Renderiza√ß√£o Condicional
    const renderContent = () => {
        if (view === "loading") {
            return <div className="animate-fade-in-up text-center w-full text-slate-500">{t('system_initializing')}</div>;
        }
        
        if (view === "welcome") {
            return <WelcomeScreen onRegister={() => setView("auth")} onContinue={() => setView("home")} t={t} />;
        }
        
        if (view === "home") {
            return (
                <div className="animate-fade-in-up text-center w-full">
                    <h1 className="text-3xl font-extrabold mb-2">{t("app_title_portfolio")}</h1>
                    <p className="text-slate-500 mb-8">{t('home_choose_app')}</p>
                    <div className="flex flex-wrap justify-center gap-6 max-w-3xl mx-auto">
                        {MENU.map(item => <AppCard key={item.id} item={item} t={t} onClick={() => item.action(item)}/>)}
                    </div>
                </div>
            );
        }

        if (view === "settings") {
            return <SettingsScreen userData={userData} onAuth={() => setView("auth")} onOpenProfile={handleOpenProfile} goBack={() => setView("home")} t={t} currentLang={lang} onOpenLanguage={() => setView("language_select")} />;
        }
        if (view === "auth") {
            return <AuthScreen onLoginSuccess={handleLogin} goBack={() => setView("settings")} t={t} currentLang={lang} />;
        }
        if (view === "language_select") {
            return <LanguageSelectionScreen goBack={() => setView("settings")} currentLang={lang} setLang={setLang} t={t} />;
        }
        if (view === "miniapp" && activeApp) {
            return <MiniAppScreen config={activeApp} goBack={() => setView("home")} t={t}/>;
        }

        return <div className="text-center text-red-500">{t('error_route_not_found')}</div>;
    }

    return (
        <main className="w-full max-w-5xl mx-auto p-4 sm:p-6 lg:p-8 flex flex-col items-center justify-center flex-1 h-full">
            {renderContent()}
            
            <LanguageFallbackAlert 
                isVisible={showLanguageAlert} 
                t={t} 
                onClose={() => setShowLanguageAlert(false)} 
            />
        </main>
    );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
document.getElementById("initial-loader").remove();
</script>
</body>
</html>
