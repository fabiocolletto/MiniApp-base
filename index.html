<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MiniApps — Shell</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0">
  <link rel="stylesheet" href="miniapp-base/style/styles.css">
</head>
<body>
  <div class="app-shell">
    <button
      type="button"
      class="btn ghost fullscreen-toggle"
      data-action="toggle-fullscreen"
      aria-pressed="false"
      aria-label="Tela cheia"
      title="Tela cheia"
    >
      <span class="material-symbols-rounded fullscreen-toggle__icon" data-icon="enter" aria-hidden="true">fullscreen</span>
      <span class="material-symbols-rounded fullscreen-toggle__icon" data-icon="exit" aria-hidden="true">fullscreen_exit</span>
    </button>
    <header class="shell-header">
      <div class="shell-container">
        <div class="header-content">
          <div class="branding">
            <span class="material-symbols-rounded app-icon app-icon--shell" aria-hidden="true">apps</span>
            <div>
              <h1>MiniApps Shell</h1>
              <p>Escolha um mini‑app no catálogo para iniciar.</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="shell-main">
      <div class="shell-container">
        <section class="panel-wrapper" aria-label="Painel de miniapp incorporado">
          <header>
            <h2>MiniApp em execução</h2>
          </header>
          <iframe id="miniapp-panel" name="miniapp-panel" src="./miniapp-catalogo/index.html" title="MiniApp embarcado"></iframe>
          <noscript>Ative o JavaScript para alternar entre os mini‑apps.</noscript>
        </section>
      </div>
    </main>

    <footer class="app-footer">
      <div class="shell-container">
        <p class="app-footer__info">
          <span class="app-footer__brand">
            <img
              src="https://5horas.com.br/wp-content/uploads/2025/10/Icone-Light-Transparente-500x500px.webp"
              alt="5 Horas"
              class="app-footer__logo"
              loading="lazy"
              width="48"
              height="48"
            >
            <span class="app-footer__research">5 horas de pesquisa e análise limitada</span>
          </span>
          <span aria-hidden="true">•</span>
          <span class="app-footer__product">MiniApps Shell</span>
          <span aria-hidden="true">•</span>
          <span class="app-footer__meta">Versão 0.2.0 (experimental)</span>
        </p>
      </div>
    </footer>
  </div>

  <script>
    (function () {
      const defaultMiniApp = './miniapp-catalogo/index.html';
      const panel = document.getElementById('miniapp-panel');
      const panelWrapper = document.querySelector('.panel-wrapper');
      const shellMainContainer = document.querySelector('.shell-main .shell-container');
      const appShell = document.querySelector('.app-shell');
      const fullscreenToggle = document.querySelector('[data-action="toggle-fullscreen"]');
      const catalogUrl = new URL(defaultMiniApp, window.location.href);
      const catalogPath = catalogUrl.pathname.replace(/\/+$/, '');

      function isCatalogUrl(url) {
        try {
          const parsed = new URL(url, window.location.href);
          return parsed.pathname.replace(/\/+$/, '') === catalogPath;
        } catch (_) {
          return false;
        }
      }

      function updateCatalogState(sourceUrl) {
        const isCatalog = isCatalogUrl(sourceUrl);

        if (panelWrapper) {
          panelWrapper.classList.toggle('panel-wrapper--catalog', isCatalog);
        }

        if (shellMainContainer) {
          shellMainContainer.classList.toggle('shell-container--catalog', isCatalog);
        }

        if (appShell) {
          appShell.classList.toggle('is-catalog-open', isCatalog);
        }
      }

      function isFullscreenActive() {
        return document.fullscreenElement === appShell || document.fullscreenElement === document.documentElement;
      }

      function syncFullscreenState() {
        const fullscreen = isFullscreenActive();

        if (appShell) {
          appShell.classList.toggle('is-fullscreen', fullscreen);
        }

        if (fullscreenToggle) {
          const label = fullscreen ? 'Sair do modo tela cheia' : 'Tela cheia';
          fullscreenToggle.setAttribute('aria-pressed', fullscreen ? 'true' : 'false');
          fullscreenToggle.setAttribute('aria-label', label);
          fullscreenToggle.setAttribute('title', label);
        }
      }

      async function enterFullscreen() {
        if (!appShell) {
          return;
        }

        try {
          if (document.fullscreenElement === appShell) {
            return;
          }

          if (appShell.requestFullscreen) {
            try {
              await appShell.requestFullscreen({ navigationUI: 'hide' });
            } catch (requestError) {
              if (requestError && requestError.name === 'TypeError') {
                await appShell.requestFullscreen();
              } else {
                throw requestError;
              }
            }
          } else if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          }
        } catch (error) {
          console.error('Não foi possível ativar a tela cheia nativa.', error);
        } finally {
          syncFullscreenState();
        }
      }

      async function exitFullscreen() {
        if (!document.fullscreenElement || !document.exitFullscreen) {
          syncFullscreenState();
          return;
        }

        try {
          await document.exitFullscreen();
        } catch (error) {
          console.error('Não foi possível sair da tela cheia nativa.', error);
        } finally {
          syncFullscreenState();
        }
      }

      if (fullscreenToggle) {
        fullscreenToggle.addEventListener('click', () => {
          if (isFullscreenActive()) {
            exitFullscreen();
          } else {
            enterFullscreen();
          }
        });
      }

      document.addEventListener('fullscreenchange', syncFullscreenState);
      document.addEventListener('fullscreenerror', syncFullscreenState);

      syncFullscreenState();

      function loadMiniApp(url, options = {}) {
        if (!panel) {
          return;
        }

        const targetUrl = typeof url === 'string' && url.trim() ? url : defaultMiniApp;

        if (panel.src !== new URL(targetUrl, window.location.href).href) {
          panel.src = targetUrl;
        }

        updateCatalogState(targetUrl);

        if (options.focus !== false && typeof panel.focus === 'function') {
          requestAnimationFrame(() => {
            try {
              panel.focus({ preventScroll: true });
            } catch (_) {
              panel.focus();
            }
          });
        }
      }

      window.loadMiniApp = loadMiniApp;

      document.querySelectorAll('[data-miniapp-target]').forEach((trigger) => {
        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          const targetUrl = trigger.getAttribute('data-miniapp-target');
          loadMiniApp(targetUrl);
        });
      });

      if (panel) {
        panel.addEventListener('load', () => {
          updateCatalogState(panel.src);
        });
      }

      window.addEventListener('message', (event) => {
        if (event.origin !== window.location.origin) {
          return;
        }

        const { data } = event;

        if (typeof data === 'string') {
          if (data === 'open-catalog') {
            loadMiniApp(defaultMiniApp);
          } else {
            loadMiniApp(data);
          }
          return;
        }

        if (data && typeof data === 'object') {
          if (typeof data.miniAppUrl === 'string') {
            loadMiniApp(data.miniAppUrl);
            return;
          }

          if (typeof data.url === 'string' && data.action === 'load-miniapp') {
            loadMiniApp(data.url);
            return;
          }

          if (data.action === 'open-catalog') {
            loadMiniApp(defaultMiniApp);
          }
        }
      });

      loadMiniApp(panel ? panel.getAttribute('src') : defaultMiniApp, { focus: false });
    })();
  </script>
</body>
</html>
