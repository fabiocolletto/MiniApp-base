<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniApp - Shell React</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <link rel="stylesheet" href="./docs/miniapp-global.css">
    <link rel="stylesheet" href="./docs/miniapp-card.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
    <script src="./docs/components/app-shared-header.js"></script>
    <script src="./docs/components/app-shared-footer.js"></script>
    <link rel="manifest" href="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/pwa/manifest.webmanifest">
    <meta name="theme-color" content="#f3f4f6">
    <style>
        app-shared-footer .icon-button:hover,
        app-shared-footer .icon-button:focus-visible {
            background-color: transparent !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="body-with-fixed-footer" style="margin: 0; padding: 0; width: 100%; height: 100%; overflow-x: hidden;">
    <div id="root"></div>
    <script>
        const h = React.createElement;
        const { useCallback, useEffect, useMemo, useState } = React;
        const { ThemeProvider, createTheme, CssBaseline, Box, Container, Paper, Stack, Typography } = MaterialUI;
        const HeaderComponent = window.AppSharedHeader;
        const FooterComponent = window.AppSharedFooter;

        if (!HeaderComponent || !FooterComponent) {
            throw new Error('Componentes compartilhados não foram carregados para o shell React.');
        }

        const NAV_STAGE_DEFINITIONS = {
            catalog: {
                key: 'catalog',
                title: 'MiniApp de Catálogo',
                description: 'Lista oficial de miniapps em preparo.',
                icon: 'grid_view',
                sourceId: 'catalog',
                isCore: true,
                launchUrl: './miniapps/catalog/index.html'
            },
            favorites: {
                key: 'favorites',
                title: 'MiniApp de Favoritos',
                description: 'Painel para organizar atalhos favoritos.',
                icon: 'star',
                sourceId: 'favorites',
                isCore: true,
                launchUrl: './miniapps/favorites/index.html'
            },
            recents: {
                key: 'recents',
                title: 'MiniApp de Recentes',
                description: 'Histórico de miniapps acessados recentemente.',
                icon: 'history',
                sourceId: 'recents',
                isCore: true,
                launchUrl: './miniapps/recents/index.html'
            },
            settings: {
                key: 'settings',
                title: 'MiniApp de Configurações',
                description: 'Preferências globais do usuário.',
                icon: 'settings',
                sourceId: 'settings',
                isCore: true,
                launchUrl: './miniapps/settings/index.html'
            }
        };

        const IFRAME_RESIZE_MESSAGE_TYPE = 'catalog:height';
        const ALLOWED_IFRAME_ORIGINS = new Set(['null', window.location.origin]);

        const appTheme = createTheme({
            palette: {
                mode: 'light',
                primary: { main: '#f97316' },
                secondary: { main: '#0ea5e9' },
                background: {
                    default: '#f3f4f6',
                    paper: '#ffffff',
                },
                text: {
                    primary: '#0f172a',
                    secondary: '#475569',
                },
            },
            typography: {
                fontFamily: '"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                h4: { fontWeight: 600 },
                button: { textTransform: 'none', fontWeight: 600 },
            },
            shape: {
                borderRadius: 24,
            },
            components: {
                MuiPaper: {
                    styleOverrides: {
                        root: {
                            borderRadius: 32,
                            border: '1px solid rgba(15,23,42,0.08)',
                            boxShadow: '0 30px 60px rgba(15,23,42,0.15)',
                        },
                    },
                },
                MuiContainer: {
                    defaultProps: {
                        maxWidth: 'lg',
                    },
                },
            },
        });

        function IframeStage({ stageDefinition, preferredHeight }) {
            const hasPreferredHeight = typeof preferredHeight === 'number' && preferredHeight > 0;
            const resolvedHeight = hasPreferredHeight ? `${Math.round(preferredHeight)}px` : null;

            return h(
                Box,
                {
                    component: 'section',
                    id: `iframe-stage-${stageDefinition.key}`,
                    sx: {
                        flex: hasPreferredHeight ? '0 0 auto' : 1,
                        display: 'flex',
                        flexDirection: 'column',
                        borderRadius: 4,
                        overflow: hasPreferredHeight ? 'visible' : 'hidden',
                        boxShadow: '0 30px 60px rgba(15, 23, 42, 0.2)',
                        minHeight: hasPreferredHeight ? resolvedHeight : { xs: '70vh', md: '75vh' },
                        height: resolvedHeight || undefined,
                    },
                },
                h('iframe', {
                    src: stageDefinition.launchUrl,
                    title: stageDefinition.title,
                    style: {
                        width: '100%',
                        height: resolvedHeight || '100%',
                        border: 'none',
                        display: 'block',
                    }
                })
            );
        }

        function App() {
            const navDefinitions = useMemo(() => NAV_STAGE_DEFINITIONS, []);
            const resolveStageDefinition = useCallback(
                (key) => {
                    const normalizedKey = (key || '').toLowerCase();
                    if (Object.prototype.hasOwnProperty.call(navDefinitions, normalizedKey)) {
                        return navDefinitions[normalizedKey];
                    }
                    return navDefinitions.catalog;
                },
                [navDefinitions]
            );
            const [activeStageKey, setActiveStageKey] = useState(() => resolveStageDefinition('catalog').key);
            const [footerState, setFooterState] = useState('expanded');
            const [activeFrameHeight, setActiveFrameHeight] = useState(null);

            const activeStageDefinition = useMemo(
                () => resolveStageDefinition(activeStageKey),
                [activeStageKey, resolveStageDefinition]
            );

            const handleNavigate = useCallback(
                (key) => {
                    setActiveStageKey(resolveStageDefinition(key).key);
                },
                [resolveStageDefinition]
            );

            const handleFooterStateChange = useCallback((nextState) => {
                setFooterState(nextState);
            }, []);

            useEffect(() => {
                if (activeStageDefinition.launchUrl) {
                    window.dispatchEvent(
                        new CustomEvent('app:notify', {
                            detail: {
                                message: `Navegando para Iframe: ${activeStageDefinition.title}`,
                                type: 'info'
                            }
                        })
                    );
                }
            }, [activeStageDefinition]);

            useEffect(() => {
                setActiveFrameHeight(null);
            }, [activeStageDefinition.key]);

            useEffect(() => {
                const normalizedSource = (activeStageDefinition.sourceId || activeStageDefinition.key || '').toLowerCase();
                if (!normalizedSource) {
                    return undefined;
                }

                function handleMessage(event) {
                    if (!ALLOWED_IFRAME_ORIGINS.has(event.origin)) {
                        return;
                    }
                    const payload = event.data;
                    if (!payload || payload.type !== IFRAME_RESIZE_MESSAGE_TYPE) {
                        return;
                    }
                    const payloadSource = (payload.sourceId || '').toLowerCase();
                    if (payloadSource !== normalizedSource) {
                        return;
                    }
                    const nextHeight = Number(payload.height);
                    if (!Number.isFinite(nextHeight) || nextHeight <= 0) {
                        return;
                    }
                    const rounded = Math.ceil(nextHeight);
                    setActiveFrameHeight((current) => (current === rounded ? current : rounded));
                }

                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [activeStageDefinition.key, activeStageDefinition.sourceId]);
            const mainContent = activeStageDefinition.launchUrl
                ? h(IframeStage, { stageDefinition: activeStageDefinition, preferredHeight: activeFrameHeight })
                : h(
                    Paper,
                    { elevation: 0, sx: { padding: 4, marginX: 'auto', maxWidth: 720 } },
                    h(
                        Stack,
                        { direction: 'row', spacing: 3, alignItems: 'center' },
                        h('span', { className: 'material-icons-sharp', style: { fontSize: '3rem', color: '#f97316' } }, activeStageDefinition.icon || 'hub'),
                        h(
                            Stack,
                            { spacing: 1 },
                            h(Typography, { component: 'p', variant: 'overline' }, 'MiniApp'),
                            h(Typography, { component: 'h2', variant: 'h4' }, activeStageDefinition.title),
                            h(Typography, { component: 'p', color: 'text.secondary' }, activeStageDefinition.description)
                        )
                    )
                );

            return h(
                ThemeProvider,
                { theme: appTheme },
                h(CssBaseline, null),
                h(
                    'div',
                    { className: 'miniapp-shell', style: { minHeight: '100vh', display: 'flex', flexDirection: 'column' } },
                    h(HeaderComponent, {
                        title: activeStageDefinition.title,
                        icon: activeStageDefinition.icon,
                        hideSearch: true
                    }),
                    h(
                        Box,
                        { component: 'main', className: 'miniapp-stage', sx: { flex: 1, display: 'flex', flexDirection: 'column' } },
                        h(
                            Container,
                            { sx: { flex: 1, display: 'flex', flexDirection: 'column', gap: 4 } },
                            mainContent
                        )
                    ),
                    h(FooterComponent, {
                        activeTab: activeStageKey,
                        variant: 'full',
                        state: footerState,
                        onNavigate: handleNavigate,
                        onStateChange: handleFooterStateChange,
                        showSettings: true,
                        showMeta: true
                    })
                )
            );
        }

        const rootElement = document.getElementById('root');
        ReactDOM.createRoot(rootElement).render(h(App));
    </script>
</body>
</html>
