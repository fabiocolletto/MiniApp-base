<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5 Horas • MiniApps</title>
    <link rel="stylesheet" href="./styles/tokens.css" />
    <link rel="stylesheet" href="./styles/main.css" />
    <link rel="stylesheet" href="./styles/auth.css" />
    <link rel="manifest" href="./public/manifest.webmanifest" />
    <meta name="theme-color" content="#f29f05" />
    <meta name="application-name" content="5 Horas MiniApps" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="MiniApps" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="icon" type="image/svg+xml" sizes="192x192" href="./public/icons/miniapp-icon-192.svg" />
    <link rel="icon" type="image/svg+xml" sizes="512x512" href="./public/icons/miniapp-icon-512.svg" />
    <link rel="apple-touch-icon" sizes="192x192" href="./public/icons/miniapp-icon-192.svg" />
    <link rel="apple-touch-icon" sizes="512x512" href="./public/icons/miniapp-icon-512.svg" />
  </head>
<body class="auth-only">
  <header class="auth-shell__header" aria-label="Identidade do MiniApp">
    <div class="auth-shell__brand">
      <span class="auth-shell__brand-label">5 Horas</span>
      <span class="auth-shell__brand-divider" aria-hidden="true">•</span>
      <span class="auth-shell__brand-product">MiniApps</span>
    </div>
    <p class="auth-shell__context">Acesso unificado para todos os serviços</p>
  </header>

  <main id="app" class="auth-screen">
    <section class="auth-card" aria-labelledby="authWelcomeTitle">
      <header class="auth-header">
        <h1 id="authWelcomeTitle" data-i18n="auth.welcome">Bem-vindo</h1>
        <p class="auth-sub" data-i18n="auth.subtitle">
          Acesse sua conta, crie um novo cadastro ou explore como convidado
        </p>
      </header>

      <div class="auth-selector" role="tablist" aria-label="Modos de acesso">
        <button
          id="btnLogin"
          class="auth-selector__button is-active"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="true"
          tabindex="0"
          data-view="login"
          data-i18n="auth.login"
        >
          Entrar
        </button>
        <button
          id="btnRegister"
          class="auth-selector__button"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="false"
          tabindex="-1"
          data-view="register"
          data-i18n="auth.register"
        >
          Criar conta
        </button>
        <button
          id="btnGuest"
          class="auth-selector__button"
          type="button"
          role="tab"
          aria-controls="authViewRoot"
          aria-selected="false"
          tabindex="-1"
          data-view="guest"
          data-i18n="auth.guest"
        >
          Convidado
        </button>
      </div>

      <div class="auth-card__body">
        <section id="authViewRoot" class="auth-card__view" aria-live="polite"></section>
      </div>

      <div class="auth-footer" role="note">
        <small id="statusHint" data-i18n="auth.hint">
          Use os botões acima para escolher entre entrar, criar conta ou explorar como convidado.
        </small>
      </div>
    </section>
  </main>

  <footer class="auth-shell__footer">
    <small class="auth-shell__footer-text">
      <span>© <span data-current-year></span> 5 Horas</span>
      <span class="auth-shell__footer-divider" aria-hidden="true">•</span>
      <span>MiniApps</span>
      <span class="auth-shell__footer-divider" aria-hidden="true">•</span>
      <span>Versão <strong data-app-version>carregando…</strong></span>
    </small>
  </footer>


  <script type="module">
    import eventBus from './scripts/events/event-bus.js';
    import { registerServiceWorker } from './scripts/pwa/register-service-worker.js';
    import { renderLoginPanel } from './scripts/views/login.js';
    import { renderRegisterPanel } from './scripts/views/register.js';
    import { getMiniAppsSnapshot } from './scripts/data/miniapp-store.js';

    const viewRoot = document.getElementById('authViewRoot');
    const authCard = document.querySelector('.auth-card');
    const selector = document.querySelector('.auth-selector');
    const selectorButtons = Array.from(document.querySelectorAll('.auth-selector__button'));
    const statusHint = document.getElementById('statusHint');
    const APP_DOC_BASE_PATH = './docs/miniapps';
    const APP_QUERY_PARAM = 'app';

    function normalizeMiniAppId(value) {
      if (typeof value !== 'string') {
        return '';
      }

      return value.trim().toLowerCase();
    }

    function buildMiniAppDocPath(id) {
      const normalized = normalizeMiniAppId(id);
      return normalized ? `${APP_DOC_BASE_PATH}/${normalized}.md` : '';
    }

    function findMiniAppById(id) {
      const normalized = normalizeMiniAppId(id);
      if (!normalized) {
        return null;
      }

      return (
        getMiniAppsSnapshot().find((app) => normalizeMiniAppId(app?.id) === normalized) ?? null
      );
    }

    function openMiniAppShortcut(id) {
      const normalized = normalizeMiniAppId(id);
      if (!normalized) {
        return false;
      }

      const target = findMiniAppById(normalized);
      if (!target) {
        return false;
      }

      const docPath = buildMiniAppDocPath(normalized);
      if (!docPath) {
        return false;
      }

      window.location.replace(docPath);
      return true;
    }

    function renderGuestAccessPanel(root, options = {}) {
      if (!(root instanceof HTMLElement)) {
        return;
      }

      root.className = 'card view auth-view view--guest';
      root.dataset.view = 'guest';

      const panel = document.createElement('section');
      panel.className = 'auth-panel__form guest-panel';

      const highlightAppId = normalizeMiniAppId(options.highlightAppId);
      let highlightedLink = null;
      let highlightedApp = null;

      const title = document.createElement('h2');
      title.className = 'auth-panel__title guest-panel__title';
      title.textContent = 'MiniApps gratuitos';

      const intro = document.createElement('p');
      intro.className = 'auth-panel__intro guest-panel__intro';
      intro.textContent =
        'Explore uma seleção de MiniApps liberados sem cadastro. Você pode abrir e testar imediatamente.';

      const list = document.createElement('ul');
      list.className = 'guest-panel__list';

      const apps = getMiniAppsSnapshot()
        .filter((app) => Array.isArray(app?.access) && app.access.includes('usuario'))
        .sort((a, b) => {
          const aName = typeof a?.name === 'string' ? a.name : '';
          const bName = typeof b?.name === 'string' ? b.name : '';
          return aName.localeCompare(bName, 'pt-BR');
        });

      if (apps.length === 0) {
        const emptyState = document.createElement('p');
        emptyState.className = 'guest-panel__empty';
        emptyState.textContent =
          'No momento não há MiniApps gratuitos disponíveis. Volte em breve para conferir as novidades.';
        panel.append(title, intro, emptyState);
        root.replaceChildren(panel);
        return;
      }

      apps.forEach((app) => {
        const item = document.createElement('li');
        item.className = 'guest-panel__item';

        const appTitle = document.createElement('h3');
        appTitle.className = 'guest-panel__item-title';
        appTitle.textContent = app?.name?.trim() || 'MiniApp disponível';

        const description = document.createElement('p');
        description.className = 'guest-panel__item-description';
        description.textContent =
          app?.description?.trim() || 'Abra o MiniApp para conhecer as funcionalidades liberadas ao convidado.';

        const link = document.createElement('a');
        link.className = 'guest-panel__link';
        link.target = '_blank';
        link.rel = 'noreferrer noopener';
        const appId = typeof app?.id === 'string' ? app.id.trim() : '';
        const normalizedId = normalizeMiniAppId(appId) || 'miniapp';
        item.dataset.appId = normalizedId;
        link.href = buildMiniAppDocPath(normalizedId) || '#';
        link.textContent = 'Abrir documentação do MiniApp';
        link.title = `Ver detalhes do MiniApp ${appTitle.textContent}`;

        if (normalizedId === highlightAppId) {
          item.classList.add('guest-panel__item--active');
          highlightedLink = link;
          highlightedApp = app;
        }

        item.append(appTitle, description, link);
        list.append(item);
      });

      const note = document.createElement('p');
      note.className = 'guest-panel__note';
      note.textContent =
        'Para salvar progresso e sincronizar preferências entre dispositivos, faça login ou crie uma conta a qualquer momento.';

      panel.append(title, intro, list, note);
      root.replaceChildren(panel);

      if (highlightedLink) {
        queueMicrotask(() => {
          try {
            highlightedLink.focus();
          } catch (error) {
            console.warn('Não foi possível focar o atalho solicitado.', error);
          }
        });

        if (typeof options.onHighlight === 'function') {
          options.onHighlight({ app: highlightedApp, link: highlightedLink, id: highlightAppId });
        }
      }
    }

    const VIEW_RENDERERS = {
      login: {
        render: renderLoginPanel,
        hint: 'Informe seu telefone e senha ou selecione o modo convidado para explorar o MiniApp.',
      },
      register: {
        render: renderRegisterPanel,
        hint: 'Preencha os dados abaixo para criar sua conta com segurança.',
      },
      guest: {
        render: renderGuestAccessPanel,
        hint: 'Conheça os MiniApps liberados para convidados sem precisar de cadastro.',
      },
    };

    let currentView = null;

    function focusFirstInteractiveElement(root) {
      if (!(root instanceof HTMLElement)) {
        return;
      }

      const focusable = root.querySelector(
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );

      if (focusable instanceof HTMLElement) {
        focusable.focus({ preventScroll: true });
      }
    }

    function updateHint(viewName) {
      if (!(statusHint instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (viewConfig?.hint) {
        statusHint.textContent = viewConfig.hint;
      }
    }

    function setActiveButton(viewName) {
      selectorButtons.forEach((button) => {
        if (!(button instanceof HTMLElement)) {
          return;
        }

        const isActive = button.dataset.view === viewName;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-selected', String(isActive));
        button.tabIndex = isActive ? 0 : -1;
      });
    }

    function renderAuthView(viewName, { shouldFocus = true, viewProps = {} } = {}) {
      if (!(viewRoot instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (!viewConfig) {
        return;
      }

      viewRoot.replaceChildren();
      viewConfig.render(viewRoot, viewProps);
      currentView = viewName;

      setActiveButton(viewName);
      updateHint(viewName);

      if (authCard instanceof HTMLElement) {
        authCard.setAttribute('data-active-view', viewName);
      }

      if (shouldFocus) {
        queueMicrotask(() => focusFirstInteractiveElement(viewRoot));
      }
    }

    function handleAppNavigate(payload) {
      if (!payload || typeof payload !== 'object') {
        return;
      }

      const { view } = payload;
      if (view === 'login' || view === 'register' || view === 'guest') {
        renderAuthView(view, { shouldFocus: true });
      }
    }

    selectorButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const viewName = button.dataset.view;
        if (viewName) {
          renderAuthView(viewName, { shouldFocus: true });
        }
      });
    });

    selector?.addEventListener('keydown', (event) => {
      if (!(event instanceof KeyboardEvent)) {
        return;
      }

      const views = selectorButtons.map((button) => button.dataset.view).filter(Boolean);
      if (!views.length) {
        return;
      }

      const currentIndex = views.indexOf(currentView ?? '');
      const lastIndex = views.length - 1;

      if (event.key === 'ArrowRight' || event.key === 'ArrowDown') {
        event.preventDefault();
        const nextIndex = currentIndex < 0 ? 0 : Math.min(currentIndex + 1, lastIndex);
        const nextButton = selectorButtons[nextIndex];
        if (nextButton) {
          nextButton.click();
        }
      } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {
        event.preventDefault();
        const prevIndex = currentIndex > 0 ? currentIndex - 1 : 0;
        const prevButton = selectorButtons[prevIndex];
        if (prevButton) {
          prevButton.click();
        }
      }
    });

    eventBus.on('app:navigate', handleAppNavigate);

    renderAuthView('login', { shouldFocus: false });

    const versionTarget = document.querySelector('[data-app-version]');
    const currentYearTarget = document.querySelector('[data-current-year]');

    if (currentYearTarget instanceof HTMLElement) {
      currentYearTarget.textContent = String(new Date().getFullYear());
    }

    async function loadAppVersion() {
      try {
        const response = await fetch('./package.json', { cache: 'no-store' });

        if (!response.ok) {
          if (versionTarget instanceof HTMLElement) {
            versionTarget.textContent = 'indisponível';
          }
          return null;
        }

        const packageInfo = await response.json();
        const version = typeof packageInfo?.version === 'string' ? packageInfo.version.trim() : '';

        if (versionTarget instanceof HTMLElement) {
          if (version) {
            versionTarget.textContent = `v${version}`;
          } else {
            versionTarget.textContent = 'em desenvolvimento';
          }
        }

        return version || null;
      } catch (error) {
        console.warn('Não foi possível carregar a versão do aplicativo.', error);
        if (versionTarget instanceof HTMLElement) {
          versionTarget.textContent = 'indisponível';
        }
        return null;
      }
    }

    async function setupPwaSupport() {
      const version = await loadAppVersion();
      await registerServiceWorker(version);
    }

    setupPwaSupport().catch((error) => {
      console.error('Falha ao configurar os recursos PWA.', error);
    });

    const currentUrl = new URL(window.location.href);
    const requestedMiniApp = normalizeMiniAppId(currentUrl.searchParams.get(APP_QUERY_PARAM));

    if (requestedMiniApp) {
      const redirected = openMiniAppShortcut(requestedMiniApp);

      if (!redirected) {
        renderAuthView('guest', {
          shouldFocus: true,
          viewProps: {
            highlightAppId: requestedMiniApp,
            onHighlight({ app }) {
              if (statusHint instanceof HTMLElement && app) {
                statusHint.textContent = `Documentação do MiniApp "${app.name}" aberta nesta tela. Use o botão para acessar os detalhes.`;
              }
            },
          },
        });
      }
    }
  </script>

</body>
</html>
