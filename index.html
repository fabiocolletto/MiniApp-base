<!DOCTYPE html>
<!--
  PWAO ‚Äì GENOMA v2 (PALCO GLOBAL com NAVEGA√á√ÉO v1)
  -------------------------------------------------
  Arquivo: /index.html (raiz do reposit√≥rio)

  ‚Ä¢ Palco global (Stage)
  ‚Ä¢ Navega√ß√£o nativa no estilo do Genoma v1 (welcome ‚Üí dashboard ‚Üí ...)
  ‚Ä¢ Conex√£o com c√©lulas via renderizador (evento celula.expressar)
  ‚Ä¢ ScreenFactory: telas geradas pelo Genoma via prefixo data.*

  IMPORTANTE
  ‚Ä¢ Sem regra de neg√≥cio
  ‚Ä¢ Sem depend√™ncia de frameworks
  ‚Ä¢ C√©lulas vivem dentro do Stage
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PWAO</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="opp/manifest.webmanifest" />

  <!-- Material Symbols (√≠cones do header) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: Inter, system-ui, sans-serif;
      background: #ffffff;
      color: #1f2937;
    }

    #app {
      min-height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center; /* centraliza tudo horizontalmente */
    }

    /* Container central √∫nico para header, stage e footer */
    .app-shell {
      width: 100%;
      max-width: 1200px; /* largura padr√£o desktop */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      z-index: 40;
    }

    header .header-left,
    header .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header .title {
      font-weight: 600;
      font-size: 15px;
    }

    header button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
    }

    .icon-btn:hover {
      background: #f1f5f9;
    }

    .material-symbols-outlined {
      font-size: 22px;
      line-height: 1;
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    }

    header button:active { transform: scale(0.96); }

    footer { display: none; }

    main#stage,
    main#pwao-stage,
    .stage {
      padding: 24px;
      /* largura agora vem exclusivamente do .app-shell */
      width: 100%;
      margin: 0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      align-items: stretch; /* garante mesma altura visual */
    }

    @media (min-width: 768px) {
      .grid { grid-template-columns: repeat(4, 1fr); }
    }

    @media (min-width: 1280px) {
      .grid { grid-template-columns: repeat(6, 1fr); }
    }

    .card {
      width: 100%; /* garante padroniza√ß√£o em todas as telas */
      aspect-ratio: 1 / 1;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      text-align: center;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 600;
      background: #fff;
      appearance: none;
      -webkit-appearance: none;
    }

    .card:active { transform: scale(0.99); }

    .card .icon { font-size: 36px; line-height: 1; }

    .welcome {
      min-height: calc(100vh - 56px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .welcome-box {
      max-width: 360px;
      width: 100%;
      text-align: center;
      margin: 0 auto;
    }

    .welcome-box h1 {
      font-size: 28px;
      margin: 0 0 8px 0;
    }

    .welcome-box p {
      color: #6b7280;
      margin: 0 0 24px 0;
    }

    .welcome-actions {
      display: grid;
      gap: 10px;
    }

    .welcome-box button {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #4f46e5;
      background: #ffffff;
      color: #4f46e5;
      font-weight: 600;
      cursor: pointer;
    }

    .tone-finance { background:#eef2ff; color:#4338ca; border-color:#c7d2fe; }

    /* Subtons Finan√ßas */
    .finance-income { background:#ecfdf5; border-color:#6ee7b7; color:#047857; }
    .finance-expense { background:#fef2f2; border-color:#fca5a5; color:#b91c1c; }
    .finance-report { background:#eff6ff; border-color:#93c5fd; color:#1d4ed8; }
    .tone-education { background:#fffbeb; color:#b45309; border-color:#fde68a; }

    /* Subtons Educa√ß√£o */
    .edu-study { background:#fffbeb; border-color:#fde68a; color:#92400e; }
    .edu-exam { background:#eff6ff; border-color:#93c5fd; color:#1d4ed8; }
    .edu-task { background:#f0fdf4; border-color:#86efac; color:#166534; }
    .edu-agenda { background:#fdf2f8; border-color:#fbcfe8; color:#9d174d; }
    .edu-contest { background:#f5f3ff; border-color:#c4b5fd; color:#5b21b6; }
    .edu-sim { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .tone-health { background:#ecfeff; color:#0f766e; border-color:#99f6e4; }

    /* Subtons Sa√∫de */
    .health-record { background:#f0fdf4; border-color:#86efac; color:#166534; }
    .health-appointment { background:#ecfeff; border-color:#67e8f9; color:#155e75; }
    .health-meds { background:#fefce8; border-color:#fde68a; color:#854d0e; }
    .health-vaccine { background:#eff6ff; border-color:#93c5fd; color:#1e40af; }
    .health-exam { background:#faf5ff; border-color:#d8b4fe; color:#6b21a8; }
    .health-reminder { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .tone-settings { background:#f1f5f9; color:#334155; border-color:#e2e8f0; }

    .loading, .error {
      padding: 24px;
      text-align: center;
      font-size: 14px;
      color: #475569;
    }

    .error { color: #991b1b; }

    .form {
      margin-top: 12px;
      display: grid;
      gap: 12px;
      text-align: left;
      max-width: 560px;
      margin-left: auto;
      margin-right: auto;
    }

    .field label {
      display: block;
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
    }

    .field input, .field select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font: inherit;
    }

    .primary {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #111827;
      background: #111827;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .primary:active { transform: scale(0.99); }

    /* Menu lateral do AppShell */
    #pwao-menu-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100vh;
      background: #ffffff;
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
      transform: translateX(-280px);
      transition: transform 0.25s ease;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 100;
    }

    #pwao-menu-panel.open { transform: translateX(0); }

    #pwao-menu-panel .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    #pwao-menu-panel .menu-title {
      font-weight: 700;
      font-size: 16px;
    }

    #pwao-menu-panel .menu-list {
      display: grid;
      gap: 10px;
    }

    #pwao-menu-panel .menu-item {
      padding: 12px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      text-align: left;
      cursor: pointer;
      transition: 0.2s;
    }

    #pwao-menu-panel .menu-item:hover { background: #eef2ff; }
    #pwao-menu-panel .menu-item:active { transform: scale(0.99); }
  </style>
</head>
<body>

  <div id="app"></div>

  <script type="module">
  import { createRenderer } from './src/core/renderer.js';
  (function () {
    'use strict';

    /* ========================== ELEMENTOS ========================== */
    const Renderer = createRenderer({ rootId: 'app' });
    Renderer.ensureShell();

    const STAGE = Renderer.getStage();
    const FOOTER = document.getElementById('pwao-footer');

    const BTN_BACK = document.getElementById('btn-back');
    const BTN_USER = document.getElementById('btn-user');
    const HEADER_TITLE = document.getElementById('pwao-title');

    /* ========================== ESTADO ========================== */
    let CURRENT_SCREEN = null;
    const HISTORY = [];

    /* ========================== RENDER ========================== */
    function renderStage(html, opts = {}) {
      Renderer.render(html, opts);
    }

    function setHeaderTitle(title) {
      Renderer.setTitle(title);
    }

    function updateBackVisibility() {
      if (!BTN_BACK) return;
      BTN_BACK.style.visibility = HISTORY.length ? 'visible' : 'hidden';
    }

    function goBack() {
      const prev = HISTORY.pop();
      if (!prev) {
        updateBackVisibility();
        return;
      }
      // Voltar n√£o empilha hist√≥rico
      CURRENT_SCREEN = null;
      navigate(prev, { pushHistory: false });
    }

    function renderFooter(buttons = []) {
      // Reservado (hoje oculto)
      FOOTER.innerHTML = (buttons || []).map(btn =>
        `<button data-screen="${btn.screen || ''}" data-celula="${btn.celula || ''}">${btn.label}</button>`
      ).join('');
    }

    /* ========================== MEM√ìRIA (IndexedDB + fallback) ========================== */
    const Memory = (() => {
      const DB = 'pwao-organism';
      let db = null;
      const mem = new Map();

      function open() {
        if (!('indexedDB' in window)) {
          console.warn('IndexedDB indispon√≠vel neste ambiente. Usando mem√≥ria vol√°til.');
          db = null;
          return Promise.resolve();
        }

        return new Promise((resolve) => {
          const req = indexedDB.open(DB, 1);
          req.onupgradeneeded = (e) => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains('cells')) {
              d.createObjectStore('cells', { keyPath: 'nome' });
            }
          };
          req.onsuccess = () => { db = req.result; resolve(); };
          req.onerror = () => {
            console.warn('Falha ao abrir IndexedDB. Usando mem√≥ria vol√°til.');
            db = null;
            resolve();
          };
        });
      }

      function saveCell(c) {
        if (!c?.nome) return Promise.resolve();
        mem.set(c.nome, c);

        if (!db) return Promise.resolve();
        return new Promise((resolve, reject) => {
          const tx = db.transaction('cells', 'readwrite');
          const store = tx.objectStore('cells');
          const req = store.put(c);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      function getCell(n) {
        if (!n) return Promise.resolve(null);

        if (mem.has(n)) return Promise.resolve(mem.get(n));
        if (!db) return Promise.resolve(null);

        return new Promise((resolve) => {
          const tx = db.transaction('cells', 'readonly');
          const store = tx.objectStore('cells');
          const req = store.get(n);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => resolve(null);
        });
      }

      return { open, saveCell, getCell };
    })();

    /* ========================== NARRADOR (Event Bus) ========================== */
    const Narrador = (() => {
      const map = {};
      return {
        on(tipo, fn) { (map[tipo] ||= []).push(fn); },
        emitir(evt) {
          const list = map[evt.tipo] || [];
          list.forEach((f) => {
            try { f(evt); } catch (e) { console.warn(e); }
          });
        }
      };
    })();

    window.Narrador = Narrador;

    /* ========================== API P√öBLICA (C√âLULAS) ========================== */
    window.PWAO_RegistrarCelula = async (m) => {
      if (!m?.nome || !m?.caminho) return;
      await Memory.saveCell({
        nome: m.nome,
        caminho: m.caminho,
        orgao: m.orgao || null,
        versao: m.versao || '0.0.0',
        descricao: m.descricao || ''
      });
    };

    /* ========================== EXPRESS√ÉO DE C√âLULAS ========================== */
    async function fetchWithFallback(cell) {
      async function tryFetch(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch-failed');
        return res.text();
      }

      try {
        return await tryFetch(cell.caminho);
      } catch (e) {
        if (cell.fallback) {
          try {
            return await tryFetch(cell.fallback);
          } catch (_) {}
        }
        throw new Error('all-fetch-failed');
      }
    }

    async function expressarCelula(nome) {
      const cell = await Memory.getCell(nome);
      if (!cell) {
        renderStage(`<div class="error">C√©lula n√£o registrada: <b>${nome}</b></div>`);
        return;
      }

      try {
        const html = await fetchWithFallback(cell);
        renderStage(html);
      } catch (e) {
        renderStage(`<div class="error">Falha ao carregar c√©lula: <b>${nome}</b><br><small>${cell.caminho}</small></div>`);
      }
    }

    Narrador.on('celula.expressar', (e) => expressarCelula(e.nome));

    /* ========================== DATA_SCREENS (telas geradas) ========================== */
    const DATA_SCREENS = {
      'finance.income.single': {
        title: 'Receita Avulsa',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true, placeholder: 'Ex: Bico, venda, reembolso' },
          { name: 'valor', label: 'Valor', type: 'number', required: true, placeholder: 'Ex: 150.00' },
          { name: 'data', label: 'Data', type: 'date', required: true }
        ]
      },
      'finance.income.recurring': {
        title: 'Receita Recorrente',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true, placeholder: 'Ex: Sal√°rio, aluguel' },
          { name: 'valor', label: 'Valor', type: 'number', required: true, placeholder: 'Ex: 2500.00' },
          { name: 'dia', label: 'Dia do m√™s', type: 'number', required: true, placeholder: 'Ex: 5' }
        ]
      },
      'finance.expense.single': {
        title: 'Despesa Avulsa',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true, placeholder: 'Ex: Mercado, farm√°cia' },
          { name: 'valor', label: 'Valor', type: 'number', required: true, placeholder: 'Ex: 80.00' },
          { name: 'data', label: 'Data', type: 'date', required: true }
        ]
      },
      'finance.expense.recurring': {
        title: 'Despesa Recorrente',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true, placeholder: 'Ex: Internet, escola' },
          { name: 'valor', label: 'Valor', type: 'number', required: true, placeholder: 'Ex: 120.00' },
          { name: 'dia', label: 'Dia do m√™s', type: 'number', required: true, placeholder: 'Ex: 10' }
        ]
      },
      'user.profile': {
        title: 'Perfil do Usu√°rio',
        fields: [
          { name: 'name', label: 'Nome completo', type: 'text', required: true, placeholder: 'Seu nome' },
          { name: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'email@exemplo.com' },
          { name: 'birth', label: 'Data de nascimento', type: 'date' },
          { name: 'phone', label: 'Telefone', type: 'tel', placeholder: '(00) 00000-0000' }
        ]
      }
    };

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (c) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    function renderDataForm(spec, routeKey) {
      const fields = (spec.fields || []).map((f) => {
        const id = `f_${routeKey}_${f.name}`.replace(/[^a-zA-Z0-9_]/g, '_');
        const required = f.required ? 'required' : '';
        const placeholder = f.placeholder ? `placeholder="${escapeHtml(f.placeholder)}"` : '';
        const value = f.value ? `value="${escapeHtml(f.value)}"` : '';

        return `
          <div class="field">
            <label for="${id}">${escapeHtml(f.label || f.name)}</label>
            <input id="${id}" name="${escapeHtml(f.name)}" type="${escapeHtml(f.type || 'text')}" ${required} ${placeholder} ${value} />
          </div>
        `;
      }).join('');

      renderStage(`
        <div>
          <div style="text-align:center; font-weight:700; margin-bottom:8px;">${escapeHtml(spec.title || 'Cadastro')}</div>
          <div style="text-align:center; color:#6b7280; font-size:13px; margin-bottom:16px;">Tela gerada pelo Genoma (data.*). Persist√™ncia ainda em implanta√ß√£o.</div>
          <form class="form" id="data-form">
            ${fields}
            <button class="primary" type="submit">Salvar</button>
          </form>
        </div>
      `);

      const form = document.getElementById('data-form');
      if (!form) return;
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());

        console.log('[data.* submit]', routeKey, payload);
        renderStage(`<div class="loading">Salvo (mock). Pr√≥ximo: enviar para c√©lula de persist√™ncia.</div>`);
      });
    }

    function ScreenFactory(target) {
      if (!target.startsWith('data.')) return false;

      const routeKey = target.replace(/^data\./, '');
      const spec = DATA_SCREENS[routeKey];

      if (!spec) {
        setHeaderTitle('Cadastro');
        renderStage(`<div class="error">Tela data n√£o registrada: <b>${escapeHtml(routeKey)}</b></div>`);
        return true;
      }

      setHeaderTitle(spec.title);
      renderDataForm(spec, routeKey);
      return true;
    }

    /* ========================== TELAS NATIVAS (v1) ========================== */
    const SCREENS = {
      _meta: {
        welcome:   { title: 'Bem-vindo' },
        dashboard: { title: 'Dashboard' },
        finance:   { title: 'Finan√ßas' },
        education: { title: 'Educa√ß√£o' },
        health:    { title: 'Sa√∫de' },
        alerts:    { title: 'Alertas' },
        settings:  { title: 'Configura√ß√µes' },
        offline:   { title: 'Offline' },
        error:     { title: 'Erro' }
      },

      welcome() {
        setHeaderTitle(SCREENS._meta.welcome.title);

        renderStage(`
          <div class="welcome">
            <div class="welcome-box">
              <div class="icon" style="font-size:48px; margin-bottom:12px;">üöÄ</div>
              <h1>Bem-vindo</h1>
              <p>Seu painel inteligente come√ßa aqui</p>
              <div class="welcome-actions">
                <button id="btn-start">Entrar</button>
              </div>
            </div>
          </div>
        `);
        const btnStart = document.getElementById('btn-start');
        if (btnStart) btnStart.onclick = () => navigate('dashboard');
      },

      dashboard() {
        setHeaderTitle(SCREENS._meta.dashboard.title);
        renderStage(`
          <div class="grid">
            <button class="card tone-finance" data-action="render" data-target="finance">
              <div class="icon">üí∞</div>
              <div>Finan√ßas</div>
            </button>
            <button class="card tone-education" data-action="render" data-target="education">
              <div class="icon">üéì</div>
              <div>Educa√ß√£o</div>
            </button>
            <button class="card tone-health" data-action="render" data-target="health">
              <div class="icon">üè•</div>
              <div>Sa√∫de</div>
            </button>
            <button class="card tone-settings" data-action="render" data-target="settings">
              <div class="icon">‚öôÔ∏è</div>
              <div>Configura√ß√µes</div>
            </button>
          </div>
        `);
      },

      finance() {
        setHeaderTitle(SCREENS._meta.finance.title);
        renderStage(`
          <div class="grid">
            <button class="card finance-income" data-action="render" data-target="data.finance.income.single">
              <div class="icon">‚ûï</div>
              <div>Receitas Avulsas</div>
            </button>
            <button class="card finance-income" data-action="render" data-target="data.finance.income.recurring">
              <div class="icon">üîÅ</div>
              <div>Receitas Recorrentes</div>
            </button>
            <button class="card finance-expense" data-action="render" data-target="data.finance.expense.single">
              <div class="icon">‚ûñ</div>
              <div>Despesas Avulsas</div>
            </button>
            <button class="card finance-expense" data-action="render" data-target="data.finance.expense.recurring">
              <div class="icon">üîÅ</div>
              <div>Despesas Recorrentes</div>
            </button>
            <button class="card finance-report" data-action="render" data-target="finance.reports">
              <div class="icon">üìà</div>
              <div>Relat√≥rios</div>
            </button>
            <button class="card" data-action="render" data-target="finance.settings">
              <div class="icon">‚öôÔ∏è</div>
              <div>Ajustes</div>
            </button>
          </div>
        `);
      },

      education() {
        setHeaderTitle(SCREENS._meta.education.title);
        renderStage(`
          <div class="grid">
            <button class="card edu-study" data-action="render" data-target="education.study">
              <div class="icon">üìö</div>
              <div>Estudos do Dia</div>
            </button>
            <button class="card edu-exam" data-action="render" data-target="education.exam">
              <div class="icon">üìù</div>
              <div>Provas & Avalia√ß√µes</div>
            </button>
            <button class="card edu-contest" data-action="render" data-target="education.contest">
              <div class="icon">üèÜ</div>
              <div>Concursos</div>
            </button>
            <button class="card edu-agenda" data-action="render" data-target="education.agenda">
              <div class="icon">üìÖ</div>
              <div>Agenda Escolar</div>
            </button>
            <button class="card edu-task" data-action="render" data-target="education.tasks">
              <div class="icon">‚úÖ</div>
              <div>Tarefas de Casa</div>
            </button>
            <button class="card edu-sim" data-action="render" data-target="education.simulations">
              <div class="icon">‚è±Ô∏è</div>
              <div>Simulados</div>
            </button>
          </div>
        `);
      },

      health() {
        setHeaderTitle(SCREENS._meta.health.title);
        renderStage(`
          <div class="grid">
            <button class="card health-record" data-action="render" data-target="health.records">
              <div class="icon">üìã</div>
              <div>Hist√≥rico M√©dico</div>
            </button>
            <button class="card health-appointment" data-action="render" data-target="health.appointments">
              <div class="icon">ü©∫</div>
              <div>Consultas</div>
            </button>
            <button class="card health-meds" data-action="render" data-target="health.meds">
              <div class="icon">üíä</div>
              <div>Medicamentos</div>
            </button>
            <button class="card health-vaccine" data-action="render" data-target="health.vaccines">
              <div class="icon">üíâ</div>
              <div>Vacinas</div>
            </button>
            <button class="card health-exam" data-action="render" data-target="health.exams">
              <div class="icon">üß™</div>
              <div>Exames</div>
            </button>
            <button class="card health-reminder" data-action="render" data-target="health.reminders">
              <div class="icon">‚è∞</div>
              <div>Lembretes</div>
            </button>
          </div>
        `);
      },

      alerts() {
        setHeaderTitle(SCREENS._meta.alerts.title);
        renderStage('<div class="loading">Nenhum alerta no momento.</div>');
      },

      settings() {
        setHeaderTitle(SCREENS._meta.settings.title);
        renderStage(`
          <div class="grid">
            <button class="card" data-action="render" data-target="data.user.profile">
              <div class="icon">üë§</div>
              <div>Perfil do Usu√°rio</div>
            </button>
          </div>
        `);
      },

      offline() {
        setHeaderTitle(SCREENS._meta.offline.title);
        renderStage('<div class="error">Voc√™ est√° offline.</div>');
      },

      error() {
        setHeaderTitle(SCREENS._meta.error.title);
        renderStage('<div class="error">Ocorreu um erro inesperado.</div>');
      }
    };

    /* ========================== ERRO PREVISTO (Educa√ß√£o) ========================== */
    function renderEducationPlanned() {
      setHeaderTitle('Educa√ß√£o');
      renderStage(`
        <div class="welcome">
          <div class="welcome-box">
            <div class="icon" style="font-size:40px; margin-bottom:12px;">üöß</div>
            <h1>Em implanta√ß√£o</h1>
            <p>Este recurso educacional est√° previsto no sistema e ser√° disponibilizado em breve.</p>
            <button id="btn-back-education">Voltar ao painel Educa√ß√£o</button>
          </div>
        </div>
      `);

      const backBtn = document.getElementById('btn-back-education');
      if (backBtn) backBtn.onclick = () => navigate('education');
    }

    /* ========================== NAVEGA√á√ÉO (v1) ========================== */
    function navigate(screen, opts = { pushHistory: true }) {
      // Hist√≥rico
      if (opts.pushHistory !== false) {
        if (CURRENT_SCREEN && screen !== CURRENT_SCREEN) {
          HISTORY.push(CURRENT_SCREEN);
        }
      }

      // Tela nativa
      if (typeof SCREENS[screen] === 'function') {
        CURRENT_SCREEN = screen;
        SCREENS[screen]();
        updateBackVisibility();
        return;
      }

      // Erro previsto: Educa√ß√£o (apenas education.*)
      if (typeof screen === 'string' && screen.startsWith('education.')) {
        CURRENT_SCREEN = 'education';
        renderEducationPlanned();
        updateBackVisibility();
        return;
      }

      // Tela data.*
      if (typeof screen === 'string' && ScreenFactory(screen)) {
        CURRENT_SCREEN = screen;
        updateBackVisibility();
        return;
      }

      // Qualquer outra coisa vira c√©lula (expressar)
      CURRENT_SCREEN = screen;
      Narrador.emitir({ tipo: 'celula.expressar', nome: screen });
      updateBackVisibility();
    }

    /* ========================== CLIQUES (renderizador) ========================== */
    if (STAGE) {
      STAGE.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-action="render"]');
        if (!btn) return;

        const target = btn.dataset.target;
        if (!target) return;

        // 1) Tela nativa
        if (typeof SCREENS[target] === 'function') {
          navigate(target);
          return;
        }

        // 2) Tela gerada pelo Genoma
        if (ScreenFactory(target)) {
          CURRENT_SCREEN = target;
          updateBackVisibility();
          return;
        }

        // 3) Erro previsto (Educa√ß√£o)
        if (target.startsWith('education.')) {
          navigate(target);
          return;
        }

        // 4) C√©lula
        CURRENT_SCREEN = target;
        Narrador.emitir({ tipo: 'celula.expressar', nome: target });
        updateBackVisibility();
      });
    }

    // Header
    if (BTN_BACK) BTN_BACK.addEventListener('click', goBack);
    if (BTN_USER) BTN_USER.addEventListener('click', () => navigate('data.user.profile'));

    // Footer reservado
    if (FOOTER) {
      FOOTER.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const screen = btn.dataset.screen;
        const celula = btn.dataset.celula;

        if (screen) navigate(screen);
        if (celula) Narrador.emitir({ tipo: 'celula.expressar', nome: celula });
      });
    }

    /* ========================== TESTES (SMOKE) ========================== */
    function runTests() {
      console.group('Genoma v2 ‚Äì Tests');

      console.assert(typeof window.Narrador?.emitir === 'function', 'Narrador.emitir deve existir');
      console.assert(typeof window.PWAO_RegistrarCelula === 'function', 'PWAO_RegistrarCelula deve existir');
      console.assert(typeof SCREENS.welcome === 'function', 'Tela welcome deve existir');
      console.assert(typeof SCREENS.dashboard === 'function', 'Tela dashboard deve existir');
      console.assert(typeof SCREENS.finance === 'function', 'Tela finance deve existir');
      console.assert(typeof SCREENS.education === 'function', 'Tela education deve existir');
      console.assert(typeof SCREENS.health === 'function', 'Tela health deve existir');
      console.assert(HEADER_TITLE && HEADER_TITLE.textContent.length >= 0, 'Header title deve existir');

      setHeaderTitle('Teste');
      console.assert(HEADER_TITLE.textContent === 'Teste', 'setHeaderTitle deve atualizar o header');
      setHeaderTitle('PWAO');

      console.assert(ScreenFactory('data.finance.income.single') === true, 'ScreenFactory deve reconhecer data.*');
      console.assert(ScreenFactory('finance.income.single') === false, 'ScreenFactory n√£o deve reconhecer sem prefixo');

      // Teste: erro previsto educa√ß√£o
      navigate('education.study');
      console.assert((HEADER_TITLE.textContent || '').includes('Educa√ß√£o'), 'Fallback educa√ß√£o deve manter t√≠tulo Educa√ß√£o');

      console.log('OK: smoke tests');
      console.groupEnd();

      // Volta para um estado previs√≠vel ap√≥s os testes
      navigate('welcome', { pushHistory: false });
      HISTORY.length = 0;
      updateBackVisibility();
    }

    /* ========================== BOOT ========================== */
    (async function bootstrap() {
      renderStage('<div class="loading">Inicializando‚Ä¶</div>');

      await Memory.open();

      // Registro m√≠nimo de c√©lulas essenciais do sistema
      // C√©lulas ‚Äì Sa√∫de da Fam√≠lia (arquivos podem ser implantados depois)
      await window.PWAO_RegistrarCelula({
        nome: 'health.records',
        caminho: './products/health/records/index.html',
        descricao: 'Hist√≥rico m√©dico da fam√≠lia'
      });

      await window.PWAO_RegistrarCelula({
        nome: 'health.meds',
        caminho: './products/health/meds/index.html',
        descricao: 'Controle de medicamentos'
      });

      await window.PWAO_RegistrarCelula({
        nome: 'health.appointments',
        caminho: './products/health/appointments/index.html',
        descricao: 'Consultas m√©dicas'
      });

      await window.PWAO_RegistrarCelula({
        nome: 'health.vaccines',
        caminho: './products/health/vaccines/index.html',
        descricao: 'Carteira de vacina√ß√£o'
      });

      await window.PWAO_RegistrarCelula({
        nome: 'health.exams',
        caminho: './products/health/exams/index.html',
        descricao: 'Exames e laudos'
      });

      await window.PWAO_RegistrarCelula({
        nome: 'health.reminders',
        caminho: './products/health/reminders/index.html',
        descricao: 'Lembretes de sa√∫de'
      });

      runTests();
    })();

  })();
  </script>

</body>
</html>
