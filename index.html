<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWAO ‚Äì Genoma V3 FIX2</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js">// üß¨ Gene Admin ‚Äì registro e carregamento do painel externo
  Admin: {
    criar: async (dados) => {
      await Genoma.DB.salvar("admins", dados);
      window.__perfilAdminExistente = true;
      Narrador.emitir({ tipo: "admin.registrado", dados });
    }
  },

  </script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
  //------------------------------------------------------
  // üå± GENOMA DO PWAO ‚Äì V3 (Corrigido: ordem de scripts)
  //------------------------------------------------------
  const Genoma = {

    // Loader passa a executar <script> da c√©lula externa
    Loader: {
      async carregarHTML(url) {
        const texto = await fetch(url).then(r => r.text());
        Renderer.renderHTMLcomScripts(texto);
      }
    },

    Auth: {
      registrar: async (dados) => {
        await Genoma.DB.salvar("users", dados);
        Narrador.emitir({ tipo: "auth.registrado", dados });
      }
    },

    DB: {
      _db: null,
      abrir: () => {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open("GenomaDB", 1);
          req.onupgradeneeded = (ev) => {
          const db = ev.target.result;
          if (!db.objectStoreNames.contains("users")) db.createObjectStore("users", { keyPath: "id" });
          if (!db.objectStoreNames.contains("admins")) db.createObjectStore("admins", { keyPath: "id" });
        }("users", { keyPath: "id" });
            }
          };
          req.onsuccess = () => { Genoma.DB._db = req.result; resolve(req.result); };
          req.onerror = () => reject(req.error);
        });
      },
      salvar: async (store, obj) => {
        const db = Genoma.DB._db || await Genoma.DB.abrir();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(store, "readwrite");
          const st = tx.objectStore(store);
          const req = st.put(obj);
          req.onsuccess = () => resolve(obj);
          req.onerror = () => reject(req.error);
        });
      }
    },

    Scenes: {
    criarPerfil: () => (
      <div className="p-6 text-center">
        <h1 className="text-2xl font-bold mb-4">Criar Primeiro Perfil</h1>
        <p className="opacity-70 mb-4">Escolha qual perfil deseja criar agora.</p>

        <div className="flex flex-col gap-3 max-w-sm mx-auto">
          {(!window.__perfilAdminExistente) && (
            <button className="bg-red-700 text-white py-2 rounded" onClick={() => Narrador.emitir({ tipo: "perfil.criar", perfil: "admin" })}>
              Administrador do PWAO
            </button>
          )}

          <button className="bg-blue-600 text-white py-2 rounded" onClick={() => Narrador.emitir({ tipo: "perfil.criar", perfil: "aluno" })}>Aluno</button>
          <button className="bg-green-600 text-white py-2 rounded" onClick={() => Narrador.emitir({ tipo: "perfil.criar", perfil: "responsavel" })}>Respons√°vel</button>
          <button className="bg-purple-600 text-white py-2 rounded" onClick={() => Narrador.emitir({ tipo: "perfil.criar", perfil: "tutor" })}>Tutor</button>
          <button className="bg-orange-600 text-white py-2 rounded" onClick={() => Narrador.emitir({ tipo: "perfil.criar", perfil: "instituicao" })}>Institui√ß√£o</button>
        </div>
      </div>
    ),
      dashboard: () => (
        <div className="p-6 text-center">
          <h1 className="text-2xl font-bold mb-4">PWAO ‚Äì Dashboard</h1>
          <button
            className="bg-blue-600 text-white px-4 py-2 rounded"
            onClick={() => Narrador.emitir({ tipo: "auth.cadastro" })}
          >
            Criar Conta
          </button>
        </div>
      ),

      sucesso: () => (
        <div className="p-6 text-center text-green-700 font-bold">
          Cadastro conclu√≠do!
        </div>
      )
    }
  };

  //------------------------------------------------------
  // üß† NARRADOR ‚Äì Consci√™ncia
  //------------------------------------------------------
  const Narrador = {
    cenaAtual: "dashboard",
    emitir(evento) {
      this._interpretar(evento);
    },
    _interpretar(evento) {
      switch (evento.tipo) {
        case "auth.cadastro":
          Genoma.Loader.carregarHTML(
            "https://raw.githubusercontent.com/fabiocolletto/miniapp/main/products/sistema/auth/index.html"
          );
          break;

        case "auth.registrar":
          Genoma.Auth.registrar(evento.dados);
          break;

        case "auth.registrado":
          this.cenaAtual = "criarPerfil";
          Renderer.atualizar();
          break;

        case "perfil.criar":
          if (evento.perfil === "admin") {
            Genoma.Admin.criar({ id: "admin-"+Date.now(), criadoEm: Date.now() });
          }
          break;

        case "admin.registrado":
          Genoma.Loader.carregarHTML(
            "https://raw.githubusercontent.com/fabiocolletto/miniapp/main/products/sistema/admin/painel.html"
          );
          break;
      }
        case "auth.registrar":
          Genoma.Auth.registrar(evento.dados);
          break;
        case "auth.registrado":
        this.cenaAtual = "criarPerfil";
        Renderer.atualizar();
        break;
      }
    }
  };

  //------------------------------------------------------
  // üé® RENDERER ‚Äì Agora executa scripts externos na ordem certa
  //------------------------------------------------------
  const Renderer = {
    atualizar: () => {
      if (!window.__rootInstance) return;
      window.__rootInstance.render(Genoma.Scenes[Narrador.cenaAtual]());
    },

    renderHTMLcomScripts: (htmlString) => {
      // 1) Monta container tempor√°rio para separar HTML e scripts
      const container = document.createElement("div");
      container.innerHTML = htmlString;

      const scripts = [];
      container.querySelectorAll("script").forEach(oldScript => {
        scripts.push({
          src: oldScript.src || null,
          content: oldScript.src ? null : oldScript.textContent
        });
        oldScript.remove();
      });

      // 2) Renderiza o HTML (sem scripts) dentro da raiz React
      if (!window.__rootInstance) return;
      window.__rootInstance.render(
        <div dangerouslySetInnerHTML={{ __html: container.innerHTML }} />
      );

      // 3) Depois que o React montar o DOM, injeta e executa os scripts
      setTimeout(() => {
        scripts.forEach(info => {
          const script = document.createElement("script");
          if (info.src) {
            script.src = info.src;
          } else if (info.content) {
            script.textContent = info.content;
          }
          document.body.appendChild(script);
        });
      }, 0);
    }
  };

  //------------------------------------------------------
  // üöÄ IN√çCIO DO SISTEMA
  //------------------------------------------------------
  const rootElement = document.getElementById("root");
  if (!rootElement) {
    console.error("Elemento #root n√£o encontrado no DOM.");
  } else {
    window.__rootInstance = ReactDOM.createRoot(rootElement);
    Renderer.atualizar();
  }

  // Exp√µe Narrador para miniapps externos
  window.Narrador = Narrador;

  </script>
</body>
</html>
