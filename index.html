<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PWAO – UI Render Engine</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
  </style>
</head>
<body class="bg-white text-slate-800 min-h-screen">

<div id="app-root"></div>

<script>

/* ==========================================================
   UI RENDER ENGINE – CORE (ESTÁVEL)
   ========================================================== */

let CURRENT_CONTRACT = null;
const HISTORY_STACK = [];

const VIEW_REGISTRY = {};

function renderEngine(input, isBack = false) {
  const contract = resolveContract(input);
  validateContract(contract);

  if (CURRENT_CONTRACT && !isBack) {
    HISTORY_STACK.push(CURRENT_CONTRACT.identity.viewId);
    runLifecycle('onExit', CURRENT_CONTRACT);
  }

  const prepared = prepareState(contract);
  const renderer = selectRenderer(contract.classification);
  const rawHTML = renderer.render(prepared);
  const finalHTML = applyLayout(rawHTML, contract.layout, contract.behavior, contract);

  mount(finalHTML);
  attachBehavior();
  runLifecycle('onEnter', contract);

  CURRENT_CONTRACT = contract;
}

/* ==========================================================
   LIFECYCLE (NO-OP SE NÃO DEFINIDO)
   ========================================================== */

function runLifecycle(hookName, contract) {
  try {
    const lifecycle = contract?.behavior?.lifecycle;
    if (!lifecycle) return;
    const handler = lifecycle[hookName];
    if (typeof handler === 'function') handler({ hook: hookName, contract });
  } catch (err) {
    console.warn('Lifecycle error', err);
  }
}

/* ==========================================================
   RESOLVE & VALIDATE
   ========================================================== */

function resolveContract(input) {
  if (typeof input === 'string') {
    const contract = VIEW_REGISTRY[input];
    if (!contract) throw new Error(`View '${input}' não registrada`);
    return contract;
  }
  return input;
}

function validateContract(contract) {
  if (!contract?.identity?.viewId) throw new Error('Contrato sem identity.viewId');
  if (!contract?.classification?.category) throw new Error('Contrato sem classification.category');

  const nav = contract.payload?.navigation || [];
  nav.forEach(key => {
    if (!VIEW_REGISTRY[key]) {
      throw new Error(`Destino '${key}' não registrado (referenciado por ${contract.identity.viewId})`);
    }
  });
}

/* ==========================================================
   PREPARE STATE
   ========================================================== */

function prepareState(contract) {
  return {
    title: contract.identity.title,
    navigation: contract.payload?.navigation || [],
    contract
  };
}

/* ==========================================================
   RENDERER SELECTOR
   ========================================================== */

function selectRenderer(classification) {
  switch (classification.category) {
    case 'navigator': return NavigatorRenderer;
    default: throw new Error('Renderer não encontrado');
  }
}

/* ==========================================================
   RENDERER – NAVIGATOR (FLAT)
   ========================================================== */

const NavigatorRenderer = {
  render(state) {
    if (!state.navigation.length) {
      return `<p class="text-center text-slate-400">Nenhuma opção disponível.</p>`;
    }

    const buttons = state.navigation.map((key) => {
      const target = VIEW_REGISTRY[key];
      const tone = target?.ui?.tone || 'neutral';
      const toneClass = UI_TONES[tone] || UI_TONES.neutral;

      return `
        <button data-view="${key}" class="${toneClass} p-6 flex flex-col items-center justify-center">
          <span class="material-symbols-outlined text-4xl">${target.identity.icon}</span>
          <span class="mt-2 font-medium text-center">${target.identity.title}</span>
        </button>
      `;
    }).join('');

    return `<div class="grid grid-cols-2 gap-3">${buttons}</div>`;
  }
};

/* ==========================================================
   TONS SEMÂNTICOS (FLAT)
   ========================================================== */

const UI_TONES = {
  finance: 'bg-indigo-50 text-indigo-700',
  expense: 'bg-red-50 text-red-700',
  income: 'bg-emerald-50 text-emerald-700',
  report: 'bg-blue-50 text-blue-700',
  education: 'bg-amber-50 text-amber-700',
  study: 'bg-yellow-50 text-yellow-700',
  exam: 'bg-orange-50 text-orange-700',
  progress: 'bg-lime-50 text-lime-700',
  agenda: 'bg-cyan-50 text-cyan-700',
  health: 'bg-teal-50 text-teal-700',
  consult: 'bg-sky-50 text-sky-700',
  exam_health: 'bg-purple-50 text-purple-700',
  meds: 'bg-rose-50 text-rose-700',
  settings: 'bg-slate-100 text-slate-700',
  neutral: 'bg-white text-slate-700'
};

/* ==========================================================
   LAYOUT (FLAT)
   ========================================================== */

function applyLayout(html, layout, behavior, contract) {
  const isWelcome = contract.identity.viewId === 'welcome';

  if (isWelcome) {
    return `
      <div class="min-h-screen flex items-center justify-center p-6 bg-white">
        <div class="max-w-sm w-full text-center">
          <span class="material-symbols-outlined text-6xl text-indigo-600 mb-6">rocket_launch</span>
          <h1 class="text-3xl font-semibold text-slate-800 mb-2">Bem-vindo</h1>
          <p class="text-slate-500 mb-8">Seu painel inteligente começa aqui</p>
          <button data-view="dashboard" class="w-full border border-indigo-600 text-indigo-600 font-semibold py-4">Entrar</button>
        </div>
      </div>
    `;
  }

  const titleHTML = layout?.title?.visible
    ? `<h2 class="text-xl font-semibold text-center mb-6">${layout.title.text}</h2>`
    : '';

  const backButtonHTML = behavior?.back?.enabled
    ? `<button id="floating-back" class="fixed top-4 left-4 border border-slate-300 w-10 h-10 flex items-center justify-center">
         <span class="material-symbols-outlined">arrow_back</span>
       </button>`
    : '';

  return `
    ${backButtonHTML}
    <div class="min-h-screen p-6 max-w-xl mx-auto">
      ${titleHTML}
      ${html}
    </div>
  `;
}

/* ==========================================================
   MOUNT & EVENTS
   ========================================================== */

function mount(html) {
  document.getElementById('app-root').innerHTML = html;
}

function attachBehavior() {
  document.querySelectorAll('[data-view]').forEach((btn) => {
    btn.onclick = () => renderEngine(btn.dataset.view);
  });

  const backBtn = document.getElementById('floating-back');
  if (backBtn) backBtn.onclick = () => renderEngine(HISTORY_STACK.pop(), true);
}

/* ==========================================================
   VIEW CONTRACTS
   ========================================================== */

VIEW_REGISTRY.welcome = {
  identity: { viewId: 'welcome', title: 'Bem-vindo', icon: 'home' },
  classification: { category: 'navigator' },
  payload: { navigation: ['dashboard'] }
};

VIEW_REGISTRY.dashboard = {
  identity: { viewId: 'dashboard', title: 'Dashboard', icon: 'dashboard' },
  classification: { category: 'navigator' },
  payload: { navigation: ['finance', 'education', 'health', 'settings'] },
  layout: { title: { visible: true, text: 'Dashboard' } },
  behavior: { back: { enabled: true } }
};

/* ===================== FINANÇAS ===================== */

VIEW_REGISTRY.finance = {
  ui: { tone: 'finance' },
  identity: { viewId: 'finance', title: 'Finanças', icon: 'attach_money' },
  classification: { category: 'navigator' },
  payload: {
    navigation: [
      'finance_expense_single',
      'finance_expense_recurring',
      'finance_income_single',
      'finance_income_recurring',
      'finance_report_analytic',
      'finance_report_summary'
    ]
  },
  layout: { title: { visible: true, text: 'Finanças' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.finance_expense_single = {
  ui: { tone: 'expense' },
  identity: { viewId: 'finance_expense_single', title: 'Despesa Avulsa', icon: 'remove_circle' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Despesa Avulsa' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.finance_expense_recurring = {
  ui: { tone: 'expense' },
  identity: { viewId: 'finance_expense_recurring', title: 'Despesa Recorrente', icon: 'autorenew' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Despesa Recorrente' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.finance_income_single = {
  ui: { tone: 'income' },
  identity: { viewId: 'finance_income_single', title: 'Receita Avulsa', icon: 'add_circle' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Receita Avulsa' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.finance_income_recurring = {
  ui: { tone: 'income' },
  identity: { viewId: 'finance_income_recurring', title: 'Receita Recorrente', icon: 'cached' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Receita Recorrente' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.finance_report_analytic = {
  ui: { tone: 'report' },
  identity: { viewId: 'finance_report_analytic', title: 'Relatório Analítico', icon: 'analytics' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Relatório Analítico' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.finance_report_summary = {
  ui: { tone: 'report' },
  identity: { viewId: 'finance_report_summary', title: 'Relatório Sintético', icon: 'summarize' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Relatório Sintético' } },
  behavior: { back: { enabled: true } }
};

/* ===================== EDUCAÇÃO / SAÚDE / CONFIG ===================== */

VIEW_REGISTRY.education = {
  ui: { tone: 'education' },
  identity: { viewId: 'education', title: 'Educação', icon: 'school' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Educação' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.health = {
  ui: { tone: 'health' },
  identity: { viewId: 'health', title: 'Saúde', icon: 'local_hospital' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Saúde' } },
  behavior: { back: { enabled: true } }
};

VIEW_REGISTRY.settings = {
  ui: { tone: 'settings' },
  identity: { viewId: 'settings', title: 'Configurações', icon: 'settings' },
  classification: { category: 'navigator' },
  payload: { navigation: [] },
  layout: { title: { visible: true, text: 'Configurações' } },
  behavior: { back: { enabled: true } }
};

renderEngine('welcome');

</script>
</body>
</html>
