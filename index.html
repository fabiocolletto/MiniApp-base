<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PWAO ‚Äì Genoma V4.3</title>
  <link rel="manifest" href="./opp/manifest.webmanifest" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #fafafa; }
    #root { padding: 20px; }
  </style>
</head>
<body>
  <div id="root">Carregando organismo‚Ä¶</div>

<script>
// =============================================================
// GENOMA V4.3 ‚Äì Autodiscovery Aperfei√ßoado + Caminhos Org√¢nicos
// =============================================================
// Esta vers√£o corrige completamente problemas de caminho ao
// carregar c√©lulas em reposit√≥rios hospedados (GitHub Pages).
// Agora o Genoma sempre resolve rotas relativas com "./".
// =============================================================

// -------------------------------------------------------------
// 1. Mem√≥ria Org√¢nica
// -------------------------------------------------------------
const Memoria = {
  db: null,
  async init() {
    return new Promise((resolve) => {
      const req = indexedDB.open("pwao_memoria", 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("settings")) db.createObjectStore("settings");
        if (!db.objectStoreNames.contains("cells")) db.createObjectStore("cells", { keyPath: "nome" });
      };
      req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
    });
  },
  async registrarCelula(celula) {
    return new Promise((resolve) => {
      const tx = this.db.transaction(["cells"], "readwrite");
      tx.objectStore("cells").put(celula);
      tx.oncomplete = resolve;
    });
  },
  async listarCelulas() {
    return new Promise((resolve) => {
      const tx = this.db.transaction(["cells"], "readonly");
      const req = tx.objectStore("cells").getAll();
      req.onsuccess = () => resolve(req.result || []);
    });
  }
};

// -------------------------------------------------------------
// 2. Narrador ‚Äì Sistema de Eventos
// -------------------------------------------------------------
const Narrador = {
  ouvintes: [],
  emitir(evento) { this.ouvintes.forEach((fn) => fn(evento)); },
  ouvir(fn) { this.ouvintes.push(fn); }
};

// -------------------------------------------------------------
// 3. Loader ‚Äì Agora com Caminho Org√¢nico Corrigido
// -------------------------------------------------------------
const Loader = {
  mapa: {},

  resolverCaminho(caminho) {
    // Sempre garantir que o caminho comece com "./"
    if (caminho.startsWith("./")) return caminho;
    if (caminho.startsWith("/")) return `.${caminho}`; // corrige caminhos absolutos
    return `./${caminho}`; // corrige caminhos sem ponto
  },

  async registrar(celula) {
    const caminhoCorrigido = this.resolverCaminho(celula.caminho);
    this.mapa[celula.nome] = caminhoCorrigido;
    await Memoria.registrarCelula({ ...celula, caminho: caminhoCorrigido });
  },

  async expressar(nome) {
    const caminho = this.mapa[nome];
    if (!caminho) {
      Renderer.expressar(`<p style='color:red'>‚ùå C√©lula n√£o encontrada: ${nome}</p>`);
      return;
    }
    Renderer.montarCelula(caminho);
  },

  async autodiscovery() {
    const celulas = await Memoria.listarCelulas();
    celulas.forEach(c => {
      this.mapa[c.nome] = this.resolverCaminho(c.caminho);
    });
  }
};

// -------------------------------------------------------------
// Cat√°logo Org√¢nico: sementes m√≠nimas
// -------------------------------------------------------------
// Para evitar bot√µes quebrados em ambientes onde nenhuma c√©lula
// foi registrada previamente, definimos um conjunto m√≠nimo de
// c√©lulas nativas. Elas s√£o registradas apenas se ainda n√£o
// estiverem na Mem√≥ria Org√¢nica.
const CelulasNativas = [
  {
    nome: "educacao.quiz",
    caminho: "celulas/educacao/quiz/index.html",
    orgao: "educacao",
    versao: "1.0.0",
    descricao: "C√©lula de Quiz Educacional (√≥rg√£o: orgao-quiz.js)"
  },
  {
    nome: "sistema.auth",
    caminho: "celulas/sistema/auth/index.html",
    orgao: "sistema",
    versao: "1.0.0",
    descricao: "C√©lula de Autentica√ß√£o do sistema"
  },
  {
    nome: "sistema.admin",
    caminho: "celulas/sistema/admin/index.html",
    orgao: "sistema",
    versao: "1.0.0",
    descricao: "Painel administrativo do sistema"
  }
];

// -------------------------------------------------------------
// Registro Global para C√©lulas
// -------------------------------------------------------------
window.PWAO_RegistrarCelula = async function (manifesto) {
  await Loader.registrar(manifesto);
  console.log("üîó C√©lula registrada:", manifesto.nome);
};

// -------------------------------------------------------------
// 4. Renderer ‚Äì Express√£o Visual
// -------------------------------------------------------------
const Renderer = {
  async expressar(html) {
    document.getElementById("root").innerHTML = html;
  },
  async montarCelula(caminho) {
    try {
      const resp = await fetch(caminho);
      const html = await resp.text();

      // Parsear o HTML para preservar scripts e execut√°-los corretamente
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const conteudo = doc.body.innerHTML;

      // Monta o conte√∫do visual da c√©lula
      this.expressar(conteudo);

      // Executa scripts presentes na c√©lula (incluindo modules)
      const scripts = doc.querySelectorAll("script");
      scripts.forEach((oldScript) => {
        const novoScript = document.createElement("script");
        // Copia atributos relevantes (ex.: type="module", src, async)
        Array.from(oldScript.attributes).forEach((attr) => {
          novoScript.setAttribute(attr.name, attr.value);
        });
        if (!oldScript.src) {
          novoScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(novoScript);
      });
    } catch (e) {
      this.expressar(`<p style='color:red'>Erro ao carregar c√©lula: ${caminho}</p>`);
    }
  }
};

// -------------------------------------------------------------
// 5. Registrar Service Worker do OPP
// -------------------------------------------------------------
if ("serviceWorker" in navigator) {
  const ambienteSeguro = location.protocol === "https:" || location.hostname === "localhost";
  if (ambienteSeguro) {
    navigator.serviceWorker.register("./opp/service-worker.js")
      .then(() => console.log("üß¨ OPP Service Worker registrado"))
      .catch(err => console.warn("Falha ao registrar SW:", err));
  } else {
    console.log("SW n√£o registrado: ambiente inseguro");
  }
}

// -------------------------------------------------------------
// 6. Ciclo de Vida do Organismo
// -------------------------------------------------------------
async function iniciarOrganismo() {
  await Memoria.init();
  await Loader.autodiscovery();

  // Registrar c√©lulas nativas caso ainda n√£o estejam dispon√≠veis
  for (const celula of CelulasNativas) {
    if (!Loader.mapa[celula.nome]) {
      await Loader.registrar(celula);
    }
  }

  Narrador.ouvir((evento) => {
    if (evento.tipo === "celula.expressar") Loader.expressar(evento.nome);
  });

  Renderer.expressar(`
    <h1>PWAO ‚Äì Genoma V4.3</h1>
    <p>Organismo iniciado com autodiscovery aprimorado.</p>
    <button onclick="Narrador.emitir({tipo: 'celula.expressar', nome: 'educacao.quiz'})">Abrir Quiz</button>
    <button onclick="Narrador.emitir({tipo: 'celula.expressar', nome: 'sistema.auth'})">Abrir Auth</button>
    <button onclick="Narrador.emitir({tipo: 'celula.expressar', nome: 'sistema.admin'})">Abrir Admin</button>
  `);
}

iniciarOrganismo();
</script>
</body>
</html>
