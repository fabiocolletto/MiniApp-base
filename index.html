<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniApp - Shell React</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <link rel="stylesheet" href="./docs/miniapp-global.css">
    <link rel="stylesheet" href="./docs/miniapp-card.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
    <script src="./docs/components/app-shared-header.js"></script>
    <script src="./docs/components/app-shared-footer.js"></script>
    <link rel="manifest" href="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/pwa/manifest.webmanifest">
    <meta name="theme-color" content="#f3f4f6">
    <style>
        app-shared-footer .icon-button:hover,
        app-shared-footer .icon-button:focus-visible {
            background-color: transparent !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="body-with-fixed-footer" style="margin: 0; padding: 0; width: 100%; height: 100%; overflow-x: hidden;">
    <div id="root"></div>
    <script>
        const h = React.createElement;
        const { useCallback, useEffect, useMemo, useState } = React;
        const { ThemeProvider, createTheme, CssBaseline, Box, Container, Paper, Stack, Typography } = MaterialUI;
        const HeaderComponent = window.AppSharedHeader;
        const FooterComponent = window.AppSharedFooter;

        if (!HeaderComponent || !FooterComponent) {
            throw new Error('Componentes compartilhados não foram carregados para o shell React.');
        }

        const SUPPORTED_LANGUAGES = ['pt-BR', 'en-US', 'es-ES'];
        const DEFAULT_GLOBAL_PREFERENCES = Object.freeze({ theme: 'light', language: 'pt-BR' });
        const GLOBAL_PREFERENCES_STORAGE_KEY = 'miniapp:settings:global-preferences';
        const GLOBAL_PREFERENCES_MESSAGE_TYPE = 'miniapp:global-preferences';
        const PREFERRED_COLOR_SCHEME_QUERY = '(prefers-color-scheme: dark)';
        const LANGUAGE_COPY = Object.freeze({
            'pt-BR': Object.freeze({
                header: Object.freeze({
                    searchLabel: 'Pesquisar MiniApps',
                    installLabel: 'Instalar'
                }),
                footer: Object.freeze({
                    nav: Object.freeze({
                        catalog: 'Catálogo',
                        favorites: 'Favoritos',
                        recents: 'Recentes',
                        settings: 'Configurações'
                    }),
                    meta: Object.freeze({
                        heading: 'Explorar MiniApps',
                        collapsedLabel: 'Navegação rápida',
                        collapse: 'Recolher',
                        expand: 'Expandir o rodapé'
                    })
                })
            }),
            'en-US': Object.freeze({
                header: Object.freeze({
                    searchLabel: 'Search MiniApps',
                    installLabel: 'Install'
                }),
                footer: Object.freeze({
                    nav: Object.freeze({
                        catalog: 'Catalog',
                        favorites: 'Favorites',
                        recents: 'Recents',
                        settings: 'Settings'
                    }),
                    meta: Object.freeze({
                        heading: 'Explore MiniApps',
                        collapsedLabel: 'Quick navigation',
                        collapse: 'Collapse',
                        expand: 'Expand footer'
                    })
                })
            }),
            'es-ES': Object.freeze({
                header: Object.freeze({
                    searchLabel: 'Buscar MiniApps',
                    installLabel: 'Instalar'
                }),
                footer: Object.freeze({
                    nav: Object.freeze({
                        catalog: 'Catálogo',
                        favorites: 'Favoritos',
                        recents: 'Recientes',
                        settings: 'Configuraciones'
                    }),
                    meta: Object.freeze({
                        heading: 'Explorar MiniApps',
                        collapsedLabel: 'Navegación rápida',
                        collapse: 'Replegar',
                        expand: 'Expandir el pie'
                    })
                })
            })
        });

        const NAV_STAGE_DEFINITIONS = {
            catalog: {
                key: 'catalog',
                icon: 'grid_view',
                titles: {
                    'pt-BR': 'MiniApp de Catálogo',
                    'en-US': 'Catalog MiniApp',
                    'es-ES': 'MiniApp de Catálogo'
                },
                descriptions: {
                    'pt-BR': 'Lista oficial de miniapps em preparo.',
                    'en-US': 'Official list of MiniApps in preparation.',
                    'es-ES': 'Lista oficial de MiniApps en preparación.'
                },
                sourceId: 'catalog',
                isCore: true,
                launchUrl: './miniapps/catalog/index.html'
            },
            favorites: {
                key: 'favorites',
                icon: 'star',
                titles: {
                    'pt-BR': 'MiniApp de Favoritos',
                    'en-US': 'Favorites MiniApp',
                    'es-ES': 'MiniApp de Favoritos'
                },
                descriptions: {
                    'pt-BR': 'Painel para organizar atalhos favoritos.',
                    'en-US': 'Dashboard to organize favorite shortcuts.',
                    'es-ES': 'Panel para organizar accesos favoritos.'
                },
                sourceId: 'favorites',
                isCore: true,
                launchUrl: './miniapps/favorites/index.html'
            },
            recents: {
                key: 'recents',
                icon: 'history',
                titles: {
                    'pt-BR': 'MiniApp de Recentes',
                    'en-US': 'Recents MiniApp',
                    'es-ES': 'MiniApp de Recientes'
                },
                descriptions: {
                    'pt-BR': 'Histórico de miniapps acessados recentemente.',
                    'en-US': 'History of recently accessed MiniApps.',
                    'es-ES': 'Historial de MiniApps accedidos recientemente.'
                },
                sourceId: 'recents',
                isCore: true,
                launchUrl: './miniapps/recents/index.html'
            },
            settings: {
                key: 'settings',
                icon: 'settings',
                titles: {
                    'pt-BR': 'MiniApp de Configurações',
                    'en-US': 'Settings MiniApp',
                    'es-ES': 'MiniApp de Configuraciones'
                },
                descriptions: {
                    'pt-BR': 'Preferências globais do usuário.',
                    'en-US': 'Global user preferences.',
                    'es-ES': 'Preferencias globales del usuario.'
                },
                sourceId: 'settings',
                isCore: true,
                launchUrl: './miniapps/settings/index.html'
            }
        };

        function resolveStageCopy(definition, language) {
            const fallbackLanguage = 'pt-BR';
            const title = definition.titles?.[language]
                || definition.titles?.[fallbackLanguage]
                || definition.title
                || definition.key;
            const description = definition.descriptions?.[language]
                || definition.descriptions?.[fallbackLanguage]
                || definition.description
                || '';
            return { title, description };
        }

        function getLanguageCopy(language) {
            return LANGUAGE_COPY[language] || LANGUAGE_COPY['pt-BR'];
        }

        function normalizeThemePreference(theme) {
            if (theme === 'dark') {
                return 'dark';
            }
            if (theme === 'system') {
                return 'system';
            }
            return 'light';
        }

        function normalizeResolvedTheme(theme) {
            return theme === 'dark' ? 'dark' : 'light';
        }

        function resolveEffectiveTheme(themePreference, systemTheme) {
            const normalizedPreference = normalizeThemePreference(themePreference);
            if (normalizedPreference === 'system') {
                return normalizeResolvedTheme(systemTheme);
            }
            return normalizeResolvedTheme(normalizedPreference);
        }

        function getSystemTheme() {
            if (typeof window === 'undefined' || typeof window.matchMedia !== 'function') {
                return 'light';
            }
            try {
                const mediaQuery = window.matchMedia(PREFERRED_COLOR_SCHEME_QUERY);
                return mediaQuery.matches ? 'dark' : 'light';
            } catch (error) {
                console.warn('Não foi possível detectar o tema do sistema. Aplicando tema claro por padrão.', error);
                return 'light';
            }
        }

        function normalizeLanguage(language) {
            return SUPPORTED_LANGUAGES.includes(language) ? language : DEFAULT_GLOBAL_PREFERENCES.language;
        }

        function normalizePreferences(preferences) {
            if (!preferences) {
                return { ...DEFAULT_GLOBAL_PREFERENCES };
            }
            return {
                theme: normalizeThemePreference(preferences.theme),
                language: normalizeLanguage(preferences.language)
            };
        }

        function safeParsePreferences(rawValue) {
            if (!rawValue) {
                return null;
            }
            try {
                return JSON.parse(rawValue);
            } catch (error) {
                console.warn('Preferências globais inválidas foram ignoradas.', error);
                return null;
            }
        }

        function readStoredPreferences() {
            if (typeof window === 'undefined') {
                return { ...DEFAULT_GLOBAL_PREFERENCES };
            }
            try {
                const rawValue = window.localStorage?.getItem(GLOBAL_PREFERENCES_STORAGE_KEY);
                const parsed = safeParsePreferences(rawValue);
                return normalizePreferences(parsed);
            } catch (error) {
                console.warn('Não foi possível ler preferências globais do armazenamento.', error);
                return { ...DEFAULT_GLOBAL_PREFERENCES };
            }
        }

        function createAppTheme(mode) {
            const paletteMode = normalizeResolvedTheme(mode);
            const isDark = paletteMode === 'dark';
            const borderColor = isDark ? 'rgba(148, 163, 184, 0.25)' : 'rgba(15,23,42,0.08)';
            const surfaceShadow = isDark ? '0 30px 60px rgba(2, 6, 23, 0.5)' : '0 30px 60px rgba(15, 23, 42, 0.15)';
            return createTheme({
                palette: {
                    mode: paletteMode,
                    primary: { main: '#f97316' },
                    secondary: { main: '#0ea5e9' },
                    background: {
                        default: isDark ? '#020617' : '#f3f4f6',
                        paper: isDark ? '#0f172a' : '#ffffff',
                    },
                    text: {
                        primary: isDark ? '#f8fafc' : '#0f172a',
                        secondary: isDark ? '#94a3b8' : '#475569',
                    },
                },
                typography: {
                    fontFamily: '"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                    h4: { fontWeight: 600 },
                    button: { textTransform: 'none', fontWeight: 600 },
                },
                shape: {
                    borderRadius: 24,
                },
                components: {
                    MuiPaper: {
                        styleOverrides: {
                            root: {
                                borderRadius: 32,
                                border: `1px solid ${borderColor}`,
                                boxShadow: surfaceShadow,
                            },
                        },
                    },
                    MuiContainer: {
                        defaultProps: {
                            maxWidth: 'lg',
                        },
                    },
                },
            });
        }

        const IFRAME_RESIZE_MESSAGE_TYPE = 'catalog:height';
        const ALLOWED_IFRAME_ORIGINS = new Set(['null', window.location.origin]);

        const MIN_STAGE_HEIGHT = 640;

        function normalizeViewportFloor(value) {
            if (typeof value === 'number' && Number.isFinite(value) && value > 0) {
                return Math.max(Math.round(value), MIN_STAGE_HEIGHT);
            }
            return MIN_STAGE_HEIGHT;
        }

        function computeStageViewportFloor() {
            if (typeof window === 'undefined') {
                return MIN_STAGE_HEIGHT;
            }
            const viewport = window.innerHeight || document.documentElement?.clientHeight || MIN_STAGE_HEIGHT;
            const headerEl = document.querySelector('.app-header');
            const footerEl = document.querySelector('app-shared-footer');
            const headerHeight = headerEl ? headerEl.getBoundingClientRect().height : 0;
            const footerHeight = footerEl ? footerEl.getBoundingClientRect().height : 0;
            const available = viewport - headerHeight - footerHeight;
            const seventyFivePercent = Math.round(viewport * 0.75);
            return normalizeViewportFloor(Math.max(available, seventyFivePercent));
        }

        function IframeStage({ stageDefinition, preferredHeight, viewportFloor, themeMode, globalPreferences }) {
            const hasPreferredHeight = typeof preferredHeight === 'number' && preferredHeight > 0;
            const normalizedFloor = normalizeViewportFloor(viewportFloor);
            const resolvedHeight = hasPreferredHeight
                ? Math.max(Math.round(preferredHeight), normalizedFloor)
                : normalizedFloor;
            const resolvedTheme = normalizeResolvedTheme(themeMode);
            const stageShadow = resolvedTheme === 'dark'
                ? '0 30px 60px rgba(2, 6, 23, 0.65)'
                : '0 30px 60px rgba(15, 23, 42, 0.2)';
            const iframeRef = React.useRef(null);

            React.useEffect(() => {
                const iframeEl = iframeRef.current;
                if (!iframeEl || !iframeEl.contentWindow || !globalPreferences) {
                    return undefined;
                }
                try {
                    iframeEl.contentWindow.postMessage(
                        { type: GLOBAL_PREFERENCES_MESSAGE_TYPE, preferences: globalPreferences },
                        '*'
                    );
                } catch (error) {
                    console.warn('Não foi possível enviar preferências para o iframe ativo.', error);
                }
                return undefined;
            }, [globalPreferences, stageDefinition.launchUrl]);

            return h(
                Box,
                {
                    component: 'section',
                    id: `iframe-stage-${stageDefinition.key}`,
                    sx: {
                        flex: 1,
                        display: 'flex',
                        flexDirection: 'column',
                        borderRadius: 0,
                        overflow: 'hidden',
                        boxShadow: stageShadow,
                        minHeight: resolvedHeight,
                    },
                },
                h('iframe', {
                    src: stageDefinition.launchUrl,
                    title: stageDefinition.title,
                    style: {
                        width: '100%',
                        height: '100%',
                        minHeight: resolvedHeight,
                        border: 'none',
                        display: 'block',
                        flex: 1,
                    },
                    ref: iframeRef
                })
            );
        }

        function App() {
            const navDefinitions = useMemo(() => NAV_STAGE_DEFINITIONS, []);
            const resolveStageDefinition = useCallback(
                (key) => {
                    const normalizedKey = (key || '').toLowerCase();
                    if (Object.prototype.hasOwnProperty.call(navDefinitions, normalizedKey)) {
                        return navDefinitions[normalizedKey];
                    }
                    return navDefinitions.catalog;
                },
                [navDefinitions]
            );
            const [globalPreferences, setGlobalPreferences] = useState(() => readStoredPreferences());
            const [systemTheme, setSystemTheme] = useState(() => getSystemTheme());
            const [activeStageKey, setActiveStageKey] = useState(() => resolveStageDefinition('catalog').key);
            const [footerState, setFooterState] = useState('expanded');
            const [activeFrameHeight, setActiveFrameHeight] = useState(null);
            const [stageViewportFloor, setStageViewportFloor] = useState(() => computeStageViewportFloor());
            const effectiveTheme = useMemo(
                () => resolveEffectiveTheme(globalPreferences.theme, systemTheme),
                [globalPreferences.theme, systemTheme]
            );
            const appTheme = useMemo(
                () => createAppTheme(effectiveTheme),
                [effectiveTheme]
            );
            const languageCopy = useMemo(
                () => getLanguageCopy(globalPreferences.language),
                [globalPreferences.language]
            );

            const activeStageDefinition = useMemo(() => {
                const definition = resolveStageDefinition(activeStageKey);
                const copy = resolveStageCopy(definition, globalPreferences.language);
                return { ...definition, ...copy };
            }, [activeStageKey, globalPreferences.language, resolveStageDefinition]);

            const handleNavigate = useCallback(
                (key) => {
                    setActiveStageKey(resolveStageDefinition(key).key);
                },
                [resolveStageDefinition]
            );

            const handleFooterStateChange = useCallback((nextState) => {
                setFooterState(nextState);
            }, []);

            const handleIncomingPreferences = useCallback((nextValue) => {
                const normalized = normalizePreferences(nextValue);
                setGlobalPreferences((current) => {
                    if (
                        current.theme === normalized.theme &&
                        current.language === normalized.language
                    ) {
                        return current;
                    }
                    return normalized;
                });
            }, []);

            useEffect(() => {
                const html = document.documentElement;
                if (html) {
                    html.setAttribute('data-theme', effectiveTheme);
                    html.setAttribute('lang', globalPreferences.language);
                }
                const metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) {
                    metaTheme.setAttribute('content', effectiveTheme === 'dark' ? '#020617' : '#f3f4f6');
                }
            }, [effectiveTheme, globalPreferences.language]);

            useEffect(() => {
                setStageViewportFloor(computeStageViewportFloor());
            }, [footerState]);

            useEffect(() => {
                if (typeof window === 'undefined' || typeof window.matchMedia !== 'function') {
                    return undefined;
                }
                const mediaQuery = window.matchMedia(PREFERRED_COLOR_SCHEME_QUERY);
                const updateSystemTheme = (event) => {
                    const isDark = typeof event?.matches === 'boolean' ? event.matches : mediaQuery.matches;
                    setSystemTheme(isDark ? 'dark' : 'light');
                };
                updateSystemTheme(mediaQuery);
                if (typeof mediaQuery.addEventListener === 'function') {
                    mediaQuery.addEventListener('change', updateSystemTheme);
                    return () => mediaQuery.removeEventListener('change', updateSystemTheme);
                }
                mediaQuery.addListener(updateSystemTheme);
                return () => mediaQuery.removeListener(updateSystemTheme);
            }, []);

            useEffect(() => {
                if (typeof window === 'undefined') {
                    return undefined;
                }
                function handleStorage(event) {
                    if (event.key !== GLOBAL_PREFERENCES_STORAGE_KEY) {
                        return;
                    }
                    const parsed = safeParsePreferences(event.newValue);
                    handleIncomingPreferences(parsed);
                }
                window.addEventListener('storage', handleStorage);
                return () => window.removeEventListener('storage', handleStorage);
            }, [handleIncomingPreferences]);

            useEffect(() => {
                if (typeof window === 'undefined') {
                    return undefined;
                }
                function handlePreferenceEvent(event) {
                    const detail = event.detail || {};
                    handleIncomingPreferences(detail.preferences || detail);
                }
                window.addEventListener(GLOBAL_PREFERENCES_MESSAGE_TYPE, handlePreferenceEvent);
                return () => window.removeEventListener(GLOBAL_PREFERENCES_MESSAGE_TYPE, handlePreferenceEvent);
            }, [handleIncomingPreferences]);

            useEffect(() => {
                if (typeof window === 'undefined') {
                    return undefined;
                }
                function handleResize() {
                    setStageViewportFloor(computeStageViewportFloor());
                }
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                if (typeof window === 'undefined' || typeof window.ResizeObserver !== 'function') {
                    return undefined;
                }
                const observer = new window.ResizeObserver(() => {
                    setStageViewportFloor(computeStageViewportFloor());
                });
                const headerEl = document.querySelector('.app-header');
                const footerEl = document.querySelector('app-shared-footer');
                if (headerEl) {
                    observer.observe(headerEl);
                }
                if (footerEl) {
                    observer.observe(footerEl);
                }
                return () => observer.disconnect();
            }, []);

            useEffect(() => {
                if (activeStageDefinition.launchUrl) {
                    window.dispatchEvent(
                        new CustomEvent('app:notify', {
                            detail: {
                                message: `Navegando para Iframe: ${activeStageDefinition.title}`,
                                type: 'info'
                            }
                        })
                    );
                }
            }, [activeStageDefinition]);

            useEffect(() => {
                setActiveFrameHeight(null);
            }, [activeStageDefinition.key]);

            useEffect(() => {
                const normalizedSource = (activeStageDefinition.sourceId || activeStageDefinition.key || '').toLowerCase();

                function handleMessage(event) {
                    if (!ALLOWED_IFRAME_ORIGINS.has(event.origin)) {
                        return;
                    }
                    const payload = event.data;
                    if (!payload || typeof payload !== 'object') {
                        return;
                    }
                    if (payload.type === IFRAME_RESIZE_MESSAGE_TYPE) {
                        if (!normalizedSource) {
                            return;
                        }
                        const payloadSource = (payload.sourceId || '').toLowerCase();
                        if (payloadSource !== normalizedSource) {
                            return;
                        }
                        const nextHeight = Number(payload.height);
                        if (!Number.isFinite(nextHeight) || nextHeight <= 0) {
                            return;
                        }
                        const rounded = Math.ceil(nextHeight);
                        setActiveFrameHeight((current) => (current === rounded ? current : rounded));
                        return;
                    }
                    if (payload.type === GLOBAL_PREFERENCES_MESSAGE_TYPE) {
                        const nextPreferences = payload.detail?.preferences || payload.preferences;
                        handleIncomingPreferences(nextPreferences);
                    }
                }

                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [activeStageDefinition.key, activeStageDefinition.sourceId, handleIncomingPreferences]);
            const mainContent = activeStageDefinition.launchUrl
                ? h(IframeStage, {
                    stageDefinition: activeStageDefinition,
                    preferredHeight: activeFrameHeight,
                    viewportFloor: stageViewportFloor,
                    themeMode: effectiveTheme,
                    globalPreferences,
                })
                : h(
                    Paper,
                    { elevation: 0, sx: { padding: 4, marginX: 'auto', maxWidth: 720 } },
                    h(
                        Stack,
                        { direction: 'row', spacing: 3, alignItems: 'center' },
                        h('span', { className: 'material-icons-sharp', style: { fontSize: '3rem', color: '#f97316' } }, activeStageDefinition.icon || 'hub'),
                        h(
                            Stack,
                            { spacing: 1 },
                            h(Typography, { component: 'p', variant: 'overline' }, 'MiniApp'),
                            h(Typography, { component: 'h2', variant: 'h4' }, activeStageDefinition.title),
                            h(Typography, { component: 'p', color: 'text.secondary' }, activeStageDefinition.description)
                        )
                    )
                );

            return h(
                ThemeProvider,
                { theme: appTheme },
                h(CssBaseline, null),
                h(
                    'div',
                    { className: 'miniapp-shell', style: { minHeight: '100vh', display: 'flex', flexDirection: 'column' } },
                    h(HeaderComponent, {
                        title: activeStageDefinition.title,
                        icon: activeStageDefinition.icon,
                        hideSearch: false,
                        installVisible: true,
                        searchLabel: languageCopy.header.searchLabel,
                        installLabel: languageCopy.header.installLabel
                    }),
                    h(
                        Box,
                        { component: 'main', className: 'miniapp-stage', sx: { flex: 1, display: 'flex', flexDirection: 'column' } },
                        h(
                            Container,
                            {
                                disableGutters: false,
                                maxWidth: false,
                                sx: { flex: 1, display: 'flex', flexDirection: 'column', gap: 4, px: { xs: 2, md: 3 } }
                            },
                            mainContent
                        )
                    ),
                    h(FooterComponent, {
                        activeTab: activeStageKey,
                        variant: 'full',
                        state: footerState,
                        onNavigate: handleNavigate,
                        onStateChange: handleFooterStateChange,
                        showSettings: true,
                        showMeta: true,
                        copy: languageCopy.footer
                    })
                )
            );
        }

        const rootElement = document.getElementById('root');
        ReactDOM.createRoot(rootElement).render(h(App));
    </script>
</body>
</html>
