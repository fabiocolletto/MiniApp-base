<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MiniApps — Shell</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0">
  <link rel="stylesheet" href="miniapp-base/style/styles.css">
</head>
<body>
  <div class="app-shell">
    <header class="shell-header">
      <div class="shell-container">
        <div class="header-content">
          <div class="branding">
            <span class="material-symbols-rounded app-icon app-icon--shell" aria-hidden="true">apps</span>
            <div class="branding__text">
              <h1 data-shell-app-title>MiniApps Shell</h1>
              <p data-shell-app-subtitle>Escolha um mini‑app no catálogo para iniciar.</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="shell-main">
      <div class="shell-container">
        <section class="panel-wrapper" aria-label="Painel de miniapp incorporado">
          <header>
            <h2>MiniApp em execução</h2>
            <div class="panel-actions" role="group" aria-label="Ações do painel">
              <button
                type="button"
                class="btn panel-action"
                data-action="open-catalog"
              >
                <span class="material-symbols-rounded" aria-hidden="true">apps</span>
                <span data-catalog-button-label>Abrir catálogo</span>
              </button>
            </div>
          </header>
          <iframe id="miniapp-panel" name="miniapp-panel" src="./miniapp-catalogo/index.html" title="MiniApp embarcado"></iframe>
          <noscript>Ative o JavaScript para alternar entre os mini‑apps.</noscript>
        </section>
      </div>
    </main>

    <footer class="app-footer">
      <div class="shell-container">
        <div class="footer-shortcuts">
          <button
            type="button"
            class="btn ghost footer-menu-toggle"
            data-action="toggle-footer-actions"
            aria-controls="footer-quick-actions"
            aria-expanded="false"
            aria-haspopup="true"
            aria-label="Abrir atalhos do rodapé"
            title="Abrir atalhos"
          >
            <span class="material-symbols-rounded" aria-hidden="true">menu</span>
          </button>
          <div
            class="footer-actions"
            id="footer-quick-actions"
            data-footer-actions
            hidden
            aria-labelledby="footer-actions-heading"
          >
            <div class="shell-actions" role="group" aria-label="Atalhos do shell">
              <button
                type="button"
                class="btn ghost shell-action catalog-toggle"
                data-action="open-catalog"
                aria-label="Abrir catálogo"
                title="Abrir catálogo"
              >
                <span class="material-symbols-rounded" aria-hidden="true">apps</span>
              </button>
              <button
                type="button"
                class="btn ghost shell-action fullscreen-toggle"
                data-action="toggle-fullscreen"
                aria-pressed="false"
                aria-label="Tela cheia"
                title="Tela cheia"
              >
                <span class="material-symbols-rounded fullscreen-toggle__icon" data-icon="enter" aria-hidden="true">fullscreen</span>
                <span class="material-symbols-rounded fullscreen-toggle__icon" data-icon="exit" aria-hidden="true">fullscreen_exit</span>
              </button>
            </div>
            <section class="footer-about">
              <h3
                class="footer-about__title"
                id="footer-actions-heading"
                data-footer-about-title
              >
                Sobre o app
              </h3>
              <p class="footer-about__item footer-about__product" data-footer-about-product>
                MiniApps Shell
              </p>
              <p class="footer-about__item footer-about__version" data-footer-about-version>
                Versão 0.2.0 (experimental)
              </p>
            </section>
          </div>
        </div>
        <p class="app-footer__info">
          <span class="app-footer__brand">
            <img
              src="https://5horas.com.br/wp-content/uploads/2025/10/Icone-Light-Transparente-500x500px.webp"
              alt="5 Horas"
              class="app-footer__logo"
              loading="lazy"
              width="48"
              height="48"
            >
            <span class="app-footer__research">5 horas de pesquisa e análise limitada</span>
          </span>
        </p>
      </div>
    </footer>
  </div>

  <script>
    (function () {
      const defaultMiniApp = './miniapp-catalogo/index.html';
      const panel = document.getElementById('miniapp-panel');
      const panelWrapper = document.querySelector('.panel-wrapper');
      const shellMainContainer = document.querySelector('.shell-main .shell-container');
      const appShell = document.querySelector('.app-shell');
      const headerTitle = document.querySelector('[data-shell-app-title]');
      const headerSubtitle = document.querySelector('[data-shell-app-subtitle]');
      const fullscreenToggle = document.querySelector('[data-action="toggle-fullscreen"]');
      const catalogToggles = Array.from(document.querySelectorAll('[data-action="open-catalog"]'));
      const footerMenuToggle = document.querySelector('[data-action="toggle-footer-actions"]');
      const footerActions = document.querySelector('[data-footer-actions]');
      const footerAboutTitle = document.querySelector('[data-footer-about-title]');
      const footerAboutProduct = document.querySelector('[data-footer-about-product]');
      const footerAboutVersion = document.querySelector('[data-footer-about-version]');
      const catalogUrl = new URL(defaultMiniApp, window.location.href);
      const catalogPath = catalogUrl.pathname.replace(/\/+$/, '');
      const SHELL_PRODUCT_NAME = 'MiniApps Shell';
      const SHELL_VERSION = '0.2.0 (experimental)';
      const SUPPORTED_LOCALES = ['pt-BR', 'en-US', 'es-ES'];
      const CATALOG_LABELS = {
        'pt-BR': {
          open: 'Abrir catálogo',
          active: 'Catálogo em exibição',
        },
        'en-US': {
          open: 'Open catalog',
          active: 'Catalog in view',
        },
        'es-ES': {
          open: 'Abrir catálogo',
          active: 'Catálogo en pantalla',
        },
      };

      const SHELL_HEADER_COPY = {
        'pt-BR': {
          title: SHELL_PRODUCT_NAME,
          subtitle: 'Escolha um mini‑app no catálogo para iniciar.',
        },
        'en-US': {
          title: SHELL_PRODUCT_NAME,
          subtitle: 'Pick a miniapp from the catalog to get started.',
        },
        'es-ES': {
          title: SHELL_PRODUCT_NAME,
          subtitle: 'Elige un miniapp del catálogo para comenzar.',
        },
      };

      const CATALOG_HEADER_COPY = {
        'pt-BR': {
          title: 'Catálogo de MiniApps',
          subtitle: 'Navegue pelas experiências disponíveis e escolha uma para abrir.',
        },
        'en-US': {
          title: 'MiniApps Catalog',
          subtitle: 'Browse the available experiences and choose one to open.',
        },
        'es-ES': {
          title: 'Catálogo de MiniApps',
          subtitle: 'Explora las experiencias disponibles y elige una para abrir.',
        },
      };

      const FOOTER_SHORTCUT_TOGGLE_COPY = {
        expanded: {
          label: 'Fechar atalhos do rodapé',
          title: 'Fechar atalhos',
        },
        collapsed: {
          label: 'Abrir atalhos do rodapé',
          title: 'Abrir atalhos',
        },
      };

      const FOOTER_ABOUT_COPY = {
        'pt-BR': {
          heading: 'Sobre o app',
          product: SHELL_PRODUCT_NAME,
          version: 'Versão ' + SHELL_VERSION,
        },
        'en-US': {
          heading: 'About the app',
          product: SHELL_PRODUCT_NAME,
          version: 'Version ' + SHELL_VERSION,
        },
        'es-ES': {
          heading: 'Acerca de la app',
          product: SHELL_PRODUCT_NAME,
          version: 'Versión ' + SHELL_VERSION,
        },
      };

      const miniAppMetadata = new Map();
      let activeMiniAppUrl = null;

      function setFooterToggleState(isExpanded) {
        if (!footerMenuToggle) {
          return;
        }

        const stateKey = isExpanded ? 'expanded' : 'collapsed';
        const copy = FOOTER_SHORTCUT_TOGGLE_COPY[stateKey];

        footerMenuToggle.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');

        if (copy && copy.label) {
          footerMenuToggle.setAttribute('aria-label', copy.label);
        }

        if (copy && copy.title) {
          footerMenuToggle.setAttribute('title', copy.title);
        }
      }

      function openFooterActions() {
        if (!footerActions || !footerMenuToggle) {
          return;
        }

        footerActions.hidden = false;
        footerActions.removeAttribute('hidden');
        footerActions.classList.add('footer-actions--open');
        setFooterToggleState(true);
      }

      function closeFooterActions(options = {}) {
        if (!footerActions || !footerMenuToggle) {
          return;
        }

        const { restoreFocus = false } = options;

        footerActions.classList.remove('footer-actions--open');
        footerActions.hidden = true;
        footerActions.setAttribute('hidden', '');
        setFooterToggleState(false);

        if (restoreFocus && typeof footerMenuToggle.focus === 'function') {
          footerMenuToggle.focus();
        }
      }

      if (footerActions && footerMenuToggle) {
        closeFooterActions();
      } else if (footerMenuToggle) {
        setFooterToggleState(false);
      }

      syncFooterAboutSection();

      if (footerMenuToggle && footerActions) {
        footerMenuToggle.addEventListener('click', () => {
          if (footerActions.classList.contains('footer-actions--open')) {
            closeFooterActions();
          } else {
            openFooterActions();
          }
        });

        document.addEventListener('click', (event) => {
          if (!footerActions.classList.contains('footer-actions--open')) {
            return;
          }

          if (
            footerActions.contains(event.target) ||
            footerMenuToggle.contains(event.target)
          ) {
            return;
          }

          closeFooterActions();
        });

        document.addEventListener('keydown', (event) => {
          if (event.key !== 'Escape' || !footerActions.classList.contains('footer-actions--open')) {
            return;
          }

          event.preventDefault();
          closeFooterActions({ restoreFocus: true });
        });
      }

      function getActiveLocale() {
        const docLang = (document.documentElement && document.documentElement.lang) || '';
        const normalized = SUPPORTED_LOCALES.find((locale) => docLang.toLowerCase() === locale.toLowerCase());

        if (normalized) {
          return normalized;
        }

        const baseLang = docLang.split('-')[0];
        const fallback = SUPPORTED_LOCALES.find((locale) => locale.startsWith(baseLang));

        return fallback || 'pt-BR';
      }

      function getDefaultHeaderCopy() {
        const locale = getActiveLocale();
        return SHELL_HEADER_COPY[locale] || SHELL_HEADER_COPY['pt-BR'];
      }

      function getCatalogHeaderCopy() {
        const locale = getActiveLocale();
        return CATALOG_HEADER_COPY[locale] || CATALOG_HEADER_COPY['pt-BR'];
      }

      function getFooterAboutCopy() {
        const locale = getActiveLocale();
        return FOOTER_ABOUT_COPY[locale] || FOOTER_ABOUT_COPY['pt-BR'];
      }

      function syncFooterAboutSection() {
        const copy = getFooterAboutCopy();

        if (!copy) {
          return;
        }

        if (footerAboutTitle) {
          footerAboutTitle.textContent = copy.heading;
        }

        if (footerAboutProduct) {
          footerAboutProduct.textContent = copy.product;
        }

        if (footerAboutVersion) {
          footerAboutVersion.textContent = copy.version;
        }

      }

      function normalizeMiniAppUrl(url) {
        try {
          const absolute = new URL(url, window.location.href);
          absolute.hash = '';
          absolute.search = '';
          return absolute.href.replace(/\/+$/, '');
        } catch (_) {
          return null;
        }
      }

      function sanitizeMetadata(metadata = {}) {
        if (!metadata || typeof metadata !== 'object') {
          return {};
        }

        const sanitized = {};

        if (typeof metadata.title === 'string') {
          const trimmedTitle = metadata.title.trim();
          if (trimmedTitle) {
            sanitized.title = trimmedTitle;
          }
        }

        if (typeof metadata.subtitle === 'string') {
          const trimmedSubtitle = metadata.subtitle.trim();
          if (trimmedSubtitle) {
            sanitized.subtitle = trimmedSubtitle;
          }
        }

        return sanitized;
      }

      function setHeaderContent(metadata) {
        const fallback = getDefaultHeaderCopy();
        const title = metadata && metadata.title ? metadata.title : fallback.title;
        const subtitle = metadata && metadata.subtitle ? metadata.subtitle : fallback.subtitle;

        if (headerTitle) {
          headerTitle.textContent = title;
        }

        if (headerSubtitle) {
          if (subtitle) {
            headerSubtitle.textContent = subtitle;
            headerSubtitle.hidden = false;
          } else {
            headerSubtitle.textContent = '';
            headerSubtitle.hidden = true;
          }
        }
      }

      function storeMetadataForUrl(normalizedUrl, metadata) {
        if (!normalizedUrl) {
          return null;
        }

        const sanitized = sanitizeMetadata(metadata);

        if (!sanitized.title && !sanitized.subtitle) {
          return miniAppMetadata.get(normalizedUrl) || null;
        }

        const existing = miniAppMetadata.get(normalizedUrl) || {};
        const next = {
          title: sanitized.title || existing.title,
          subtitle: sanitized.subtitle || existing.subtitle,
        };

        miniAppMetadata.set(normalizedUrl, next);
        return next;
      }

      function applyMiniAppMetadata(normalizedUrl) {
        const metadata = normalizedUrl ? miniAppMetadata.get(normalizedUrl) : null;
        setHeaderContent(metadata || null);
      }

      const normalizedCatalogUrl = normalizeMiniAppUrl(defaultMiniApp);

      if (normalizedCatalogUrl) {
        activeMiniAppUrl = normalizedCatalogUrl;
        storeMetadataForUrl(normalizedCatalogUrl, getCatalogHeaderCopy());
        applyMiniAppMetadata(activeMiniAppUrl);
      }

      function applyCatalogToggleState(isCatalog) {
        if (!catalogToggles.length) {
          return;
        }

        const locale = getActiveLocale();
        const labels = CATALOG_LABELS[locale] || CATALOG_LABELS['pt-BR'];
        const label = isCatalog ? labels.active : labels.open;

        catalogToggles.forEach((toggle) => {
          toggle.disabled = Boolean(isCatalog);

          if (isCatalog) {
            toggle.setAttribute('disabled', '');
          } else {
            toggle.removeAttribute('disabled');
          }

          toggle.setAttribute('aria-disabled', isCatalog ? 'true' : 'false');
          toggle.setAttribute('aria-label', label);
          toggle.setAttribute('title', label);

          const labelElement = toggle.querySelector('[data-catalog-button-label]');

          if (labelElement) {
            labelElement.textContent = label;
          }
        });
      }

      function isCatalogUrl(url) {
        try {
          const parsed = new URL(url, window.location.href);
          return parsed.pathname.replace(/\/+$/, '') === catalogPath;
        } catch (_) {
          return false;
        }
      }

      function updateCatalogState(sourceUrl) {
        const isCatalog = isCatalogUrl(sourceUrl);

        if (panelWrapper) {
          panelWrapper.classList.toggle('panel-wrapper--catalog', isCatalog);
        }

        if (shellMainContainer) {
          shellMainContainer.classList.toggle('shell-container--catalog', isCatalog);
        }

        if (appShell) {
          appShell.classList.toggle('is-catalog-open', isCatalog);
        }

        applyCatalogToggleState(isCatalog);
      }

      function isFullscreenActive() {
        return document.fullscreenElement === appShell || document.fullscreenElement === document.documentElement;
      }

      function syncFullscreenState() {
        const fullscreen = isFullscreenActive();

        if (appShell) {
          appShell.classList.toggle('is-fullscreen', fullscreen);
        }

        if (fullscreenToggle) {
          const label = fullscreen ? 'Sair do modo tela cheia' : 'Tela cheia';
          fullscreenToggle.setAttribute('aria-pressed', fullscreen ? 'true' : 'false');
          fullscreenToggle.setAttribute('aria-label', label);
          fullscreenToggle.setAttribute('title', label);
        }
      }

      async function enterFullscreen() {
        if (!appShell) {
          return;
        }

        try {
          if (document.fullscreenElement === appShell) {
            return;
          }

          if (appShell.requestFullscreen) {
            try {
              await appShell.requestFullscreen({ navigationUI: 'hide' });
            } catch (requestError) {
              if (requestError && requestError.name === 'TypeError') {
                await appShell.requestFullscreen();
              } else {
                throw requestError;
              }
            }
          } else if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          }
        } catch (error) {
          console.error('Não foi possível ativar a tela cheia nativa.', error);
        } finally {
          syncFullscreenState();
        }
      }

      async function exitFullscreen() {
        if (!document.fullscreenElement || !document.exitFullscreen) {
          syncFullscreenState();
          return;
        }

        try {
          await document.exitFullscreen();
        } catch (error) {
          console.error('Não foi possível sair da tela cheia nativa.', error);
        } finally {
          syncFullscreenState();
        }
      }

      if (fullscreenToggle) {
        fullscreenToggle.addEventListener('click', () => {
          if (isFullscreenActive()) {
            exitFullscreen();
          } else {
            enterFullscreen();
          }

          if (!isDesktopLayout()) {
            closeFooterActions();
          }
        });
      }

      if (catalogToggles.length > 0) {
        catalogToggles.forEach((toggle) => {
          toggle.addEventListener('click', () => {
            loadMiniApp(defaultMiniApp, {
              metadata: getCatalogHeaderCopy(),
            });

            if (toggle.closest('[data-footer-actions]')) {
              if (typeof isDesktopLayout === 'function') {
                if (!isDesktopLayout()) {
                  closeFooterActions();
                }
              } else if (window.matchMedia) {
                const desktopQuery = window.matchMedia('(min-width: 64rem)');
                if (!desktopQuery.matches) {
                  closeFooterActions();
                }
              }
            }
          });
        });
      }

      document.addEventListener('fullscreenchange', syncFullscreenState);
      document.addEventListener('fullscreenerror', syncFullscreenState);

      syncFullscreenState();

      function loadMiniApp(url, options = {}) {
        if (!panel) {
          return;
        }

        const targetUrl = typeof url === 'string' && url.trim() ? url : defaultMiniApp;
        const normalizedTarget = normalizeMiniAppUrl(targetUrl);
        const absoluteTarget = new URL(targetUrl, window.location.href).href;

        if (options && typeof options.metadata === 'object' && normalizedTarget) {
          storeMetadataForUrl(normalizedTarget, options.metadata);
        }

        activeMiniAppUrl = normalizedTarget;
        applyMiniAppMetadata(activeMiniAppUrl);

        if (panel.src !== absoluteTarget) {
          panel.src = targetUrl;
        }

        updateCatalogState(targetUrl);

        if (options.focus !== false && typeof panel.focus === 'function') {
          requestAnimationFrame(() => {
            try {
              panel.focus({ preventScroll: true });
            } catch (_) {
              panel.focus();
            }
          });
        }
      }

      window.loadMiniApp = loadMiniApp;

      document.querySelectorAll('[data-miniapp-target]').forEach((trigger) => {
        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          const targetUrl = trigger.getAttribute('data-miniapp-target');
          const metadata = {
            title: trigger.getAttribute('data-miniapp-name'),
            subtitle: trigger.getAttribute('data-miniapp-description'),
          };

          loadMiniApp(targetUrl, { metadata });
        });
      });

      if (panel) {
        panel.addEventListener('load', () => {
          updateCatalogState(panel.src);
          applyMiniAppMetadata(activeMiniAppUrl);
        });
      }

      window.addEventListener('message', (event) => {
        if (event.origin !== window.location.origin) {
          return;
        }

        const { data } = event;

        if (typeof data === 'string') {
          if (data === 'open-catalog') {
            loadMiniApp(defaultMiniApp, {
              metadata: getCatalogHeaderCopy(),
            });
          } else {
            loadMiniApp(data);
          }
          return;
        }

        if (data && typeof data === 'object') {
          if (typeof data.miniAppUrl === 'string') {
            loadMiniApp(data.miniAppUrl);
            return;
          }

          if (typeof data.url === 'string' && data.action === 'load-miniapp') {
            loadMiniApp(data.url);
            return;
          }

          if (data.action === 'miniapp-header') {
            if (!panel || event.source !== panel.contentWindow) {
              return;
            }

            const normalizedSource = activeMiniAppUrl || normalizeMiniAppUrl(panel.src);
            const stored = storeMetadataForUrl(normalizedSource, data);

            if (stored && normalizedSource === activeMiniAppUrl) {
              setHeaderContent(stored);
            }

            return;
          }

          if (data.action === 'open-catalog') {
            loadMiniApp(defaultMiniApp, {
              metadata: getCatalogHeaderCopy(),
            });
          }
        }
      });

      loadMiniApp(panel ? panel.getAttribute('src') : defaultMiniApp, {
        focus: false,
        metadata: getCatalogHeaderCopy(),
      });
    })();
  </script>
</body>
</html>
