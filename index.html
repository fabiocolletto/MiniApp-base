<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PWAO ‚Äì Genoma V4.1</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #fafafa; }
    #root { padding: 20px; }
  </style>
</head>
<body>
  <div id="root">Carregando organismo‚Ä¶</div>

<script>
// =============================================================
// GENOMA V4.1 ‚Äì Com Autodiscovery de C√©lulas PWAO
// =============================================================
// Este Genoma √© capaz de:
// - Carregar c√©lulas externas
// - Descobrir c√©lulas automaticamente via Manifesto
// - Registrar c√©lulas dinamicamente
// - Expressar cenas sob demanda
// - Manter o n√∫cleo imut√°vel
// =============================================================

// -------------------------------------------------------------
// 1. Mem√≥ria Org√¢nica
// -------------------------------------------------------------
const Memoria = {
  db: null,
  async init() {
    return new Promise((resolve) => {
      const req = indexedDB.open("pwao_memoria", 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("settings")) db.createObjectStore("settings");
        if (!db.objectStoreNames.contains("cells")) db.createObjectStore("cells", { keyPath: "nome" });
      };
      req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
    });
  },
  async registrarCelula(celula) {
    return new Promise((resolve) => {
      const tx = this.db.transaction(["cells"], "readwrite");
      tx.objectStore("cells").put(celula);
      tx.oncomplete = resolve;
    });
  },
  async listarCelulas() {
    return new Promise((resolve) => {
      const tx = this.db.transaction(["cells"], "readonly");
      const req = tx.objectStore("cells").getAll();
      req.onsuccess = () => resolve(req.result || []);
    });
  }
};

// -------------------------------------------------------------
// 2. Narrador ‚Äì Consci√™ncia do Sistema
// -------------------------------------------------------------
const Narrador = {
  ouvintes: [],
  emitir(evento) {
    this.ouvintes.forEach((fn) => fn(evento));
  },
  ouvir(fn) { this.ouvintes.push(fn); }
};

// -------------------------------------------------------------
// 3. Loader ‚Äì Carrega e Descobre C√©lulas
// -------------------------------------------------------------
const Loader = {
  mapa: {}, // preenchido com autodiscovery

  async registrar(celula) {
    this.mapa[celula.nome] = celula.caminho;
    await Memoria.registrarCelula(celula);
  },

  async expressar(nome) {
    const caminho = this.mapa[nome];
    if (!caminho) {
      Renderer.expressar(`<p>‚ùå C√©lula n√£o encontrada: ${nome}</p>`);
      return;
    }
    Renderer.montarCelula(caminho);
  },

  // AUTODISCOVERY: recebe manifestos de qualquer c√©lula externa
  async autodiscovery() {
    const celulas = await Memoria.listarCelulas();
    celulas.forEach(c => this.mapa[c.nome] = c.caminho);
  }
};

// Exposto globalmente para as c√©lulas se registrarem
window.PWAO_RegistrarCelula = async function (manifesto) {
  await Loader.registrar(manifesto);
  console.log("üîó C√©lula registrada no organismo:", manifesto.nome);
};

// -------------------------------------------------------------
// 4. Renderer ‚Äì Expressor de C√©lulas
// -------------------------------------------------------------
const Renderer = {
  async expressar(html) {
    document.getElementById("root").innerHTML = html;
  },

  async montarCelula(caminho) {
    try {
      const resp = await fetch(caminho);
      const html = await resp.text();
      this.expressar(html);
    } catch (e) {
      this.expressar(`<p>Erro ao carregar c√©lula: ${caminho}</p>`);
    }
  }
};

// -------------------------------------------------------------
// 5. Ciclo de Vida do Organismo
// -------------------------------------------------------------
async function iniciarOrganismo() {
  await Memoria.init();
  await Loader.autodiscovery(); // carrega c√©lulas registradas previamente

  Narrador.ouvir((evento) => {
    if (evento.tipo === "celula.expressar") Loader.expressar(evento.nome);
  });

  // Cena inicial do organismo
  Renderer.expressar(`
    <h1>PWAO ‚Äì Genoma V4.1</h1>
    <p>Organismo iniciado com autodiscovery.</p>

    <button onclick="Narrador.emitir({tipo: 'celula.expressar', nome: 'sistema.auth'})">Abrir Auth</button>
    <button onclick="Narrador.emitir({tipo: 'celula.expressar', nome: 'educacao.quiz'})">Abrir Quiz</button>
    <button onclick="Narrador.emitir({tipo: 'celula.expressar', nome: 'sistema.admin'})">Abrir Admin</button>
  `);
}

iniciarOrganismo();
</script>
</body>
</html>
