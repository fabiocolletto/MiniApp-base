<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWAO – Genoma orgânico</title>
  <link rel="manifest" href="./opp/manifest.webmanifest">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    :root {
      --bg: #0b1021;
      --panel: #0f172a;
      --card: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --primary: #60a5fa;
      --border: #1f2937;
      --accent: #22d3ee;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(96,165,250,0.18), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 20px 24px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .branding {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .branding .icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      display: grid;
      place-items: center;
      color: #0b1021;
      font-weight: 700;
      box-shadow: var(--shadow);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px;
    }

    main {
      flex: 1;
      padding: 0 24px 32px;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
    }

    @media (max-width: 1080px) {
      main { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    h1 { margin: 0; font-size: 22px; }
    h2 { margin: 0 0 12px; font-size: 18px; }
    p { margin: 0; color: var(--muted); }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .status {
      border-radius: 14px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.03);
      border: 1px dashed var(--border);
      color: var(--muted);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status .bullet {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #34d399;
      box-shadow: 0 0 0 6px rgba(52,211,153,0.12);
    }

    .cell-list { display: flex; flex-direction: column; gap: 10px; margin-top: 12px; }

    .cell {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }

    .cell strong { color: #fff; display: block; }
    .cell small { color: var(--muted); }

    .actions { display: flex; gap: 8px; }

    button {
      all: unset;
      cursor: pointer;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: #fff;
    }

    button:hover { transform: translateY(-1px); border-color: var(--accent); color: var(--accent); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px;
    }

    .stage {
      min-height: 420px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 16px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .stage iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      background: #fff;
    }

    .stage-placeholder {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      padding: 32px;
      color: var(--muted);
      pointer-events: none;
    }

    .stage-placeholder strong { color: #fff; }
  </style>
</head>
<body>
  <header>
    <div class="branding">
      <div class="icon">P</div>
      <div>
        <h1>Genoma PWAO</h1>
        <p id="genoma-status">Inicializando organismo…</p>
      </div>
    </div>
    <span class="tag" id="sw-status"><span class="material-icons" aria-hidden="true">offline_bolt</span>OPP offline-ready</span>
  </header>

  <main>
    <section class="card">
      <h2>Memória Orgânica</h2>
      <p>Autodiscovery das células registradas e prontas para expressão.</p>
      <div class="status-grid" style="margin: 14px 0;" id="status-grid"></div>
      <div class="pill">
        <span class="material-icons" aria-hidden="true">visibility</span>
        <span id="cell-count">0 células vivas</span>
      </div>
      <div class="cell-list" id="cell-list"></div>
    </section>

    <section class="card">
      <h2>Stage Orgânico</h2>
      <p>O Genoma usa o Narrador para expressar células em isolamento via iframe.</p>
      <div class="stage" id="stage">
        <div class="stage-placeholder" id="stage-placeholder">
          <div>
            <div class="pill" style="margin-bottom:10px;"><span class="material-icons" aria-hidden="true">hourglass_empty</span>Sem célula ativa</div>
            <strong>Use o autodiscovery para expressar uma célula.</strong>
            <p>O Stage preserva CSS e JS originais ao carregar o HTML completo da célula.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const Narrador = (() => {
      const assinaturas = [];
      function emitir(evento) {
        assinaturas.filter(sub => sub.tipo === evento.tipo).forEach(sub => sub.callback(evento));
      }
      function ao(tipo, callback) {
        assinaturas.push({ tipo, callback });
      }
      return { emitir, ao };
    })();

    function criarMemoriaOrganica() {
      const memoriaVolatil = new Map();
      const suporteIndexedDB = 'indexedDB' in window;
      const banco = { instancia: null, nome: 'pwao-organic-memory', loja: 'cells' };

      function abrirIndexedDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(banco.nome, 1);
          req.onupgradeneeded = () => req.result.createObjectStore(banco.loja, { keyPath: 'nome' });
          req.onsuccess = () => { banco.instancia = req.result; resolve(req.result); };
          req.onerror = () => reject(req.error);
        });
      }

      async function garantirBanco() {
        if (!suporteIndexedDB) return null;
        if (banco.instancia) return banco.instancia;
        try { return await abrirIndexedDB(); } catch (err) {
          console.warn('IndexedDB indisponível, usando memória volátil.', err);
          return null;
        }
      }

      async function salvarCelula(manifesto) {
        if (!suporteIndexedDB) { memoriaVolatil.set(manifesto.nome, manifesto); return manifesto; }
        const db = await garantirBanco();
        if (!db) { memoriaVolatil.set(manifesto.nome, manifesto); return manifesto; }
        return new Promise((resolve, reject) => {
          const tx = db.transaction(banco.loja, 'readwrite');
          tx.objectStore(banco.loja).put(manifesto);
          tx.oncomplete = () => resolve(manifesto);
          tx.onerror = () => { memoriaVolatil.set(manifesto.nome, manifesto); reject(tx.error); };
        });
      }

      async function listarCelulas() {
        if (!suporteIndexedDB) return Array.from(memoriaVolatil.values());
        const db = await garantirBanco();
        if (!db) return Array.from(memoriaVolatil.values());
        return new Promise(resolve => {
          const resultado = [];
          const tx = db.transaction(banco.loja, 'readonly');
          const req = tx.objectStore(banco.loja).openCursor();
          req.onsuccess = () => {
            const cursor = req.result;
            if (cursor) { resultado.push(cursor.value); cursor.continue(); }
          };
          tx.oncomplete = () => resolve(resultado);
          tx.onerror = () => resolve(resultado);
        });
      }

      return { salvarCelula, listarCelulas };
    }

    function criarLoader(memoria) {
      const registros = new Map();

      async function registrar(manifesto) {
        if (!manifesto || !manifesto.nome || !manifesto.caminho) return null;
        registros.set(manifesto.nome, manifesto);
        await memoria.salvarCelula(manifesto);
        Narrador.emitir({ tipo: 'celula.registrada', manifesto });
        Narrador.emitir({ tipo: 'celulas.disponiveis', celulas: Array.from(registros.values()) });
        return manifesto;
      }

      async function autodiscover() {
        const guardadas = await memoria.listarCelulas();
        guardadas.forEach(c => registros.set(c.nome, c));
        Narrador.emitir({ tipo: 'celulas.disponiveis', celulas: Array.from(registros.values()) });
      }

      function obter(nome) { return registros.get(nome); }

      return { registrar, autodiscover, obter };
    }

    function criarRenderer() {
      const lista = document.getElementById('cell-list');
      const contador = document.getElementById('cell-count');
      const stage = document.getElementById('stage');
      const placeholder = document.getElementById('stage-placeholder');
      const statusGrid = document.getElementById('status-grid');
      const genomaStatus = document.getElementById('genoma-status');

      function desenharStatus() {
        statusGrid.innerHTML = '';
        const blocos = [
          { icon: 'memory', label: 'Memória orgânica ativa' },
          { icon: 'visibility', label: 'Autodiscovery pronto' },
          { icon: 'science', label: 'Narrador em escuta' }
        ];
        blocos.forEach(item => {
          const div = document.createElement('div');
          div.className = 'status';
          div.innerHTML = `<span class="bullet" aria-hidden="true"></span><span class="material-icons" aria-hidden="true">${item.icon}</span><span>${item.label}</span>`;
          statusGrid.appendChild(div);
        });
      }

      function desenharCelulas(celulas) {
        contador.textContent = `${celulas.length} célula${celulas.length === 1 ? '' : 's'} vivas`;
        lista.innerHTML = '';
        if (!celulas.length) {
          const vazio = document.createElement('div');
          vazio.className = 'pill';
          vazio.innerHTML = '<span class="material-icons" aria-hidden="true">info</span>Nenhum manifesto registrado. Aguarde as células se anunciarem.';
          lista.appendChild(vazio);
          return;
        }
        celulas.forEach(celula => {
          const card = document.createElement('div');
          card.className = 'cell';
          card.innerHTML = `
            <div>
              <strong>${celula.nome}</strong>
              <small>${celula.descricao || 'Manifesto orgânico'}</small>
            </div>
            <div class="actions">
              <button data-express="${celula.nome}"><span class="material-icons" aria-hidden="true">play_arrow</span>Expressar</button>
            </div>
          `;
          lista.appendChild(card);
        });
      }

      function mostrarMensagem(titulo, detalhe) {
        placeholder.innerHTML = `<div><div class="pill" style="margin-bottom:10px;"><span class="material-icons" aria-hidden="true">rocket_launch</span>${titulo}</div><p>${detalhe}</p></div>`;
        placeholder.style.display = 'grid';
        stage.querySelectorAll('iframe').forEach(frame => frame.remove());
      }

      function expressar(manifesto) {
        placeholder.style.display = 'none';
        stage.querySelectorAll('iframe').forEach(frame => frame.remove());
        const iframe = document.createElement('iframe');
        iframe.title = manifesto.nome;
        iframe.src = manifesto.caminho;
        stage.appendChild(iframe);
        genomaStatus.textContent = `Expressando ${manifesto.nome} (${manifesto.versao || '1.0.0'})`;
      }

      desenharStatus();
      return { desenharCelulas, mostrarMensagem, expressar };
    }

    const memoria = criarMemoriaOrganica();
    const loader = criarLoader(memoria);
    const renderer = criarRenderer();

    window.PWAO_RegistrarCelula = manifesto => loader.registrar(manifesto);

    Narrador.ao('celulas.disponiveis', ({ celulas }) => renderer.desenharCelulas(celulas));
    Narrador.ao('celula.expressar', ({ nome }) => {
      const manifesto = loader.obter(nome);
      if (!manifesto) {
        renderer.mostrarMensagem('Célula não localizada', `Nenhum manifesto chamado ${nome} foi descoberto.`);
        return;
      }
      renderer.mostrarMensagem('Carregando célula…', `Stage preparando iframe para ${manifesto.nome}.`);
      renderer.expressar(manifesto);
    });

    document.addEventListener('click', event => {
      const expressBtn = event.target.closest('[data-express]');
      if (!expressBtn) return;
      const nome = expressBtn.dataset.express;
      Narrador.emitir({ tipo: 'celula.expressar', nome });
    });

    async function registrarServiceWorker() {
      const statusTag = document.getElementById('sw-status');
      if (!('serviceWorker' in navigator)) {
        statusTag.innerHTML = '<span class="material-icons" aria-hidden="true">warning</span>OPP indisponível neste ambiente';
        return;
      }
      try {
        await navigator.serviceWorker.register('/opp/service-worker.js');
        statusTag.innerHTML = '<span class="material-icons" aria-hidden="true">offline_pin</span>OPP ativo e em cache';
      } catch (err) {
        console.warn('Falha ao registrar service worker', err);
        statusTag.innerHTML = '<span class="material-icons" aria-hidden="true">cloud_off</span>OPP não registrado';
      }
    }

    async function semearCelulaModelo() {
      const manifesto = {
        nome: 'sistema.appfamily',
        caminho: 'celulas/sistema/Index.html',
        orgao: 'sistema',
        versao: '1.0.0',
        descricao: 'App Família – modelo completo convertido para PWAO'
      };
      if (!loader.obter(manifesto.nome)) {
        await loader.registrar(manifesto);
      }
      Narrador.emitir({ tipo: 'celula.expressar', nome: manifesto.nome });
    }

    (async () => {
      renderer.mostrarMensagem('Iniciando Genoma', 'Memória orgânica e Narrador sendo ativados.');
      await loader.autodiscover();
      await semearCelulaModelo();
      registrarServiceWorker();
    })();
  </script>
</body>
</html>
