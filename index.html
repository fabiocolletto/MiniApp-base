<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniApp - Shell React</title>
    <link rel="stylesheet" href="https://unpkg.com/open-props@1.6.18/open-props.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/miniapp-global.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/miniapp-card.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/components/app-shared-header.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/components/app-shared-footer.js"></script>
    <link rel="manifest" href="./pwa/manifest.webmanifest">
    <meta name="theme-color" content="#f3f4f6">
    <style>
        app-shared-footer .icon-button:hover,
        app-shared-footer .icon-button:focus-visible {
            background-color: transparent !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="body-with-fixed-footer" style="margin: 0; padding: 0; width: 100%; height: 100%; overflow-x: hidden;">
    <div id="root"></div>
    <script>
        const h = React.createElement;
        const { useCallback, useEffect, useMemo, useRef, useState } = React;

        const NAV_STAGE_DEFINITIONS = {
            home: {
                key: 'home',
                title: 'MiniApp Home',
                description: 'MiniApp Home carregado via Iframe.',
                icon: 'home',
                sourceId: 'home',
                isCore: true,
                launchUrl: 'about:blank'
            },
            alerts: {
                key: 'alerts',
                title: 'Notificações',
                description: 'Painel de alertas e avisos.',
                icon: 'notifications',
                sourceId: 'alerts',
                isCore: true
            },
            catalog: {
                key: 'catalog',
                title: 'Catálogo (Placeholder)',
                description: 'Painel do catálogo sem carregamento de dados.',
                icon: 'grid_view',
                sourceId: 'catalog',
                isCore: true
            },
            settings: {
                key: 'settings',
                title: 'Configurações',
                description: 'Painel de ajustes do usuário.',
                icon: 'settings',
                sourceId: 'settings',
                isCore: true
            },
            account: {
                key: 'account',
                title: 'Conta do Usuário',
                description: 'Painel externo carregado via Iframe.',
                icon: 'person',
                sourceId: 'account',
                isCore: true,
                launchUrl: 'about:blank'
            }
        };

        function HomeStage() {
            return h(
                'section',
                { id: 'homeStage', className: 'stage-panel' },
                h('app-shared-header', {
                    id: 'homeHeader',
                    title: 'MiniApp 5Horas',
                    icon: 'flash_on',
                    'hide-search': true
                }),
                h(
                    'div',
                    {
                        className: 'u-flex u-direction-column u-align-center u-justify-center u-gap-md u-text-center u-padding-xl',
                        style: { minHeight: 'min(70vh, 600px)' }
                    },
                    h(
                        'div',
                        { className: 'u-flex u-direction-column u-gap-2xs' },
                        h('p', { className: 'u-text-sm muted-text' }, 'Aplicação de Base'),
                        h('h1', { className: 'u-text-2xl u-font-extrabold' }, 'Navegação Ativa')
                    ),
                    h(
                        'p',
                        { id: 'welcomeMessage', className: 'u-text-base muted-text', style: { maxWidth: '320px' } },
                        'Este código contém apenas as funções de navegação entre os ícones do rodapé.'
                    )
                )
            );
        }

        function PlaceholderStage({ stageDefinition }) {
            return h(
                'section',
                { id: 'placeholderStage', className: 'stage-panel' },
                h(
                    'div',
                    { className: 'placeholder-card' },
                    h(
                        'div',
                        { className: 'placeholder-icon', 'aria-hidden': 'true' },
                        h('span', { className: 'material-icons-sharp', id: 'placeholderIcon' }, stageDefinition.icon || 'hub')
                    ),
                    h(
                        'div',
                        { className: 'placeholder-content' },
                        h('p', { className: 'placeholder-label' }, 'Etapa'),
                        h('h2', { className: 'placeholder-title', id: 'placeholderTitle' }, stageDefinition.title),
                        h(
                            'p',
                            { className: 'placeholder-description', id: 'placeholderDescription' },
                            stageDefinition.description
                        )
                    )
                )
            );
        }

        function IframeStage({ stageDefinition }) {
            return h(
                'section',
                { id: `iframe-stage-${stageDefinition.key}`, className: 'stage-panel iframe-stage', style: { padding: '0' } },
                h('iframe', {
                    src: stageDefinition.launchUrl,
                    title: stageDefinition.title,
                    style: { width: '100%', height: '100%', border: 'none' }
                })
            );
        }

        function App() {
            const footerRef = useRef(null);
            const navDefinitions = useMemo(() => NAV_STAGE_DEFINITIONS, []);
            const resolveStageDefinition = useCallback(
                (key) => {
                    const normalizedKey = (key || '').toLowerCase();
                    if (Object.prototype.hasOwnProperty.call(navDefinitions, normalizedKey)) {
                        return navDefinitions[normalizedKey];
                    }
                    return navDefinitions.home;
                },
                [navDefinitions]
            );
            const [activeStageKey, setActiveStageKey] = useState(() => resolveStageDefinition('home').key);
            const [footerState, setFooterState] = useState('collapsed');

            useEffect(() => {
                const footer = footerRef.current;
                if (!footer) return undefined;
                const initialActive = resolveStageDefinition(footer.getAttribute('active-tab') || 'home');
                setActiveStageKey(initialActive.key);
                const initialState = footer.getAttribute('state') === 'collapsed' ? 'collapsed' : 'expanded';
                setFooterState(initialState);

                const syncFooterState = () => {
                    const nextState = footer.getAttribute('state') === 'collapsed' ? 'collapsed' : 'expanded';
                    setFooterState(nextState);
                };

                const handleNavigate = (event) => {
                    const key = event.detail?.target || event.detail?.key;
                    if (!key) return;
                    event.preventDefault();
                    setActiveStageKey(resolveStageDefinition(key).key);
                };

                footer.addEventListener('app:navigate', handleNavigate);

                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'state') {
                            syncFooterState();
                        }
                    });
                });

                observer.observe(footer, { attributes: true, attributeFilter: ['state'] });

                return () => {
                    footer.removeEventListener('app:navigate', handleNavigate);
                    observer.disconnect();
                };
            }, [resolveStageDefinition]);

            useEffect(() => {
                const footer = footerRef.current;
                if (!footer) return;
                const currentActive = footer.getAttribute('active-tab');
                if (!currentActive) {
                    footer.setAttribute('active-tab', 'home');
                }
                if (currentActive !== activeStageKey) {
                    footer.setAttribute('active-tab', activeStageKey);
                }
            }, [activeStageKey]);

            useEffect(() => {
                const footer = footerRef.current;
                if (footer) {
                    footer.setAttribute('state', footerState);
                }
            }, [footerState]);

            useEffect(() => {
                const footer = footerRef.current;
                const stageDefinition = resolveStageDefinition(activeStageKey);
                if (stageDefinition.launchUrl && footer?.showFooterMessage) {
                    footer.showFooterMessage(`Navegando para Iframe: ${stageDefinition.title}`, false);
                }
            }, [activeStageKey, resolveStageDefinition]);

            const activeStageDefinition = resolveStageDefinition(activeStageKey);
            let mainContent = null;

            if (activeStageDefinition.key === 'home') {
                mainContent = h(HomeStage);
            } else if (activeStageDefinition.launchUrl) {
                mainContent = h(IframeStage, { stageDefinition: activeStageDefinition });
            } else {
                mainContent = h(PlaceholderStage, { stageDefinition: activeStageDefinition });
            }

            return h(
                'div',
                { className: 'app-shell' },
                h('main', { className: 'app-main app-stage' }, mainContent),
                h('app-shared-footer', {
                    ref: footerRef,
                    id: 'globalFooter',
                    'active-tab': activeStageKey,
                    variant: 'full',
                    state: footerState
                })
            );
        }

        const rootElement = document.getElementById('root');
        ReactDOM.createRoot(rootElement).render(h(App));
    </script>
</body>
</html>
