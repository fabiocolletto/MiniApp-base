<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5 Horas • MiniApps</title>
    <link rel="stylesheet" href="./styles/tokens.css" />
    <link rel="stylesheet" href="./styles/main.css" />
    <script src="./public/env.js"></script>
    <link
      rel="icon"
      href="https://5horas.com.br/wp-content/uploads/2025/10/Icone-Light-Transparente-500x500px.webp"
      type="image/webp"
      sizes="500x500"
    />
  </head>
<body class="auth-only">
  <main id="app" class="auth-screen">
    <section class="auth-card">
      <header class="auth-header">
        <h1 data-i18n="auth.welcome">Bem-vindo</h1>
        <p class="auth-sub" data-i18n="auth.subtitle">Acesse sua conta ou crie um novo cadastro</p>
      </header>

      <div class="auth-actions">
        <button id="btnLogin" class="btn btn-primary" data-i18n="auth.login">Entrar</button>
        <button id="btnRegister" class="btn btn-outline" data-i18n="auth.register">Criar conta</button>
      </div>

      <footer class="auth-footer">
        <small id="statusHint" data-i18n="auth.hint">Você pode ativar o modo multidispositivos depois do login, em Personalizações.</small>
      </footer>
    </section>
  </main>

  <section
    id="authDialog"
    class="auth-dialog"
    aria-hidden="true"
    aria-modal="true"
    role="dialog"
    hidden
  >
    <div class="auth-dialog__backdrop" data-auth-close></div>
    <div class="auth-dialog__container" role="document">
      <header class="auth-dialog__header">
        <h2 class="auth-dialog__title" id="authDialogTitle">Acesso rápido</h2>
        <button
          type="button"
          class="auth-dialog__close"
          aria-label="Fechar painel de autenticação"
          data-auth-close
        >
          ×
        </button>
      </header>
      <div class="auth-dialog__body">
        <section id="authViewRoot" class="auth-dialog__view" aria-labelledby="authDialogTitle"></section>
      </div>
    </div>
  </section>

  <style>
    :root{
      --p: var(--ac-primary, #2e7d32);
      --txt: var(--ac-text, #1a1a1a);
      --muted: #6b7280;
      --bd: var(--ac-border, #e5e7eb);
      --bg: var(--ac-surface, #ffffff);
    }
    html, body { height:100%; margin:0; }
    .auth-screen{
      min-height:100%;
      display:grid;
      place-items:center;
      background: var(--ac-bg, #f8fafc);
      padding:24px;
    }
    .auth-card{
      width:min(420px, 92vw);
      background:var(--bg);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:24px;
      box-shadow: 0 6px 24px rgba(0,0,0,.05);
    }
    .auth-header h1{ margin:0 0 6px; font: 600 22px/1.2 system-ui, sans-serif; color:var(--txt); }
    .auth-sub{ margin:0 0 18px; color:var(--muted); }
    .auth-actions{ display:flex; gap:12px; }
    .btn{ flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--bd); cursor:pointer; font:600 15px/1 system-ui, sans-serif; }
    .btn-primary{ background:var(--p); color:#fff; border-color:transparent; }
    .btn-outline{ background:#fff; color:var(--txt); }
    .auth-footer{ margin-top:14px; color:var(--muted); }
    .auth-dialog[hidden]{ display:none; }
    .auth-dialog{ position:fixed; inset:0; z-index:1000; display:grid; place-items:center; padding:24px; }
    .auth-dialog__backdrop{ position:absolute; inset:0; background:rgba(17,24,39,.55); backdrop-filter:blur(4px); }
    .auth-dialog__container{ position:relative; z-index:1; width:min(680px, 94vw); max-height:92vh; display:flex; flex-direction:column; gap:16px; padding:20px; border-radius:18px; background:var(--bg); box-shadow:0 24px 60px rgba(15,23,42,.35); border:1px solid rgba(255,255,255,.12); overflow:hidden; }
    .auth-dialog__header{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .auth-dialog__title{ margin:0; font:600 18px/1.3 system-ui, sans-serif; color:var(--txt); }
    .auth-dialog__close{ border:none; background:transparent; font-size:24px; line-height:1; color:var(--muted); cursor:pointer; border-radius:8px; width:32px; height:32px; display:grid; place-items:center; }
    .auth-dialog__close:focus-visible{ outline:2px solid var(--p); outline-offset:2px; }
    .auth-dialog__body{
      display:flex;
      flex-direction:column;
      overflow:auto;
      padding:clamp(16px, 2.4vw, 24px);
      padding-right:calc(clamp(16px, 2.4vw, 24px) - 4px);
      gap:clamp(12px, 2vw, 20px);
      box-sizing:border-box;
    }
    .auth-dialog__view{ min-width:0; }
    .auth-dialog__body > .auth-dialog__view{
      flex:1;
      display:grid;
      align-content:start;
    }
    .auth-dialog__body > .view--login,
    .auth-dialog__body > .view--register{
      min-height:auto;
      grid-template-rows:minmax(0, max-content);
      justify-items:center;
      gap:clamp(0.65rem, 2.2vw, 1rem);
      padding-block:clamp(1rem, 2.4vw, 1.6rem);
    }
    body.auth-dialog--open{ overflow:hidden; }
  </style>

  <script type="module">
    import eventBus from './scripts/events/event-bus.js';
    import { renderLoginPanel } from './scripts/views/login.js';
    import { renderRegisterPanel } from './scripts/views/register.js';

    const dialog = document.getElementById('authDialog');
    const dialogViewRoot = document.getElementById('authViewRoot');
    const dialogTitle = document.getElementById('authDialogTitle');
    const closeButtons = dialog?.querySelectorAll('[data-auth-close]') ?? [];

    const VIEW_RENDERERS = {
      login: {
        title: 'Entrar na sua conta',
        render: renderLoginPanel,
      },
      register: {
        title: 'Crie sua conta',
        render: renderRegisterPanel,
      },
    };

    let lastTrigger = null;

    function isDialogOpen() {
      return dialog && !dialog.hasAttribute('hidden');
    }

    function focusFirstInteractiveElement() {
      if (!dialog) {
        return;
      }

      const focusable = dialog.querySelector(
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );

      if (focusable instanceof HTMLElement) {
        focusable.focus();
      }
    }

    function openDialog(viewName, trigger) {
      if (!(dialog instanceof HTMLElement) || !(dialogViewRoot instanceof HTMLElement)) {
        return;
      }

      const viewConfig = VIEW_RENDERERS[viewName];
      if (!viewConfig) {
        return;
      }

      lastTrigger = trigger instanceof HTMLElement ? trigger : null;

      dialogViewRoot.replaceChildren();
      viewConfig.render(dialogViewRoot);

      if (dialogTitle) {
        dialogTitle.textContent = viewConfig.title;
      }

      dialog.removeAttribute('hidden');
      dialog.setAttribute('aria-hidden', 'false');
      document.body.classList.add('auth-dialog--open');
      focusFirstInteractiveElement();
    }

    function closeDialog() {
      if (!(dialog instanceof HTMLElement) || !(dialogViewRoot instanceof HTMLElement)) {
        return;
      }

      dialog.setAttribute('hidden', '');
      dialog.setAttribute('aria-hidden', 'true');
      dialogViewRoot.replaceChildren();
      document.body.classList.remove('auth-dialog--open');

      if (lastTrigger instanceof HTMLElement) {
        lastTrigger.focus({ preventScroll: true });
      }
      lastTrigger = null;
    }

    function handleDialogClose(event) {
      if (!(event instanceof Event)) {
        return;
      }

      const target = event.target;
      if (target instanceof HTMLElement && target.dataset.authClose !== undefined) {
        closeDialog();
      }
    }

    closeButtons.forEach((button) => {
      button.addEventListener('click', handleDialogClose);
    });

    dialog?.addEventListener('click', (event) => {
      if (event.target === dialog) {
        closeDialog();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && isDialogOpen()) {
        event.preventDefault();
        closeDialog();
      }
    });

    function handleAppNavigate(payload) {
      if (!payload || typeof payload !== 'object') {
        return;
      }

      const { view } = payload;
      if (view === 'login' || view === 'register') {
        openDialog(view, dialog);
        return;
      }

      if (view === 'home' || view === 'user') {
        closeDialog();
      }
    }

    eventBus.on('app:navigate', handleAppNavigate);

    const loginButton = document.getElementById('btnLogin');
    const registerButton = document.getElementById('btnRegister');

    loginButton?.addEventListener('click', () => openDialog('login', loginButton));
    registerButton?.addEventListener('click', () => openDialog('register', registerButton));
  </script>

</body>
</html>
