<!DOCTYPE html>
<!--
  PWAO ‚Äì GENOMA v2 (PALCO GLOBAL com NAVEGA√á√ÉO v1)
  -------------------------------------------------
  Arquivo: /index.html (raiz do reposit√≥rio)

  ‚Ä¢ Palco global (Stage)
  ‚Ä¢ Navega√ß√£o nativa no estilo do Genoma v1 (welcome ‚Üí dashboard ‚Üí ...)
  ‚Ä¢ Conex√£o com c√©lulas via renderizador (evento celula.expressar)
  ‚Ä¢ ScreenFactory: telas geradas pelo Genoma via prefixo data.*

  IMPORTANTE
  ‚Ä¢ Sem regra de neg√≥cio
  ‚Ä¢ Sem depend√™ncia de frameworks
  ‚Ä¢ C√©lulas vivem dentro do Stage
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PWAO</title>
  <meta name="theme-color" content="#0f172a" />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: Inter, system-ui, sans-serif;
      background: #ffffff;
      color: #1f2937;
    }

    #app {
      min-height: 100vh;
      position: relative;
    }

    header {
      position: sticky;
      top: 0;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      z-index: 40;
    }

    header .title {
      font-weight: 600;
      font-size: 15px;
    }

    header button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 8px;
    }

    header button:active { transform: scale(0.96); }

    footer { display: none; }

    main#stage {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (min-width: 768px) {
      .grid { grid-template-columns: repeat(4, 1fr); }
    }

    @media (min-width: 1280px) {
      .grid { grid-template-columns: repeat(6, 1fr); }
    }

    .card {
      aspect-ratio: 1 / 1;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      text-align: center;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 600;
      background: #fff;
      appearance: none;
      -webkit-appearance: none;
    }

    .card:active { transform: scale(0.99); }

    .card .icon { font-size: 36px; line-height: 1; }

    .welcome {
      min-height: calc(100vh - 56px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .welcome-box {
      max-width: 360px;
      width: 100%;
      text-align: center;
      margin: 0 auto;
    }

    .welcome-box h1 {
      font-size: 28px;
      margin: 0 0 8px 0;
    }

    .welcome-box p {
      color: #6b7280;
      margin: 0 0 24px 0;
    }

    .welcome-box button {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #4f46e5;
      background: #ffffff;
      color: #4f46e5;
      font-weight: 600;
      cursor: pointer;
    }

    .tone-finance { background:#eef2ff; color:#4338ca; border-color:#c7d2fe; }
    .tone-education { background:#fffbeb; color:#b45309; border-color:#fde68a; }
    .tone-health { background:#ecfeff; color:#0f766e; border-color:#99f6e4; }
    .tone-settings { background:#f1f5f9; color:#334155; border-color:#e2e8f0; }

    .loading, .error {
      padding: 24px;
      text-align: center;
      font-size: 14px;
      color: #475569;
    }

    .error { color: #991b1b; }

    .form {
      margin-top: 12px;
      display: grid;
      gap: 12px;
      text-align: left;
    }

    .field label {
      display: block;
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
    }

    .field input, .field select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font: inherit;
    }

    .primary {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #111827;
      background: #111827;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .primary:active { transform: scale(0.99); }
  </style>
</head>
<body>

  <div id="app">
    <header>
      <button id="btn-back" aria-label="Voltar">‚óÄ</button>
      <div class="title" id="header-title">PWAO</div>
      <button id="btn-user" aria-label="Painel do Usu√°rio">Usu√°rio</button>
    </header>

    <main id="stage"></main>
    <footer id="footer"></footer>
  </div>

  <script>
  (function () {
    'use strict';

    /* ========================== ELEMENTOS ========================== */
    const STAGE = document.getElementById('stage');
    const FOOTER = document.getElementById('footer');

    const BTN_BACK = document.getElementById('btn-back');
    const BTN_USER = document.getElementById('btn-user');
    const HEADER_TITLE = document.getElementById('header-title');

    /* ========================== ESTADO ========================== */
    let CURRENT_SCREEN = null;
    const HISTORY = [];

    /* ========================== RENDER ========================== */
    function renderStage(html) {
      STAGE.innerHTML = html;
    }

    function setHeaderTitle(title) {
      if (HEADER_TITLE) HEADER_TITLE.textContent = title || 'PWAO';
    }

    function renderFooter(buttons = []) {
      // Reservado (hoje oculto)
      FOOTER.innerHTML = buttons.map(btn =>
        `<button data-screen="${btn.screen || ''}" data-celula="${btn.celula || ''}">${btn.label}</button>`
      ).join('');
    }

    /* ========================== MEM√ìRIA (IndexedDB + fallback) ========================== */
    const Memory = (() => {
      const DB = 'pwao-organism';
      let db = null;
      const mem = new Map();

      function open() {
        // Sempre "abre" (mesmo que seja s√≥ fallback)
        if (!('indexedDB' in window)) {
          console.warn('IndexedDB indispon√≠vel neste ambiente. Usando mem√≥ria vol√°til.');
          db = null;
          return Promise.resolve();
        }

        return new Promise((resolve) => {
          const req = indexedDB.open(DB, 1);
          req.onupgradeneeded = (e) => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains('cells')) {
              d.createObjectStore('cells', { keyPath: 'nome' });
            }
          };
          req.onsuccess = () => { db = req.result; resolve(); };
          req.onerror = () => {
            console.warn('Falha ao abrir IndexedDB. Usando mem√≥ria vol√°til.');
            db = null;
            resolve();
          };
        });
      }

      function saveCell(c) {
        if (!c?.nome) return Promise.resolve();
        mem.set(c.nome, c);

        if (!db) return Promise.resolve();
        return new Promise((resolve, reject) => {
          const tx = db.transaction('cells', 'readwrite');
          const store = tx.objectStore('cells');
          const req = store.put(c);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      function getCell(n) {
        if (!n) return Promise.resolve(null);

        if (mem.has(n)) return Promise.resolve(mem.get(n));
        if (!db) return Promise.resolve(null);

        return new Promise((resolve) => {
          const tx = db.transaction('cells', 'readonly');
          const store = tx.objectStore('cells');
          const req = store.get(n);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => resolve(null);
        });
      }

      return { open, saveCell, getCell };
    })();

    /* ========================== NARRADOR (Event Bus) ========================== */
    const Narrador = (() => {
      const map = {};
      return {
        on(tipo, fn) { (map[tipo] ||= []).push(fn); },
        emitir(evt) {
          const list = map[evt.tipo] || [];
          list.forEach((f) => {
            try { f(evt); } catch (e) { console.warn(e); }
          });
        }
      };
    })();

    window.Narrador = Narrador;

    /* ========================== API P√öBLICA (C√âLULAS) ========================== */
    window.PWAO_RegistrarCelula = async (m) => {
      if (!m?.nome || !m?.caminho) return;
      await Memory.saveCell({
        nome: m.nome,
        caminho: m.caminho,
        orgao: m.orgao || null,
        versao: m.versao || '0.0.0',
        descricao: m.descricao || ''
      });
    };

    /* ========================== EXPRESS√ÉO DE C√âLULAS ========================== */
    async function expressarCelula(nome) {
      const cell = await Memory.getCell(nome);
      if (!cell) {
        renderStage(`<div class="error">C√©lula n√£o registrada: <b>${nome}</b></div>`);
        return;
      }

      try {
        const res = await fetch(cell.caminho, { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch-failed');
        const html = await res.text();
        renderStage(html);
      } catch (e) {
        renderStage(`<div class="error">Falha ao carregar c√©lula: <b>${nome}</b></div>`);
      }
    }

    Narrador.on('celula.expressar', (e) => expressarCelula(e.nome));

    /* ========================== TELAS NATIVAS (v1) ========================== */
    const SCREENS = {
      _meta: {
        welcome:   { title: 'Bem-vindo' },
        dashboard: { title: 'Dashboard' },
        finance:   { title: 'Finan√ßas' },
        alerts:    { title: 'Alertas' },
        settings:  { title: 'Configura√ß√µes' },
        offline:   { title: 'Offline' },
        error:     { title: 'Erro' }
      },

      welcome() {
        setHeaderTitle(SCREENS._meta.welcome.title);
        renderStage(`
          <div class="welcome">
            <div class="welcome-box">
              <div class="icon" style="font-size:48px; margin-bottom:12px;">üöÄ</div>
              <h1>Bem-vindo</h1>
              <p>Seu painel inteligente come√ßa aqui</p>
              <button id="btn-start">Entrar</button>
            </div>
          </div>
        `);
        const btn = document.getElementById('btn-start');
        if (btn) btn.onclick = () => navigate('dashboard');
      },

      dashboard() {
        setHeaderTitle(SCREENS._meta.dashboard.title);
        renderStage(`
          <div class="grid">
            <button class="card tone-finance" data-action="render" data-target="finance">
              <div class="icon">üí∞</div>
              <div>Finan√ßas</div>
            </button>
            <button class="card tone-education" data-action="render" data-target="education">
              <div class="icon">üéì</div>
              <div>Educa√ß√£o</div>
            </button>
            <button class="card tone-health" data-action="render" data-target="health">
              <div class="icon">üè•</div>
              <div>Sa√∫de</div>
            </button>
            <button class="card tone-settings" data-action="render" data-target="settings">
              <div class="icon">‚öôÔ∏è</div>
              <div>Configura√ß√µes</div>
            </button>
          </div>
        `);
      },

      // Painel de √°rea: Finan√ßas (6 bot√µes)
      finance() {
        setHeaderTitle(SCREENS._meta.finance.title);
        renderStage(`
          <div class="grid">
            <button class="card" data-action="render" data-target="data.finance.income.single">
              <div class="icon">‚ûï</div>
              <div>Receitas Avulsas</div>
            </button>
            <button class="card" data-action="render" data-target="data.finance.income.recurring">
              <div class="icon">üîÅ</div>
              <div>Receitas Recorrentes</div>
            </button>
            <button class="card" data-action="render" data-target="data.finance.expense.single">
              <div class="icon">‚ûñ</div>
              <div>Despesas Avulsas</div>
            </button>
            <button class="card" data-action="render" data-target="data.finance.expense.recurring">
              <div class="icon">üîÅ</div>
              <div>Despesas Recorrentes</div>
            </button>
            <button class="card" data-action="render" data-target="finance.reports">
              <div class="icon">üìà</div>
              <div>Relat√≥rios</div>
            </button>
            <button class="card" data-action="render" data-target="finance.settings">
              <div class="icon">‚öôÔ∏è</div>
              <div>Ajustes</div>
            </button>
          </div>
        `);
      },

      alerts() {
        setHeaderTitle(SCREENS._meta.alerts.title);
        renderStage('<div class="loading">Nenhum alerta no momento.</div>');
      },

      settings() {
        setHeaderTitle(SCREENS._meta.settings.title);
        renderStage(`
          <div class="grid">
            <button class="card" data-action="render" data-target="sistema.user-profile">
              <div class="icon">üë§</div>
              <div>Perfil do Usu√°rio</div>
            </button>
          </div>
        `);
      },

      offline() {
        setHeaderTitle(SCREENS._meta.offline.title);
        renderStage('<div class="error">Voc√™ est√° offline.</div>');
      },

      error() {
        setHeaderTitle(SCREENS._meta.error.title);
        renderStage('<div class="error">Ocorreu um erro inesperado.</div>');
      }
    };

    /* ========================== NAVEGA√á√ÉO (v1) ========================== */
    function navigate(screen) {
      if (SCREENS._meta && SCREENS._meta[screen]?.title) {
        setHeaderTitle(SCREENS._meta[screen].title);
      }

      if (CURRENT_SCREEN && screen !== CURRENT_SCREEN) {
        HISTORY.push(CURRENT_SCREEN);
      }

      CURRENT_SCREEN = screen;

      if (typeof SCREENS[screen] === 'function') {
        SCREENS[screen]();
      } else {
        renderStage(`<div class="error">Tela n√£o registrada: <b>${screen}</b></div>`);
      }
    }

    function goBack() {
      const prev = HISTORY.pop();
      if (prev && typeof SCREENS[prev] === 'function') {
        CURRENT_SCREEN = prev;
        SCREENS[prev]();
      }
    }

    BTN_BACK.addEventListener('click', goBack);

    BTN_USER.addEventListener('click', () => {
      // Atalho global do header
      Narrador.emitir({ tipo: 'celula.expressar', nome: 'sistema.user-profile' });
    });

    /* ========================== SCREEN FACTORY (data.*) ========================== */
    // Pergunta de comportamento (precisa da tua confirma√ß√£o):
    // Ao abrir uma tela data.*, voc√™ quer:
    //  A) salvar rascunho local imediatamente, ou
    //  B) s√≥ salvar no submit?
    // (Hoje deixei como B: apenas renderizar o formul√°rio.)

    const DATA_SCREENS = {
      // chave = "domain.type.mode" (sem o prefixo data.)
      'finance.income.single': {
        title: 'Nova Receita Avulsa',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true },
          { name: 'valor', label: 'Valor', type: 'number', required: true },
          { name: 'data', label: 'Data', type: 'date', required: true }
        ]
      },
      'finance.income.recurring': {
        title: 'Nova Receita Recorrente',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true },
          { name: 'valor', label: 'Valor', type: 'number', required: true },
          { name: 'frequencia', label: 'Frequ√™ncia', type: 'select', options: ['Mensal', 'Semanal', 'Anual'], required: true },
          { name: 'inicio', label: 'In√≠cio', type: 'date', required: true }
        ]
      },
      'finance.expense.single': {
        title: 'Nova Despesa Avulsa',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true },
          { name: 'valor', label: 'Valor', type: 'number', required: true },
          { name: 'data', label: 'Data', type: 'date', required: true }
        ]
      },
      'finance.expense.recurring': {
        title: 'Nova Despesa Recorrente',
        fields: [
          { name: 'descricao', label: 'Descri√ß√£o', type: 'text', required: true },
          { name: 'valor', label: 'Valor', type: 'number', required: true },
          { name: 'frequencia', label: 'Frequ√™ncia', type: 'select', options: ['Mensal', 'Semanal', 'Anual'], required: true },
          { name: 'inicio', label: 'In√≠cio', type: 'date', required: true }
        ]
      }
    };

    function renderDataForm(spec, routeKey) {
      const fieldsHtml = (spec.fields || []).map((f) => {
        const req = f.required ? 'required' : '';
        if (f.type === 'select') {
          const opts = (f.options || []).map(o => `<option value="${o}">${o}</option>`).join('');
          return `
            <div class="field">
              <label for="${f.name}">${f.label}</label>
              <select id="${f.name}" name="${f.name}" ${req}>
                <option value="">Selecione‚Ä¶</option>
                ${opts}
              </select>
            </div>
          `;
        }

        const inputType = f.type === 'number' ? 'number' : (f.type === 'date' ? 'date' : 'text');
        return `
          <div class="field">
            <label for="${f.name}">${f.label}</label>
            <input id="${f.name}" name="${f.name}" type="${inputType}" ${req} />
          </div>
        `;
      }).join('');

      renderStage(`
        <div class="welcome-box">
          <h1 style="font-size:22px; margin: 8px 0;">${spec.title}</h1>
          <p style="margin: 0 0 14px 0;">Tela gerada pelo Genoma ‚Ä¢ <span style="color:#64748b">${routeKey}</span></p>
          <form id="data-form" class="form">
            ${fieldsHtml}
            <button class="primary" type="submit">Salvar</button>
          </form>
        </div>
      `);

      const form = document.getElementById('data-form');
      if (!form) return;
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());

        // Aqui voc√™ decide o destino real (c√©lula de persist√™ncia)
        // Por enquanto, apenas demonstra o contrato.
        console.log('[data.* submit]', routeKey, payload);
        renderStage(`<div class="loading">Salvo (mock). Pr√≥ximo: enviar para c√©lula de persist√™ncia.</div>`);
      });
    }

    function ScreenFactory(target) {
      if (!target.startsWith('data.')) return false;

      const routeKey = target.replace(/^data\./, '');
      const spec = DATA_SCREENS[routeKey];

      if (!spec) {
        setHeaderTitle('Cadastro');
        renderStage(`<div class="error">Tela data n√£o registrada: <b>${routeKey}</b></div>`);
        return true;
      }

      setHeaderTitle(spec.title);
      renderDataForm(spec, routeKey);
      return true;
    }

    /* ========================== CLIQUES (renderizador) ========================== */
    STAGE.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="render"]');
      if (!btn) return;

      const target = btn.dataset.target;
      if (!target) return;

      // 1) Tela nativa
      if (typeof SCREENS[target] === 'function') {
        navigate(target);
        return;
      }

      // 2) Tela gerada pelo Genoma
      if (ScreenFactory(target)) return;

      // 3) C√©lula
      Narrador.emitir({ tipo: 'celula.expressar', nome: target });
    });

    // Footer reservado
    FOOTER.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const screen = btn.dataset.screen;
      const celula = btn.dataset.celula;

      if (screen) navigate(screen);
      if (celula) Narrador.emitir({ tipo: 'celula.expressar', nome: celula });
    });

    /* ========================== TESTES (SMOKE) ========================== */
    function runTests() {
      console.group('Genoma v2 ‚Äì Tests');

      console.assert(typeof window.Narrador?.emitir === 'function', 'Narrador.emitir deve existir');
      console.assert(typeof window.PWAO_RegistrarCelula === 'function', 'PWAO_RegistrarCelula deve existir');
      console.assert(typeof SCREENS.welcome === 'function', 'Tela welcome deve existir');
      console.assert(typeof SCREENS.dashboard === 'function', 'Tela dashboard deve existir');
      console.assert(typeof SCREENS.finance === 'function', 'Tela finance deve existir');
      console.assert(HEADER_TITLE && HEADER_TITLE.textContent.length >= 0, 'Header title deve existir');

      setHeaderTitle('Teste');
      console.assert(HEADER_TITLE.textContent === 'Teste', 'setHeaderTitle deve atualizar o header');
      setHeaderTitle('PWAO');

      console.assert(ScreenFactory('data.finance.income.single') === true, 'ScreenFactory deve reconhecer data.*');
      console.assert(ScreenFactory('finance.income.single') === false, 'ScreenFactory n√£o deve reconhecer sem prefixo');

      console.log('OK: smoke tests');
      console.groupEnd();

      // Volta para um estado previs√≠vel ap√≥s os testes
      navigate('welcome');
    }

    /* ========================== BOOT ========================== */
    (async function bootstrap() {
      renderStage('<div class="loading">Inicializando‚Ä¶</div>');

      await Memory.open();

      // Registro m√≠nimo de c√©lulas essenciais do sistema
      await window.PWAO_RegistrarCelula({
        nome: 'sistema.user-profile',
        caminho: './products/system/user-profile/index.html',
        descricao: 'Painel de cadastro do usu√°rio'
      });

      runTests();
    })();

  })();
  </script>

</body>
</html>
