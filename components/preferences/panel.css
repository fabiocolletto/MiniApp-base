@layer components {
  body.preferences-panel-open {
    overflow: hidden;
  }

  .preferences-overlay {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    padding: clamp(var(--ac-space-2), 5vw, var(--ac-space-4));
    background: color-mix(in srgb, #0b0f13 45%, transparent);
    backdrop-filter: blur(18px);
    z-index: calc(var(--ac-z-modal, 100) + 10);
  }

  .preferences-overlay[hidden] {
    display: none !important;
  }

  .preferences-panel {
    background: var(--ac-surface);
    color: var(--ac-text);
    border-radius: var(--ac-radius);
    box-shadow: var(--ac-shadow-strong);
    border: 1px solid var(--ac-border-subtle);
    display: grid;
    gap: var(--ac-space-2);
    width: min(100%, 420px);
    max-height: min(90vh, 640px);
    overflow-y: auto;
    padding: clamp(var(--ac-space-2), 4vw, var(--ac-space-3));
    scrollbar-gutter: stable both-edges;
  }

  .preferences-panel__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--ac-space-1);
    padding-bottom: var(--ac-space-1);
    border-bottom: 1px solid var(--ac-border-subtle);
  }

  .preferences-panel__header h2 {
    margin: 0;
    font: 600 clamp(1.05rem, 1.8vw + 0.4rem, 1.35rem) / 1.3 var(--ac-font-primary);
    color: var(--ac-text);
  }

  .preferences-panel__close {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: var(--global-radius-pill, 999px);
    border: 1px solid var(--ac-border-subtle);
    background: transparent;
    color: var(--ac-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
  }

  .preferences-panel__close:hover,
  .preferences-panel__close:focus-visible {
    background: color-mix(in srgb, var(--ac-primary) 12%, transparent);
    border-color: color-mix(in srgb, var(--ac-primary) 35%, transparent);
    transform: translateY(-1px);
  }

  .preferences-form {
    display: grid;
    gap: var(--ac-space-2);
  }

  .preferences-section {
    display: grid;
    gap: var(--ac-space-1);
  }

  .preferences-section h3 {
    margin: 0;
    font: 600 clamp(0.95rem, 1.3vw + 0.4rem, 1.1rem) / 1.4 var(--ac-font-primary);
    color: var(--ac-text);
  }

  .preferences-section__hint,
  .preferences-hint {
    margin: 0;
    font: 400 clamp(0.8rem, 1vw + 0.35rem, 0.9rem) / 1.5 var(--ac-font-primary);
    color: var(--ac-text-muted);
  }

  .preferences-options {
    display: grid;
    gap: var(--ac-space-1);
  }

  .preferences-options--inline {
    grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr));
  }

  .preferences-option {
    display: grid;
    gap: 0.25rem;
    padding: clamp(0.75rem, 1.8vw, 1rem);
    border-radius: var(--ac-radius-md);
    border: 1px solid var(--ac-border-subtle);
    background: color-mix(in srgb, var(--ac-surface) 90%, var(--ac-surface-muted) 10%);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    position: relative;
  }

  .preferences-option input[type='radio'] {
    position: absolute;
    inset: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .preferences-option:has(input[type='radio']:focus-visible) {
    outline: 3px solid color-mix(in srgb, var(--ac-primary) 45%, transparent);
    outline-offset: 2px;
  }

  .preferences-option:has(input[type='radio']:checked) {
    border-color: color-mix(in srgb, var(--ac-primary) 55%, transparent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--ac-primary) 18%, transparent);
  }

  .preferences-option__label {
    font: 600 clamp(0.95rem, 1.2vw + 0.4rem, 1.05rem) / 1.4 var(--ac-font-primary);
    color: var(--ac-text);
  }

  .preferences-option__description {
    font: 400 clamp(0.78rem, 0.9vw + 0.35rem, 0.9rem) / 1.5 var(--ac-font-primary);
    color: var(--ac-text-muted);
  }

  .preferences-field {
    display: grid;
    gap: 0.4rem;
  }

  .preferences-field label {
    font: 500 clamp(0.85rem, 1vw + 0.35rem, 0.95rem) / 1.4 var(--ac-font-primary);
    color: var(--ac-text-secondary);
  }

  .preferences-field select {
    border-radius: var(--ac-radius-md);
    border: 1px solid var(--ac-border-subtle);
    padding: 0.6rem 0.75rem;
    font: 500 1rem/1.4 var(--ac-font-primary);
    color: var(--ac-text);
    background: var(--ac-surface);
  }

  .preferences-slider {
    display: grid;
    gap: 0.5rem;
  }

  .preferences-slider input[type='range'] {
    width: 100%;
    accent-color: var(--ac-primary);
  }

  .preferences-switch {
    display: grid;
    gap: 0.5rem;
  }

  .preferences-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
  }

  .preferences-toggle input[type='checkbox'] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .preferences-toggle__control {
    width: 2.75rem;
    height: 1.4rem;
    border-radius: var(--global-radius-pill, 999px);
    background: color-mix(in srgb, var(--ac-primary) 12%, var(--ac-border-subtle) 88%);
    position: relative;
    transition: background-color 0.2s ease;
  }

  .preferences-toggle__control::after {
    content: '';
    position: absolute;
    top: 0.2rem;
    left: 0.2rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: var(--ac-surface);
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.18);
    transition: transform 0.2s ease;
  }

  .preferences-toggle input[type='checkbox']:checked + .preferences-toggle__control {
    background: color-mix(in srgb, var(--ac-primary) 65%, transparent);
  }

  .preferences-toggle input[type='checkbox']:checked + .preferences-toggle__control::after {
    transform: translateX(1.35rem);
  }

  .preferences-toggle__label {
    font: 500 clamp(0.9rem, 1vw + 0.35rem, 1rem) / 1.4 var(--ac-font-primary);
    color: var(--ac-text);
  }

  @media (max-width: 36rem) {
    .preferences-panel {
      width: min(100%, 100vw - 1.5rem);
      max-height: 100vh;
      border-radius: clamp(var(--ac-radius-sm), 2vw, var(--ac-radius));
    }
  }
}
