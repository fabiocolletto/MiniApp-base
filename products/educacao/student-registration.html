<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro do Aluno</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet"/>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fff; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 20px; }
        
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px white inset !important;
            box-shadow: 0 0 0 30px white inset !important;
            -webkit-text-fill-color: #333 !important; 
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: white !important; 
        }
        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            outline: none;
        }

        .required-missing {
            border-color: #fca5a5 !important;
            box-shadow: 0 0 0 2px rgba(252, 165, 165, 0.4) !important;
        }

        .error-message {
            color: #dc2626; /* red-600 */
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem; /* mt-1 */
            font-weight: 500; /* font-medium */
        }

        .tab-button {
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            transition: all 0.2s;
            flex-grow: 1;
            text-align: center;
            white-space: nowrap;
            position: relative; 
        }
        @media (min-width: 640px) {
             .tab-button { font-size: 1rem; padding: 0.75rem 1rem; }
        }
        
        #tab-data { --tab-color: #2563eb; }
        #tab-responsibles { --tab-color: #7c3aed; }
        #tab-tutors { --tab-color: #059669; }
        #tab-institution { --tab-color: #ec4899; }

        .tab-button.active {
            color: var(--tab-color); 
            border-bottom-color: var(--tab-color); 
        }
        .tab-button:hover:not(.active) {
            color: #4b5563;
        }

        :root {
            --chip-color-text-save: #2563eb;
            --chip-color-border-save: #93c5fd;
            --chip-color-hover-bg-save: #eff6ff;
            
            --chip-color-text-delete: #dc2626;
            --chip-color-border-delete: #fca5a5;
            --chip-color-hover-bg-delete: #fef2f2;

            --chip-color-text-clear: #0891b2;
            --chip-color-border-clear: #67e8f9;
            --chip-color-hover-bg-clear: #ecfeff;
        }
        
        .action-chip-button {
            background-color: white !important; 
            border-width: 1px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, box-shadow 0.2s, background-color 0.2s, border-color 0.3s;
            padding: 0.75rem 1rem; 
            border-radius: 0.75rem; 
            font-weight: 600;
            justify-content: flex-start;
            white-space: nowrap;
            overflow: hidden;
        }
        .action-chip-button:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); 
            transform: translateY(-0.1rem);
        }
        
        .action-chip-button .action-icon {
            margin-right: 0.5rem;
            transition: margin 0.3s ease-in-out, color 0.3s;
        }

        .hidden-text .action-chip-button {
            width: 48px; 
            height: 48px;
            padding: 0.625rem;
            justify-content: center;
            align-items: center;
        }
        
        .hidden-text .action-chip-button .action-icon {
            margin-right: 0; 
            color: white !important;
            transition: margin 0.3s ease-in-out, color 0.3s;
        }

        .hidden-text .action-chip-save {
            background-color: var(--chip-color-text-save) !important;
            border-color: var(--chip-color-text-save) !important;
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3) !important;
        }
        .hidden-text .action-chip-clear {
            background-color: var(--chip-color-text-clear) !important;
            border-color: var(--chip-color-text-clear) !important;
            box-shadow: 0 4px 8px rgba(8, 145, 178, 0.3) !important;
        }
        .hidden-text .action-chip-delete {
            background-color: var(--chip-color-text-delete) !important;
            border-color: var(--chip-color-text-delete) !important;
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3) !important;
        }

        .hidden-text .action-chip-button span:not(.action-icon) {
             opacity: 0;
             width: 0;
             transition: opacity 0.3s ease-out;
        }

        .action-chip-save { color: var(--chip-color-text-save) !important; border-color: var(--chip-color-border-save); }
        .action-chip-save:hover { background-color: var(--chip-color-hover-bg-save) !important; }

        .action-chip-delete { color: var(--chip-color-text-delete) !important; border-color: var(--chip-color-border-delete); }
        .action-chip-delete:hover { background-color: var(--chip-color-hover-bg-delete) !important; }

        .action-chip-clear { color: var(--chip-color-text-clear) !important; border-color: var(--chip-color-border-clear); }
        .action-chip-clear:hover { background-color: var(--chip-color-hover-bg-clear) !important; }

        .profile-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.75rem;
            border-left-width: 4px;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
            margin-bottom: 0.5rem;
        }
        .profile-card:hover {
            background-color: #f9fafb;
            cursor: pointer;
        }
        .profile-card.bg-red-50 {
             border-color: #f87171 !important;
        }
        .list-item {
            padding: 0;
            border-bottom: none;
        }
        .list-item:last-child {
            border-bottom: none;
        }

        .add-block-container {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
        }
        
        .editing-mode {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3);
            background-color: #f3e8ff;
        }
    </style>
</head>
<body class="text-slate-800 antialiased overflow-y-auto">

    <main class="space-y-6 px-6 py-6 max-w-4xl mx-auto">

        <div class="border-b pb-4 border-blue-100 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-blue-600">Cadastro do Aluno</h2>
                <p class="text-sm text-gray-500">Seu perfil para acessar os servi√ßos.</p>
            </div>
        </div>
        
        <div id="summary-panel" class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-200">
            <!-- CONTE√öDO SER√Å RENDERIZADO PELO JS, DEIXANDO VAZIO SE N√ÉO HOUVER DADOS -->
        </div>
        
        <section class="bg-white rounded-xl shadow-lg border border-gray-100">
            
            <div class="flex border-b border-gray-200">
                <button id="tab-data" class="tab-button active" onclick="changeTab('data')">
                    <span class="material-symbols-rounded align-middle mr-1 text-base">badge</span>
                    Aluno
                </button>
                <button id="tab-responsibles" class="tab-button text-gray-400" onclick="changeTab('responsibles')">
                    <span class="material-symbols-rounded align-middle mr-1 text-base">diversity_3</span>
                    Respons√°veis
                </button>
                <button id="tab-tutors" class="tab-button text-gray-400" onclick="changeTab('tutors')">
                    <span class="material-symbols-rounded align-middle mr-1 text-base">diversity_1</span>
                    Professores/Tutores
                </button>
                <button id="tab-institution" class="tab-button text-gray-400" onclick="changeTab('institution')">
                    <span class="material-symbols-rounded align-middle mr-1 text-base">school</span>
                    Institui√ß√µes
                </button>
            </div>

            <form id="student-form" class="p-6 space-y-6">
                
                <div id="content-data" class="tab-content space-y-6">
                    
                    <div class="space-y-4 border border-blue-200 p-4 rounded-lg bg-white">
                        <h3 class="text-base font-semibold text-blue-700 px-2 flex items-center">
                            <span class="material-symbols-rounded mr-2 text-base">star</span>
                            Identifica√ß√£o Essencial (Obrigat√≥rio)
                        </h3>

                        <div>
                            <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo do Aluno</label>
                            <input type="text" id="student-name" required placeholder="Nome do estudante" class="form-input" autocomplete="name"/>
                            <div id="student-name-error" class="error-message"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="student-phone-number" class="block text-sm font-medium text-gray-700 mb-1">
                                    Telefone de Contato
                                    <span class="text-xs text-gray-500 ml-2">(Celular com WhatsApp)</span>
                                </label>
                                <div class="flex space-x-2">
                                    <input type="text" id="student-phone-ddi" required 
                                           placeholder="DDI" 
                                           maxlength="4" 
                                           class="form-input w-1/4 max-w-[80px] text-center" 
                                           autocomplete="country-code" 
                                           value="+55"/>
                                    <input type="tel" id="student-phone-ddd" required 
                                           placeholder="DDD" 
                                           maxlength="2" 
                                           class="form-input w-1/5 max-w-[70px] text-center js-mask-ddd" 
                                           autocomplete="tel-area-code"/>
                                    <input type="tel" id="student-phone-number" required 
                                           placeholder="9XXXX-XXXX" 
                                           maxlength="10" 
                                           class="form-input flex-1 js-mask-national-phone" 
                                           autocomplete="tel-national"/>
                                </div>
                                <div id="student-phone-error" class="error-message"></div>
                            </div>

                            <div>
                                <label for="new-resp-cep" class="block text-sm font-medium text-gray-700 mb-1">CEP</label>
                                <input type="tel" id="student-cep" required placeholder="00000-000" maxlength="9" class="form-input js-mask-cep" autocomplete="postal-code" pattern="\d*"/>
                                <div id="student-cep-error" class="error-message"></div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 border border-blue-200 p-4 rounded-lg bg-white">
                        <h3 class="text-base font-semibold text-blue-600 px-2 flex items-center">
                            <span class="material-symbols-rounded mr-2 text-base">verified</span>
                            Detalhes para Ativa√ß√£o de Perfil (Opcional)
                        </h3>
                        
                        <div>
                            <label for="student-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                            <input type="email" id="student-email" placeholder="email.aluno@exemplo.com" class="form-input" autocomplete="email"/>
                            <div id="student-email-error" class="error-message"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-1">
                                <label for="student-birthdate" class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento</label>
                                <input type="tel" id="student-birthdate" placeholder="DD/MM/AAAA" maxlength="10" class="form-input js-mask-date" autocomplete="bday"/>
                                <div id="student-birthdate-error" class="error-message"></div>
                            </div>
                            <div class="md:col-span-1">
                                <label for="student-gender" class="block text-sm font-medium text-gray-700 mb-1">G√™nero</label>
                                <select id="student-gender" class="form-input" autocomplete="sex">
                                    <option value="">-- Selecione --</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Outros">Outros</option>
                                    <option value="NaoInformado">N√£o Informado</option>
                                </select>
                                <div id="student-gender-error" class="error-message"></div>
                            </div>
                            
                             <div id="gender-other-field" class="hidden md:col-span-1">
                                 <label for="student-gender-other-select" class="block text-sm font-medium text-gray-700 mb-1">G√™nero Espec√≠fico</label>
                                 <select id="student-gender-other-select" class="form-input">
                                 </select>
                                 <input type="hidden" id="student-gender-other"/>
                                 <div id="student-gender-other-error" class="error-message"></div>
                             </div>

                            <div class="hidden">
                                <input type="text" id="student-cpf" autocomplete="off"/>
                            </div>
                        </div>
                        
                    </div>
                </div> 
                
                <div id="content-responsibles" class="tab-content space-y-6 hidden"></div>
                <div id="content-tutors" class="tab-content space-y-6 hidden"></div>
                <div id="content-institution" class="tab-content space-y-6 hidden"></div>
            
            </form>
        </section>

    </main>
    
    <div id="global-actions-buttons" class="fixed left-6 bottom-8 z-30 flex flex-col space-y-2 transition-opacity duration-300">
        <button id="global-save-btn" type="button" onclick="handleGlobalAction('save')" 
            class="action-chip-button action-chip-save font-medium rounded-full text-sm px-4 py-2.5 inline-flex items-center shadow-md transition-transform hover:scale-105">
            <span class="material-symbols-rounded text-xl action-icon">save</span>
            <span id="save-btn-text">Salvar Tudo</span>
        </button>
    </div>

    <div id="status-message" class="fixed bottom-6 right-6 text-sm p-3 rounded-lg text-center font-medium hidden z-50 shadow-lg"></div>

    <script type="module">
        const LOCAL_STORAGE_KEY = 'student_data';
        const INSTITUTION_STORAGE_KEY = 'institution_data'; 
        const AVAILABLE_TUTORS_KEY = 'available_tutors'; 
        const AVAILABLE_RESPONSIBLES_KEY = 'available_responsibles'; 
        
        const OTHER_GENDERS_OPTIONS = [
            { value: "", label: "-- Selecione o G√™nero Espec√≠fico --" },
            { value: "NaoBinario", label: "N√£o Bin√°rio" },
            { value: "GeneroFluido", label: "G√™nero Fluido" },
            { value: "Ag√™nero", label: "Ag√™nero" },
            { value: "Big√™nero", label: "Big√™nero" },
            { value: "OutroEspecificado", label: "Outro (Especificar)" }
        ];

        let linkedTutors = []; 
        let linkedResponsibles = []; 
        let linkedInstitutions = []; 
        let currentInstitutionToLink = null;
        let activeTabId = 'data';
        let hideTimeout;
        
        function handleFixedLengthJump(currentInput, nextInputId) {
            if (currentInput.maxLength > 0 && currentInput.value.length >= currentInput.maxLength) {
                const nextInput = document.getElementById(nextInputId);
                if (nextInput) {
                    nextInput.focus();
                }
            }
        }
        
        function handleEnterKeyFocus(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                const focusable = Array.from(document.querySelectorAll('input:not([type="hidden"]):not([disabled]), select:not([disabled]), button:not([disabled])'));
                const currentFocusedIndex = focusable.findIndex(el => el === document.activeElement);
                
                if (currentFocusedIndex > -1 && currentFocusedIndex < focusable.length - 1) {
                    focusable[currentFocusedIndex + 1].focus();
                } else if (currentFocusedIndex === focusable.length - 1) {
                    document.getElementById('global-save-btn').click();
                } else if (focusable.length > 0) {
                     focusable[0].focus();
                }
            }
        }

        function validateRequiredPhone(ddi, ddd, nationalPhone) {
            const cleanDdi = ddi.replace(/[^\d+]/g, '');
            const cleanDdd = ddd.replace(/\D/g, '');
            const cleanNumber = nationalPhone.replace(/\D/g, '');

            const isDdiValid = cleanDdi.length >= 2 && cleanDdi.startsWith('+');
            const isDddValid = cleanDdd.length === 2;
            
            let isNumberValid = false;
            if (cleanDdi === '+55') {
                 isNumberValid = cleanNumber.length === 9; // Exige 9 d√≠gitos no Brasil
            } else {
                 isNumberValid = cleanNumber.length >= 8 && cleanNumber.length <= 9;
            }

            if (!isDdiValid || !isDddValid || !isNumberValid) {
                if (!isDdiValid) return "O DDI deve come√ßar com '+' e ter no m√≠nimo 2 d√≠gitos.";
                if (!isDddValid) return "O DDD deve ter exatamente 2 d√≠gitos.";
                if (cleanDdi === '+55' && !isNumberValid) return "O telefone nacional (se DDI for +55) deve ter 9 d√≠gitos.";
                if (!isNumberValid) return "O n√∫mero deve ter 8 ou 9 d√≠gitos.";
            }
            return true; 
        }

        function validateRequiredEmail(email) {
            if (email.trim() === '') return true; // EMAIL √â OPCIONAL
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return "Informe um formato de e-mail v√°lido (ex: nome@dominio.com).";
            }
            return true;
        }
        
        function validateRequiredCep(cep) {
             if (cep.length !== 9) {
                 return "O CEP deve estar no formato 00000-000 (9 caracteres).";
             }
             return true;
        }

        function maskDDD(value) {
             value = value.replace(/\D/g, "").substring(0, 2);
             return value;
        }

        function maskNationalPhone(value) {
            value = value.replace(/\D/g, "");
            
            if (value.length > 4) {
                if (value.length >= 9) {
                     value = value.replace(/^(\d{5})(\d{4})$/, "$1-$2"); 
                } 
                else if (value.length === 8) {
                    value = value.replace(/^(\d{4})(\d{4})$/, "$1-$2"); 
                }
            }
            return value.substring(0, 10);
        }

        function maskCep(value) {
            value = value.replace(/\D/g, "");
            value = value.replace(/^(\d{5})(\d)/g, "$1-$2");
            return value;
        }
        
        function maskDate(value) {
            value = value.replace(/\D/g, "");
            value = value.replace(/^(\d{2})(\d)/g, "$1/$2"); 
            value = value.replace(/^(\d{2})\/(\d{2})(\d)/g, "$1/$2/$3"); 
            return value.substring(0, 10);
        }

        function calculateAge(birthdateString) {
            const parts = birthdateString.split('/');
            if (parts.length !== 3) return null;
            
            const [day, month, year] = parts.map(Number);
            
            if (!day || !month || !year) return null;

            const today = new Date();
            const birthDate = new Date(year, month - 1, day);
            
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        function setStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
            
            if (type === 'ok') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'warn') {
                statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusEl.classList.add('bg-gray-100', 'text-gray-800');
            }
            statusEl.classList.remove('hidden');

            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }
        
        function getStudentData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            const parsedData = data ? JSON.parse(data) : null;
            
            linkedTutors = parsedData && parsedData.tutors ? parsedData.tutors : [];
            linkedResponsibles = parsedData && parsedData.responsibles ? parsedData.responsibles : []; 
            linkedInstitutions = parsedData && parsedData.linkedInstitutions ? parsedData.linkedInstitutions : []; 
            
            return parsedData;
        }
        
        function getAvailableInstitutions() {
             const data = localStorage.getItem(INSTITUTION_STORAGE_KEY);
             const institution = data ? JSON.parse(data) : null; 
             
             if (institution && institution.name) {
                 return [{ id: institution.name, name: institution.name }];
             }
             return [];
        }

        function getAvailableTutors() {
            const data = localStorage.getItem(AVAILABLE_TUTORS_KEY);
            let availableTutors = [];

            if (data) {
                try {
                    availableTutors = JSON.parse(data).map(t => ({ 
                        id: t.name.replace(/\s/g, '-').toLowerCase(), 
                        name: t.name 
                    }));
                } catch (e) {
                    console.error("Erro ao carregar tutores dispon√≠veis do localStorage:", e);
                }
            }
            return availableTutors;
        }

        function getAvailableResponsibles() {
            const data = localStorage.getItem(AVAILABLE_RESPONSIBLES_KEY);
            let availableResponsibles = [];
            
            if (!data) {
                 availableResponsibles = [
                     { id: 'paifabio', name: 'F√°bio Colletto', relationship: 'Pai', phone: '+55 (11) 98765-4321', email: 'fabio@exemplo.com', cep: '01000-000' },
                     { id: 'maejuliana', name: 'Juliana Silva', relationship: 'M√£e', phone: '+55 (11) 91234-5678', email: 'juliana@exemplo.com', cep: '01000-000' },
                 ];
            } else {
                 try {
                     availableResponsibles = JSON.parse(data);
                 } catch (e) {
                     console.error("Erro ao carregar respons√°veis dispon√≠veis do localStorage:", e);
                 }
            }

            return availableResponsibles.map(r => ({
                ...r,
                id: r.id || r.name.replace(/\s/g, '-').toLowerCase(), 
            }));
        }

        function saveStudentData(data) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
        }

        function clearStudentData() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            linkedTutors = []; 
            linkedResponsibles = []; 
            linkedInstitutions = []; 
        }

        function clearDataTab() {
            document.getElementById('student-name').value = '';
            document.getElementById('student-birthdate').value = '';
            document.getElementById('student-gender').value = '';
            document.getElementById('student-phone-ddi').value = '+55'; 
            document.getElementById('student-phone-ddd').value = ''; 
            document.getElementById('student-phone-number').value = ''; 
            document.getElementById('student-cep').value = '';
            document.getElementById('student-email').value = '';
            document.getElementById('gender-other-field').classList.add('hidden');
            const otherSelect = document.getElementById('student-gender-other-select');
            if(otherSelect) otherSelect.value = OTHER_GENDERS_OPTIONS[0].value;
        }

        function clearResponsibilities() {
            linkedResponsibles = [];
        }
        
        function clearTutorLinks() {
            linkedTutors = [];
        }

        function clearInstitutionLinks() {
            linkedInstitutions = [];
            document.getElementById('temp-enrollment').value = '';
            document.getElementById('temp-course').value = '';
            document.getElementById('temp-room').value = '';
            const select = document.getElementById('new-institution-select');
            if(select) select.value = '';
            const detailsFields = document.getElementById('institution-details-fields');
            if(detailsFields) detailsFields.classList.add('hidden');
            currentInstitutionToLink = null;
        }

        // --- VALIDA√á√ÉO M√çNIMA PARA ATIVAR O BOT√ÉO SALVAR (NOME, TELEFONE, CEP) ---
        function isMinimumDataForSaveComplete() {
            const name = document.getElementById('student-name').value.trim();
            const ddi = document.getElementById('student-phone-ddi').value.trim();
            const ddd = document.getElementById('student-phone-ddd').value.trim();
            const number = document.getElementById('student-phone-number').value.trim();
            const cep = document.getElementById('student-cep').value.trim();
            const maskedCep = maskCep(cep);
            
            return name.length > 0 && validateRequiredPhone(ddi, ddd, number) === true && validateRequiredCep(maskedCep) === true;
        }
        
        // Obt√©m a lista completa de erros (mensagens e campos)
        function getMissingRequirements() {
             const missing = [];
             
             const name = document.getElementById('student-name').value.trim();
             const ddi = document.getElementById('student-phone-ddi').value.trim();
             const ddd = document.getElementById('student-phone-ddd').value.trim();
             const number = document.getElementById('student-phone-number').value.trim();
             const cep = document.getElementById('student-cep').value.trim();
             const birthdate = document.getElementById('student-birthdate').value;
             const gender = document.getElementById('student-gender').value;
             
             // VALIDA√á√ÉO ESSENCIAL (Nome, Telefone, CEP)
             if (!name) missing.push({ field: 'student-name', message: "O nome completo √© obrigat√≥rio." });
             
             const phoneValidation = validateRequiredPhone(ddi, ddd, number);
             if (phoneValidation !== true) missing.push({ field: 'student-phone', message: phoneValidation });
             
             const cepValidation = validateRequiredCep(cep);
             if (cepValidation !== true) missing.push({ field: 'student-cep', message: cepValidation });

             // VALIDA√á√ÉO OPICIONAL (E-mail, Data, G√™nero)
             const email = document.getElementById('student-email').value.trim();
             const emailValidation = validateRequiredEmail(email); // Valida formato APENAS se preenchido
             if (emailValidation !== true) missing.push({ field: 'student-email', message: emailValidation });

             // Regras de Neg√≥cio e Conex√µes
             
             // Regra de Respons√°vel Legal para Menores (Depende da Data de Nascimento, que √© opcional)
             if (birthdate && birthdate.length === 10) {
                const age = calculateAge(birthdate);
                if (age !== null && age < 18) {
                    const hasLegalGuardian = linkedResponsibles.some(r => 
                        r.relationship === 'Pai' || r.relationship === 'M√£e' || r.relationship === 'Guardi√£o Legal'
                    );
                    if (!hasLegalGuardian) {
                        missing.push({ field: 'linked-responsibles-list-container', message: "Para menores de 18 anos, √© obrigat√≥rio vincular Pai, M√£e ou Guardi√£o Legal." });
                    }
                }
             }
             
             // V√≠nculo Incompleto com Institui√ß√µes
             for (const inst of linkedInstitutions) {
                  if (!inst.enrollment || !inst.course) {
                     missing.push({ field: 'linked-institutions-list-container', message: `V√≠nculo Incompleto com ${inst.name}. Matr√≠cula e Curso s√£o obrigat√≥rios.` });
                     break; 
                  }
             }

             // Retorna a lista de TUDO que est√° errado, mas o status ATIVO s√≥ depende do essencial.
             return missing;
        }

        // Nova fun√ß√£o para valida√ß√£o inline e atualiza√ß√£o de UI
        function validateDataTab() {
            const errors = getMissingRequirements();
            const errorMap = errors.reduce((acc, err) => {
                acc[err.field] = err.message;
                return acc;
            }, {});

            const inputFields = [
                'student-name', 'student-cep', 'student-email', 
                'student-birthdate', 'student-gender'
            ];
            
            // 1. Limpa todas as mensagens e classes de erro
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.required-missing').forEach(el => el.classList.remove('required-missing'));
            
            // 2. Aplica novas mensagens e classes para a Aba 'Aluno'
            inputFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                const errorDiv = document.getElementById(`${fieldId}-error`);
                
                if (errorMap[fieldId]) {
                    if (input) input.classList.add('required-missing');
                    if (errorDiv) errorDiv.textContent = errorMap[fieldId];
                }
            });
            
            // Tratamento especial para o telefone (3 inputs)
            if (errorMap['student-phone']) {
                ['student-phone-ddi', 'student-phone-ddd', 'student-phone-number'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.classList.add('required-missing');
                });
                const phoneErrorDiv = document.getElementById('student-phone-error');
                if (phoneErrorDiv) phoneErrorDiv.textContent = errorMap['student-phone'];
            }
            
            // Tratamento especial para G√™nero Outros (Select) - √â OPCIONAL, mas se 'Outros' for selecionado, o sub-campo √© exigido.
            const genderSelect = document.getElementById('student-gender');
            if (genderSelect && genderSelect.value === 'Outros') {
                 const genderOtherSelect = document.getElementById('student-gender-other-select');
                 const errorDiv = document.getElementById('student-gender-other-error');
                 
                 if (!genderOtherSelect.value || genderOtherSelect.value === OTHER_GENDERS_OPTIONS[0].value) {
                     genderOtherSelect.classList.add('required-missing');
                     errorDiv.textContent = "Especifique o G√™nero selecionado.";
                     errors.push({field: 'student-gender-other', message: "Especifique o G√™nero selecionado."});
                 } else {
                     genderOtherSelect.classList.remove('required-missing');
                     errorDiv.textContent = "";
                 }
            }


            // 3. Aplica classes vermelhas nos cont√™ineres das Abas de Conex√£o (se houver erros)
            const respContainer = document.getElementById('linked-responsibles-list-container');
            const instContainer = document.getElementById('linked-institutions-list-container');
            
            if (respContainer && errorMap['linked-responsibles-list-container']) {
                 respContainer.classList.add('required-missing');
            }
            if (instContainer && errorMap['linked-institutions-list-container']) {
                 instContainer.classList.add('required-missing');
            }

            // 4. Retorna true SE n√£o houver erros nos campos ESSENCIAIS + Regras de Neg√≥cio (menores).
            const essentialErrors = errors.filter(err => 
                 err.field === 'student-name' || 
                 err.field === 'student-phone' || 
                 err.field === 'student-cep' ||
                 err.field === 'linked-responsibles-list-container' ||
                 err.field === 'linked-institutions-list-container' ||
                 err.field === 'student-gender-other'
            );

            return essentialErrors.length === 0;
        }

        // Fun√ß√£o √öNICA para verificar o status de completude (Agora s√≥ depende do essencial + regras de neg√≥cio)
        function isFormComplete() {
            return validateDataTab();
        }
        
        // NOVO: Fun√ß√£o para verificar e atualizar o status do bot√£o Salvar, que agora s√≥ exige o m√≠nimo
        function checkMinimumSaveStatus() {
            const isMinComplete = isMinimumDataForSaveComplete();
            const saveButton = document.getElementById('global-save-btn');
            
            if (saveButton) {
                 if (isMinComplete) {
                      saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
                 } else {
                      saveButton.classList.add('opacity-50', 'cursor-not-allowed');
                 }
            }
            
            // Mant√©m a l√≥gica de desabilitar abas de conex√£o se o m√≠nimo n√£o for atingido
            updateTabIndicators();
        }

        function updateStatusBadge(isComplete) {
            const badge = document.getElementById('profile-status-badge');

            if (!badge) return;
            
            // updateTabIndicators agora √© chamado aqui e em checkMinimumSaveStatus
            
            if (isComplete) {
                badge.textContent = "ATIVO";
                badge.classList.remove('bg-yellow-100', 'text-yellow-800');
                badge.classList.add('bg-green-100', 'text-green-800');
                badge.title = "Todos os campos obrigat√≥rios foram preenchidos.";
            } else {
                badge.textContent = "INATIVO";
                badge.classList.remove('bg-green-100', 'text-green-800');
                badge.classList.add('bg-yellow-100', 'text-yellow-800');
                badge.title = "Preencha todos os campos obrigat√≥rios para ativar o perfil.";
            }
            
            updateGlobalButtonText(activeTabId);
        }
        
        // --- FIM VALIDA√á√ÉO E STATUS ---

        function renderSummary(data) {
            const summaryPanel = document.getElementById('summary-panel');
            
            // Remove o conte√∫do do painel para reconstruir
            summaryPanel.innerHTML = '';
            
            const isDataAvailable = data && data.name;

            if (!isDataAvailable) {
                 summaryPanel.className = 'p-4 rounded-xl shadow-md border border-gray-200 bg-white';
                 summaryPanel.innerHTML = `<p class="text-gray-500 text-sm italic">Preencha o formul√°rio e clique em Salvar para criar o perfil do aluno e visualizar o resumo aqui.</p>`;
                 updateStatusBadge(false);
                 return;
            }

            // Se houver dados, renderiza a etiqueta completa
            summaryPanel.className = 'bg-blue-50 p-4 rounded-xl shadow-md border border-blue-200';
            summaryPanel.innerHTML = `
                 <p class="text-sm font-semibold text-blue-800 flex items-center mb-2">
                     <span class="material-symbols-rounded text-lg mr-1">person</span> Perfil Atual
                     <span id="profile-status-badge" class="ml-auto text-xs font-bold px-3 py-1 rounded-full"></span>
                 </p>
                 <div id="summary-content"></div>
                 <div id="inactive-reason" class="hidden">
                     <ul id="incomplete-list" class="list-disc list-inside text-xs text-yellow-900 ml-4 mt-1"></ul>
                 </div>
            `;
            
            const summaryContent = document.getElementById('summary-content');
            // isFormComplete √© chamado aqui para definir o status ATIVO/INATIVO.
            const isComplete = isFormComplete(); 
            updateStatusBadge(isComplete);

            let respHtml = '';
            let tutorHtml = '';
            let instHtml = '';

            const responsibles = data.responsibles;
            respHtml += `<p class="text-xs text-gray-600 font-semibold mt-2">Respons√°veis Vinculados (${responsibles.length}):</p>`;
            if (responsibles.length > 0) {
                responsibles.forEach(r => {
                     const cepDisplay = r.cep ? ` | CEP: ${r.cep}` : ''; 
                     respHtml += `<p class="text-xs text-gray-600 ml-3">üë§ ${r.name} (${r.relationship || 'N√£o informado'})${cepDisplay} | üìû ${r.phone || 'N√£o informado'}</p>`; 
                });
            } else {
                respHtml += `<p class="text-xs text-gray-500 ml-3 font-semibold">Nenhum respons√°vel vinculado.</p>`;
            }
                
            
            if (data.tutors && data.tutors.length > 0) {
                 tutorHtml += `<p class="text-xs text-gray-600 font-semibold mt-2">Professores/Tutores (${data.tutors.length}):</p>`;
                 data.tutors.forEach(t => {
                     tutorHtml += `<p class="text-xs text-gray-600 ml-3">üéì ${t.name}</p>`;
                 });
            } else {
                tutorHtml += `<p class="text-xs text-gray-500 ml-3 font-semibold">Nenhum tutor vinculado.</p>`;
            }
            
            
            const institutions = data.linkedInstitutions;
            
            instHtml += `<p class="text-xs text-gray-600 font-semibold mt-2">V√≠nculos Institucionais (${institutions.length}):</p>`;
            if (institutions.length > 0) {
                institutions.forEach(inst => {
                    const roomDisplay = inst.room ? ` | Sala: ${inst.room}` : '';
                    const isCompleteLink = inst.enrollment && inst.course;

                     instHtml += `<p class="text-xs ${isCompleteLink ? 'text-gray-600' : 'text-red-500 font-semibold'} ml-3">
                            üè´ ${inst.name} (${inst.course || 'Curso Pendente'})
                        </p>`; 
                     instHtml += `<p class="text-xs text-gray-500 ml-6">Matr√≠cula: ${inst.enrollment || 'Pendente'}${roomDisplay}</p>`; 
                });
            } else {
                instHtml += `<p class="text-xs text-gray-500 ml-3 font-semibold">Nenhuma institui√ß√£o vinculada.</p>`;
            }

            const genderValue = data.gender || '';
            const genderOtherValue = data.genderOther || '';
            let genderDisplay = 'N√£o Informado';
            
            if (genderValue === 'Feminino' || genderValue === 'Masculino') {
                genderDisplay = genderValue;
            } else if (genderValue === 'Outros' && genderOtherValue) {
                genderDisplay = genderOtherValue; 
            } else if (genderValue === 'NaoInformado') {
                genderDisplay = 'N√£o Informado';
            }

            const cepDisplay = data.cep || 'Pendente';
            const birthdateDisplay = data.birthdate ? data.birthdate : 'Pendente';


            summaryContent.innerHTML = `
                <p class="text-sm font-bold text-gray-700 flex items-center"><span class="material-symbols-rounded text-lg mr-1 text-blue-500">person</span> ${data.name}</p>
                <div class="mt-2 space-y-1">
                    <p class="text-xs text-gray-600 font-semibold">Aluno:</p>
                    <p class="text-xs text-gray-600 ml-3">üìû ${data.phone} | üìç CEP: ${cepDisplay}</p>
                    <p class="text-xs text-gray-600 ml-3">Nasc.: ${birthdateDisplay || 'N√£o informado'} | G√™nero: ${genderDisplay} | üìß ${data.email || 'N√£o informado'}</p>

                    ${respHtml}
                    ${tutorHtml}
                    ${instHtml}

                </div>
                <p class="text-xs text-blue-500 mt-3">√öltima atualiza√ß√£o: ${data.updated}</p>
            `;
            
            renderLinkedResponsibles(); 
            renderLinkedTutors(); 
            renderLinkedInstitutions(); 
        }
        
        function updateTabIndicators() {
            const isMinData = isMinimumDataForSaveComplete(); // Usa a nova verifica√ß√£o m√≠nima
            
            const connectionTabs = ['responsibles', 'tutors', 'institution'];
            connectionTabs.forEach(id => {
                const tab = document.getElementById(`tab-${id}`);
                if (isMinData) {
                    tab.classList.remove('text-gray-400', 'cursor-not-allowed');
                } else {
                    tab.classList.add('text-gray-400', 'cursor-not-allowed');
                }
            });

             // A l√≥gica do bot√£o Salvar foi movida para checkMinimumSaveStatus()
        }
        
        function markMissingFields() {
            // Esta fun√ß√£o s√≥ √© chamada indiretamente pelo isFormComplete()
            isFormComplete();
        }


        function collectFormData() {
            const phoneDdi = document.getElementById('student-phone-ddi');
            const phoneDdd = document.getElementById('student-phone-ddd');
            const phoneNumber = document.getElementById('student-phone-number');
            const cepInput = document.getElementById('student-cep');
            const genderSelect = document.getElementById('student-gender');
            const genderOtherSelect = document.getElementById('student-gender-other-select');
            const birthdateInput = document.getElementById('student-birthdate');
            
            const fullPhone = `${phoneDdi.value.trim()} (${phoneDdd.value.trim()}) ${phoneNumber.value.trim()}`.replace(/\s+/g, ' ').trim();


            const data = {
                profileType: 'student',
                name: document.getElementById('student-name').value.trim(),
                phone: fullPhone,
                ddi: phoneDdi.value.trim(),
                ddd: phoneDdd.value.trim(),
                nationalNumber: phoneNumber.value.trim(),
                cep: maskCep(cepInput.value.trim()),
                birthdate: birthdateInput.value.trim(), 
                gender: genderSelect.value, 
                email: document.getElementById('student-email').value.trim(),
                
                responsibles: linkedResponsibles, 
                tutors: linkedTutors, 
                linkedInstitutions: linkedInstitutions, 
                
                updated: new Date().toLocaleString('pt-BR'),
            };

            if (genderSelect.value === 'Outros' && genderOtherSelect) {
                data.genderOther = genderOtherSelect.value.trim();
            } else {
                data.genderOther = '';
            }
            
            return data;
        }

        window.checkFormStatusAndSave = function() {
            const data = collectFormData();
            
            // Valida o m√≠nimo para o bot√£o Salvar
            checkMinimumSaveStatus();

            // Se o nome n√£o estiver preenchido, n√£o salvamos nem renderizamos resumo completo
            if (data.name) {
                // Se houver nome, faz a valida√ß√£o completa (que atualiza o badge ATIVO/INATIVO)
                isFormComplete();
                saveStudentData(data);
                renderSummary(data);
            } else {
                // Se o nome estiver vazio, garantimos que o resumo volte ao estado inicial.
                renderSummary(null);
            }
        }
        
        function handleGenderChange() {
            const select = document.getElementById('student-gender');
            const otherFieldDiv = document.getElementById('gender-other-field');
            const otherSelect = document.getElementById('student-gender-other-select');
            
            if (select.value === 'Outros') {
                otherFieldDiv.classList.remove('hidden');
                if (otherSelect) {
                    otherSelect.focus();
                }
            } else {
                otherFieldDiv.classList.add('hidden');
                if(otherSelect) otherSelect.value = OTHER_GENDERS_OPTIONS[0].value;
            }
             window.checkFormStatusAndSave();
        }

        function populateOtherGendersSelect() {
            const select = document.getElementById('student-gender-other-select');
            if (!select) return;

            select.innerHTML = '';
            OTHER_GENDERS_OPTIONS.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                select.appendChild(opt);
            });
        }

        window.changeTab = function(tabId) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            const globalActionsContainer = document.getElementById('global-actions-buttons');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.add('hidden'));
            
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            
            activeTabId = tabId;
            updateGlobalButtonText(tabId);
            startHideGlobalButtonTextTimer();

            if (tabId === 'data' && globalActionsContainer) {
                 globalActionsContainer.classList.remove('hidden');
            } else if (globalActionsContainer) {
                 globalActionsContainer.classList.add('hidden');
            }
        }

        function createEmptyLinkCard(borderColor, textColor, type) {
            const icon = type === 'institutions' ? 'school' : (type === 'responsibles' ? 'diversity_3' : 'person_check'); 
            const titleText = type === 'institutions' ? 'Institui√ß√£o Pendente' : (type === 'responsibles' ? 'Respons√°vel Pendente' : 'Tutor Pendente');
            
            return `
                <div class="profile-card bg-white border-gray-200 border-l-4 ${borderColor} shadow-sm opacity-50 w-full md:w-auto" style="cursor: default; height: 100px;"> 
                    <div class="flex items-start space-x-4 w-full min-w-0">
                        <span class="material-symbols-rounded text-3xl ${textColor} pt-1">${icon}</span>
                        <div class="flex-1 min-w-0 space-y-1">
                            <p class="text-lg font-bold ${textColor} truncate">${titleText}</p>
                            <div class="h-2 bg-gray-300 rounded w-1/2"></div>
                            <div class="h-2 bg-gray-300 rounded w-1/3"></div>
                        </div>
                    </div>
                    <button type="button" class="text-gray-400 p-2 rounded-full flex-shrink-0 cursor-default">
                        <span class="material-symbols-rounded text-xl">close</span>
                    </button>
                </div>
            `;
        }

        function renderLinkedItems(containerId, items, type) {
            const listContainer = document.getElementById(containerId);
            if (!listContainer) return;

            const placeholderIdMap = {
                'responsibles': 'responsibles-placeholder-cards',
                'tutors': 'tutors-placeholder-cards',
                'institutions': 'institution-placeholder-cards'
            };
            
            const placeholderContainer = document.getElementById(placeholderIdMap[type]);
            
            const removeMap = {
                responsibles: 'removeResponsible',
                tutors: 'removeTutor',
                institutions: 'removeInstitution'
            };
            
            let themeBorderColor;
            let themeTextColor;

            switch (type) {
                case 'responsibles':
                    themeBorderColor = 'border-violet-400';
                    themeTextColor = 'text-violet-600';
                    break;
                case 'tutors':
                    themeBorderColor = 'border-emerald-400';
                    themeTextColor = 'text-emerald-600';
                    break;
                case 'institutions':
                    themeBorderColor = 'border-pink-400';
                    themeTextColor = 'text-pink-600';
                    break;
            }


            if (items.length === 0) {
                listContainer.innerHTML = '';
                if (placeholderContainer) {
                    placeholderContainer.innerHTML = [0, 1, 2].map(index => createEmptyLinkCard(themeBorderColor, themeTextColor, type)).join('');
                    placeholderContainer.classList.remove('hidden');
                }
                return;
            }

            if (placeholderContainer) {
                 placeholderContainer.classList.add('hidden');
            }

            listContainer.innerHTML = items.map((item, index) => {
                let iconName, title, subtitle, detailsHtml;
                let isComplete = true;
                const removeFunctionName = removeMap[type];
                
                let itemIconClass = themeTextColor;
                let cardClickAction = '';

                switch (type) {
                    case 'responsibles':
                        iconName = 'diversity_3';
                        title = item.name;
                        subtitle = `<span class="text-xs font-semibold bg-gray-200 text-gray-800 px-2 rounded-full">${item.relationship || 'N√£o Informado'}</span>`;
                        detailsHtml = `<p class="text-sm text-gray-600">üìû ${item.phone || 'N/A'} | üìß ${item.email || 'N/A'}${item.cep ? ` | CEP: ${item.cep}` : ''}</p>`;
                        break;
                    
                    case 'tutors':
                        iconName = 'person_check';
                        title = item.name;
                        subtitle = `<span class="text-xs font-semibold bg-gray-200 text-gray-800 px-2 rounded-full">Tutor/Mentor</span>`;
                        detailsHtml = '';
                        break;

                    case 'institutions':
                        iconName = 'school';
                        isComplete = item.enrollment && item.course;
                        
                        itemIconClass = isComplete ? themeTextColor : 'text-red-500';
                        title = item.name;
                        subtitle = `<p class="text-xs ${isComplete ? 'text-gray-800' : 'text-red-600'}">
                                    ${item.course || 'Curso Pendente'} | Matr√≠cula: ${item.enrollment || 'Pendente'}
                                </p>`;
                        detailsHtml = item.room ? `<p class="text-sm text-gray-600">Sala: ${item.room}</p>` : '';
                        break;
                }

                return `
                    <div class="profile-card bg-white border-gray-200 border-l-4 ${themeBorderColor} shadow-sm hover:bg-gray-50 ${!isComplete ? 'bg-red-50 border-red-400' : ''}"
                        ${cardClickAction} style="cursor: pointer;"> 
                        <div class="flex items-start space-x-4 w-full min-w-0">
                            <span class="material-symbols-rounded text-3xl ${itemIconClass} pt-1">${iconName}</span>
                            <div class="flex-1 min-w-0">
                                <p class="text-lg font-bold ${themeTextColor} truncate">${title}</p>
                                ${subtitle}
                                <div class="text-sm text-gray-600 space-y-0.5 mt-1">
                                    ${detailsHtml}
                                </div>
                            </div>
                        </div>
                        <button type="button" 
                                onclick="event.stopPropagation(); window.${removeFunctionName}(${index});" 
                                class="text-gray-400 hover:text-red-600 transition p-2 rounded-full flex-shrink-0"
                                title="Remover V√≠nculo">
                            <span class="material-symbols-rounded text-xl">close</span>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderLinkedResponsibles() { renderLinkedItems('linked-responsibles-list', linkedResponsibles, 'responsibles'); }
        function renderLinkedTutors() { renderLinkedItems('linked-tutors-list', linkedTutors, 'tutors'); }
        function renderLinkedInstitutions() { renderLinkedItems('linked-institutions-list', linkedInstitutions, 'institutions'); }

        window.addResponsible = function(selectedId) {
            if (!selectedId) return;
            
            const availableResponsibles = getAvailableResponsibles();

            if (linkedResponsibles.some(r => r.id === selectedId)) {
                setStatus("Este respons√°vel j√° est√° vinculado ao aluno.", "warn");
                return;
            }

            const responsibleToAdd = availableResponsibles.find(r => r.id === selectedId);

            if (responsibleToAdd) {
                linkedResponsibles.push(responsibleToAdd); 
                renderLinkedResponsibles();
                setStatus(`Respons√°vel "${responsibleToAdd.name}" adicionado com sucesso.`, "ok");
            }

            window.checkFormStatusAndSave();
        }

        window.removeResponsible = function(index) {
            const respName = linkedResponsibles[index].name;
            linkedResponsibles.splice(index, 1);
            
            renderLinkedResponsibles();
            setStatus(`Respons√°vel ${respName} removido.`, "warn");

            window.checkFormStatusAndSave();
        }

        function handleResponsibleSelectChange(e) {
             const selectedId = e.target.value;
             if (selectedId) {
                 window.addResponsible(selectedId);
                 e.target.value = ""; 
             }
        }
        
        function populateResponsibleSelect(select) {
            const availableResponsibles = getAvailableResponsibles();
            
            if (select) select.removeEventListener('change', handleResponsibleSelectChange);

            select.innerHTML = ''; 

            if (availableResponsibles.length === 0) {
                select.innerHTML = '<option value="">-- N√£o h√° Respons√°veis Dispon√≠veis para V√≠nculo --</option>';
                select.disabled = true;
                return;
            }
            
            select.disabled = false;
            
            select.innerHTML = '<option value="">-- Selecionar um Respons√°vel --</option>';

            availableResponsibles.forEach(resp => {
                const option = document.createElement('option');
                option.value = resp.id;
                option.textContent = `${resp.name} (${resp.relationship})`; 
                select.appendChild(option);
            });
            
            select.addEventListener('change', handleResponsibleSelectChange);
        }

        window.addTutor = function(selectedId) {
            if (!selectedId) return;
            
            const availableTutors = getAvailableTutors();

            if (linkedTutors.some(t => t.id === selectedId)) {
                setStatus("Este tutor j√° est√° vinculado ao aluno.", "warn");
                return;
            }

            const tutorToAdd = availableTutors.find(t => t.id === selectedId);

            if (tutorToAdd) {
                linkedTutors.push({ id: tutorToAdd.id, name: tutorToAdd.name }); 
                renderLinkedTutors();
                setStatus(`Tutor "${tutorToAdd.name}" adicionado com sucesso.`, "ok");
            }

            window.checkFormStatusAndSave();
        }
        
        window.removeTutor = function(index) {
            const tutorName = linkedTutors[index].name;
            linkedTutors.splice(index, 1);
            renderLinkedTutors();
            setStatus(`V√≠nculo com "${tutorName}" removido.`, "warn");

            window.checkFormStatusAndSave();
        }

        function handleTutorSelectChange(e) {
             const selectedId = e.target.value;
             if (selectedId) {
                 window.addTutor(selectedId);
                 e.target.value = ""; 
             }
        }
        
        function populateTutorSelect(select) {
            const availableTutors = getAvailableTutors();
            
            if (select) select.removeEventListener('change', handleTutorSelectChange);

            select.innerHTML = ''; 

            if (availableTutors.length === 0) {
                select.innerHTML = '<option value="">-- N√£o h√° Tutores Dispon√≠veis para V√≠nculo --</option>';
                select.disabled = true;
                return;
            }
            
            select.disabled = false;
            
            select.innerHTML = '<option value="">-- Selecionar um Tutor --</option>';

            availableTutors.forEach(tutor => {
                const option = document.createElement('option');
                option.value = tutor.id;
                option.textContent = tutor.name; 
                select.appendChild(option);
            });
            
            select.addEventListener('change', handleTutorSelectChange);
        }
        
        function handleInstitutionSelectChange(e) {
             const selectedId = e.target.value;
             const detailsFields = document.getElementById('institution-details-fields');
             const selectedNameEl = document.getElementById('selected-institution-name');
             
             document.getElementById('temp-enrollment').value = '';
             document.getElementById('temp-course').value = '';
             document.getElementById('temp-room').value = '';

             if (selectedId) {
                 const availableInstitutions = getAvailableInstitutions();
                 currentInstitutionToLink = availableInstitutions.find(inst => inst.id === selectedId);
                 
                 if (currentInstitutionToLink) {
                     selectedNameEl.textContent = currentInstitutionToLink.name;
                     detailsFields.classList.remove('hidden');
                 }
             } else {
                 currentInstitutionToLink = null;
                 detailsFields.classList.add('hidden');
             }
        }

        window.linkInstitution = function() {
            if (!currentInstitutionToLink) {
                setStatus("Selecione uma institui√ß√£o primeiro.", "warn");
                return;
            }
            
            const enrollment = document.getElementById('temp-enrollment').value.trim();
            const course = document.getElementById('temp-course').value.trim();
            const room = document.getElementById('temp-room').value.trim();

            if (!enrollment || !course) {
                setStatus("Matr√≠cula/ID e Curso s√£o obrigat√≥rios para vincular a institui√ß√£o.", "error");
                return;
            }
            
            if (linkedInstitutions.some(inst => inst.id === currentInstitutionToLink.id)) {
                setStatus(`A institui√ß√£o "${currentInstitutionToLink.name}" j√° est√° vinculada.`, "warn");
                return;
            }

            const newLink = {
                id: currentInstitutionToLink.id,
                name: currentInstitutionToLink.name,
                enrollment: enrollment,
                course: course,
                room: room
            };

            linkedInstitutions.push(newLink);
            renderLinkedInstitutions();
            setStatus(`V√≠nculo com "${currentInstitutionToLink.name}" (Matr√≠cula: ${enrollment}) criado com sucesso.`, "ok");
            
            const selectElement = document.getElementById('new-institution-select');
            if (selectElement) selectElement.value = '';
            document.getElementById('institution-details-fields').classList.add('hidden');
            currentInstitutionToLink = null;

            window.checkFormStatusAndSave();
        }
        
        window.removeInstitution = function(index) {
            const instName = linkedInstitutions[index].name;
            linkedInstitutions.splice(index, 1);
            renderLinkedInstitutions();
            setStatus(`V√≠nculo com a institui√ß√£o "${instName}" removido.`, "warn");

            window.checkFormStatusAndSave();
        }
        
        function populateInstitutionSelect(select) {
            const availableInstitutions = getAvailableInstitutions();
            
            if (select) select.removeEventListener('change', handleInstitutionSelectChange);

            select.innerHTML = ''; 

            if (availableInstitutions.length === 0) {
                select.innerHTML = '<option value="">-- N√£o h√° Institui√ß√µes Dispon√≠veis para V√≠nculo --</option>';
                select.disabled = true;
                return;
            }
            
            select.disabled = false;
            
            select.innerHTML = '<option value="">-- Selecionar Institui√ß√£o --</option>';

            availableInstitutions.forEach(inst => {
                const option = document.createElement('option');
                const uniqueId = inst.id || inst.name;
                option.value = uniqueId;
                option.textContent = inst.name; 
                select.appendChild(option);
            });
            
            select.addEventListener('change', handleInstitutionSelectChange);
        }
        
        function clearActiveTabFields() {
             if (activeTabId === 'data') {
                 clearDataTab();
             } else if (activeTabId === 'institution') {
                 clearInstitutionLinks();
             }
        }

        function renderConnectionTab(containerId, listTitle, actionTitle, tabId, populateFunction, hasDetailsForm) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const themeBorderColor = (tabId === 'responsibles') ? 'border-violet-200' : 
                                    (tabId === 'tutors') ? 'border-emerald-200' : 'border-pink-200';
            const themeTextColor = (tabId === 'responsibles') ? 'text-violet-700' : 
                                  (tabId === 'tutors') ? 'text-emerald-700' : 'text-pink-700';

            let detailsFormHtml = '';
            if (hasDetailsForm) {
                detailsFormHtml = `
                    <div id="institution-details-fields" class="space-y-4 hidden border-t pt-4 mt-4">
                        <h5 class="text-sm font-semibold text-gray-700">Detalhes do V√≠nculo na <span id="selected-institution-name" class="font-bold text-pink-600"></span>:</h5>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="temp-enrollment" class="block text-sm font-medium text-gray-700 mb-1">Matr√≠cula/ID (Obrigat√≥rio)</label>
                                <input type="text" id="temp-enrollment" placeholder="Ex: 123456" class="form-input"/>
                            </div>
                            <div>
                                <label for="temp-course" class="block text-sm font-medium text-gray-700 mb-1">Curso / √Årea (Obrigat√≥rio)</label>
                                <input type="text" id="temp-course" placeholder="Ex: Ensino M√©dio" class="form-input"/>
                            </div>
                            <div>
                                <label for="temp-room" class="block text-sm font-medium text-gray-700 mb-1">Sala / Turma (Opcional)</label>
                                <input type="text" id="temp-room" placeholder="Ex: 3¬∫ A, Tarde" class="form-input"/>
                            </div>
                        </div>

                        <button type="button" id="link-institution-btn" 
                                class="w-full mt-4 px-4 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition flex items-center justify-center">
                            <span class="material-symbols-rounded align-middle mr-1 text-base">link</span>
                            Vincular Detalhes e Concluir
                        </button>
                    </div>
                `;
            }

            container.innerHTML = `
                <div id="linked-${tabId}-list-container" class="space-y-4 border ${themeBorderColor} p-4 rounded-lg">
                    <h3 class="text-base font-semibold ${themeTextColor} px-2 flex items-center">
                        <span class="material-symbols-rounded mr-2 text-base">${tabId === 'responsibles' ? 'diversity_3' : (tabId === 'tutors' ? 'diversity_1' : 'school')}</span>
                        <span>${listTitle}</span>
                    </h3>
                    
                    <div class="space-y-2">
                        <div id="linked-${tabId}-list" class="space-y-2"></div>
                        <div id="${tabId}-placeholder-cards" class="space-y-2 hidden grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <div class="space-y-4 border ${themeBorderColor} p-4 rounded-lg bg-white">
                    <h5 class="text-base font-semibold ${themeTextColor} px-2">${actionTitle}</h5>
                    <div class="grid grid-cols-1 gap-4 items-end">
                        <div class="col-span-1">
                            <label for="new-${tabId}-select" class="block text-sm font-medium text-gray-700 mb-1">Selecione o V√≠nculo</label>
                            <select id="new-${tabId}-select" class="form-input" disabled>
                                <option value="">-- Carregando Dados --</option>
                            </select>
                        </div>
                    </div>
                    ${detailsFormHtml}
                </div>
            `;
            
            const selectElement = document.getElementById(`new-${tabId}-select`);
            if (selectElement) {
                populateFunction(selectElement);
            }
            
            if (tabId === 'institution') {
                const instSelect = document.getElementById('new-institution-select');
                if (instSelect) instSelect.addEventListener('change', handleInstitutionSelectChange); 
                
                const linkBtn = document.getElementById('link-institution-btn');
                if (linkBtn) linkBtn.addEventListener('click', window.linkInstitution);
            }

            if (tabId === 'responsibles') renderLinkedResponsibles();
            else if (tabId === 'tutors') renderLinkedTutors();
            else if (tabId === 'institution') renderLinkedInstitutions();

        }

        function initConnectionTabs() {
            initConnectionTabs.hasRun = true;
            renderConnectionTab(
                'content-responsibles',
                'Respons√°veis Vinculados',
                'Vincular Respons√°vel',
                'responsibles',
                populateResponsibleSelect,
                false
            );

            renderConnectionTab(
                'content-tutors',
                'Tutores Vinculados',
                'Vincular Tutor',
                'tutors',
                populateTutorSelect,
                false
            );

            renderConnectionTab(
                'content-institution',
                'V√≠nculos Acad√™micos (Matr√≠cula, Curso, Sala)',
                'Vincular Nova Institui√ß√£o',
                'institution',
                populateInstitutionSelect,
                true
            );
        }
        
        window.handleGlobalAction = function(action) {
            const tab = activeTabId;
            let message = '';
            let type = 'warn';
            const saveBtn = document.getElementById('global-save-btn');


            showGlobalButtonText();

            switch (action) {
                case 'save':
                    // Se o bot√£o n√£o estiver opaco (ou seja, se o m√≠nimo foi preenchido), prossegue
                    if (!saveBtn.classList.contains('opacity-50')) {
                        
                        // Executa a valida√ß√£o completa (que exibe erros inline)
                        if (isFormComplete()) {
                            const data = collectFormData();
                            saveStudentData(data);
                            renderSummary(data);
                            
                            // Flash de Sucesso
                            if (saveBtn) {
                                saveBtn.style.transition = 'background-color 0.1s ease-in-out, color 0.1s ease-in-out';
                                saveBtn.style.backgroundColor = '#10b981'; 
                                saveBtn.style.color = 'white';
                                saveBtn.style.borderColor = '#10b981';
                                
                                setTimeout(() => {
                                    saveBtn.style.backgroundColor = 'white'; 
                                    saveBtn.style.color = 'var(--chip-color-text-save)'; 
                                    saveBtn.style.borderColor = 'var(--chip-color-border-save)';
                                }, 500); 
                            }

                            message = "Dados salvos e perfil ATIVO.";
                            type = "ok";
                        } else {
                            message = "O perfil est√° INATIVO. Corrija os campos em vermelho na Aba Aluno.";
                            type = "error";
                            // A fun√ß√£o isFormComplete j√° chama validateDataTab() que for√ßa a exibi√ß√£o dos erros inline.
                        }
                    } else {
                         message = "Preencha o Nome, Telefone e CEP para salvar.";
                         type = "warn";
                         // For√ßa a valida√ß√£o m√≠nima para exibir os erros desses campos essenciais.
                         validateDataTab();
                    }
                    break;
            }
            
            setStatus(message, type);
            startHideGlobalButtonTextTimer();
        }

        function updateGlobalButtonText(tabId) {
            const saveBtnText = document.getElementById('save-btn-text');
            if (!saveBtnText) return;

            // Se o formul√°rio est√° completamente OK, mostra Salvar Perfil, caso contr√°rio, Rascunho.
            // A opacidade √© controlada pelo status M√çNIMO, n√£o pelo status COMPLETO.
            saveBtnText.textContent = isFormComplete() ? "Salvar Perfil" : "Salvar Rascunho";
        }
        
        function hideGlobalButtonText() {
            const container = document.getElementById('global-actions-buttons');
            if (container) {
                 container.classList.add('hidden-text');
            }
        }
        
        function showGlobalButtonText() {
            const container = document.getElementById('global-actions-buttons');
            if (container) {
                 clearTimeout(hideTimeout);
                 container.classList.remove('hidden-text');
            }
        }
        
        function startHideGlobalButtonTextTimer() {
            showGlobalButtonText();
            clearTimeout(hideTimeout);
            hideTimeout = setTimeout(hideGlobalButtonText, 3000); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('student-form');
            const genderSelect = document.getElementById('student-gender');
            
            const globalActionsContainer = document.getElementById('global-actions-buttons');
            
            populateOtherGendersSelect();
            initConnectionTabs(); 

            const savedData = getStudentData(); 
            
            renderSummary(savedData);

            const phoneDdiInput = document.getElementById('student-phone-ddi');
            const phoneDddInput = document.getElementById('student-phone-ddd');
            const nationalPhoneInput = document.getElementById('student-phone-number');
            const cepInput = document.getElementById('student-cep');
            const dateInput = document.getElementById('student-birthdate');
            const nameInput = document.getElementById('student-name');
            const emailInput = document.getElementById('student-email');
            const otherGenderSelect = document.getElementById('student-gender-other-select');
            
            
            // Listener de valida√ß√£o em tempo real removido
            // A valida√ß√£o ocorrer√° apenas no click do bot√£o Salvar e no change/blur que chama checkFormStatusAndSave

            phoneDdiInput.addEventListener('input', (e) => { 
                e.target.value = e.target.value.replace(/[^\d+]/g, '').substring(0, 4); 
                handleFixedLengthJump(phoneDdiInput, 'student-phone-ddd');
                checkMinimumSaveStatus(); 
            });
            
            phoneDddInput.addEventListener('input', (e) => { 
                e.target.value = maskDDD(e.target.value); 
                handleFixedLengthJump(phoneDddInput, 'student-phone-number');
                checkMinimumSaveStatus(); 
            });
            
            nationalPhoneInput.addEventListener('input', (e) => { 
                e.target.value = maskNationalPhone(e.target.value); 
                
                const ddi = document.getElementById('student-phone-ddi').value.trim();
                const cleanNumber = e.target.value.replace(/\D/g, "");
                
                if (ddi === '+55' && cleanNumber.length === 9) {
                     handleFixedLengthJump(nationalPhoneInput, 'student-cep');
                }
                checkMinimumSaveStatus(); 
            });

            cepInput.addEventListener('input', (e) => {
                e.target.value = maskCep(e.target.value);
                handleFixedLengthJump(cepInput, 'student-email');
                checkMinimumSaveStatus(); 
            });

            dateInput.addEventListener('input', (e) => {
                e.target.value = maskDate(e.target.value);
                handleFixedLengthJump(dateInput, 'student-gender');
                checkMinimumSaveStatus(); 
            });
            
            // Adiciona listener gen√©rico para atualizar o status global (opacidade do bot√£o)
            const globalStatusListeners = (input) => {
                 input.addEventListener('blur', () => {
                     window.checkFormStatusAndSave();
                 });
                 // Adiciona listener de input para campos de texto/email (sem m√°scara)
                 if (input.tagName === 'INPUT' && !input.classList.contains('js-mask')) {
                    input.addEventListener('input', checkMinimumSaveStatus);
                 }
            };

            [nameInput, emailInput, genderSelect, dateInput].forEach(input => {
                if (input) globalStatusListeners(input);
            });

            // NOVO: Faz o cursor pular para um estado inativo (blur) ap√≥s selecionar o G√™nero Espec√≠fico
            if (otherGenderSelect) {
                 otherGenderSelect.addEventListener('change', () => {
                     otherGenderSelect.blur();
                     window.checkFormStatusAndSave();
                 });
            }

            const allInputs = form.querySelectorAll('input, select, textarea');
            allInputs.forEach(input => {
                const isAddItemField = input.closest('.add-block-container') && !input.id.startsWith('student-');
                
                if (input.tagName !== 'SELECT' && !input.readOnly) {
                    input.addEventListener('keydown', handleEnterKeyFocus);
                }
            });

            genderSelect.addEventListener('change', handleGenderChange);
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
            });
            
            // Inicializa o estado do bot√£o Salvar e o resumo
            window.checkFormStatusAndSave();

            if (globalActionsContainer) {
                globalActionsContainer.classList.remove('hidden'); 

                startHideGlobalButtonTextTimer(); 
                
                globalActionsContainer.addEventListener('mouseenter', showGlobalButtonText);
                globalActionsContainer.addEventListener('mouseleave', startHideGlobalButtonTextTimer);
                
                globalActionsContainer.addEventListener('focusin', showGlobalButtonText);
                globalActionsContainer.addEventListener('focusout', startHideGlobalButtonTextTimer);
            }
        });

    </script>
</body>
</html>
