<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Mensal</title>
    
    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet"/>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fff; }
        
        /* Estilos do Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #93c5fd; border-radius: 20px; } /* Blue-300 */
        
        /* Estilo da Célula Diária */
        .day-cell {
            border-bottom: 1px solid #dbeafe; /* Blue-100 */
            border-right: 1px solid #dbeafe; /* Blue-100 */
            min-height: 120px;
            padding: 4px;
            overflow: hidden;
            position: relative;
        }
        .day-cell:nth-child(7n) { /* Última coluna (Sábado) */
            border-right: none;
        }
        .day-number {
            font-size: 0.75rem;
            font-weight: 600;
            position: absolute;
            top: 4px;
            right: 4px;
            color: #374151; /* Gray-700 */
        }
        .day-is-today {
            background-color: #bfdbfe; /* Blue-200 */
        }

        /* Card de Tarefa Simples */
        .task-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
            margin-top: 2px;
        }
        .task-list-summary {
            font-size: 0.75rem;
            line-height: 1.2;
            color: #3b82f6; /* Blue-600 */
            font-weight: 500;
            cursor: default;
        }
        
        /* Mapeamento de Cores de Categoria (Replicado) */
        .cat-Pessoal { background-color: #3b82f6; } /* Blue-600 */
        .cat-Trabalho { background-color: #10b981; } /* Emerald-500 */
        .cat-Estudo { background-color: #f59e0b; } /* Amber-500 */
        .cat-Outros { background-color: #9ca3af; } /* Gray-400 */

    </style>
</head>
<body class="text-slate-800 antialiased overflow-y-auto">

    <main class="space-y-4">

        <!-- CABEÇALHO -->
        <div class="flex items-center justify-between border-b px-4 pb-4 border-blue-100 sticky top-0 bg-white z-20">
            <h2 class="text-xl font-bold text-blue-600">Agenda Mensal</h2>
            <div class="flex items-center gap-2">
                <button onclick="changeMonth(-1)" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition">
                    <span class="material-symbols-rounded text-lg">arrow_back_ios</span>
                </button>
                <span id="current-month" class="font-semibold text-gray-700">Mês Atual</span>
                <button onclick="changeMonth(1)" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition">
                    <span class="material-symbols-rounded text-lg">arrow_forward_ios</span>
                </button>
            </div>
        </div>
        
        <!-- CALENDÁRIO MENSAL (Grid) -->
        <div class="px-4 pb-4">
            <!-- Cabeçalhos (Dias da Semana) -->
            <div id="grid-header" class="grid grid-cols-7 bg-blue-50 border border-b-0 border-blue-200 rounded-t-lg">
                <div class="text-center p-2 text-sm font-semibold text-gray-700 border-r border-blue-200">Dom</div>
                <div class="text-center p-2 text-sm font-semibold text-gray-700 border-r border-blue-200">Seg</div>
                <div class="text-center p-2 text-sm font-semibold text-gray-700 border-r border-blue-200">Ter</div>
                <div class="text-center p-2 text-sm font-semibold text-gray-700 border-r border-blue-200">Qua</div>
                <div class="text-center p-2 text-sm font-semibold text-gray-700 border-r border-blue-200">Qui</div>
                <div class="text-center p-2 text-sm font-semibold text-gray-700 border-r border-blue-200">Sex</div>
                <div class="text-center p-2 text-sm font-semibold text-gray-700 last:border-r-0">Sáb</div>
            </div>
            
            <!-- Células de Dias -->
            <div id="calendar-grid" class="grid grid-cols-7 border border-blue-200 rounded-b-lg">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
    </main>

    <script type="module">
        const LOCAL_STORAGE_KEY = 'miniapp_tasks';
        
        // Mapeamento de Cores de Categoria (Para os dots)
        const CATEGORY_MAP = {
            'Pessoal': 'cat-Pessoal',
            'Trabalho': 'cat-Trabalho',
            'Estudo': 'cat-Estudo',
            'Outros': 'cat-Outros',
        };

        const STATUS_MAP = {
            'Concluída': { isCompleted: true },
        };

        let currentDisplayDate = new Date(); 
        currentDisplayDate.setDate(1); // Começa no primeiro dia do mês

        // --- FUNÇÕES DE PERSISTÊNCIA ---

        function getTasksFromLocal() {
            const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY);
            try {
                const allTasks = tasksJson ? JSON.parse(tasksJson) : [];
                // Filtra apenas tarefas não concluídas e com prazo definido
                return allTasks.filter(t => !STATUS_MAP[t.status]?.isCompleted && t.dueDate);
            } catch (e) {
                console.error("Erro ao ler tarefas do localStorage:", e);
                return [];
            }
        }
        
        // --- FUNÇÕES DE NAVEGAÇÃO DE MÊS ---

        window.changeMonth = function(delta) {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + delta);
            renderCalendar();
        }

        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }
        
        function getDaysInMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        }

        // --- FUNÇÃO DE RENDERIZAÇÃO PRINCIPAL ---
        
        function renderCalendar() {
            const tasks = getTasksFromLocal();
            const year = currentDisplayDate.getFullYear();
            const month = currentDisplayDate.getMonth();
            const daysInMonth = getDaysInMonth(currentDisplayDate);
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Dom, 6=Sáb

            const todayISO = formatDateISO(new Date());

            const monthFormatter = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('current-month').textContent = monthFormatter.format(currentDisplayDate);

            const gridContainer = document.getElementById('calendar-grid');
            gridContainer.innerHTML = '';
            
            // Agrupar tarefas por data (ISO)
            const tasksByDate = tasks.reduce((acc, task) => {
                const dateKey = task.dueDate;
                if (!acc[dateKey]) acc[dateKey] = [];
                acc[dateKey].push(task);
                return acc;
            }, {});

            let dayCounter = 1;
            let totalCells = 0;

            // 1. Preenche células vazias iniciais
            for (let i = 0; i < firstDayOfMonth; i++) {
                gridContainer.innerHTML += `<div class="day-cell bg-gray-50"></div>`;
                totalCells++;
            }

            // 2. Preenche os dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isoDate = formatDateISO(date);
                const isToday = isoDate === todayISO;

                const dayTasks = tasksByDate[isoDate] || [];
                
                // Gera os dots e resumo das tarefas
                let tasksHtml = '';
                if (dayTasks.length > 0) {
                    // Agrupar dots por categoria
                    const categoryCounts = dayTasks.reduce((acc, task) => {
                        const cat = task.category || 'Outros';
                        acc[cat] = (acc[cat] || 0) + 1;
                        return acc;
                    }, {});

                    tasksHtml = Object.keys(categoryCounts).map(cat => {
                        const colorClass = CATEGORY_MAP[cat] || CATEGORY_MAP['Outros'];
                        return `<div class="flex items-center">
                                    <span class="task-dot ${colorClass}" title="${cat}"></span>
                                    <span class="task-list-summary">${categoryCounts[cat]} ${cat}</span>
                                </div>`;
                    }).join('');
                }

                gridContainer.innerHTML += `
                    <div class="day-cell ${isToday ? 'day-is-today' : 'bg-white'}">
                        <span class="day-number">${day}</span>
                        <div class="mt-5 space-y-1">
                            ${tasksHtml}
                        </div>
                    </div>
                `;
                totalCells++;
            }

            // 3. Preenche células vazias finais
            while (totalCells % 7 !== 0) {
                gridContainer.innerHTML += `<div class="day-cell bg-gray-50 border-r-0"></div>`;
                totalCells++;
            }
            
            // Remove a borda direita da última coluna
            document.querySelectorAll('.day-cell:nth-child(7n)').forEach(el => {
                el.style.borderRight = 'none';
            });
        }
        
        // --- INÍCIO DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();

            // Otimização: Recarregar a cada 5 segundos para refletir mudanças do App de Tarefas
            setInterval(renderCalendar, 5000);
        });

    </script>
</body>
</html>
