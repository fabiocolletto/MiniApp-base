<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento Semanal</title>
    
    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet"/>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fff; }
        
        /* Estilos do Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #a5b4fc; border-radius: 20px; } /* Indigo-300 */
        
        /* Estilo da Célula Diária (para melhor visualização no grid) */
        .day-cell {
            border-right: 1px solid #e0e7ff; /* Indigo-100 */
            min-height: 150px;
        }
        .day-cell:last-child {
            border-right: none;
        }

        /* Estilo do Card de Tarefa */
        .task-card {
            font-size: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s;
        }
        .task-card:hover {
            transform: translateY(-1px);
        }
        
        /* Mapeamento de Cores de Categoria (Replicado do Tasks App) */
        .cat-Pessoal { background-color: #eff6ff; color: #1e40af; } /* Blue-50/700 */
        .cat-Trabalho { background-color: #ecfdf5; color: #047857; } /* Emerald-50/700 */
        .cat-Estudo { background-color: #fffbeb; color: #b45309; } /* Amber-50/800 */
        .cat-Outros { background-color: #f3f4f6; color: #4b5563; } /* Gray-100/600 */
        
        /* Mapeamento de Cores de Status para Vencido/Urgente */
        .status-Vencido { border-left: 4px solid #ef4444; } /* Red */
        .status-Hoje { border-left: 4px solid #f59e0b; } /* Amber */
        .status-Progresso { border-left: 4px solid #3b82f6; } /* Blue */
    </style>
</head>
<body class="text-slate-800 antialiased overflow-y-auto">

    <main class="space-y-4 px-4 py-4">

        <!-- CABEÇALHO -->
        <div class="flex items-center justify-between border-b pb-4 border-indigo-100 sticky top-0 bg-white z-10">
            <h2 class="text-xl font-bold text-indigo-600">Planejamento Semanal</h2>
            <span id="week-range" class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Carregando...</span>
        </div>
        
        <!-- CALENDÁRIO SEMANAL (Grid) -->
        <div id="weekly-grid" class="grid grid-cols-7 border border-indigo-200 rounded-lg overflow-hidden">
            <!-- Cabeçalhos (Dias da Semana) -->
            <div id="grid-header" class="grid grid-cols-7 bg-indigo-50 border-b border-indigo-200 sticky top-[68px] z-10">
                <!-- Conteúdo dinâmico -->
            </div>
            
            <!-- Células de Tarefas -->
            <div id="grid-body" class="grid grid-cols-7">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
        
        <!-- SEÇÃO DE TAREFAS SEM PRAZO -->
        <div class="pt-4 border-t border-gray-200">
            <h3 class="text-base font-semibold text-gray-700 mb-2">Tarefas sem Prazo Definido</h3>
            <div id="undated-tasks" class="space-y-2 text-sm">
                <p class="text-gray-400">Nenhuma tarefa sem prazo.</p>
            </div>
        </div>

    </main>

    <script type="module">
        const LOCAL_STORAGE_KEY = 'miniapp_tasks';
        
        // Mapeamento de cores de categoria (deve ser o mesmo do tasks.html)
        const CATEGORY_COLORS = {
            'Pessoal': 'cat-Pessoal',
            'Trabalho': 'cat-Trabalho',
            'Estudo': 'cat-Estudo',
            'Outros': 'cat-Outros',
        };

        const STATUS_MAP = {
            'Pendente': { color: 'bg-red-200', isCompleted: false },
            'Em Progresso': { color: 'bg-yellow-200', isCompleted: false },
            'Bloqueada': { color: 'bg-gray-300', isCompleted: false },
            'Concluída': { color: 'bg-green-200', isCompleted: true },
        };
        
        // --- FUNÇÕES DE PERSISTÊNCIA ---

        function getTasksFromLocal() {
            const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY);
            try {
                // Filtra apenas tarefas não concluídas para o planejamento
                const allTasks = tasksJson ? JSON.parse(tasksJson) : [];
                return allTasks.filter(t => !STATUS_MAP[t.status]?.isCompleted);
            } catch (e) {
                console.error("Erro ao ler tarefas do localStorage:", e);
                return [];
            }
        }
        
        // Função utilitária para obter o início da semana (Domingo)
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Domingo, 6 = Sábado
            const diff = d.getDate() - day; // Ir para o Domingo
            d.setDate(diff);
            d.setHours(0, 0, 0, 0); // Zera o horário
            return d;
        }

        // Função utilitária para formatar data ISO (YYYY-MM-DD)
        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }

        // --- FUNÇÃO DE RENDERIZAÇÃO PRINCIPAL ---
        
        function renderWeeklyPlanner() {
            const tasks = getTasksFromLocal();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const startOfWeek = getStartOfWeek(today); // Início da semana atual (Domingo)
            const weekDates = [];
            const tasksByDate = {};
            const undatedTasks = [];

            // 1. Preenche as datas da semana e inicializa o agrupamento
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const isoDate = formatDateISO(day);
                weekDates.push({ date: day, isoDate: isoDate, isToday: isoDate === formatDateISO(today) });
                tasksByDate[isoDate] = [];
            }
            
            // 2. Classifica as tarefas
            tasks.forEach(task => {
                // Tarefas devem ter o formato YYYY-MM-DD
                if (task.dueDate && tasksByDate.hasOwnProperty(task.dueDate)) {
                    tasksByDate[task.dueDate].push(task);
                } else {
                    undatedTasks.push(task);
                }
            });
            
            // 3. Renderiza o cabeçalho do calendário (dias da semana)
            const headerContainer = document.getElementById('grid-header');
            const bodyContainer = document.getElementById('grid-body');
            const weekRangeEl = document.getElementById('week-range');
            
            headerContainer.innerHTML = '';
            bodyContainer.innerHTML = '';
            
            const firstDayFormatted = new Intl.DateTimeFormat('pt-BR', { day: 'numeric', month: 'short' }).format(startOfWeek);
            const lastDayFormatted = new Intl.DateTimeFormat('pt-BR', { day: 'numeric', month: 'short' }).format(weekDates[6].date);
            weekRangeEl.textContent = `Semana: ${firstDayFormatted} - ${lastDayFormatted}`;


            weekDates.forEach((dayData, index) => {
                const dayName = new Intl.DateTimeFormat('pt-BR', { weekday: 'short' }).format(dayData.date);
                const isTodayClass = dayData.isToday ? 'bg-indigo-200 text-indigo-900 font-bold' : 'text-gray-700';
                
                // Cabeçalho
                headerContainer.innerHTML += `
                    <div class="text-center p-2 text-sm border-r border-indigo-200 last:border-r-0 ${isTodayClass}">
                        ${dayName} <span class="font-normal block">${dayData.date.getDate()}</span>
                    </div>
                `;

                // Corpo (Células)
                const dayTasks = tasksByDate[dayData.isoDate];
                let tasksHtml = '';
                
                dayTasks.forEach(task => {
                    const categoryClass = CATEGORY_COLORS[task.category] || CATEGORY_COLORS['Outros'];
                    const isLate = task.dueDate && new Date(task.dueDate + 'T00:00:00') < today;
                    const borderClass = isLate ? 'status-Vencido' : 'status-Progresso'; // Simplificado
                    
                    tasksHtml += `
                        <div class="task-card ${categoryClass} ${borderClass}" title="${task.category}: ${task.text}">
                            ${task.text}
                        </div>
                    `;
                });

                bodyContainer.innerHTML += `
                    <div class="day-cell p-2 border-b border-indigo-200 min-h-[150px]">
                        ${tasksHtml}
                    </div>
                `;
            });
            
            // 4. Renderiza tarefas sem data
            const undatedContainer = document.getElementById('undated-tasks');
            if (undatedTasks.length > 0) {
                 undatedContainer.innerHTML = undatedTasks.map(task => {
                    const categoryClass = CATEGORY_COLORS[task.category] || CATEGORY_COLORS['Outros'];
                    return `
                        <div class="task-card ${categoryClass} w-full" title="${task.category}: ${task.text}">
                            <span class="font-semibold">${task.text}</span> - <span class="text-xs">Sem prazo</span>
                        </div>
                    `;
                 }).join('');
            } else {
                undatedContainer.innerHTML = `<p class="text-gray-400">Nenhuma tarefa sem prazo.</p>`;
            }

            // Garante que o grid-body tenha altura mínima para display
            bodyContainer.style.gridAutoRows = 'minmax(150px, auto)';
        }
        
        // --- INÍCIO DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            renderWeeklyPlanner();

            // Otimização: Recarregar a cada 5 segundos para refletir mudanças do App de Tarefas
            setInterval(renderWeeklyPlanner, 5000);
        });

    </script>
</body>
</html>
