<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWAO ‚Äì Painel do Administrador</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // O Narrador √© exposto pelo Appshell Genoma
    if (!window.Narrador) {
      alert("Erro: Narrador n√£o est√° dispon√≠vel. Painel n√£o inicializou.");
    }
  </script>
</head>

<body class="bg-gray-100 text-gray-900 p-4">
  <h1 class="text-3xl font-bold mb-4">Painel do Administrador ‚Äì PWAO</h1>

  <!-- STATUS GERAL -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Status do Sistema</h2>
    <p><strong>Genoma:</strong> <span id="genomaVersao">V3 FIX2</span></p>
    <p><strong>IndexedDB:</strong> <span id="statusDB">Carregando‚Ä¶</span></p>
    <p><strong>Perfis admin encontrados:</strong> <span id="adminCount">0</span></p>
  </section>

  <!-- LISTA DE USU√ÅRIOS -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Usu√°rios Cadastrados</h2>
    <ul id="listaUsuarios" class="list-disc pl-6 text-gray-800"></ul>
  </section>

  <!-- LISTA DE PERFIS -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Perfis da Fam√≠lia</h2>
    <ul id="listaPerfis" class="list-disc pl-6 text-gray-800"></ul>
  </section>

  <!-- LOG DO NARRADOR -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Logs do Narrador</h2>
    <pre id="logsNarrador" class="bg-gray-900 text-green-400 p-3 rounded h-40 overflow-auto text-sm"></pre>
  </section>

  <!-- MINIAPPS -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Miniapps</h2>
    <div class="flex flex-col gap-2">
      <button class="bg-blue-600 text-white py-2 rounded"
        onclick="Narrador.emitir({ tipo: 'miniapps.abrir', nome: 'quiz' })">
        Abrir Miniapp Quiz
      </button>

      <button class="bg-purple-600 text-white py-2 rounded"
        onclick="Narrador.emitir({ tipo: 'miniapps.abrir', nome: 'familia' })">
        Carregar Miniapp Fam√≠lia
      </button>
    </div>
  </section>

  <!-- DIAGN√ìSTICO -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Diagn√≥stico do PWAO</h2>
    <button onclick="diagnosticar()" class="bg-red-600 text-white px-4 py-2 rounded">Rodar Diagn√≥stico</button>
    <pre id="diagnostico" class="bg-gray-900 text-green-400 p-3 rounded h-40 overflow-auto text-sm mt-3"></pre>
  </section>

<script>
  //---------------------------------------------------
  // üîç Fun√ß√µes administrativas
  //---------------------------------------------------

  // Carrega dados do IndexedDB
  function abrirDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open("GenomaDB", 1);
      req.onsuccess = () => resolve(req.result);
      req.onerror   = () => reject(req.error);
    });
  }

  // Listar usu√°rios e perfis
  async function carregarUsuariosPerfis() {
    const db = await abrirDB();
    document.getElementById("statusDB").innerText = "Online";

    const tx1 = db.transaction("users", "readonly").objectStore("users").getAll();
    tx1.onsuccess = () => {
      const lista = document.getElementById("listaUsuarios");
      lista.innerHTML = "";
      tx1.result.forEach(u => {
        const li = document.createElement("li");
        li.textContent = `${u.nome || 'Sem nome'} ‚Äî ${u.email || 'Sem e-mail'}`;
        lista.appendChild(li);
      });
    };

    const tx2 = db.transaction("admins", "readonly").objectStore("admins").getAll();
    tx2.onsuccess = () => {
      document.getElementById("adminCount").innerText = tx2.result.length;
    };

    // Perfis (o store ser√° criado depois pelo sistema)
    try {
      if (db.objectStoreNames.contains("perfis")) {
        const tx3 = db.transaction("perfis", "readonly").objectStore("perfis").getAll();
        tx3.onsuccess = () => {
          const lista = document.getElementById("listaPerfis");
          lista.innerHTML = "";
          tx3.result.forEach(p => {
            const li = document.createElement("li");
            li.textContent = `${p.tipo} ‚Äî ID: ${p.id}`;
            lista.appendChild(li);
          });
        };
      }
    } catch (e) {
      console.warn("Store perfis inexistente ainda.");
    }
  }

  //---------------------------------------------------
  // üß† Log do Narrador
  //---------------------------------------------------
  let logs = [];
  const originalEmitir = window.Narrador.emitir;
  window.Narrador.emitir = function(ev) {
    logs.push(JSON.stringify(ev));
    document.getElementById("logsNarrador").innerText = logs.join("\n");
    originalEmitir.call(window.Narrador, ev);
  };

  //---------------------------------------------------
  // ü©∫ Diagn√≥stico
  //---------------------------------------------------
  async function diagnosticar() {
    const diag = {
      rootExiste: !!document.getElementById("root"),
      narradorAtivo: !!window.Narrador,
      genomaVersao: document.getElementById("genomaVersao").innerText,
      stores: []
    };

    const db = await abrirDB();
    diag.stores = Array.from(db.objectStoreNames);

    document.getElementById("diagnostico").innerText = JSON.stringify(diag, null, 2);
  }

  //---------------------------------------------------
  // üöÄ Inicializa√ß√£o
  //---------------------------------------------------
  carregarUsuariosPerfis();
</script>

</body>
</html>
