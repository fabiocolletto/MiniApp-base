<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de MiniApps - Gviz (React)</title>
    <!-- Carregando Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importando React e Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Importando Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        /* Fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .font-sans { font-family: 'Inter', sans-serif; }

        /* Estilos base do Card */
        .miniapp-card {
            width: 100%;
            max-width: 600px;
            position: relative;
            z-index: 1;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .miniapp-card:active {
            transform: scale(0.98); 
        }

        /* Animação do Coração */
        @keyframes heart-beat {
            0% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1); }
            75% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .animate-heart {
            animation: heart-beat 0.4s ease-in-out;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #171717; 
        }
        ::-webkit-scrollbar-thumb {
            background: #404040; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ea580c; 
        }
    </style>
</head>
<body class="bg-neutral-900 font-sans text-white m-0">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const ReactDOM = window.ReactDOM;

        // =========================================================
        // 1. CONFIGURAÇÃO
        // =========================================================
        const DEFAULT_SHEET_ID = "1aKPEGQcKRzYmiWzeqyi19jX7GB8RDOBkN_NbxxX5NKU"; 
        const DEFAULT_SHEET_NAME = "miniapps"; 

        // =========================================================
        // 2. UTILITÁRIOS (CSV & GVIZ)
        // =========================================================

        function getSheetCsvUrl(sheetId, sheetName) {
            if (!sheetId) return "";
            return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        }

        function parseCsvLine(text) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(cell); cell = ''; }
                else cell += char;
            }
            result.push(cell);
            return result.map(c => {
                const trimmed = c.trim();
                if (trimmed.startsWith('"') && trimmed.endsWith('"')) return trimmed.slice(1, -1).replace(/""/g, '"');
                return trimmed;
            });
        }

        function parseCsv(text) {
            const clean = (text || "").replace(/^\uFEFF/, "");
            const lines = clean.split(/\r?\n/).filter(l => l.trim() !== "");
            if (!lines.length) return [];
            
            const headers = parseCsvLine(lines[0]).map(h => h.trim().toLowerCase());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCsvLine(lines[i]);
                const obj = {};
                headers.forEach((h, idx) => { obj[h] = (values[idx] ?? "").trim(); });
                
                if (!obj.id) {
                    obj.id = obj.slug || obj.url || obj.title || `temp-${Math.random().toString(36).substring(2, 9)}`;
                }
                rows.push(obj);
            }
            return rows;
        }

        async function loadFromSheet(sheetId, sheetName) {
            const cleanedSheetId = sheetId.trim();
            const cleanedSheetName = sheetName.trim();
            const csvUrl = getSheetCsvUrl(cleanedSheetId, cleanedSheetName);
            if (!csvUrl) return null;

            const MAX_RETRIES = 2;
            for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
                try {
                    if (attempt > 0) await new Promise(r => setTimeout(r, 1000 * attempt));
                    const res = await fetch(csvUrl, { cache: "no-store" });
                    if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);
                    const text = await res.text();
                    if (text.includes("<!doctype html>") || text.includes("google.com/accounts")) {
                        throw new Error("A resposta foi HTML em vez de CSV. Verifique se a planilha está pública.");
                    }
                    const rows = parseCsv(text);
                    if (!rows.length) return []; 

                    const mapKeys = {
                        "título": "title", "titulo": "title", "nome": "title",
                        "link": "url", "endereco": "url", "endereço": "url", "site": "url",
                        "descrição": "description", "descricao": "description", "detalhes": "details",
                        "subtitulo": "subtitle", "subtítulo": "subtitle",
                        "categoria": "category", "status": "status", 
                        "cor": "color", "icone": "icon", "icon": "icon",
                        "visibilidade": "visibility", "ativo": "active"
                    };

                    return rows.map(r => {
                        const newR = {};
                        for (const key in r) {
                            const lowerKey = key.toLowerCase();
                            const mappedKey = mapKeys[lowerKey] || lowerKey;
                            newR[mappedKey] = r[key];
                        }
                        return newR;
                    });
                } catch (err) {
                    if (attempt === MAX_RETRIES) throw err;
                }
            }
        }

        // =========================================================
        // 3. COMPONENTES UI
        // =========================================================

        // Modal Genérico (Texto ou Iframe)
        const Modal = ({ isOpen, closeModal, title, content, iframeUrl }) => {
          if (!isOpen) return null;
          const isAppMode = !!iframeUrl;

          return (
            <div className="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-50 p-4 transition-all">
              <div className={`bg-gray-800 rounded-xl shadow-2xl flex flex-col border border-gray-700 relative overflow-hidden ${isAppMode ? 'w-full h-[90vh] max-w-6xl' : 'max-w-lg w-full'}`}>
                
                <div className="flex justify-between items-center p-4 bg-gray-900/50 border-b border-gray-700">
                  <h3 className="text-xl font-bold text-orange-500 truncate pr-4">{title}</h3>
                  <div className="flex items-center gap-3">
                      {isAppMode && (
                          <a 
                            href={iframeUrl} target="_blank" rel="noopener noreferrer"
                            className="text-xs md:text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1 bg-blue-900/30 px-3 py-1.5 rounded-full hover:bg-blue-900/50 transition border border-blue-800"
                          >
                              <span className="material-symbols-outlined text-base">open_in_new</span>
                              <span className="hidden md:inline">Abrir Externo</span>
                          </a>
                      )}
                      <button onClick={closeModal} className="text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-full p-1.5 transition flex items-center justify-center">
                        <span className="material-symbols-outlined text-2xl">close</span>
                      </button>
                  </div>
                </div>

                <div className="flex-1 overflow-hidden relative bg-neutral-950">
                    {isAppMode ? (
                        <div className="w-full h-full relative">
                            <div className="absolute inset-0 flex items-center justify-center text-gray-600 z-0">
                                <span className="material-symbols-outlined animate-spin text-3xl mr-2">cached</span>
                                Carregando App...
                            </div>
                            <iframe 
                                src={iframeUrl} 
                                className="w-full h-full border-0 relative z-10" 
                                title={title}
                                allow="camera; microphone; fullscreen; geolocation"
                            ></iframe>
                        </div>
                    ) : (
                        <div className="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
                            <p className="text-gray-300 leading-relaxed whitespace-pre-wrap text-sm md:text-base">{content}</p>
                        </div>
                    )}
                </div>

                {!isAppMode && (
                    <div className="p-4 border-t border-gray-700 flex justify-end bg-gray-900/30">
                        <button onClick={closeModal} className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:shadow-orange-600/20 transition">
                            Fechar
                        </button>
                    </div>
                )}
              </div>
            </div>
          );
        };

        // Modal de Configurações (Novo)
        const SettingsModal = ({ isOpen, closeModal, sheetId, setSheetId, sheetName, setSheetName, onSave }) => {
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
                    <div className="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md border border-gray-700 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                <span className="material-symbols-outlined text-orange-500">settings</span>
                                Configurações
                            </h3>
                            <button onClick={closeModal} className="text-gray-400 hover:text-white transition">
                                <span className="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        
                        <div className="space-y-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-400 mb-1">ID da Planilha Google</label>
                                <input 
                                    type="text" 
                                    value={sheetId} 
                                    onChange={(e) => setSheetId(e.target.value)}
                                    className="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-3"
                                    placeholder="Ex: 1aKPEGQc..."
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-400 mb-1">Nome da Aba (Sheet Name)</label>
                                <input 
                                    type="text" 
                                    value={sheetName} 
                                    onChange={(e) => setSheetName(e.target.value)}
                                    className="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-3"
                                    placeholder="Ex: miniapps"
                                />
                            </div>
                        </div>

                        <div className="flex justify-end gap-3">
                             <button 
                                onClick={closeModal}
                                className="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition"
                            >
                                Cancelar
                            </button>
                            <button 
                                onClick={onSave}
                                className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition flex items-center gap-2"
                            >
                                <span className="material-symbols-outlined text-sm">save</span>
                                Salvar e Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente Card
        const MiniAppCard = ({ data, openModal, isFavorite, onToggleFavorite }) => {
          const title = data.title || 'Sem Título';
          const subtitle = data.subtitle || data.description || '...';
          const category = data.category || 'App';
          const status = data.status || 'Pago';
          const iconName = data.icon || 'extension';
          const gradient = data.gradient || 'linear-gradient(135deg, #1f2937 0%, #111827 100%)';
          const url = data.url;
          const [isHovered, setIsHovered] = useState(false);
          const [animateHeart, setAnimateHeart] = useState(false);

          const handleCardClick = () => {
            if (url && url.trim() !== "") {
              openModal(title, null, url);
            } else {
              alert("Este MiniApp ainda não possui um link configurado.");
            }
          };

          const handleFavoriteClick = (e) => {
              e.stopPropagation();
              onToggleFavorite(data.id);
              setAnimateHeart(true);
              setTimeout(() => setAnimateHeart(false), 400);
          };

          return (
            <div
              className={`miniapp-card bg-[#1E1E1E] rounded-lg overflow-hidden flex flex-row shadow-md border border-transparent hover:border-orange-500/30 ${url ? 'cursor-pointer' : 'cursor-default'}`}
              onMouseEnter={() => setIsHovered(true)}
              onMouseLeave={() => setIsHovered(false)}
              onClick={handleCardClick}
              title={url ? `Abrir ${title}` : "Indisponível"}
            >
              <div className="w-1/3 relative flex items-center justify-center overflow-hidden rounded-l-lg" style={{ background: gradient, minWidth: '100px' }}>
                <span className={`material-symbols-outlined text-5xl text-white/50 transition-transform duration-500 ${isHovered ? 'scale-110' : ''}`}>{iconName}</span>
              </div>
              <div className="w-2/3 p-4 relative flex flex-col justify-between">
                  <div className="absolute top-2 right-2 flex items-center gap-1 z-20">
                      <button onClick={handleFavoriteClick} className={`p-1.5 rounded-full transition-all hover:bg-white/10 ${isFavorite ? 'text-orange-500' : 'text-gray-600 hover:text-orange-400'}`}>
                        <span className={`material-symbols-outlined text-xl ${animateHeart ? 'animate-heart' : ''}`} style={{ fontVariationSettings: isFavorite ? "'FILL' 1" : "'FILL' 0" }}>favorite</span>
                      </button>
                      <button onClick={(e) => { e.stopPropagation(); openModal(title, data.details || data.description || "Sem detalhes.", null); }} className="p-1.5 rounded-full text-gray-500 hover:text-orange-400 hover:bg-white/10 transition-all">
                        <span className="material-symbols-outlined text-xl">info</span>
                      </button>
                  </div>
                  <div className="pr-16"> 
                    <h2 className="text-lg font-bold text-white mb-2 leading-tight">{title}</h2>
                    <p className="text-sm text-gray-400 line-clamp-2 min-h-[2.5rem] leading-relaxed">{subtitle}</p>
                  </div>
                  <div className="flex justify-between items-end mt-4">
                    <span className="text-[10px] uppercase font-bold tracking-wider text-gray-600 bg-gray-800 px-2 py-1 rounded">{category}</span>
                    <button onClick={(e) => { e.stopPropagation(); handleCardClick(); }} className={`text-sm font-medium py-1.5 px-4 rounded-full transition-colors shadow-lg z-20 ${url ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}`}>
                        {url ? 'Acessar' : 'Indisponível'}
                    </button>
                  </div>
              </div>
            </div>
          );
        };

        // =========================================================
        // 4. APP PRINCIPAL
        // =========================================================

        const App = () => {
          const [miniApps, setMiniApps] = useState([]);
          const [filteredApps, setFilteredApps] = useState([]);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [favorites, setFavorites] = useState(() => {
              const saved = localStorage.getItem('miniapp_favorites');
              return saved ? JSON.parse(saved) : [];
          });
          const [showOnlyFavorites, setShowOnlyFavorites] = useState(false);
          
          // Estado do Modal de Configurações
          const [settingsOpen, setSettingsOpen] = useState(false);
          // Estados de Configuração (Inputs)
          const [sheetId, setSheetId] = useState(DEFAULT_SHEET_ID);
          const [sheetName, setSheetName] = useState(DEFAULT_SHEET_NAME);

          const [modalState, setModalState] = useState({ isOpen: false, title: '', content: '', iframeUrl: null });

          const toggleFavorite = (appId) => {
              setFavorites(prev => {
                  const newFavs = prev.includes(appId) ? prev.filter(id => id !== appId) : [...prev, appId];            
                  localStorage.setItem('miniapp_favorites', JSON.stringify(newFavs));
                  return newFavs;
              });
          };

          const fetchData = useCallback(async () => {
            if (!sheetId) return;
            setLoading(true);
            setError(null);
            try {
                const data = await loadFromSheet(sheetId, sheetName);
                const validData = data.filter(d => {
                    const isActive = String(d.active || "true").toLowerCase() !== "false";
                    const isPublic = String(d.visibility || "public").toLowerCase() !== "private";
                    return d.title && isActive && isPublic;
                });
                setMiniApps(validData);
                // Fecha modal de settings se estiver aberto
                setSettingsOpen(false);
            } catch (e) {
                console.error(e);
                setError(e.message);
            } finally {
                setLoading(false);
            }
          }, [sheetId, sheetName]);

          useEffect(() => { fetchData(); }, []);

          useEffect(() => {
              if (showOnlyFavorites) setFilteredApps(miniApps.filter(app => favorites.includes(app.id)));
              else setFilteredApps(miniApps);
          }, [miniApps, showOnlyFavorites, favorites]);

          const openModal = (title, content, url = null) => setModalState({ isOpen: true, title, content, iframeUrl: url });
          const closeModal = () => setModalState(prev => ({ ...prev, isOpen: false, iframeUrl: null }));

          return (
            <div className="min-h-screen bg-neutral-900 pb-20 relative">
                
              {/* Botão de Configurações (Canto Superior Direito) - SEM BORDA */}
              <div className="absolute top-4 right-4 z-40">
                  <button 
                    onClick={() => setSettingsOpen(true)}
                    className="text-gray-400 hover:text-white bg-gray-800/50 hover:bg-gray-700 p-2 rounded-full transition backdrop-blur-sm"
                    title="Configurações da Planilha"
                  >
                      <span className="material-symbols-outlined text-2xl">settings</span>
                  </button>
              </div>

              {/* Header Hero */}
              <div className="bg-gradient-to-b from-gray-800 to-neutral-900 pb-8 pt-12 px-6 border-b border-gray-800">
                  <div className="max-w-6xl mx-auto text-center">
                    <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-orange-600 mb-4">
                        Catálogo MiniApps
                    </h1>
                    <p className="text-gray-400 text-lg max-w-2xl mx-auto mb-6">
                        Explore nossa coleção. Clique no card para abrir o App.
                    </p>

                    {/* Filtro de Favoritos (Agora centralizado e limpo) */}
                    <div className="flex justify-center">
                        <div className="flex items-center gap-2 bg-gray-800 p-1.5 rounded-full border border-gray-700">
                            <button onClick={() => setShowOnlyFavorites(false)} className={`px-4 py-2 rounded-full text-sm font-bold transition-all ${!showOnlyFavorites ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-400 hover:text-white'}`}>
                                Todos
                            </button>
                            <button onClick={() => setShowOnlyFavorites(true)} className={`px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-2 ${showOnlyFavorites ? 'bg-orange-900/50 text-orange-400 border border-orange-800 shadow-sm' : 'text-gray-400 hover:text-white'}`}>
                                <span className="material-symbols-outlined text-base" style={{ fontVariationSettings: "'FILL' 1" }}>favorite</span>
                                Favoritos ({favorites.length})
                            </button>
                        </div>
                    </div>
                  </div>
              </div>

              {/* Conteúdo Principal */}
              <div className="max-w-7xl mx-auto px-6 py-10">
                  {loading && (
                      <div className="flex flex-col items-center justify-center py-20 text-orange-500 animate-pulse">
                          <span className="material-symbols-outlined text-5xl mb-4">cloud_sync</span>
                          <p className="text-xl font-medium">Atualizando catálogo...</p>
                      </div>
                  )}

                  {error && (
                      <div className="bg-red-900/20 border border-red-800 text-red-400 p-6 rounded-xl text-center max-w-2xl mx-auto mt-10">
                          <span className="material-symbols-outlined text-4xl mb-2">error</span>
                          <p className="font-bold text-lg">Erro ao carregar</p>
                          <p className="text-sm mt-2 opacity-80">{error}</p>
                      </div>
                  )}

                  {!loading && !error && (
                      <>
                        {filteredApps.length === 0 ? (
                            <div className="text-center py-20">
                                <div className="bg-gray-800/50 inline-block p-8 rounded-full mb-4">
                                    <span className="material-symbols-outlined text-6xl text-gray-600">
                                        {showOnlyFavorites ? 'favorite_border' : 'search_off'}
                                    </span>
                                </div>
                                <p className="text-xl text-gray-400">
                                    {showOnlyFavorites ? 'Você ainda não tem favoritos.' : 'Nenhum aplicativo encontrado.'}
                                </p>
                                {showOnlyFavorites && (
                                    <button onClick={() => setShowOnlyFavorites(false)} className="mt-4 text-orange-500 hover:underline">Ver todos</button>
                                )}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-6">
                                {filteredApps.map((app, index) => (
                                    <MiniAppCard 
                                        key={app.id || index} 
                                        data={app} 
                                        isFavorite={favorites.includes(app.id)}
                                        onToggleFavorite={toggleFavorite}
                                        openModal={openModal} 
                                    />
                                ))}
                            </div>
                        )}
                      </>
                  )}
              </div>

              {/* Modais */}
              <Modal 
                isOpen={modalState.isOpen} 
                title={modalState.title} 
                content={modalState.content} 
                iframeUrl={modalState.iframeUrl}
                closeModal={closeModal} 
              />

              <SettingsModal 
                isOpen={settingsOpen}
                closeModal={() => setSettingsOpen(false)}
                sheetId={sheetId}
                setSheetId={setSheetId}
                sheetName={sheetName}
                setSheetName={setSheetName}
                onSave={fetchData}
              />
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
