<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniApp - Admin Usuários (Sistema)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/miniapp-global.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/miniapp-card.css" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/idb@7.1.1/build/umd.js"></script>

  <script src="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/components/app-shared-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/components/app-modal-context.js"></script>

  <!-- ✅ shared admin core (você colocou na pasta docs/components) -->
  <script src="https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/docs/components/admin-shared.js"></script>

  <meta name="theme-color" content="#020617" />
</head>

<body class="miniapp-shell" style="margin:0; padding:0; width:100%; height:100%; overflow-x:hidden;">
  <main id="admin-users-root" class="miniapp-stage"></main>

  <script>
    const ReactLib = window.React;
    const Material = window.MaterialUI;
    const AppUI = window.AppUI;
    const AdminShared = window.AdminShared;

    const e = ReactLib.createElement;
    const { AppCard, AppButton } = AppUI;

    const { assertDeps, bootstrapAdminStore, makeLayout } = AdminShared;

    assertDeps("admin-users-root");
    bootstrapAdminStore();
    const AdminStore = window.AdminStore;

    const { useCallback, useEffect, useMemo, useState } = ReactLib;
    const {
      Box, Stack, Typography, TextField,
      FormControl, InputLabel, Select, MenuItem,
      Divider, Chip
    } = Material;

    function AdminUsersCard({ status, outlinedSx }) {
      const emptyUser = { id:"", name:"", email:"", phone:"", role:"viewer", active:true, senhaHash:"" };

      const [items, setItems] = useState([]);
      const [form, setForm] = useState(emptyUser);
      const [editingId, setEditingId] = useState(null);
      const [error, setError] = useState(null);
      const [ok, setOk] = useState(null);
      const [loading, setLoading] = useState(true);

      const reload = useCallback(async () => {
        setLoading(true);
        const list = await AdminStore.list("users");
        const safe = Array.isArray(list) ? list : [];
        safe.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        setItems(safe);
        setLoading(false);
      }, []);

      useEffect(() => { reload(); }, [reload]);

      const onEdit = useCallback((it) => {
        setEditingId(it.id);
        setForm(it);
        setError(null); setOk(null);
      }, []);

      const onNew = useCallback(() => {
        setEditingId(null);
        setForm(emptyUser);
        setError(null); setOk(null);
      }, []);

      const onDelete = useCallback(async (it) => {
        setError(null); setOk(null);
        await AdminStore.remove("users", it.id);
        await reload();
        setOk("Usuário excluído.");
        if (editingId === it.id) onNew();
      }, [editingId, onNew, reload]);

      const onResetPwd = useCallback(async (it) => {
        setError(null); setOk(null);
        const patched = { ...it, senhaHash:"" };
        await AdminStore.upsert("users", patched);
        await reload();
        setOk(`Senha resetada para ${it.name || it.email}.`);
        if (editingId === it.id) setForm(patched);
      }, [editingId, reload]);

      const validate = useCallback(() => {
        if (!form.name) return "Nome é obrigatório.";
        if (!form.email) return "E-mail é obrigatório.";
        return null;
      }, [form]);

      const onSave = useCallback(async () => {
        setError(null); setOk(null);
        const v = validate();
        if (v) { setError(v); return; }

        const patched = { ...form, active: !!form.active };
        const saved = await AdminStore.upsert("users", patched);
        await reload();
        setOk(editingId ? "Usuário atualizado." : "Usuário criado.");

        if (!editingId) {
          setForm(emptyUser);
        } else {
          setEditingId(saved.id);
          setForm(saved);
        }
      }, [editingId, emptyUser, form, reload, validate]);

      return e(
        AppCard,
        {
          title: "Admin • Usuários",
          subtitle: "Cadastro administrativo de usuários",
          helper: "CRUD local. Sem autosave. Reset de senha só na lista."
        },
        e(Stack, { spacing: 2 },

          e(Typography, { variant:"subtitle1", fontWeight:700 }, "Usuários cadastrados"),

          loading ? e(Typography, { variant:"caption", color:"text.secondary" }, "Carregando...") : null,
          !loading && items.length === 0
            ? e(Typography, { variant:"caption", color:"text.secondary" }, "Nenhum usuário ainda.")
            : null,

          !loading && items.length > 0
            ? e(Stack, { spacing: 1 },
                items.map(it =>
                  e(Box, {
                    key: it.id,
                    sx: {
                      display:"flex",
                      alignItems:"center",
                      justifyContent:"space-between",
                      p:1,
                      border:"1px solid rgba(255,255,255,0.12)",
                      borderRadius:"10px",
                      background:"rgba(255,255,255,0.02)"
                    }
                  },
                    e(Stack, { spacing: 0.25 },
                      e(Typography, { variant:"body2", fontWeight:600 }, it.name || "(sem nome)"),
                      e(Typography, { variant:"caption", color:"text.secondary" },
                        (it.email || "") + " · " + (it.role || "viewer") + (it.phone ? (" · " + it.phone) : "")
                      ),
                      it.active === false
                        ? e(Chip, { size:"small", label:"Inativo", color:"default", variant:"outlined" })
                        : null
                    ),
                    e(Stack, { direction:"row", spacing:1 },
                      e(AppButton, { tone:"secondary", variant:"outlined", onClick: ()=>onEdit(it) }, "Editar"),
                      e(AppButton, { tone:"warning", variant:"outlined", onClick: ()=>onResetPwd(it) }, "Resetar senha"),
                      e(AppButton, { tone:"danger", variant:"outlined", onClick: ()=>onDelete(it) }, "Excluir")
                    )
                  )
                )
              )
            : null,

          e(Divider),

          e(Stack, { direction:"row", spacing:1, alignItems:"center", justifyContent:"space-between" },
            e(Typography, { variant:"subtitle2", fontWeight:700 }, editingId ? "Editar usuário" : "Novo usuário"),
            e(AppButton, { tone:"ghost", variant:"text", onClick: onNew }, "Limpar / Novo")
          ),

          e(Stack, { spacing: 1.5 },
            e(TextField, {
              variant:"outlined", sx: outlinedSx,
              label:"Nome", size:"small",
              value: form.name || "",
              onChange: ev => setForm(f => ({ ...f, name: ev.target.value })),
              fullWidth:true
            }),
            e(TextField, {
              variant:"outlined", sx: outlinedSx,
              label:"Telefone", size:"small",
              value: form.phone || "",
              onChange: ev => setForm(f => ({ ...f, phone: ev.target.value })),
              fullWidth:true
            }),
            e(TextField, {
              variant:"outlined", sx: outlinedSx,
              label:"E-mail", size:"small",
              value: form.email || "",
              onChange: ev => setForm(f => ({ ...f, email: ev.target.value })),
              fullWidth:true
            }),

            e(Stack, { direction:{ xs:"column", sm:"row" }, spacing:2 },
              e(FormControl, { fullWidth:true, size:"small", sx: outlinedSx },
                e(InputLabel, null, "Categoria / Permissão"),
                e(Select, {
                  value: form.role || "viewer",
                  label: "Categoria / Permissão",
                  onChange: ev => setForm(f => ({ ...f, role: ev.target.value }))
                },
                  e(MenuItem, { value:"admin" }, "Administrador"),
                  e(MenuItem, { value:"collaborator" }, "Colaborador"),
                  e(MenuItem, { value:"viewer" }, "Leitor")
                )
              ),

              e(FormControl, { fullWidth:true, size:"small", sx: outlinedSx },
                e(InputLabel, null, "Status"),
                e(Select, {
                  value: form.active === false ? "inactive" : "active",
                  label: "Status",
                  onChange: ev => setForm(f => ({ ...f, active: ev.target.value === "active" }))
                },
                  e(MenuItem, { value:"active" }, "Ativo"),
                  e(MenuItem, { value:"inactive" }, "Inativo")
                )
              )
            )
          ),

          error ? e(Typography, { variant:"caption", color:"error.main" }, error) : null,
          ok ? e(Typography, { variant:"caption", color:"success.main" }, ok) : null,

          e(Stack, { direction:"row", spacing: 1.5, justifyContent:"flex-end", mt: 1 },
            e(AppButton, { tone:"secondary", variant:"outlined", onClick: onSave }, editingId ? "Salvar alterações" : "Criar registro")
          ),

          e(Typography, { variant:"caption", color:"text.secondary" },
            `Última ação: ${status.lastSaveTime || "Nenhuma"} · ${status.message}`
          )
        )
      );
    }

    makeLayout(AdminUsersCard, "admin-users-root");
  </script>
</body>
</html>
