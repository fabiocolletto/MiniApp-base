<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>
    <!-- As bibliotecas (Tailwind, React, Babel) são carregadas pelo HOST (Shell) -->
    <style>
        body { background-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // I18N Fallback (apenas as chaves necessárias)
        const FALLBACK_I18N = {
            "pt-BR": {
                section_profile: "Perfil",
                msg_locked_title: "Acesso Restrito",
                msg_locked_subtitle: "Faça login no menu principal para desbloquear seus dados reais.",
                data_personal: "Dados Pessoais",
                data_system: "Segurança & Sistema",
                data_fullname: "Nome Completo",
                data_phone: "Telefone",
                data_phone_subtitle: "Usado como Login",
                data_email: "E-mail",
                data_id_hash: "ID Único (Hash)",
                data_id_subtitle: "Toque para copiar",
                data_json_raw: "JSON Bruto",
                processing_photo: "Processando...",
                profile_role_user: "Usuário",
                profile_role_student: "Aluno",
                alert_login_required: "Por favor, faça login no App principal para alterar a foto.",
                alert_mobile_required: "A alteração de foto foi projetada para uso em dispositivos móveis (câmera).",
                alert_copied: "Copiado!",
                alert_error_processing: "Erro ao processar imagem."
            }
        };

        // Funções auxiliares
        const t = (key) => {
            const lang = window.__app_lang || 'pt-BR';
            return FALLBACK_I18N[lang]?.[key] || FALLBACK_I18N['pt-BR'][key] || key;
        };

        // --- SISTEMA DE CORES ---
        const COLOR = {
            indigo: { base:"indigo", bg50:"bg-indigo-50", text500:"text-indigo-500", text600:"text-indigo-600", hoverBg:"hover:bg-indigo-50", hoverBorder:"hover:border-indigo-200" },
            purple: { base:"purple", bg50:"bg-purple-50", text500:"text-purple-500", text600:"text-purple-600", hoverBg:"hover:bg-purple-50", hoverBorder:"hover:border-purple-200" },
            slate:  { base:"slate",  bg50:"bg-slate-50",  text500:"text-slate-500",  text600:"text-slate-600",  hoverBg:"hover:bg-slate-50",  hoverBorder:"hover:border-slate-200" },
        };
        
        const DUMMY_USER = {
            name: t("data_fullname"),
            role: t("profile_role_user"),
            phone: "+55 00 00000-0000",
            email: t("data_email"),
            id: "00000000000000000000000000000000"
        };
        
        // --- FUNÇÃO DE COMUNICAÇÃO DE ALERTA PARA O HOST ---
        const showHostAlert = (message, type = 'info') => {
            window.parent.postMessage({ type: 'HOST_ALERT', payload: { message, type } }, '*');
        };

        /* --- COMPONENTES VISUAIS --- */
        const SectionTitle = ({ icon, title, color = "slate" }) => {
            const c = COLOR[color] || COLOR.slate;
            return (
                <div className="flex items-center gap-2 mb-2 mt-6 first:mt-0 px-1">
                    <span className={`material-symbols-rounded text-sm ${c.text500}`}>{icon}</span>
                    <span className={`text-xs font-bold ${c.text600} uppercase tracking-widest`}>{title}</span>
                </div>
            );
        };

        const ConfigItem = ({ icon, title, subtitle, value, color = "indigo", onClick }) => {
            const c = COLOR[color] || COLOR.indigo;
            const isInteractive = !!onClick;
            
            return (
                <div 
                    className={`flex items-center justify-between w-full px-4 py-3 rounded-xl transition-all border bg-white border-slate-200 text-slate-700 shadow-sm ${isInteractive ? `cursor-pointer active:scale-[0.99] hover:shadow ${c.hoverBg} ${c.hoverBorder}` : ''}`}
                    onClick={onClick}
                >
                    <div className="flex items-center gap-3 overflow-hidden">
                        <span className={`material-symbols-rounded text-xl ${c.text500}`}>{icon}</span>
                        <div className="flex flex-col overflow-hidden">
                            <span className="font-medium text-sm truncate">{title}</span>
                            {subtitle && <span className="text-[10px] text-slate-400 truncate">{subtitle}</span>}
                        </div>
                    </div>
                    <div className="flex items-center pl-2">
                        {value && <span className="text-sm font-semibold text-slate-600 mr-2">{value}</span>}
                        {isInteractive && <span className="material-symbols-rounded text-slate-400">content_copy</span>}
                    </div>
                </div>
            );
        };

        // --- MFE Principal ---
        function ProfileApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [processingPhoto, setProcessingPhoto] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [authError, setAuthError] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            const [context, setContext] = useState(null); // Receberá userId e appId do Host
            
            const fileInputRef = useRef(null);

            // 1. Lógica para receber o contexto do Host
            useEffect(() => {
                const checkMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                setIsMobile(checkMobile);

                const handleHostContext = (event) => {
                    if (event.data && event.data.type === 'HOST_CONTEXT') {
                        setContext(event.data.payload);
                        window.removeEventListener('message', handleHostContext); // Não precisa mais ouvir
                    }
                };

                window.addEventListener('message', handleHostContext);
                
                return () => window.removeEventListener('message', handleHostContext);
            }, []);
            
            // 2. Lógica para solicitar dados do Host assim que o contexto chegar
            useEffect(() => {
                if (context) {
                    let isMounted = true;
                    // Solicita os dados de usuário do Firestore via Host (Shell)
                    window.parent.postMessage({ 
                        type: 'DB_REQUEST', 
                        requestId: 'profile_load',
                        payload: { action: 'get_user' } 
                    }, '*');

                    const handleDBResponse = (event) => {
                        const { type, requestId, result } = event.data;
                        if (type === 'DB_RESPONSE' && requestId === 'profile_load' && isMounted) {
                            if (result) {
                                setUser(result);
                            } else {
                                setAuthError(true); 
                            }
                            setLoading(false);
                            window.removeEventListener('message', handleDBResponse);
                        }
                    };

                    window.addEventListener('message', handleDBResponse);

                    // Timeout caso a resposta do Host demore (fallback)
                    const timer = setTimeout(() => {
                        if (isMounted && loading) {
                            setAuthError(true);
                            setLoading(false);
                        }
                    }, 1500);

                    return () => {
                        isMounted = false;
                        clearTimeout(timer);
                        window.removeEventListener('message', handleDBResponse);
                    };
                }
            }, [context]);

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => showHostAlert(t('alert_copied'), 'success'));
            };

            const handlePhotoClick = () => {
                if (!isMobile) {
                    showHostAlert(t('alert_mobile_required'), 'error');
                    return;
                }
                
                if (isLocked) {
                    showHostAlert(t('alert_login_required'), 'error');
                    return;
                }
                
                fileInputRef.current.click();
            };

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 300;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        }
                    }
                });
            };

            const handleFileChange = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    setProcessingPhoto(true);
                    const file = e.target.files[0];
                    try {
                        const compressedBase64 = await compressImage(file);
                        const updatedUser = { ...user, photo: compressedBase64 };
                        window.parent.postMessage({ 
                            type: 'DB_REQUEST', 
                            requestId: 'profile_update',
                            payload: { action: 'update_user', data: updatedUser } 
                        }, '*');
                    } catch (err) {
                        console.error(err);
                        setProcessingPhoto(false);
                        showHostAlert(t('alert_error_processing'), 'error');
                    }
                }
            };

            if (loading || !context) {
                return (
                    <div className="flex flex-col items-center justify-center h-64 text-slate-400 gap-2">
                        <span className="material-symbols-rounded animate-spin text-3xl">sync</span>
                        <span className="text-xs">Carregando perfil...</span>
                    </div>
                );
            }

            const isLocked = authError || !user;
            const displayUser = isLocked ? DUMMY_USER : user;
            const userPhoto = displayUser.photo || null;

            return (
                <div className="relative max-w-2xl mx-auto p-4 animate-[fadeInUp_0.3s_ease-out]">
                    {/* Input de Arquivo (Sempre Oculto) */}
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />

                    {/* --- OVERLAY DE BLOQUEIO (Muito Transparente: 15%) --- */}
                    {isLocked && (
                        <div className="absolute inset-0 z-50 flex flex-col items-center justify-center p-8 text-center bg-white/15 backdrop-blur-[1px] rounded-3xl transition-all">
                            <div className="bg-white/95 p-6 rounded-3xl shadow-lg border border-white/50 backdrop-blur-md animate-[fadeInUp_0.5s_ease-out]">
                                <div className="h-16 w-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 shadow-inner mx-auto">
                                    <span className="material-symbols-rounded text-3xl text-slate-400">lock</span>
                                </div>
                                <h2 className="text-lg font-bold text-slate-800 mb-2">{t('msg_locked_title')}</h2>
                                <p className="text-slate-500 text-xs max-w-[200px] mx-auto leading-relaxed">{t('msg_locked_subtitle')}</p>
                            </div>
                        </div>
                    )}

                    {/* --- CONTEÚDO PRINCIPAL --- */}
                    <div className={`transition-all duration-500 ${isLocked ? 'opacity-80 filter blur-[0.5px] pointer-events-none grayscale-[0.2]' : ''}`}>
                        
                        {/* Cabeçalho com Foto Editável */}
                        <div className="flex items-center gap-4 mb-8 px-2">
                            <div className="relative group">
                                <div className="h-20 w-20 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-2xl shadow-lg border-2 border-white overflow-hidden">
                                    {processingPhoto ? <span className="material-symbols-rounded animate-spin">sync</span> : userPhoto ? <img src={userPhoto} alt="Perfil" className="w-full h-full object-cover" /> : (displayUser.name ? displayUser.name.substring(0, 2).toUpperCase() : '??')}
                                </div>
                                
                                {/* Botão de Editar Foto (SEMPRE RENDERIZADO, mas com estilo de desativação) */}
                                <button 
                                    onClick={handlePhotoClick}
                                    className={`absolute bottom-0 right-0 bg-white text-purple-600 rounded-full p-1.5 shadow-md border border-purple-100 transition flex items-center justify-center 
                                        ${isLocked ? 'opacity-50 cursor-not-allowed' : 'hover:scale-110 active:scale-95'}
                                        ${!isMobile ? 'opacity-50 cursor-not-allowed' : ''}
                                    `}
                                    title={isMobile ? (isLocked ? t('alert_login_required') : "Alterar Foto") : t('alert_mobile_required')}
                                >
                                    <span className="material-symbols-rounded text-sm">photo_camera</span>
                                </button>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800">{displayUser.name}</h1>
                                <span className="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-0.5 rounded border border-purple-100 capitalize">{displayUser.role || t('profile_role_user')}</span>
                            </div>
                        </div>

                        {/* Lista de Dados */}
                        <div className="flex flex-col gap-3">
                            <SectionTitle icon="badge" title={t('data_personal')} color="purple" />
                            <ConfigItem icon="person" title={t('data_fullname')} value={displayUser.name} color="purple" />
                            <ConfigItem icon="call" title={t('data_phone')} subtitle={t('data_phone_subtitle')} value={displayUser.phone} color="purple" />
                            <ConfigItem icon="mail" title={t('data_email')} value={displayUser.email || "Não informado"} color="purple" />
                            <SectionTitle icon="fingerprint" title={t('data_system')} color="slate" />
                            <ConfigItem icon="key" title={t('data_id_hash')} subtitle={t('data_id_subtitle')} color="slate" onClick={() => !isLocked && copyToClipboard(displayUser.id)} />
                             <div className="mt-4 pt-4 border-t border-slate-100">
                                <div onClick={() => !isLocked && setShowDebug(!showDebug)} className="flex items-center gap-2 cursor-pointer opacity-60 hover:opacity-100 transition">
                                    <span className="material-symbols-rounded text-slate-400 text-sm">terminal</span>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{t('data_json_raw')}</span>
                                    <span className="material-symbols-rounded text-slate-400 text-sm ml-auto">{showDebug ? 'expand_less' : 'expand_more'}</span>
                                </div>
                                {showDebug && <div className="mt-2 bg-slate-50 p-3 rounded-lg border border-slate-200 text-[10px] font-mono text-slate-500 break-all">{JSON.stringify(displayUser)}</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProfileApp />);
    </script>
</body>
</html>
