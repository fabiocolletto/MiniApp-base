<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <!-- CORRIGIDO: Adicionado react-dom para que ReactDOM.createRoot funcione -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>

    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ["Inter", "sans-serif"] } } }
        };
    </script>
    <style>
        body { background-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* --- DADOS FICTÍCIOS PARA O FUNDO (QUANDO BLOQUEADO) --- */
        const DUMMY_USER = {
            name: "Nome do Usuário",
            role: "Cargo",
            phone: "+55 00 00000-0000",
            email: "email@exemplo.com",
            id: "00000000000000000000000000000000"
        };

        /* --- SISTEMA DE CORES --- */
        const COLOR = {
            indigo: { base:"indigo", bg50:"bg-indigo-50", text500:"text-indigo-500", text600:"text-indigo-600", hoverBg:"hover:bg-indigo-50", hoverBorder:"hover:border-indigo-200" },
            purple: { base:"purple", bg50:"bg-purple-50", text500:"text-purple-500", text600:"text-purple-600", hoverBg:"hover:bg-purple-50", hoverBorder:"hover:border-purple-200" },
            amber:  { base:"amber",  bg50:"bg-amber-50",  text500:"text-amber-500",  text600:"text-amber-600",  hoverBg:"hover:bg-amber-50",  hoverBorder:"hover:border-amber-200" },
            cyan:   { base:"cyan",   bg50:"bg-cyan-50",   text500:"text-cyan-500",   text600:"text-cyan-600",   hoverBg:"hover:bg-cyan-50",   hoverBorder:"hover:border-cyan-200" },
            slate:  { base:"slate",  bg50:"bg-slate-50",  text500:"text-slate-500",  text600:"text-slate-600",  hoverBg:"hover:bg-slate-50",  hoverBorder:"hover:border-slate-200" },
        };

        /* --- COMPONENTES VISUAIS --- */
        const SectionTitle = ({ icon, title, color = "slate" }) => {
            const c = COLOR[color] || COLOR.slate;
            return (
                <div className="flex items-center gap-2 mb-2 mt-6 first:mt-0 px-1">
                    <span className={`material-symbols-rounded text-sm ${c.text500}`}>{icon}</span>
                    <span className={`text-xs font-bold ${c.text600} uppercase tracking-widest`}>{title}</span>
                </div>
            );
        };

        const ConfigItem = ({ icon, title, subtitle, value, color = "indigo", onClick }) => {
            const c = COLOR[color] || COLOR.indigo;
            const isInteractive = !!onClick;
            
            return (
                <div 
                    className={`flex items-center justify-between w-full px-4 py-3 rounded-xl transition-all border bg-white border-slate-200 text-slate-700 shadow-sm ${isInteractive ? `cursor-pointer active:scale-[0.99] hover:shadow ${c.hoverBg} ${c.hoverBorder}` : ''}`}
                    onClick={onClick}
                >
                    <div className="flex items-center gap-3 overflow-hidden">
                        <span className={`material-symbols-rounded text-xl ${c.text500}`}>{icon}</span>
                        <div className="flex flex-col overflow-hidden">
                            <span className="font-medium text-sm truncate">{title}</span>
                            {subtitle && <span className="text-[10px] text-slate-400 truncate">{subtitle}</span>}
                        </div>
                    </div>
                    <div className="flex items-center pl-2">
                        {value && <span className="text-sm font-semibold text-slate-600 mr-2">{value}</span>}
                        {isInteractive && <span className="material-symbols-rounded text-slate-400">content_copy</span>}
                    </div>
                </div>
            );
        };

        function ProfileApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [processingPhoto, setProcessingPhoto] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [authError, setAuthError] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            
            const fileInputRef = useRef(null);

            useEffect(() => {
                const checkMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                setIsMobile(checkMobile);

                let isMounted = true;
                try {
                    window.parent.postMessage({ 
                        type: 'DB_REQUEST', 
                        requestId: 'profile_load',
                        payload: { action: 'get_user' } 
                    }, '*');
                } catch (e) {
                    console.warn("Stand-alone mode");
                }

                const handleMessage = (event) => {
                    const { type, requestId, result } = event.data;
                    if (type === 'DB_RESPONSE' && requestId === 'profile_load' && isMounted) {
                        if (result) {
                            setUser(result);
                        } else {
                            setAuthError(true); 
                        }
                        setLoading(false);
                    }
                    if (type === 'DB_RESPONSE' && requestId === 'profile_update' && isMounted) {
                        setUser(result);
                        setProcessingPhoto(false);
                    }
                };

                window.addEventListener('message', handleMessage);

                const timer = setTimeout(() => {
                    if (isMounted && loading) {
                        setAuthError(true);
                        setLoading(false);
                    }
                }, 1500);

                return () => {
                    isMounted = false;
                    window.removeEventListener('message', handleMessage);
                    clearTimeout(timer);
                };
            }, [loading]);

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => alert("Copiado!"));
            };

            // Nova lógica para o clique da foto: Verifica se está bloqueado ANTES de tentar processar.
            const handlePhotoClick = () => {
                if (!isMobile) {
                    alert("A alteração de foto foi projetada para uso em dispositivos móveis (câmera).");
                    return;
                }
                
                if (isLocked) {
                    alert("Por favor, faça login no App principal para alterar a foto.");
                    return;
                }
                
                fileInputRef.current.click();
            };

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 300;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        }
                    }
                });
            };

            const handleFileChange = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    setProcessingPhoto(true);
                    const file = e.target.files[0];
                    try {
                        const compressedBase64 = await compressImage(file);
                        const updatedUser = { ...user, photo: compressedBase64 };
                        window.parent.postMessage({ 
                            type: 'DB_REQUEST', 
                            requestId: 'profile_update',
                            payload: { action: 'update_user', data: updatedUser } 
                        }, '*');
                    } catch (err) {
                        console.error(err);
                        setProcessingPhoto(false);
                        alert("Erro ao processar imagem.");
                    }
                }
            };

            if (loading) {
                return (
                    <div className="flex flex-col items-center justify-center h-64 text-slate-400 gap-2">
                        <span className="material-symbols-rounded animate-spin text-3xl">sync</span>
                        <span className="text-xs">Carregando perfil...</span>
                    </div>
                );
            }

            const isLocked = authError || !user;
            const displayUser = isLocked ? DUMMY_USER : user;
            const userPhoto = displayUser.photo || null;

            return (
                <div className="relative max-w-2xl mx-auto p-4 animate-[fadeInUp_0.3s_ease-out]">
                    {/* Input de Arquivo (Sempre Oculto) */}
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />

                    {/* --- OVERLAY DE BLOQUEIO (Muito Transparente: 15%) --- */}
                    {isLocked && (
                        <div className="absolute inset-0 z-50 flex flex-col items-center justify-center p-8 text-center bg-white/15 backdrop-blur-[1px] rounded-3xl transition-all">
                            <div className="bg-white/95 p-6 rounded-3xl shadow-lg border border-white/50 backdrop-blur-md animate-[fadeInUp_0.5s_ease-out]">
                                <div className="h-16 w-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 shadow-inner mx-auto">
                                    <span className="material-symbols-rounded text-3xl text-slate-400">lock</span>
                                </div>
                                <h2 className="text-lg font-bold text-slate-800 mb-2">Acesso Restrito</h2>
                                <p className="text-slate-500 text-xs max-w-[200px] mx-auto leading-relaxed">Faça <strong>login</strong> no menu principal para desbloquear seus dados reais.</p>
                            </div>
                        </div>
                    )}

                    {/* --- CONTEÚDO PRINCIPAL --- */}
                    <div className={`transition-all duration-500 ${isLocked ? 'opacity-80 filter blur-[0.5px] pointer-events-none grayscale-[0.2]' : ''}`}>
                        
                        {/* Cabeçalho com Foto Editável */}
                        <div className="flex items-center gap-4 mb-8 px-2">
                            <div className="relative group">
                                <div className="h-20 w-20 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-2xl shadow-lg border-2 border-white overflow-hidden">
                                    {processingPhoto ? <span className="material-symbols-rounded animate-spin">sync</span> : userPhoto ? <img src={userPhoto} alt="Perfil" className="w-full h-full object-cover" /> : (displayUser.name ? displayUser.name.substring(0, 2).toUpperCase() : '??')}
                                </div>
                                
                                {/* Botão de Editar Foto (SEMPRE RENDERIZADO, mas com estilo de desativação) */}
                                <button 
                                    onClick={handlePhotoClick} // A lógica de bloqueio está DENTRO de handlePhotoClick
                                    className={`absolute bottom-0 right-0 bg-white text-purple-600 rounded-full p-1.5 shadow-md border border-purple-100 transition flex items-center justify-center 
                                        ${isLocked ? 'opacity-50 cursor-not-allowed' : 'hover:scale-110 active:scale-95'}
                                        ${!isMobile ? 'opacity-50 cursor-not-allowed' : ''}
                                    `}
                                    title={isMobile ? (isLocked ? "Faça login para alterar" : "Alterar Foto") : "Exclusivo para celular"}
                                >
                                    <span className="material-symbols-rounded text-sm">photo_camera</span>
                                </button>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800">{displayUser.name}</h1>
                                <span className="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-0.5 rounded border border-purple-100 capitalize">{displayUser.role || 'Usuário'}</span>
                            </div>
                        </div>

                        {/* Lista de Dados */}
                        <div className="flex flex-col gap-3">
                            <SectionTitle icon="badge" title="Dados Pessoais" color="purple" />
                            <ConfigItem icon="person" title="Nome Completo" value={displayUser.name} color="purple" />
                            <ConfigItem icon="call" title="Telefone" subtitle="Usado como Login" value={displayUser.phone} color="purple" />
                            <ConfigItem icon="mail" title="E-mail" value={displayUser.email || "Não informado"} color="purple" />
                            <SectionTitle icon="fingerprint" title="Segurança & Sistema" color="slate" />
                            <ConfigItem icon="key" title="ID Único (Hash)" subtitle="Toque para copiar" color="slate" onClick={() => !isLocked && copyToClipboard(displayUser.id)} />
                             <div className="mt-4 pt-4 border-t border-slate-100">
                                <div onClick={() => !isLocked && setShowDebug(!showDebug)} className="flex items-center gap-2 cursor-pointer opacity-60 hover:opacity-100 transition">
                                    <span className="material-symbols-rounded text-slate-400 text-sm">terminal</span>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">JSON Bruto</span>
                                    <span className="material-symbols-rounded text-slate-400 text-sm ml-auto">{showDebug ? 'expand_less' : 'expand_more'}</span>
                                </div>
                                {showDebug && <div className="mt-2 bg-slate-50 p-3 rounded-lg border border-slate-200 text-[10px] font-mono text-slate-500 break-all">{JSON.stringify(displayUser)}</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProfileApp />);
    </script>
</body>
</html>
