<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro e Login</title>
    <!-- Carrega Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet"/>
    <style>
        /* Estilos básicos para o MiniApp */
        body { font-family: 'Inter', sans-serif; background-color: transparent; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    
    <div id="auth-card" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border-t-4 border-purple-600">
        <h1 class="text-3xl font-bold text-gray-800 mb-2" id="form-title">Entrar</h1>
        <p class="text-sm text-gray-500 mb-6" id="form-subtitle">Acesse sua conta ou crie um novo cadastro.</p>

        <div id="message-area" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>

        <form id="auth-form" onsubmit="handleAuth(event)">
            <!-- CAMPO TELEFONE -->
            <div class="mb-4">
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone (com DDD)</label>
                <input type="tel" id="phone" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition" 
                       placeholder="(99) 99999-9999" pattern="[0-9]{10,15}" title="Insira um número válido (mínimo 10 dígitos)">
            </div>
            <!-- NOVO CAMPO EMAIL -->
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                <input type="email" id="email" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition" 
                       placeholder="seu.email@exemplo.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="password" required minlength="6"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition" 
                       placeholder="Mínimo 6 caracteres">
            </div>

            <button type="submit" id="submit-btn" 
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                <span id="loading-spinner" class="hidden animate-spin h-5 w-5 mr-3 border-b-2 border-white rounded-full"></span>
                <span id="button-text">Entrar</span>
            </button>
        </form>
        
        <div class="mt-4 text-center">
            <button id="toggle-mode-btn" onclick="toggleMode()" class="text-sm text-purple-600 hover:text-purple-700 transition">
                Ainda não tem conta? Cadastre-se
            </button>
        </div>

        <div id="logout-area" class="mt-6 border-t pt-4 text-center hidden">
            <p id="logged-in-message" class="text-sm text-gray-600 mb-3"></p>
            <button id="logout-btn" onclick="handleLogout()" 
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
                Sair
            </button>
        </div>
    </div>

    <!-- SCRIPT DE AUTENTICAÇÃO SIMULADA (SEM FIREBASE) -->
    <script>
        let isRegisterMode = false;
        let currentUserPhone = null;
        let currentUserEmail = null;

        // --- FUNÇÕES DE COMUNICAÇÃO MFE -> HOST ---
        function showHostAlert(type, message) {
            window.parent.postMessage({ type: 'HOST_ALERT', payload: { message, type } }, '*');
        }

        function sendMfeLog(message) {
            window.parent.postMessage({ type: 'MFE_LOG', payload: { message, component: 'Auth' } }, '*');
        }
        
        // Função para mostrar ou esconder a área de logout
        function updateAuthUI(isLoggedIn, phoneNumber = null, emailAddress = null) {
            const authCard = document.getElementById('auth-card');
            const logoutArea = document.getElementById('logout-area');
            
            if (isLoggedIn) {
                authCard.classList.add('hidden');
                logoutArea.classList.remove('hidden');
                document.getElementById('logged-in-message').textContent = `Você está logado(a) com ${emailAddress}.`;
                currentUserPhone = phoneNumber;
                currentUserEmail = emailAddress;
                sendMfeLog(`UI atualizada para o estado de Login: ${emailAddress}`);
            } else {
                authCard.classList.remove('hidden');
                logoutArea.classList.add('hidden');
                currentUserPhone = null;
                currentUserEmail = null;
                sendMfeLog('UI atualizada para o estado de Logout.');
            }
        }
        // --- FIM DAS FUNÇÕES DE COMUNICAÇÃO ---

        function setFormLoading(isLoading) {
            const submitBtn = document.getElementById('submit-btn');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');
            
            submitBtn.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('hidden');
                buttonText.textContent = isRegisterMode ? 'Registrando...' : 'Acessando...';
            } else {
                spinner.classList.add('hidden');
                buttonText.textContent = isRegisterMode ? 'Cadastrar' : 'Entrar';
            }
            // Oculta o campo de email no modo Entrar
            const emailField = document.getElementById('email');
            if (!isRegisterMode) {
                 emailField.required = false;
                 emailField.parentNode.classList.add('hidden');
            } else {
                 emailField.required = true;
                 emailField.parentNode.classList.remove('hidden');
            }
        }
        
        window.toggleMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('form-title').textContent = isRegisterMode ? 'Novo Cadastro' : 'Entrar';
            document.getElementById('form-subtitle').textContent = isRegisterMode ? 'Crie sua conta com telefone, email e senha.' : 'Acesse sua conta para continuar.';
            document.getElementById('toggle-mode-btn').textContent = isRegisterMode ? 'Já tem conta? Entrar' : 'Ainda não tem conta? Cadastre-se';
            
            document.getElementById('auth-card').classList.toggle('border-purple-600', !isRegisterMode);
            document.getElementById('auth-card').classList.toggle('border-emerald-600', isRegisterMode);
            
            document.getElementById('submit-btn').classList.toggle('bg-purple-600', !isRegisterMode);
            document.getElementById('submit-btn').classList.toggle('hover:bg-purple-700', !isRegisterMode);
            document.getElementById('submit-btn').classList.toggle('bg-emerald-600', isRegisterMode);
            document.getElementById('submit-btn').classList.toggle('hover:bg-emerald-700', isRegisterMode);

            setFormLoading(false); // Reinicia o botão
            
            // Reajusta a visibilidade do campo de email
            const emailField = document.getElementById('email').parentNode;
            if (isRegisterMode) {
                emailField.classList.remove('hidden');
            } else {
                emailField.classList.add('hidden');
            }
        };
        
        function validatePhoneNumber(number) {
            const cleanNumber = number.replace(/\D/g, ''); 
            return cleanNumber.length >= 10; 
        }

        // --- FUNÇÃO DE AUTENTICAÇÃO SIMULADA (CHAMADA API) ---
        window.handleAuth = async (event) => {
            event.preventDefault();
            setFormLoading(true);

            const phoneNumber = document.getElementById('phone').value;
            const emailAddress = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!validatePhoneNumber(phoneNumber)) {
                showHostAlert('error', 'Por favor, insira um número de telefone válido (com DDD).');
                setFormLoading(false);
                return;
            }

            if (isRegisterMode && (!emailAddress || !emailAddress.includes('@'))) {
                showHostAlert('error', 'Por favor, insira um endereço de e-mail válido para o cadastro.');
                setFormLoading(false);
                return;
            }

            if (password.length < 6) {
                showHostAlert('error', 'A senha deve ter no mínimo 6 caracteres.');
                setFormLoading(false);
                return;
            }

            // SIMULAÇÃO DE CHAMADA DE REDE (2 SEGUNDOS)
            await new Promise(resolve => setTimeout(resolve, 2000)); 

            try {
                if (isRegisterMode) {
                    showHostAlert('success', `Sucesso! Cadastro de ${emailAddress} enviado para validação.`);
                    
                    // 1. Notifica a janela pai (HOST) sobre o sucesso do login
                    window.parent.postMessage({ type: 'AUTH_SUCCESS', phone: phoneNumber, email: emailAddress }, '*');
                    updateAuthUI(true, phoneNumber, emailAddress);

                } else {
                    // No modo Login, usamos o email como identificador (simulação)
                    const simulatedEmail = "usuario.logado@simulacao.com";
                    showHostAlert('success', `Acesso realizado com sucesso! Bem-vindo(a), ${simulatedEmail}.`);
                    
                    // 1. Notifica a janela pai (HOST) sobre o sucesso do login
                    window.parent.postMessage({ type: 'AUTH_SUCCESS', phone: phoneNumber, email: simulatedEmail }, '*');
                    updateAuthUI(true, phoneNumber, simulatedEmail);
                }
                
            } catch (error) {
                showHostAlert('error', 'Erro na comunicação com o servidor.');
            } finally {
                setFormLoading(false);
            }
        };

        // --- FUNÇÃO DE LOGOUT ---
        window.handleLogout = () => {
            sendMfeLog('Botão Sair pressionado. Enviando evento de logout para o Host.');
            
            // 2. Notifica a janela pai (HOST) sobre o Logout
            window.parent.postMessage({ type: 'AUTH_LOGOUT' }, '*');
            
            // Reverte a UI para o estado de login/cadastro
            updateAuthUI(false);
            window.location.reload(); // Recarrega o iframe para limpar o estado
        };

        // Função para inicializar o estado inicial correto
        document.addEventListener('DOMContentLoaded', () => {
            // Garante que o campo de email esteja escondido no modo Entrar inicial
            const emailField = document.getElementById('email');
            if (!isRegisterMode) {
                 emailField.required = false;
                 emailField.parentNode.classList.add('hidden');
            }
            sendMfeLog('MFE de Autenticação Carregado e Pronto.');
        });
        
    </script>

</body>
</html>
