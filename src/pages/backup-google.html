<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backup Google – 5Horas</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500&display=swap">

  <!-- Carrega Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-100 font-inter min-h-screen">

  <header class="fixed top-0 left-0 right-0 bg-slate-900/80 backdrop-blur border-b border-slate-700/40 flex items-center justify-between p-4 z-10">
    <a href="../../index.html" class="text-slate-200 flex items-center gap-2">
      <span class="material-symbols-rounded text-base">arrow_back</span>
      Voltar
    </a>
    <h1 class="font-semibold text-lg">Backup Google Drive</h1>
    <span class="w-10"></span>
  </header>

  <main class="p-4 pt-24 max-w-lg mx-auto space-y-6">

    <section class="rounded-2xl bg-slate-800/60 p-5 border border-slate-700/70 shadow-lg">
      <h2 class="font-semibold mb-3 flex items-center gap-2 text-xl">
        <span id="sync-icon" class="material-symbols-rounded text-blue-400 animate-pulse">sync</span>
        Status de Conexão
      </h2>
      <p id="status-message" class="text-sm text-slate-300">
        Clique em "Conectar" para iniciar o acesso ao seu Google Drive.
      </p>

      <!-- Botão de Conexão -->
      <button id="btn-login" type="button" class="mt-4 w-full rounded-xl bg-blue-600 hover:bg-blue-500 px-4 py-2 text-sm font-medium transition disabled:bg-slate-700 disabled:text-slate-400">
        Conectar com Google
      </button>
    </section>

    <!-- Seção de Sincronização (Disponível após o login) -->
    <section id="sync-section" class="rounded-2xl bg-slate-800/60 p-5 border border-slate-700/70 space-y-3" aria-hidden="true" style="display: none;">
      <h2 class="font-semibold mb-1 flex items-center gap-2 text-xl">
        <span class="material-symbols-rounded text-emerald-400">cloud_done</span>
        Sincronizar Dados
      </h2>
      <p class="text-sm text-slate-300">Seu app pode agora salvar e restaurar dados multi-dispositivo.</p>

      <!-- Upload (Backup) -->
      <button id="btn-sync-upload" type="button" class="w-full rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 text-sm font-medium transition disabled:bg-slate-700 disabled:text-slate-400 flex items-center justify-center gap-2">
        <span class="material-symbols-rounded text-base">upload</span>
        Enviar Backup (Salvar)
      </button>

      <!-- Download (Restaurar) -->
      <button id="btn-sync-download" type="button" class="w-full rounded-xl bg-amber-500 hover:bg-amber-400 px-4 py-2 text-sm font-medium text-slate-900 transition disabled:bg-slate-700 disabled:text-slate-400 flex items-center justify-center gap-2">
        <span class="material-symbols-rounded text-base">download</span>
        Baixar Backup (Restaurar)
      </button>
    </section>

    <!-- Painel de Log e Erros -->
    <section class="rounded-2xl bg-slate-800/60 p-4 border border-slate-700/70">
      <h2 class="font-semibold mb-1 text-sm">Log e Detalhes</h2>
      <pre id="status-log" class="text-xs text-slate-300 whitespace-pre-wrap max-h-40 overflow-y-auto"></pre>
    </section>

  </main>

  <script type="module">
    // --- IMPORTAÇÕES DIRETAS DE CDN ---
    // CORREÇÃO: Removido o uso da variável CDN_BASE nas importações, pois o 'import' estático
    // não permite concatenação de strings. Agora usamos o caminho literal completo.
    
    // Carrega os módulos necessários
    import * as Loader from "https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/core/header/loader.js";
    import { loginWithGoogle } from "https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/auth/google-auth.js";
    import { performBackupUpload, performBackupDownload } from "https://cdn.jsdelivr.net/gh/fabiocolletto/miniapp@main/src/core/backup/index.js";


    // --- VARIÁVEIS E FUNÇÕES ---
    
    // Elementos da UI
    const statusMessageEl = document.getElementById("status-message");
    const statusLogEl = document.getElementById("status-log");
    const syncIconEl = document.getElementById("sync-icon");
    const syncSectionEl = document.getElementById("sync-section");
    const loginBtn = document.getElementById("btn-login");
    const uploadBtn = document.getElementById("btn-sync-upload");
    const downloadBtn = document.getElementById("btn-sync-download");

    let isConnected = false;

    // Utilitários de UI
    function updateStatus(message, isError = false) {
      statusMessageEl.textContent = message;
      statusMessageEl.classList.toggle('text-red-400', isError);
      statusMessageEl.classList.toggle('text-slate-300', !isError);
    }

    function updateLog(message) {
      const now = new Date().toLocaleTimeString('pt-BR');
      statusLogEl.textContent = `[${now}] ${message}\n` + statusLogEl.textContent;
    }

    function setSyncUI(connected) {
      isConnected = connected;
      loginBtn.disabled = connected;
      syncSectionEl.style.display = connected ? 'block' : 'none';
      syncSectionEl.setAttribute("aria-hidden", connected ? "false" : "true");
      
      if (connected) {
        updateStatus("Conectado. Sincronização pronta.", false);
        syncIconEl.textContent = 'cloud_done';
        syncIconEl.classList.remove('animate-pulse', 'text-blue-400');
        syncIconEl.classList.add('text-emerald-400');
      } else {
        updateStatus("Desconectado. É necessário o login.", true);
        syncIconEl.textContent = 'sync';
        syncIconEl.classList.add('animate-pulse', 'text-blue-400');
        syncIconEl.classList.remove('text-emerald-400');
      }
    }

    function setButtonsDisabled(disabled) {
      uploadBtn.disabled = disabled;
      downloadBtn.disabled = disabled;
      loginBtn.disabled = disabled || isConnected;
    }

    // --- Handlers de Eventos ---

    loginBtn.onclick = async () => {
      updateStatus("Conectando ao Google... (Pode abrir uma janela pop-up)", false);
      setButtonsDisabled(true);

      try {
        await loginWithGoogle();
        setSyncUI(true);
        updateLog("Sucesso: Usuário autenticado e token obtido.");
      } catch (error) {
        setSyncUI(false);
        const detail = error?.message || "Falha na conexão.";
        updateStatus("Falha na conexão: " + detail, true);
        updateLog("ERRO de Login: " + detail);
      } finally {
        setButtonsDisabled(false);
      }
    };

    uploadBtn.onclick = async () => {
      updateStatus("Enviando backup para o Google Drive...", false);
      setButtonsDisabled(true);

      try {
        const r = await performBackupUpload(); 
        updateStatus("Backup enviado com sucesso!", false);
        updateLog("Upload completo. Arquivo ID: " + r.id);
      } catch (error) {
        updateStatus("ERRO ao enviar backup. Veja o log.", true);
        updateLog("ERRO de Upload: " + error.message);
      } finally {
        setButtonsDisabled(false);
      }
    };

    downloadBtn.onclick = async () => {
      updateStatus("Baixando backup do Google Drive...", false);
      setButtonsDisabled(true);

      try {
        const restored = await performBackupDownload(); 
        if (restored) {
          updateStatus("Backup restaurado com sucesso. Recarregando o App...", false);
          updateLog("Download completo. Dados restaurados. A página principal deve ser recarregada.");
          if (window.parent) {
            window.parent.location.reload();
          } else {
             setTimeout(() => window.location.reload(), 1500);
          }
        } else {
          updateStatus("Nenhum backup encontrado na sua conta.", false);
          updateLog("Download: Arquivo de backup não existe ou está vazio.");
        }
      } catch (error) {
        updateStatus("ERRO ao baixar backup. Veja o log.", true);
        updateLog("ERRO de Download: " + error.message);
      } finally {
        setButtonsDisabled(false);
      }
    };

    // --- Inicialização ---

    document.addEventListener("DOMContentLoaded", () => {
        updateLog("Módulos carregados via CDN. Pronto para iniciar.");
        setSyncUI(false); 
    });
  </script>
</body>
</html>
