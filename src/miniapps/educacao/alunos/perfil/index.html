<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Educação — Perfil do Usuário</title>

  <!-- Google Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tokens de tema (adaptados de index (1).html) + ACCENT PINK (Alunos) -->
  <style>
    :root {
      color-scheme: light dark;
      --page-bg: 0 0 0;
      --page-bg-alpha: .92;
      --page-fg: 248 250 252;
      --page-fg-muted: 226 232 240;
      --page-border: 255 255 255;
      --disabled-opacity: .72;
      
      /* Cor de fundo sutil para inputs (Dark Mode) */
      --input-bg: 255 255 255 / 0.05; 

      /* Accent pink (dark) */
      --accent: 236 72 153;        /* pink-500 */
      --accent-weak: 236 72 153 / 0.12;
      --accent-border: 236 72 153 / 0.45;
      --accent-text: 253 242 248;  /* pink-50 */
    }
    html[data-theme="light"] {
      --page-bg: 248 250 252;
      --page-bg-alpha: .96;
      --page-fg: 15 23 42;
      --page-fg-muted: 51 65 85;
      --page-border: 15 23 42;
      --disabled-opacity: .85;

      /* Cor de fundo sutil para inputs (Light Mode) */
      --input-bg: 15 23 42 / 0.03; 

      /* Accent pink (light) */
      --accent: 219 39 119;        /* pink-600 */
      --accent-weak: 219 39 119 / 0.10;
      --accent-border: 219 39 119 / 0.40;
      --accent-text: 131 24 67;    /* pink-900 */
    }

    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    
    /* Estilo para inputs e botões primários */
    .input-base {
      /* Ajustado para usar a variável --input-bg e garantir que a borda use a cor da página */
      @apply w-full p-3 rounded-xl border border-[rgb(var(--page-border)/0.2)] focus:ring-2 focus:ring-[rgb(var(--accent))] focus:border-[rgb(var(--accent)/0.5)] transition-colors duration-200;
      background-color: rgb(var(--input-bg)); /* Novo fundo sutil */
    }
    .btn-primary {
      @apply w-full px-4 py-3 rounded-xl font-semibold text-[rgb(var(--accent-text))] bg-[rgb(var(--accent))] hover:bg-[rgb(var(--accent)/0.9)] transition-colors duration-200;
    }
    /* Card/seção permanece transparente com borda visível */
    .section-card {
      @apply bg-transparent border border-[rgb(var(--page-border)/0.25)] rounded-2xl shadow-none p-6 sm:p-8;
    }
  </style>
</head>
<body class="min-h-screen antialiased relative text-[rgb(var(--page-fg))] bg-[rgb(var(--page-bg)/var(--page-bg-alpha))] transition-colors">

  <!-- Header-bar FIXO no topo, com botão de voltar (esquerda) e tema (direita) -->
  <div class="fixed top-0 inset-x-0 z-50 flex justify-between items-center px-4 sm:px-6 lg:px-8 py-4 bg-transparent">
    
    <!-- Botão para retornar à tela anterior (canto superior esquerdo) -->
    <a href="javascript:history.back()"
      class="inline-flex items-center gap-1 rounded-full border border-[rgb(var(--page-border)/0.12)] bg-transparent px-3 py-2 text-sm font-semibold hover:bg-[rgb(var(--page-border)/0.06)] transition"
      aria-label="Voltar à tela anterior"
    >
      <span class="material-symbols-rounded text-base sm:text-lg" aria-hidden="true">arrow_back</span>
      <span class="hidden sm:inline">Voltar</span>
    </a>

    <!-- Botão tema canto superior direito (existente) -->
    <button
      class="inline-flex items-center gap-2 rounded-full border border-[rgb(var(--page-border)/0.12)] bg-transparent px-3 py-2 text-sm font-semibold hover:bg-[rgb(var(--page-border)/0.06)] transition"
      type="button"
      data-theme-toggle
      aria-label="Alternar tema"
    >
      <span class="material-symbols-rounded" aria-hidden="true" data-theme-icon>dark_mode</span>
      <span class="sr-only" data-theme-label>Usar tema escuro</span>
    </button>
  </div>

  <main class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pt-20">

    <!-- HERO centralizado, sem borda -->
    <header class="mt-8 mb-12 text-center">
      <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-[rgb(var(--accent))]">Meu Perfil</h1>
      <p class="mt-2 text-sm sm:text-base text-[rgb(var(--page-fg-muted))]">Gerencie suas informações e preferências.</p>
    </header>

    <!-- Seção 1: Cadastro e Edição de Dados -->
    <!-- Card transparente com borda visível -->
    <section class="mb-10 section-card">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <span class="material-symbols-rounded text-[rgb(var(--accent))]">person</span>
        Dados Cadastrais
      </h2>
      
      <form id="profile-form" class="space-y-5">
        
        <!-- Campo Nome Completo -->
        <div>
          <label for="full_name" class="block text-sm font-medium mb-1 text-[rgb(var(--page-fg-muted))]">Nome Completo</label>
          <!-- Removido: value="Nome do Usuário Atual" -->
          <input type="text" id="full_name" name="full_name" placeholder="Seu nome completo" value="" class="input-base" />
        </div>

        <!-- Campo Telefone Celular -->
        <div>
          <label for="phone" class="block text-sm font-medium mb-1 text-[rgb(var(--page-fg-muted))]">Celular (DDD + Número)</label>
          <input type="tel" id="phone" name="phone" placeholder="(XX) 9XXXX-XXXX" value="" class="input-base" maxlength="15" />
        </div>

        <!-- Campo E-mail -->
        <div>
          <label for="email" class="block text-sm font-medium mb-1 text-[rgb(var(--page-fg-muted))]">E-mail</label>
          <!-- Removido: value="usuario@exemplo.com" -->
          <input type="email" id="email" name="email" placeholder="seu.email@exemplo.com" value="" class="input-base" />
        </div>

        <!-- Campo Senha -->
        <div>
          <label for="password" class="block text-sm font-medium mb-1 text-[rgb(var(--page-fg-muted))]">Senha</label>
          <div class="relative">
             <!-- Placeholder para campo de senha, focando na estética -->
            <input type="password" id="password" name="password" placeholder="Nova senha (deixe vazio para não alterar)" value="" class="input-base pr-10" />
            <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-[rgb(var(--page-fg-muted))] hover:text-[rgb(var(--page-fg))] transition" aria-label="Mostrar/Esconder Senha">
              <span class="material-symbols-rounded text-lg">visibility_off</span>
            </button>
          </div>
        </div>

        <!-- Botão Salvar Alterações -->
        <div class="pt-2">
          <button type="submit" class="btn-primary">
             <span class="material-symbols-rounded text-lg align-middle mr-1">save</span>
             Salvar Alterações
          </button>
        </div>
      </form>
    </section>

    <!-- Seção 2: Sincronização com Cloud Services -->
    <!-- Card transparente com borda visível -->
    <section class="mb-10 section-card">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <span class="material-symbols-rounded text-[rgb(var(--accent))]">cloud_sync</span>
        Sincronização com Cloud
      </h2>

      <p class="text-sm text-[rgb(var(--page-fg-muted))] mb-5">Habilite a sincronização para manter seus dados de estudo e simulados seguros na nuvem.</p>

      <div class="space-y-4">
        
        <!-- Google Drive Toggle (Exemplo: Desconectado) - Mantendo a estética de notificação de status -->
        <div class="flex items-center justify-between p-4 rounded-xl border border-red-600/30 bg-red-500/10">
          <div class="flex items-center gap-3">
            <!-- Icone SVG do Google Drive (simplificado) -->
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill="#4285F4" d="M12 0l-8.6 14.8L7.4 24h17.2L12 0z"/>
              <path fill="#0F9D58" d="M21 24H7.4l4.6-9.2 4.6 9.2H21z"/>
              <path fill="#F4B400" d="M3.4 14.8L12 0l8.6 14.8-4.3 7.4-4.3-7.4z"/>
              <path fill="#DB4437" d="M16.6 22.2l-4.6-7.4-4.6 7.4H16.6z"/>
            </svg>
            <div>
              <p class="font-medium">Google Drive</p>
              <p id="gdrive-status" class="text-xs text-red-400">Desconectado</p>
            </div>
          </div>
          <!-- Botão para Conectar (Estilo de botão primário/ativo) -->
          <button id="toggle-gdrive" class="px-4 py-1.5 rounded-full text-xs font-semibold bg-[rgb(var(--accent))] text-[rgb(var(--accent-text))] hover:bg-[rgb(var(--accent)/0.9)] transition">
            Conectar
          </button>
        </div>

        <!-- OneDrive Toggle (Exemplo: Conectado) - Mantendo a estética de notificação de status -->
        <!-- O botão agora chama showSyncToast(true) -->
        <div class="flex items-center justify-between p-4 rounded-xl border border-emerald-600/30 bg-emerald-500/10">
          <div class="flex items-center gap-3">
            <!-- Icone SVG do OneDrive (simplificado) -->
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill="#0078D4" d="M10.8 2.4l-7.2 12 4.8 8.4 7.2-12-4.8-8.4zM16.8 14.4l-4.8 8.4 9.6-16.8-4.8 8.4zM4.8 14.4h19.2L16.8 2.4z"/>
            </svg>
            <div>
              <p class="font-medium">OneDrive</p>
              <p id="onedrive-status" class="text-xs text-emerald-400">Sincronizado</p>
            </div>
          </div>
          <!-- Botão para Desconectar (Estilo de botão secundário/perigo) -->
          <button id="toggle-onedrive" class="px-4 py-1.5 rounded-full text-xs font-semibold bg-gray-500/20 text-[rgb(var(--page-fg-muted))] hover:bg-gray-500/30 transition">
            Desconectar
          </button>
        </div>

      </div>
    </section>

  </main>

  <!-- Toast de tema (mantido) -->
  <div id="theme-toast" class="fixed bottom-4 right-4 z-[60] pointer-events-none select-none opacity-0 translate-y-2 transition-all duration-300" role="status" aria-live="polite">
    <div class="flex items-center gap-2 rounded-full border border-[rgb(var(--page-border)/0.18)] bg-[rgb(var(--page-bg)/0.9)] px-3 py-1.5 text-xs font-semibold shadow-lg">
      <span id="theme-toast-icon" class="material-symbols-rounded text-base">dark_mode</span>
      <span id="theme-toast-label">Tema escuro</span>
    </div>
  </div>

  <!-- NOVO Toast para Sincronização (canto inferior direito) -->
  <div id="sync-toast" class="fixed bottom-4 right-4 z-[60] pointer-events-none select-none opacity-0 translate-y-2 transition-all duration-300" role="status" aria-live="polite">
    <div class="flex items-center gap-2 rounded-full border border-emerald-500/30 bg-emerald-700/80 backdrop-blur-sm px-3 py-1.5 text-xs font-semibold text-white shadow-lg">
      <span class="material-symbols-rounded text-base">cloud_done</span>
      <span id="sync-toast-label">OneDrive: Sincronização Ativada!</span>
    </div>
  </div>

  <script type="module">
    import { activateBackup, getBackupConfig } from '../../../core/backup/index.js';

    // ============================
    // Lógica de Tema
    // ============================
    (function () {
      const html = document.documentElement;
      const toggleBtn = document.querySelector('[data-theme-toggle]');
      const icon = document.querySelector('[data-theme-icon]');
      const srLabel = document.querySelector('[data-theme-label]');
      const toast = document.getElementById('theme-toast');
      const toastIcon = document.getElementById('theme-toast-icon');
      const toastLabel = document.getElementById('theme-toast-label');
      let toastTimer = null;

      if (!toggleBtn) return;

      function showToast(theme) {
        if (!toast) return;
        const isDark = theme === 'dark';
        toastIcon.textContent = isDark ? 'dark_mode' : 'light_mode';
        toastLabel.textContent = isDark ? 'Tema escuro' : 'Tema claro';
        toast.classList.remove('opacity-0', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.add('opacity-0', 'translate-y-2');
          toast.classList.remove('opacity-100', 'translate-y-0');
        }, 1800);
      }

      function apply(theme, opts = { silent: false }) {
        html.setAttribute('data-theme', theme);
        const isDark = theme === 'dark';
        icon.textContent = isDark ? 'light_mode' : 'dark_mode';
        srLabel.textContent = isDark ? 'Usar tema claro' : 'Usar tema escuro';
        if (!opts.silent) showToast(theme);
      }

      function getInitialTheme() {
        const saved = localStorage.getItem('miniapp-theme');
        if (saved === 'light' || saved === 'dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      let theme = getInitialTheme();
      apply(theme, { silent: true });
      toggleBtn.addEventListener('click', () => {
        theme = theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('miniapp-theme', theme);
        apply(theme);
      });
    })();
    
    // ============================
    // Lógica do Toast de Sincronização (NOVO)
    // ============================

    let syncToastTimer = null;

    function showSyncToast(message = 'Sincronização ativada!') {
        const toast = document.getElementById('sync-toast');
        const label = document.getElementById('sync-toast-label');
        if (!toast) return;

        if (label) label.textContent = message;

        toast.classList.remove('opacity-0', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');

        if (syncToastTimer) clearTimeout(syncToastTimer);

        syncToastTimer = setTimeout(() => {
          toast.classList.add('opacity-0', 'translate-y-2');
          toast.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }


    // ============================
    // Lógica de MÁSCARA de Telefone (DDD + 9 digitos)
    // ============================
    document.addEventListener('DOMContentLoaded', () => {
        const phoneInput = document.getElementById('phone');

        if (phoneInput) {
            phoneInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito

                if (value.length > 11) {
                    value = value.substring(0, 11); // Limita a 11 dígitos (DDD + 9º)
                }

                if (value.length > 0) {
                    value = '(' + value;
                    if (value.length > 3) {
                        value = value.substring(0, 3) + ') ' + value.substring(3);
                    }
                    if (value.length > 10) {
                        value = value.substring(0, 10) + '-' + value.substring(10);
                    }
                    if (value.length > 15) {
                        value = value.substring(0, 15);
                    }
                }
                
                e.target.value = value;
            });
        }
    });

    // ============================
    // Lógica de Botões (Fluxo real de backup)
    // ============================

    const gdriveStatusEl = document.getElementById('gdrive-status');
    const onedriveStatusEl = document.getElementById('onedrive-status');
    const gdriveButton = document.getElementById('toggle-gdrive');
    const onedriveButton = document.getElementById('toggle-onedrive');

    const STATUS_CLASSNAMES = ['text-red-400', 'text-emerald-400', 'text-amber-400'];

    function updateStatus(provider, text, toneClass) {
      const statusEl = provider === 'google' ? gdriveStatusEl : onedriveStatusEl;
      const buttonEl = provider === 'google' ? gdriveButton : onedriveButton;

      if (statusEl) {
        STATUS_CLASSNAMES.forEach(cls => statusEl.classList.remove(cls));
        if (toneClass) statusEl.classList.add(toneClass);
        statusEl.textContent = text;
      }

      if (buttonEl && toneClass === 'text-emerald-400') {
        buttonEl.textContent = 'Sincronizar novamente';
      } else if (buttonEl) {
        buttonEl.textContent = provider === 'google' ? 'Conectar' : 'Desconectar';
      }
    }

    function getOwnerIdFromForm() {
      const emailInput = document.getElementById('email');
      return emailInput?.value?.trim() || '';
    }

    async function hydrateFromStoredConfig() {
      try {
        const stored = await getBackupConfig();
        if (!stored) return;

        if (stored.pendingSync) {
          const target = stored.requestedProvider;
          if (target === 'google' || target === 'onedrive') {
            updateStatus(target, 'Pendente (offline)', 'text-amber-400');
          } else {
            updateStatus('google', 'Pendente (offline)', 'text-amber-400');
            updateStatus('onedrive', 'Pendente (offline)', 'text-amber-400');
          }
          return;
        }

        if (stored.provider === 'google') {
          updateStatus('google', 'Sincronizado', 'text-emerald-400');
        }
        if (stored.provider === 'onedrive') {
          updateStatus('onedrive', 'Sincronizado', 'text-emerald-400');
        }
      } catch (error) {
        console.error('Não foi possível recuperar o status de backup salvo.', error);
      }
    }

    async function handleBackup(provider) {
      try {
        const ownerId = getOwnerIdFromForm();
        const config = await activateBackup(provider, ownerId);

        if (!config) {
          showSyncToast('Nenhuma configuração de backup retornada.');
          return;
        }

        if (config.pendingSync) {
          updateStatus(provider, 'Pendente (offline)', 'text-amber-400');
          showSyncToast('Backup pendente (offline) — será sincronizado quando voltar a internet');
          return;
        }

        updateStatus(provider, 'Sincronizado', 'text-emerald-400');
        const label = provider === 'google' ? 'Google Drive' : 'OneDrive';
        showSyncToast(`${label}: Sincronização Ativada!`);
      } catch (error) {
        console.error('Erro ao ativar backup', error);
        showSyncToast('Erro ao ativar backup. Tente novamente.');
      }
    }

    document.getElementById('profile-form').addEventListener('submit', function(event) {
        event.preventDefault();
        console.log("Formulário de perfil submetido. Lógica de salvamento precisa ser implementada.");
    });

    if (gdriveButton) {
      gdriveButton.addEventListener('click', () => handleBackup('google'));
    }

    if (onedriveButton) {
      onedriveButton.addEventListener('click', () => handleBackup('onedrive'));
    }

    hydrateFromStoredConfig();
  </script>
</body>
</html>
