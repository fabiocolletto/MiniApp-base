<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relat√≥rio de Viagem - Modelo Paran√°</title>
    <!-- Inclus√£o da biblioteca html2pdf.js via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #004a99; /* Azul institucional */
            --secondary-color: #f4f4f4;
            --success-color: #28a745;
            --error-color: #dc3545;
            --highlight-bg: #e8f4fd;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #e9ecef;
            color: #333;
        }

        /* --- ESTILOS DO FORMUL√ÅRIO --- */
        .container-form {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 { 
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* --- ESTILOS DE BLOCOS --- */
        .form-section-box {
            background-color: #f8f9fa; 
            padding: 20px; 
            border-radius: 5px; 
            border: 1px solid #e9ecef; 
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s;
        }

        .form-section-box:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
            border-color: #dbe4eb;
        }

        .form-section-title {
            margin-bottom: 15px; 
            display: block; 
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- INPUTS E CONTROLES --- */
        .form-group { 
            margin-bottom: 15px; 
            position: relative; 
        }

        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9rem; }
        
        .form-group input[type="text"], 
        .form-group input[type="number"], 
        .form-group input[type="datetime-local"],
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #fff;
            height: 48px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        /* Classe de valida√ß√£o ruim */
        .input-error {
            border: 2px solid var(--error-color) !important;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.5) !important;
        }

        .form-group textarea { height: auto; }
        
        /* Estilo para input file */
        .form-group input[type="file"] {
            padding: 10px;
            height: auto;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
        }
        /* Estilos para campos desabilitados por sync */
        .form-group select[disabled], .form-group input[disabled] {
            background-color: #e9ecef;
            cursor: not-allowed;
            color: #6c757d;
        }

        /* --- ASSISTENTE DE REDA√á√ÉO --- */
        .helper-options { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 5px; }
        .radio-card { flex: 1; min-width: 140px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; background: #fff; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .radio-card:hover { background-color: #f0f8ff; border-color: var(--primary-color); }
        .radio-card input { margin: 0; }

        /* --- LISTAS DIN√ÇMICAS (COMPROVANTES E PARADAS) --- */
        .list-item {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        .list-info { flex: 1; }
        .list-info strong { display: block; color: #333; }
        .list-info span { font-size: 0.9rem; color: #666; }
        .btn-remove {
            background: #ffebeb;
            color: #cc0000;
            border: 1px solid #ffcccc;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .btn-remove:hover { background: #ffcccc; }
        
        /* Bot√µes de A√ß√£o Espec√≠ficos para Roteiro */
        .btn-roteiro-action {
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
            transition: all 0.2s;
            margin-left: 5px;
            font-size: 0.8rem;
        }
        .btn-roteiro-action.edit {
            background-color: #007bff;
            color: white;
        }
        .btn-roteiro-action.edit:hover {
            background-color: #0056b3;
        }
        .btn-roteiro-action.add-main {
            background-color: var(--primary-color);
            color: white;
        }
        
        .comprovante-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 15px;
        }
        
        /* √Årea de inser√ß√£o de dados do comprovante */
        #dados_comprovante_container {
            border: 1px dashed #004a99;
            background: #f0f7ff;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            display: none; /* Escondido at√© selecionar arquivo */
        }

        /* Estilo para totalizador */
        #totalizador_anexos, #totalizador_outras_despesas {
            margin-top: 15px;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            font-weight: bold;
            color: #155724;
            text-align: right;
        }

        /* --- FEEDBACK VISUAL --- */
        .feedback-tooltip {
            position: absolute;
            top: 100%; left: 0; margin-top: 4px; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; color: #fff; opacity: 0; transform: translateY(-5px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 100; pointer-events: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap;
        }
        .feedback-tooltip.show { opacity: 1; transform: translateY(0); }
        .feedback-success { background-color: var(--success-color); }
        .feedback-error { background-color: var(--error-color); }

        .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .form-col { flex: 1; min-width: 200px; }

        .buttons-container {
            display: flex; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;
        }

        button.btn-success {
            padding: 16px 40px; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: 700; background-color: var(--success-color); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
        }
        
        button.btn-add {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        button.btn-cancel {
            background-color: #6c757d; /* Cinza */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            margin-right: 10px;
        }
        
        button:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }

        #status-msg { text-align: center; margin-top: 15px; font-weight: bold; color: var(--primary-color); display: none; }
        
        /* Estilo para a √°rea de inser√ß√£o de custos (que fica escondida) */
        #dados_custo_transporte_container, #dados_alimentacao_container, #dados_hospedagem_container {
            border: 1px dashed #004a99;
            background: #f0f7ff;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        /* REORGANIZADO: Lista de custos de transporte agora fica no topo da se√ß√£o 2 */
        #lista_custos_transporte_visual, #lista_outras_despesas_visual {
            margin-top: 5px;
        }

        /* Estilo para totalizador de Custos de Transporte */
        #totalizador_custos_transporte {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd; /* Cor de destaque para o transporte */
            border: 1px solid #ffeeba;
            border-radius: 4px;
            font-weight: bold;
            color: #856404;
            text-align: right;
            margin-bottom: 25px; /* Adicionado margem para separar do formul√°rio de adi√ß√£o */
        }
        
        /* Estilo para o cont√™iner de dados pessoais que ser√° oculto/mostrado */
        #dados_pessoais_ocultos_container {
             border: 1px dashed #ccc;
             background: #fdfdff;
             padding: 15px;
             border-radius: 4px;
             margin-top: 15px;
        }
        
        /* NOVO: Estilo para o resumo final */
        .resumo-final-card {
            background-color: #d1ecf1; /* Cor de informa√ß√£o/resumo */
            border: 2px solid #bee5eb;
            padding: 20px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .resumo-final-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #a2d2d8;
            font-weight: bold;
            color: #0c5460;
        }

        .resumo-final-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #0c5460;
            font-size: 1.25rem;
            font-weight: bold;
        }


        /* --- PDF OCULTO --- */
        #report-container {
            position: fixed; left: -9999px; top: 0; width: 210mm; min-height: 297mm; padding: 15mm; background: white; font-family: 'Times New Roman', serif; font-size: 12pt; color: #000; box-sizing: border-box; line-height: 1.3;
        }
        .report-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .report-section-title { background-color: #e0e0e0; border: 1px solid #000; padding: 5px; font-weight: bold; margin-top: 15px; font-size: 11pt; text-transform: uppercase; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 10pt; }
        .report-table td, .report-table th { border: 1px solid #000; padding: 6px; vertical-align: middle; }
        .report-table th { background-color: #f0f0f0; }
        .td-label { font-weight: bold; background-color: #f9f9f9; width: 20%; font-size: 9pt; text-transform: uppercase; }
        .td-value { font-size: 10pt; }
        .narrative-box { border: 1px solid #000; padding: 10px; min-height: 150px; text-align: justify; line-height: 1.5; font-size: 11pt; margin-bottom: 15px; }
        .signatures-block { margin-top: 60px; display: flex; justify-content: space-between; page-break-inside: avoid; }
        .signature-line { width: 45%; text-align: center; border-top: 1px solid #000; padding-top: 5px; font-size: 10pt; }
        .footer-integrity { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; font-size: 8pt; text-align: center; border-top: 1px solid #ccc; padding-top: 5px; color: #666; }

        /* Estilo para comprovantes no PDF */
        .pdf-comprovante-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 15px;
            page-break-inside: avoid; /* Tenta n√£o quebrar a imagem no meio da p√°gina */
            display: flex;
            align-items: flex-start;
        }
        .pdf-comprovante-img {
            width: 45%;
            max-height: 300px;
            object-fit: contain;
            border: 1px solid #000;
            margin-right: 15px;
        }
        .pdf-comprovante-data {
            flex: 1;
        }
        
        /* Novo estilo para a lista de custos de transporte */
        .cost-list-item {
            background: #fff;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        .cost-list-item strong { color: var(--primary-color); display: block; }
        .cost-list-item span { font-size: 0.9em; color: #6c757d; }
    </style>
</head>
<body>

    <!-- ================================================================== -->
    <!-- √ÅREA VIS√çVEL: O FORMUL√ÅRIO SIMPLIFICADO -->
    <!-- ================================================================== -->
    <div class="container-form" id="mainForm">
        <h1>Presta√ß√£o de Contas - Di√°rias</h1>
        
        <!-- 1. BLOCO DE DADOS PESSOAIS E BANC√ÅRIOS -->
        <div class="form-section-box">
            <label class="form-section-title">1. Quem √© voc√™? (Dados Pessoais e Banc√°rios)</label>
            
            <div class="form-group">
                <label>1.1 Nome Completo:</label>
                <!-- Mantido vis√≠vel como identificador principal -->
                <input type="text" id="inp_nome" placeholder="Digite seu nome aqui..." onblur="validarCampo(this, validarNomeCompleto)">
            </div>

            <!-- BOT√ÉO DE TRIGGER: Dados Pessoais -->
            <div id="trigger_detalhes_pessoais" style="margin-bottom: 15px; text-align: center;">
                <button class="btn-add" onclick="mostrarFormularioPessoais()">+ Visualizar/Editar Detalhes do Servidor e Banc√°rios</button>
            </div>

            <!-- √ÅREA PARA DADOS PESSOAIS E BANC√ÅRIOS (OCULTA POR PADR√ÉO) -->
            <div id="dados_pessoais_ocultos_container" style="display: none;">
                
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>1.2 Matr√≠cula:</label>
                        <input type="text" id="inp_matricula" placeholder="Ex: 12345">
                    </div>
                    <div class="form-col form-group">
                        <label>1.2 CPF (apenas n√∫meros):</label>
                        <input type="text" id="inp_cpf" placeholder="000.000.000-00" maxlength="14" onblur="validarCampo(this, validarCPF)">
                    </div>
                </div>
                
                <!-- Linha de sele√ß√£o de cargo e lota√ß√£o -->
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>1.3 Cargo:</label>
                        <select id="inp_cargo" onchange="verificarCargoManual(this.value)">
                            <option value="">Selecione seu cargo...</option>
                            <option value="Motorista">Motorista</option>
                            <option value="Agente Administrativo">Agente Administrativo</option>
                            <option value="Enfermeiro(a)">Enfermeiro(a)</option>
                            <option value="M√©dico(a)">M√©dico(a)</option>
                            <option value="Professor(a)">Professor(a)</option>
                            <option value="Auxiliar de Servi√ßos">Auxiliar de Servi√ßos</option>
                            <option value="OUTRO">OUTRO (Especificar...)</option>
                        </select>
                    </div>
                    
                    <!-- Coluna de Sele√ß√£o de Lota√ß√£o (Onde voc√™ trabalha?) -->
                    <div class="form-col form-group">
                        <label>1.3 Lota√ß√£o (Onde trabalha):</label>
                        <select id="inp_lotacao" onchange="verificarLotacaoManual(this.value)">
                            <option value="">Selecione a lota√ß√£o...</option>
                            <option value="Hospital Municipal">Hospital Municipal</option>
                            <option value="Secretaria Municipal de Sa√∫de">Secretaria Municipal de Sa√∫de</option>
                            <option value="Secretaria Municipal de Educa√ß√£o">Secretaria Municipal de Educa√ß√£o</option>
                            <option value="Setor de Frota / Garagem">Setor de Frota / Garagem</option>
                            <option value="UBS Central">UBS Central</option>
                            <option value="UBS/PSF">UBS/PSF (Especificar Bairro/Nome)</option>
                            <option value="OUTRO">OUTRO Setor (Especificar...)</option>
                        </select>
                    </div>
                </div>

                <!-- Campo manual para a op√ß√£o "Outro" de Cargo (100% de largura) -->
                <div id="div_cargo_manual" style="display:none;" class="form-group">
                    <label>Especifique seu Cargo:</label>
                    <input type="text" id="inp_cargo_manual" placeholder="Ex: T√©cnico em Inform√°tica, Coordenador de Projetos">
                </div>
                
                <!-- Campo manual para Lota√ß√£o - Outro Setor (100% de largura) -->
                <div id="div_lotacao_manual" style="display:none;" class="form-group">
                    <label>Especifique o Setor/Lota√ß√£o (Ex: Setor de Compras, Defesa Civil):</label>
                    <input type="text" id="inp_lotacao_manual" placeholder="Nome do setor...">
                </div>

                <!-- NOVO CAMPO DE OBSERVA√á√ÉO ADICIONAL (Checkbox para detalhar Lota√ß√£o ou Cargo) -->
                <div class="form-group" style="margin-top: 10px;">
                    <label class="radio-card" style="width: fit-content;">
                        <input type="checkbox" id="check_obs_adicional" onchange="alternarObsAdicional(this.checked)"> 
                        <span>**Observa√ß√£o Adicional sobre o Servidor/Lota√ß√£o?**</span>
                    </label>
                </div>
                
                <!-- Campo de Texto Livre para Observa√ß√£o Adicional -->
                <div id="div_obs_adicional" style="display:none;" class="form-group">
                    <label>Detalhes Adicionais (Ex: Bairro da UBS, Conv√™nio, etc.):</label>
                    <textarea id="inp_obs_adicional" rows="2" placeholder="Digite aqui informa√ß√µes complementares, como 'UBS Bairro Novo' ou 'Conv√™nio com a 10¬™ Regional de Sa√∫de'."></textarea>
                </div>
                
                <!-- DADOS BANC√ÅRIOS (ITEM 1.4) -->
                <label class="form-section-title" style="margin-top: 25px;">1.4 Dados Banc√°rios (Onde depositar o valor?)</label>
                <div class="form-row">
                    <div class="form-col form-group" style="flex: 2;">
                        <label>Banco:</label>
                        <select id="inp_banco_nome">
                            <option value="">Selecione...</option>
                            <option value="Banco do Brasil">Banco do Brasil</option>
                            <option value="Caixa Econ√¥mica">Caixa Econ√¥mica</option>
                            <option value="Ita√∫">Ita√∫</option>
                            <option value="Bradesco">Bradesco</option>
                            <option value="Santander">Santander</option>
                            <option value="Sicoob">Sicoob</option>
                            <option value="Sicredi">Sicredi</option>
                        </select>
                    </div>
                    <div class="form-col form-group">
                        <label>Ag√™ncia:</label>
                        <input type="text" id="inp_agencia" placeholder="0000-X">
                    </div>
                    <div class="form-col form-group">
                        <label>Conta:</label>
                        <input type="text" id="inp_conta" placeholder="00000-0">
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 15px;">
                     <!-- Bot√£o para ocultar de volta -->
                    <button class="btn-cancel" onclick="ocultarFormularioPessoais()">CONCLUIR EDI√á√ÉO</button>
                </div>
            </div>
        </div>
        
        <!-- 2. CUSTOS DE TRANSPORTE E ROTA -->
        <div class="form-section-box">
            <label class="form-section-title">2. Custos de Transporte (Viagem, KM ou Passagem)</label>
            
            <!-- Lista de custos de transporte j√° adicionados (MOVIDO PARA CIMA) -->
            <div id="lista_custos_transporte_visual" style="margin-top: 5px;">
                <!-- Itens ser√£o inseridos aqui via JS -->
            </div>
            
            <!-- TOTALIZADOR EM TEMPO REAL (MOVIDO PARA CIMA) -->
            <div id="totalizador_custos_transporte" style="display: none; margin-bottom: 25px;">
                Total de Custos de Transporte: <span id="valor_total_custos_transporte">R$ 0,00</span>
            </div>

            <!-- NOVO BOT√ÉO DE TRIGGER: Se n√£o houver custos, ele aparece. -->
            <div id="trigger_adicionar_custo" style="margin-bottom: 25px; text-align: center;">
                <button class="btn-add" onclick="mostrarFormularioCusto()">+ Adicionar Trecho/Custo de Transporte</button>
            </div>
            
            <!-- √ÅREA PARA ADICIONAR NOVO CUSTO DE TRANSPORTE -->
            <div id="dados_custo_transporte_container" style="display: none;">
                
                <!-- 2.1 MODAL DE TRANSPORTE -->
                <div class="form-group">
                    <label>2.1 Modalidade de Transporte Utilizada:</label>
                    <select id="inp_modalidade" onchange="verificarModalidade(this.value)">
                        <option value="">Selecione o modo de transporte...</option>
                        <option value="CARRO_OFICIAL">Carro Oficial (Frota)</option>
                        <option value="VEICULO_PROPRIO">Ve√≠culo Pr√≥prio (Reembolso KM)</option>
                        <option value="ONIBUS_RODOVIARIO">√înibus Rodovi√°rio</option>
                        <option value="PASSAGEM_AEREA">Avi√£o (Passagem A√©rea)</option>
                        <option value="TRANSPORTE_APP">T√°xi / Transporte por Aplicativo</option>
                        <option value="OUTRO">Outro (Especifique na descri√ß√£o)</option>
                    </select>
                </div>
                
                <!-- 2.2 TIPO DE VIAGEM (NOVO LOCAL) -->
                <div class="form-group" style="margin-top: 10px;">
                    <label>2.2 Tipo de Rota (para este custo):</label>
                    <select id="inp_tipo_viagem_custo" onchange="alternarCamposCusto()">
                        <option value="">Selecione o tipo de rota...</option>
                        <option value="IDA_E_VOLTA">Ida e Volta</option>
                        <option value="SO_IDA">S√≥ de Ida</option>
                        <option value="MULTIPLO">M√∫ltiplos Destinos / Parcial</option>
                    </select>
                </div>

                <!-- Op√ß√µes de Detalhamento do Custo (KM ou Passagem/Custo) -->
                <div id="detalhes_custo_dinamico">
                    <!-- Detalhes do modal de transporte (Km/Placa ou Passagem/Custo) ser√£o injetados aqui via JS -->
                </div>
                
                <!-- Campos OBRIGAT√ìRIOS para ORIGEM/DESTINO espec√≠ficos deste CUSTO -->
                <label class="form-section-title" style="font-size: 0.9rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px;">2.3 Roteiro Espec√≠fico (OBRIGAT√ìRIO)</label>
                
                <!-- Origem (UF/Cidade) -->
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>Origem do Custo (UF):</label>
                        <!-- Removido o pr√©-select de PR -->
                        <select id="inp_custo_origem_uf" onchange="carregarCidadesPorUF('inp_custo_origem_uf', 'inp_custo_origem_select', 'Selecione...')"><option value="">Selecione...</option></select>
                    </div>
                    <div class="form-col form-group">
                        <label>Origem do Custo (Cidade):</label>
                        <!-- Adicionado disabled -->
                        <select id="inp_custo_origem_select" disabled><option value="">Selecione...</option></select>
                    </div>
                </div>

                <!-- Destino (UF/Cidade) -->
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>Destino do Custo (UF):</label>
                        <!-- Removido o pr√©-select de PR -->
                        <select id="inp_custo_destino_uf" onchange="carregarCidadesPorUF('inp_custo_destino_uf', 'inp_custo_destino_select', 'Selecione...')"><option value="">Selecione...</option></select>
                    </div>
                    <div class="form-col form-group">
                        <label>Destino do Custo (Cidade):</label>
                        <!-- Adicionado disabled -->
                        <select id="inp_custo_destino_select" disabled><option value="">Selecione...</option></select>
                    </div>
                </div>

                <!-- NOVO: 2.4 Comprovantes M√∫ltiplos para este trecho -->
                <label class="form-section-title" style="font-size: 0.9rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px;">2.4 Comprovantes do Trecho (OBRIGAT√ìRIO)</label>

                <div id="comprovantes_custo_temp_list" style="margin-bottom: 15px;">
                    <!-- Lista tempor√°ria de comprovantes para este custo (injetada via JS) -->
                </div>

                <div style="border: 1px dashed var(--primary-color); padding: 15px; border-radius: 4px; background: #fdfdff;">
                    <label class="form-section-title" style="font-size: 0.9rem; border: none; padding: 0; margin-bottom: 10px;">Adicionar Novo Comprovante:</label>
                    
                    <div class="form-row">
                        <div class="form-col form-group">
                            <label>Tipo da Despesa:</label>
                            <select id="inp_custo_tipo_despesa">
                                <option value="">Selecione...</option>
                                <option value="Combust√≠vel">Combust√≠vel / Abastecimento</option>
                                <option value="Ped√°gio">Ped√°gio</option>
                                <option value="Estacionamento">Estacionamento</option>
                                <option value="Passagem (√înibus/App)">Passagem (√înibus/App)</option>
                                <option value="Outro (Transporte)">Outro (Transporte)</option>
                            </select>
                        </div>
                        <div class="form-col form-group">
                            <label>Valor (R$):</label>
                            <input type="number" id="inp_custo_valor_temp" step="0.01" placeholder="0,00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Anexar Comprovante (Imagem/PDF):</label>
                        <input type="file" id="input_custo_arquivo_temp" accept="image/*, application/pdf" onchange="previewCustoAnexoTemp(event)">
                    </div>
                    <div id="preview_custo_anexo_temp_container" style="text-align: center; margin-bottom: 10px; display: none;">
                        <img id="preview_custo_img_temp" src="" style="max-height: 100px; border: 1px solid #ccc; border-radius: 4px; display: none;">
                        <p id="preview_custo_text_temp" style="font-size: 0.8rem; color: #555; margin-top: 5px;"></p>
                    </div>
                    <div style="text-align: right;">
                        <button type="button" class="btn-add" onclick="adicionarComprovanteCusto()" style="padding: 8px 15px; font-size: 0.9rem;">+ ADICIONAR COMPROVANTE</button>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; border: 1px solid var(--primary-color); background: var(--highlight-bg); font-weight: bold; text-align: right;">
                    Total Reembols√°vel Deste Trecho: <span id="total_reembolsavel_trecho">R$ 0,00</span>
                </div>
                
                <div style="text-align: right; margin-top: 15px;">
                    <!-- NOVO BOT√ÉO DE CANCELAR -->
                    <button class="btn-cancel" onclick="ocultarFormularioCusto()">CANCELAR</button>
                    <button class="btn-add" onclick="adicionarCustoTransporte()">+ CONFIRMAR TRECHO E ADICIONAR √Ä LISTA</button>
                </div>
            </div>

            
        </div>
        
        <!-- NOVO ITEM 3: DESPESAS DE ALIMENTA√á√ÉO -->
        <div class="form-section-box">
            <label class="form-section-title">3. Despesas de Alimenta√ß√£o (Di√°rias)</label>
            
            <!-- Lista de despesas j√° adicionadas -->
            <div id="lista_outras_despesas_visual" style="margin-top: 5px;">
                <!-- Itens ser√£o inseridos aqui via JS -->
            </div>
            
            <!-- TOTALIZADOR EM TEMPO REAL -->
            <div id="totalizador_outras_despesas" style="display: none; margin-bottom: 25px;">
                Total de Di√°rias (Alimenta√ß√£o e Hospedagem): <span id="valor_total_outras_despesas">R$ 0,00</span>
            </div>

            <!-- BOT√ÉO DE TRIGGER: Adicionar Despesa de Alimenta√ß√£o -->
            <div id="trigger_adicionar_alimentacao" style="margin-bottom: 25px; text-align: center;">
                <button class="btn-add" onclick="mostrarFormularioAlimentacao()">+ Adicionar Despesa de Alimenta√ß√£o</button>
            </div>
            
            <!-- √ÅREA PARA ADICIONAR NOVA DESPESA DE ALIMENTA√á√ÉO (AJUSTADO PARA M√öLTIPLOS COMPROVANTES) -->
            <div id="dados_alimentacao_container" style="display: none;">
                
                <p style="font-size: 0.9rem; font-weight: bold;">Categoria do Item: ALIMENTA√á√ÉO (Di√°ria)</p>

                <!-- 3.1 DETALHE DA DESPESA -->
                <div class="form-group">
                    <label>3.1 Detalhe do Gasto (Opcional - Ex: Almo√ßo 05/10/2024, Restaurante Bom Sabor):</label>
                    <input type="text" id="inp_detalhe_alimentacao" placeholder="Ex: Almo√ßo, Jantar, Lanches do dia 05/10/2024">
                </div>

                <!-- 3.2 COMPROVANTES M√öLTIPLOS -->
                <label class="form-section-title" style="font-size: 0.9rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px;">3.2 Comprovantes do Item (OBRIGAT√ìRIO)</label>
                
                <div id="comprovantes_alimentacao_temp_list" style="margin-bottom: 15px;">
                    <!-- Lista tempor√°ria de comprovantes para este custo (injetada via JS) -->
                </div>


                <div style="border: 1px dashed var(--primary-color); padding: 15px; border-radius: 4px; background: #fdfdff;">
                    <label class="form-section-title" style="font-size: 0.9rem; border: none; padding: 0; margin-bottom: 10px;">Adicionar Novo Comprovante:</label>
                    
                    <div class="form-row">
                        <div class="form-col form-group">
                            <label>Descri√ß√£o do Comprovante:</label>
                            <select id="inp_alimentacao_tipo_despesa_temp">
                                <option value="">Selecione...</option>
                                <option value="Almo√ßo">Almo√ßo</option>
                                <option value="Jantar">Jantar</option>
                                <option value="Lanche">Lanche / Caf√©</option>
                                <option value="OutroAlimentacao">Outro (Alimenta√ß√£o)</option>
                            </select>
                        </div>
                        <div class="form-col form-group">
                            <label>Valor (R$):</label>
                            <input type="number" id="inp_alimentacao_valor_temp" step="0.01" placeholder="0,00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Anexar Comprovante (Imagem/PDF):</label>
                        <input type="file" id="input_alimentacao_arquivo_temp" accept="image/*, application/pdf" onchange="previewAlimentacaoAnexoTemp(event)">
                    </div>
                    
                    <div id="preview_alimentacao_anexo_temp_container" style="text-align: center; margin-bottom: 10px; display: none;">
                        <img id="preview_alimentacao_img_temp" src="" style="max-height: 100px; border: 1px solid #ccc; border-radius: 4px; display: none;">
                        <p id="preview_alimentacao_text_temp" style="font-size: 0.8rem; color: #555; margin-top: 5px;"></p>
                    </div>

                    <div style="text-align: right;">
                        <button type="button" class="btn-add" onclick="adicionarComprovanteAlimentacao()" style="padding: 8px 15px; font-size: 0.9rem;">+ ANEXAR COMPROVANTE</button>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; border: 1px solid var(--primary-color); background: var(--highlight-bg); font-weight: bold; text-align: right;">
                    Total Reembols√°vel Deste Item: <span id="total_reembolsavel_alimentacao">R$ 0,00</span>
                </div>
                
                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn-cancel" onclick="ocultarFormularioAlimentacao()">CANCELAR</button>
                    <button class="btn-add" onclick="adicionarDespesaAlimentacao()">+ CONFIRMAR ITEM DE ALIMENTA√á√ÉO</button>
                </div>
            </div>
            
        </div>
        
        <!-- NOVO ITEM 4: DESPESAS DE HOSPEDAGEM E OUTROS -->
        <div class="form-section-box">
            <label class="form-section-title">4. Despesas de Hospedagem e Outros Anexos</label>

            <!-- Lista de despesas j√° adicionadas -->
            <div id="lista_outras_despesas_visual_hosp" style="margin-top: 5px;">
                <!-- Itens ser√£o inseridos aqui via JS (Apenas a lista de hospedagem/outros) -->
            </div>

            <!-- BOT√ÉO DE TRIGGER: Adicionar Despesa de Hospedagem/Outros -->
            <div id="trigger_adicionar_hospedagem" style="margin-bottom: 25px; text-align: center;">
                <button class="btn-add" onclick="mostrarFormularioHospedagem()">+ Adicionar Hospedagem ou Outros</button>
            </div>
            
            <!-- √ÅREA PARA ADICIONAR NOVA DESPESA DE HOSPEDAGEM/OUTROS (AJUSTADO PARA M√öLTIPLOS COMPROVANTES) -->
            <div id="dados_hospedagem_container" style="display: none;">
                
                <!-- 4.1 TIPO DE DESPESA PRINCIPAL -->
                <div class="form-group">
                    <label>4.1 Categoria Principal:</label>
                    <select id="inp_tipo_despesa_hosp_outros">
                        <option value="">Selecione a Categoria...</option>
                        <option value="HOSPEDAGEM">Hospedagem / Hotel (Di√°ria)</option>
                        <option value="OUTRO_ANEXO">Outro Gasto Comprovado</option>
                    </select>
                </div>
                
                <!-- 4.2 DETALHE DA DESPESA -->
                <div class="form-group">
                    <label>4.2 Detalhe/Per√≠odo (Opcional - Ex: Nome do hotel, Taxa de Inscri√ß√£o):</label>
                    <input type="text" id="inp_detalhe_hospedagem" placeholder="Ex: Hotel Primavera (Di√°ria de 05/10), Taxa de Inscri√ß√£o em Congresso">
                </div>

                <!-- 4.3 COMPROVANTES M√öLTIPLOS -->
                <label class="form-section-title" style="font-size: 0.9rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px;">4.3 Comprovantes do Item (OBRIGAT√ìRIO)</label>

                <div id="comprovantes_hospedagem_temp_list" style="margin-bottom: 15px;">
                    <!-- Lista tempor√°ria de comprovantes para este custo (injetada via JS) -->
                </div>

                <div style="border: 1px dashed var(--primary-color); padding: 15px; border-radius: 4px; background: #fdfdff;">
                    <label class="form-section-title" style="font-size: 0.9rem; border: none; padding: 0; margin-bottom: 10px;">Adicionar Novo Comprovante:</label>
                    
                    <div class="form-row">
                        <div class="form-col form-group">
                            <label>Descri√ß√£o do Comprovante:</label>
                            <select id="inp_hospedagem_tipo_despesa_temp">
                                <option value="">Selecione...</option>
                                <option value="NotaHotel">Nota Fiscal do Hotel</option>
                                <option value="TaxaEvento">Taxa de Evento/Inscri√ß√£o</option>
                                <option value="Reembolso">Reembolso Diversos</option>
                                <option value="OutroGeral">Outro (Geral)</option>
                            </select>
                        </div>
                        <div class="form-col form-group">
                            <label>Valor (R$):</label>
                            <input type="number" id="inp_hospedagem_valor_temp" step="0.01" placeholder="0,00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Anexar Comprovante (Imagem/PDF):</label>
                        <input type="file" id="input_hospedagem_arquivo_temp" accept="image/*, application/pdf" onchange="previewHospedagemAnexoTemp(event)">
                    </div>
                    
                    <div id="preview_hospedagem_anexo_temp_container" style="text-align: center; margin-bottom: 10px; display: none;">
                        <img id="preview_hospedagem_img_temp" src="" style="max-height: 100px; border: 1px solid #ccc; border-radius: 4px; display: none;">
                        <p id="preview_hospedagem_text_temp" style="font-size: 0.8rem; color: #555; margin-top: 5px;"></p>
                    </div>
                    
                    <div style="text-align: right; margin-top: 10px;">
                        <button type="button" class="btn-add" onclick="adicionarComprovanteHospedagem()" style="padding: 8px 15px; font-size: 0.9rem;">+ ANEXAR COMPROVANTE</button>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; border: 1px solid var(--primary-color); background: var(--highlight-bg); font-weight: bold; text-align: right;">
                    Total Reembols√°vel Deste Item: <span id="total_reembolsavel_hospedagem">R$ 0,00</span>
                </div>
                
                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn-cancel" onclick="ocultarFormularioHospedagem()">CANCELAR</button>
                    <button class="btn-add" onclick="adicionarDespesaHospedagem()">+ CONFIRMAR ITEM DE HOSPEDAGEM/OUTROS</button>
                </div>
            </div>
            
        </div>
        
        <!-- NOVO ITEM 5: RESUMO FINAL E TOTALIZA√á√ÉO (Substituindo o antigo Item 5) -->
        <div class="form-section-box">
            <label class="form-section-title">5. Resumo Final da Presta√ß√£o de Contas</label>
            
            <div class="resumo-final-card">
                <p style="font-size: 0.9rem; margin-top: 0;">Totaliza√ß√£o de todos os custos declarados antes de gerar o relat√≥rio oficial.</p>
                
                <div class="resumo-final-item">
                    <span>Total de Custos de Transporte (Item 2):</span>
                    <span id="resumo_total_transporte">R$ 0,00</span>
                </div>
                
                <div class="resumo-final-item">
                    <span>Total de Alimenta√ß√£o (Item 3):</span>
                    <span id="resumo_total_alimentacao">R$ 0,00</span>
                </div>
                
                <div class="resumo-final-item">
                    <span>Total de Hospedagem e Outros (Item 4):</span>
                    <span id="resumo_total_hospedagem_outros">R$ 0,00</span>
                </div>
                
                <div class="resumo-final-total">
                    <span>SALDO FINAL (TOTAL REEMBOLS√ÅVEL):</span>
                    <span id="resumo_saldo_final">R$ 0,00</span>
                </div>

                <p style="font-size: 0.8rem; color: var(--error-color); margin-top: 10px; display: none;" id="aviso_zerado">
                    ‚ö†Ô∏è Aten√ß√£o: O saldo final est√° zerado ou negativo. Certifique-se de que todos os comprovantes foram adicionados corretamente.
                </p>
                <p style="font-size: 0.8rem; color: var(--warning-color); margin-top: 10px; display: none;" id="aviso_pendente">
                    üü° Pend√™ncia: Nenhum custo foi adicionado nos itens 2, 3 e 4.
                </p>
            </div>
        </div>


        <!-- BOT√ÉO FINAL -->
        <div class="buttons-container">
            <!-- Chamada para a nova fun√ß√£o de valida√ß√£o principal -->
            <button class="btn-success" onclick="validarFormularioCompleto()">&#128196; GERAR E BAIXAR DOCUMENTO</button>
        </div>
        <div id="status-msg">Gerando seu PDF... Aguarde.</div>
    </div>

    <!-- ================================================================== -->
    <!-- PDF OCULTO (TEMPLATE A4) -->
    <!-- O n√∫mero da se√ß√£o de Dados Banc√°rios no PDF foi corrigido para 3. -->
    <!-- ================================================================== -->
    <div id="report-container">
        <div class="report-header">
            <div class="brasao-placeholder">BRAS√ÉO</div>
            <div style="font-size: 14pt;">ESTADO DO PARAN√Å</div>
            <div style="font-size: 12pt; font-weight: normal;">PREFEITURA MUNICIPAL DE EXEMPLO</div>
            <div style="margin-top: 15px; font-size: 16pt;">RELAT√ìRIO DE VIAGEM E PRESTA√á√ÉO DE CONTAS</div>
            <div style="font-size: 10pt; font-weight: normal; margin-top: 5px;">(Conforme Decreto Municipal e Normas TCE-PR)</div>
        </div>

        <div class="report-section-title">1. IDENTIFICA√á√ÉO DO SERVIDOR</div>
        <table class="report-table">
            <tr>
                <td class="td-label">Nome:</td>
                <td class="td-value" colspan="3"><span id="out_nome"></span></td>
            </tr>
            <tr>
                <td class="td-label">Matr√≠cula:</td>
                <td class="td-value"><span id="out_matricula"></span></td>
                <td class="td-label">CPF:</td>
                <td class="td-value"><span id="out_cpf"></span></td>
            </tr>
            <tr>
                <td class="td-label">Cargo:</td>
                <td class="td-value"><span id="out_cargo"></span></td>
                <td class="td-label">Lota√ß√£o:</td>
                <td class="td-value"><span id="out_lotacao"></span></td>
            </tr>
        </table>
        
        <div class="report-section-title">2. DADOS DO DESLOCAMENTO E APURA√á√ÉO FINANCEIRA</div>
        <table class="report-table">
            <!-- Dados de Roteiro - Simula√ß√£o para o PDF j√° que foi removido -->
            <tr><td class="td-label">Roteiro Principal:</td><td class="td-value" colspan="3">N√ÉO DISPON√çVEL (Dados de Rota Removidos do Formul√°rio)</td></tr>
            <tr>
                <td class="td-label">Per√≠odo:</td><td class="td-value">N√ÉO DISPON√çVEL</td>
                <td class="td-label">Km Total Estimado:</td><td class="td-value"><span id="out_km_total">N/A</span></td>
            </tr>
            <tr><td class="td-label">Finalidade:</td><td class="td-value" colspan="3">N√ÉO DISPON√çVEL (Relat√≥rio Removido)</td></tr>
        </table>
        
        <div class="report-section-title" style="margin-top: 20px;">DETALHAMENTO FINANCEIRO</div>
        <table class="report-table">
            <tr><th>Descri√ß√£o</th><th style="text-align: center;">Qtd</th><th style="text-align: right;">Valor Unit.</th><th style="text-align: right;">Total</th></tr>
            <!-- Di√°rias (zerado no formul√°rio) -->
            <tr>
                <td>Di√°rias</td>
                <td style="text-align: center;"><span id="out_qtd_diaria">0</span></td>
                <td style="text-align: right;">R$ <span id="out_vlr_diaria">0,00</span></td>
                <td style="text-align: right;">R$ <span id="out_total_diarias">0,00</span></td>
            </tr>
            
            <!-- BLOCO: CUSTOS DE TRANSPORTE LISTADOS -->
            <tr>
                <td colspan="4" style="text-align: left; font-weight: bold; background-color: #fff3cd; color: #856404;">(+) Detalhamento do Custo de Transporte:</td>
            </tr>
            <tbody id="out_custos_transporte_tabela">
                <!-- Linhas de custo din√¢micas ser√£o injetadas aqui -->
                <tr>
                    <td colspan="4" style="text-align: center; color: #666; font-style: italic;">Nenhum custo de transporte adicionado.</td>
                </tr>
            </tbody>
            
            <!-- LINHA DE TOTAL DO TRANSPORTE -->
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold; background-color: #fff3cd;">SUBTOTAL TRANSPORTE:</td>
                <td style="text-align: right; font-weight: bold; background-color: #fff3cd;">R$ <span id="out_total_custos_transporte_pdf">0,00</span></td>
            </tr>
            
            <!-- BLOCO: OUTRAS DESPESAS (ALIMENTA√á√ÉO) -->
            <tr>
                <td colspan="4" style="text-align: left; font-weight: bold; background-color: #e8f4fd; color: #004a99; border-top: 1px solid #ccc;">(+) Detalhamento de Alimenta√ß√£o:</td>
            </tr>
            <tbody id="out_alimentacao_tabela">
                <!-- Linhas de alimenta√ß√£o ser√£o injetadas aqui -->
            </tbody>

            <!-- BLOCO: OUTRAS DESPESAS (HOSPEDAGEM E OUTROS) -->
            <tr>
                <td colspan="4" style="text-align: left; font-weight: bold; background-color: #f0f7ff; color: #004a99; border-top: 1px solid #ccc;">(+) Detalhamento de Hospedagem e Outros:</td>
            </tr>
            <tbody id="out_hospedagem_outros_tabela">
                <!-- Linhas de hospedagem/outros ser√£o injetadas aqui -->
            </tbody>

            <!-- LINHA DE TOTAL DE OUTRAS DESPESAS -->
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold; background-color: #e6f7ff;">SUBTOTAL DI√ÅRIAS/OUTROS:</td>
                <td style="text-align: right; font-weight: bold; background-color: #e6f7ff;">R$ <span id="out_total_outras_despesas_pdf">0,00</span></td>
            </tr>
            
            <!-- Linha Vazia para manter a estrutura -->
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold; background-color: #e6f7ff;">(+) Outras Despesas Comprovadas (Anexos):</td>
                <td style="text-align: right; font-weight: bold; background-color: #e6f7ff;">R$ <span id="out_total_anexos_pdf">0,00</span></td>
            </tr>

            
            <!-- Adiantamento (zerado no formul√°rio) -->
            <tr><td colspan="3" style="text-align: right;">(-) Adiantamento:</td><td style="text-align: right; color: #cc0000;">(R$ <span id="out_adiantamento">0,00</span>)</td></tr>
            <tr style="background-color: #f0f0f0;"><td colspan="3" style="text-align: right; font-weight: bold;">SALDO FINAL (A PAGAR/DEVOLVER):</td><td style="text-align: right; font-weight: bold;">R$ <span id="out_saldo_final">0,00</span></td></tr>
        </table>
        
        <!-- ITEM 3: DADOS BANC√ÅRIOS (Corrigido para 3) -->
        <div class="report-section-title">3. DADOS BANC√ÅRIOS PARA REEMBOLSO</div>
        <table class="report-table">
            <tr>
                <td class="td-label">Banco/Ag√™ncia/CC:</td>
                <td class="td-value" colspan="3"><span id="out_banco"></span></td>
            </tr>
        </table>

        <!-- ANEXOS (CUSTO DE TRANSPORTE + OUTRAS DESPESAS) -->
        <div id="container_anexos_pdf" style="display: none;">
            <div class="report-section-title" style="page-break-before: always;">4. ANEXOS / COMPROVANTES DIGITALIZADOS (TRANSPORTE E OUTRAS DESPESAS)</div>
            <div id="lista_anexos_pdf_conteudo"></div>
        </div>
        
        <!-- Bloco para Observa√ß√£o Adicional no PDF (Se preenchida) -->
        <div id="container_obs_adicional_pdf" style="margin-top: 15px; display: none; page-break-inside: avoid;">
            <div class="report-section-title" style="font-size: 10pt;">OBSERVA√á√ïES ADICIONAIS DO SERVIDOR</div>
            <div class="narrative-box" style="min-height: 50px;"><span id="out_obs_adicional" style="white-space: pre-wrap; font-size: 10pt;"></span></div>
        </div>

        <div class="signatures-block">
            <div class="signature-line"><br><span id="out_assinatura_nome"></span><br>Assinatura do Servidor</div>
            <div class="signature-line"><br><br>Chefia Imediata</div>
        </div>

        <div class="footer-integrity">Gerado em <span id="out_data_geracao"></span>. Hash: <span id="out_hash"></span></div>
    </div>

    <!-- ================================================================== -->
    <!-- JAVASCRIPT -->
    <!-- ================================================================== -->
    <script>
        // --- VARI√ÅVEIS GLOBAIS ---
        let listaCustosTransporte = []; // Item 2
        let comprovantesCustoTemp = []; // Lista tempor√°ria para um trecho de transporte (Item 2.4)
        let imagemCustoTempBase64 = ""; // Base64 tempor√°ria para 1 comprovante de CUSTO
        
        // NOVAS VARI√ÅVEIS PARA M√öLTIPLOS COMPROVANTES (ITENS 3 e 4)
        let listaOutrasDespesas = []; // Lista principal de despesas (Alimenta√ß√£o, Hospedagem, Outros)
        let comprovantesAlimentacaoTemp = []; // Lista tempor√°ria para 1 item de Alimenta√ß√£o
        let imagemAlimentacaoComprovanteTempBase64 = ""; // Base64 tempor√°ria para 1 comprovante de ALIMENTA√á√ÉO
        let comprovantesHospedagemTemp = []; // Lista tempor√°ria para 1 item de Hospedagem/Outros
        let imagemHospedagemComprovanteTempBase64 = ""; // Base64 tempor√°ria para 1 comprovante de HOSPEDAGEM/OUTROS
        
        // Vari√°veis antigas (removidas do fluxo) mantidas para refer√™ncia, mas vazias
        let listaComprovantes = []; 
        let listaParadas = [];      
        let imagemOutroTempBase64 = ""; 
        
        // Estrutura de dados est√°tica para Marcas e Modelos
        const dadosVeiculos = {
            "SELECIONE": [],
            "FIAT": ["Uno", "Palio", "Argo", "Strada", "Toro", "OUTRO"],
            "VOLKSWAGEN": ["Gol", "Voyage", "Polo", "Nivus", "T-Cross", "OUTRO"],
            "CHEVROLET": ["Celta", "Onix", "Prisma", "Spin", "S10", "OUTRO"],
            "FORD": ["Ka", "Fiesta", "EcoSport", "Ranger", "OUTRO"],
            "RENAULT": ["Kwid", "Sandero", "Duster", "OUTRO"],
            "OUTRO": [] // Flag to enable manual input
        };

        // ==================================================================
        // --- FUN√á√ïES DE VALIDA√á√ÉO GERAIS ---
        // ==================================================================

        function validarCampo(inputElement, validationFunction) {
            const isValid = validationFunction(inputElement.value);
            if (isValid) {
                inputElement.classList.remove('input-error');
            } else {
                inputElement.classList.add('input-error');
            }
            return isValid;
        }

        function validarNomeCompleto(nome) {
            if (!nome || nome.length < 5) return false;
            const partes = nome.trim().split(/\s+/);
            return partes.length >= 2;
        }

        function validarCPF(cpf) {
            if (!cpf) return false;
            cpf = cpf.replace(/[^\d]/g, '');
            if (cpf.length !== 11) return false;
            if (/^(\d)\1{10}$/.test(cpf)) return false;

            let soma;
            let resto;
            let i;

            soma = 0;
            for (i = 1; i <= 9; i++) {
                soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
            }
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) {
                resto = 0;
            }
            if (resto !== parseInt(cpf.substring(9, 10))) return false;

            soma = 0;
            for (i = 1; i <= 10; i++) {
                soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
            }
            resto = (soma * 10) % 11;

            if ((resto === 10) || (resto === 11)) {
                resto = 0;
            }
            if (resto !== parseInt(cpf.substring(10, 11))) return false;

            return true;
        }

        // ==================================================================
        // --- L√ìGICA DO FORMUL√ÅRIO (ITEM 1 - PESSOAL/BANC√ÅRIO) ---
        // ==================================================================
        
        /**
         * Controla a exibi√ß√£o dos campos detalhados do Item 1 (Pessoais e Banc√°rios)
         */
        function mostrarFormularioPessoais() {
            document.getElementById('trigger_detalhes_pessoais').style.display = 'none';
            document.getElementById('dados_pessoais_ocultos_container').style.display = 'block';
            document.getElementById('inp_matricula').focus();
        }

        function ocultarFormularioPessoais() {
             document.getElementById('dados_pessoais_ocultos_container').style.display = 'none';
             document.getElementById('trigger_detalhes_pessoais').style.display = 'block';
        }

        function verificarCargoManual(valorSelecionado) {
            const divManual = document.getElementById('div_cargo_manual');
            const inpManual = document.getElementById('inp_cargo_manual');
            
            if (valorSelecionado === 'OUTRO') {
                divManual.style.display = 'block';
                inpManual.focus();
            } else {
                divManual.style.display = 'none';
                inpManual.value = ""; 
            }
        }
        
        function verificarLotacaoManual(valorSelecionado) {
            const divManual = document.getElementById('div_lotacao_manual');
            const inpManual = document.getElementById('inp_lotacao_manual');
            
            if (valorSelecionado === 'OUTRO' || valorSelecionado === 'UBS/PSF') {
                divManual.style.display = 'block';
                inpManual.focus();
                
                if (valorSelecionado === 'UBS/PSF') {
                     document.querySelector('#div_lotacao_manual label').textContent = 'Especifique o Bairro ou Nome da UBS/PSF:';
                     inpManual.placeholder = 'Ex: UBS Bairro Novo, PSF Primavera';
                } else {
                     document.querySelector('#div_lotacao_manual label').textContent = 'Especifique o Setor/Lota√ß√£o (Ex: Setor de Compras, Defesa Civil):';
                     inpManual.placeholder = 'Nome do setor...';
                }
                
            } else {
                divManual.style.display = 'none';
                inpManual.value = ""; 
            }
        }
        
        function alternarObsAdicional(isChecked) {
            const divObs = document.getElementById('div_obs_adicional');
            if (isChecked) {
                divObs.style.display = 'block';
                document.getElementById('inp_obs_adicional').focus();
            } else {
                divObs.style.display = 'none';
                document.getElementById('inp_obs_adicional').value = "";
            }
        }
        
        // ==================================================================
        // --- L√ìGICA DE CUSTOS DE TRANSPORTE (ITEM 2) ---
        // ==================================================================

        function mostrarFormularioCusto() {
            document.getElementById('trigger_adicionar_custo').style.display = 'none';
            document.getElementById('dados_custo_transporte_container').style.display = 'block';
        }
        
        function ocultarFormularioCusto() {
             // Limpa o estado tempor√°rio
            comprovantesCustoTemp = [];
            renderizarComprovantesCustoTemp(); 
            document.getElementById('detalhes_custo_dinamico').innerHTML = '';
            document.getElementById('inp_modalidade').value = '';
            document.getElementById('inp_tipo_viagem_custo').value = '';
            
            // Re-esconde o formul√°rio
            document.getElementById('dados_custo_transporte_container').style.display = 'none';
            // Re-exibe o bot√£o de trigger
            document.getElementById('trigger_adicionar_custo').style.display = 'block';

            // Limpa selects de roteiro 2.3
            const custoOrigemUF = document.getElementById('inp_custo_origem_uf');
            const custoOrigemCidade = document.getElementById('inp_custo_origem_select');
            const custoDestinoUF = document.getElementById('inp_custo_destino_uf');
            const custoDestinoCidade = document.getElementById('inp_custo_destino_select');
            custoOrigemUF.value = '';
            custoOrigemCidade.innerHTML = '<option value="">Selecione...</option>';
            custoOrigemCidade.disabled = true;
            custoDestinoUF.value = '';
            custoDestinoCidade.innerHTML = '<option value="">Selecione...</option>';
            custoDestinoCidade.disabled = true;
        }

        function aplicarMascaraPlaca(elementId) {
            const input = document.getElementById(elementId);
            if (input) {
                input.addEventListener('input', function(e) {
                    let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"");
                    if(v.length>3) v=v.substring(0,3)+"-"+v.substring(3);
                    if(v.length>8) v=v.substring(0,8);
                    e.target.value=v;
                });
            }
        }
        
        function carregarModelos() {
            const marcaSelect = document.getElementById('inp_custo_marca');
            const modeloSelect = document.getElementById('inp_custo_modelo');
            const divManual = document.getElementById('div_marca_modelo_manual');
            const inputManual = document.getElementById('inp_custo_marca_modelo_manual');
            const marcaSelecionada = marcaSelect.value;
            
            divManual.style.display = 'none';
            inputManual.value = '';
            
            modeloSelect.innerHTML = '<option value="">Selecione o Modelo...</option>';
            modeloSelect.disabled = true;

            if (marcaSelecionada === 'SELECIONE') {
                return;
            }

            if (marcaSelecionada === 'OUTRO') {
                divManual.style.display = 'block';
                inputManual.placeholder = "Especifique Marca e Modelo (Ex: Mercedes-Benz Sprinter 313)...";
                inputManual.focus();
                return;
            }

            const modelos = dadosVeiculos[marcaSelecionada];
            if (modelos && modelos.length > 0) {
                modeloSelect.disabled = false;
                modelos.forEach(modelo => {
                    const option = document.createElement('option');
                    option.value = modelo;
                    option.textContent = modelo;
                    modeloSelect.appendChild(option);
                });
                
                modeloSelect.onchange = function() {
                    if (this.value === 'OUTRO') {
                        divManual.style.display = 'block';
                        inputManual.placeholder = `Especifique o Modelo da Marca ${marcaSelecionada}...`;
                        inputManual.focus();
                    } else {
                        divManual.style.display = 'none';
                        inputManual.value = '';
                    }
                };
            }
        }


        function previewCustoAnexoTemp(event) {
            const file = event.target.files[0];
            const container = document.getElementById('preview_custo_anexo_temp_container');
            const img = document.getElementById('preview_custo_img_temp');
            const text = document.getElementById('preview_custo_text_temp');
            imagemCustoTempBase64 = "";

            if (!file) {
                container.style.display = 'none';
                return;
            }

            if (file.type.startsWith('image/')) {
                img.style.display = 'block';
                text.style.display = 'none';
                text.textContent = '';
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imagemCustoTempBase64 = evt.target.result;
                    img.src = imagemCustoTempBase64;
                    container.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                img.style.display = 'none';
                text.style.display = 'block';
                text.textContent = `Arquivo PDF carregado: ${file.name}`;
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imagemCustoTempBase64 = evt.target.result;
                    container.style.display = 'block';
                };
                reader.readAsDataURL(file);

            } else {
                 alert("Tipo de arquivo n√£o suportado. Use Imagem ou PDF.");
                 event.target.value = '';
                 container.style.display = 'none';
            }
        }

        function calcularKmTotal() {
            const i = parseFloat(document.getElementById('inp_custo_km_ini')?.value) || 0;
            const f = parseFloat(document.getElementById('inp_custo_km_fim')?.value) || 0;
            const kmTotal = (f - i) > 0 ? (f - i) : 0;
            
            return { kmTotal };
        }


        function verificarModalidade(modalidade) {
            const container = document.getElementById('detalhes_custo_dinamico');
            container.innerHTML = '';
            
            let htmlCarro = `
                <label class="form-section-title" style="font-size: 0.95rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 5px;">Detalhes do Ve√≠culo e Quilometragem</label>
                
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>Marca:</label>
                        <select id="inp_custo_marca" onchange="carregarModelos()">
                            <option value="SELECIONE">Selecione a Marca...</option>
                            ${Object.keys(dadosVeiculos).filter(k => k !== 'SELECIONE').map(marca => `<option value="${marca}">${marca}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-col form-group">
                        <label>Modelo:</label>
                        <select id="inp_custo_modelo" disabled>
                            <option value="">Selecione o Modelo...</option>
                        </select>
                    </div>
                </div>
            
                <!-- Campo manual para Marca e Modelo (Invis√≠vel por padr√£o) -->
                <div id="div_marca_modelo_manual" style="display:none;" class="form-group">
                    <label>Especifique Marca e Modelo:</label>
                    <input type="text" id="inp_custo_marca_modelo_manual" placeholder="Ex: Mercedes-Benz Sprinter 313">
                </div>

                <div class="form-row">
                    <div class="form-col form-group"><label>Placa:</label><input type="text" id="inp_custo_placa" placeholder="ABC-1234" maxlength="8"></div>
                </div>
                <div class="form-row">
                    <div class="form-col form-group"><label>Km Inicial:</label><input type="number" id="inp_custo_km_ini" placeholder="0"></div>
                    <div class="form-col form-group"><label>Km Final:</label><input type="number" id="inp_custo_km_fim" placeholder="0"></div>
                    <!-- KM TOTAL continua sendo calculado no ADICIONAR e √© READONLY -->
                    <div class="form-col form-group"><label>Total Km (Calculado):</label><input type="text" id="inp_custo_km_total" readonly style="background: #eee;"></div>
                </div>
            `;
            
            let htmlOutros = `
                <label class="form-section-title" style="font-size: 0.95rem; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 5px;">Detalhes da Passagem/Custo</label>
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>Empresa/App/Cia. A√©rea:</label>
                        <input type="text" id="inp_custo_empresa_app" placeholder="Ex: Via√ß√£o Catarinense, Uber, LATAM">
                    </div>
                </div>
                <div class="form-group">
                    <label>Detalhes/ID (Opcional):</label>
                    <input type="text" id="inp_custo_detalhe" placeholder="Ex: Bilhete N¬∫ 1234, ID Viagem">
                </div>
            `;

            if (modalidade === 'CARRO_OFICIAL' || modalidade === 'VEICULO_PROPRIO') {
                container.innerHTML = htmlCarro;
                aplicarMascaraPlaca('inp_custo_placa'); 
            } else if (modalidade !== '') {
                container.innerHTML = htmlOutros;
            }
        }
        
        function alternarCamposCusto() {
            const modalidade = document.getElementById('inp_modalidade').value;
            verificarModalidade(modalidade);
        }

        // --- L√ìGICA DE COMPROVANTES TEMPOR√ÅRIOS (ITEM 2.4) ---

        function calcularTotalComprovantesCustoTemp() {
            const total = comprovantesCustoTemp.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
            document.getElementById('total_reembolsavel_trecho').textContent = `R$ ${formatarMoeda(total)}`;
            return total;
        }

        function renderizarComprovantesCustoTemp() {
            const container = document.getElementById('comprovantes_custo_temp_list');
            container.innerHTML = "";

            if (comprovantesCustoTemp.length === 0) {
                container.innerHTML = `<p style="font-size: 0.9em; color: #888; text-align: center;">Nenhum comprovante adicionado a este trecho.</p>`;
                calcularTotalComprovantesCustoTemp();
                return;
            }

            comprovantesCustoTemp.forEach((item, index) => {
                let thumbHtml = '';
                if (item.mimeType.startsWith('image/')) {
                    thumbHtml = `<img src="${item.imagemBase64}" class="comprovante-thumb" style="width: 40px; height: 40px;">`;
                } else if (item.mimeType === 'application/pdf') {
                    thumbHtml = `<div class="comprovante-thumb" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; background-color: #e6f7ff; font-size: 8px; color: var(--primary-color);">PDF</div>`;
                }
                
                const div = document.createElement('div');
                div.className = 'list-item'; 
                div.style.backgroundColor = '#fff';
                div.innerHTML = `
                    ${thumbHtml}
                    <div class="list-info">
                        <strong style="font-size: 0.9rem;">${item.tipoDespesa}</strong>
                        <span style="font-weight: bold; color: var(--success-color);">R$ ${formatarMoeda(item.valor)}</span>
                    </div>
                    <button class="btn-remove" onclick="removerComprovanteCustoTemp(${index})">Remover</button>
                `;
                container.appendChild(div);
            });
            
            calcularTotalComprovantesCustoTemp();
        }

        function removerComprovanteCustoTemp(index) {
            comprovantesCustoTemp.splice(index, 1);
            renderizarComprovantesCustoTemp();
        }


        function adicionarComprovanteCusto() {
            const tipoDespesaSelect = document.getElementById('inp_custo_tipo_despesa');
            const valorInput = document.getElementById('inp_custo_valor_temp');
            const arquivoInput = document.getElementById('input_custo_arquivo_temp');

            if (!tipoDespesaSelect.value) {
                alert("Selecione o Tipo da Despesa.");
                tipoDespesaSelect.focus();
                return;
            }
            if ((parseFloat(valorInput.value) || 0) <= 0) {
                 alert("O Valor do comprovante deve ser maior que zero.");
                 valorInput.focus();
                 return;
            }
            if (!imagemCustoTempBase64 || !arquivoInput.files[0]) {
                 alert("√â obrigat√≥rio anexar o comprovante (Imagem ou PDF).");
                 arquivoInput.focus();
                 return;
            }
            if (imagemCustoTempBase64.length < 50) {
                 alert("O arquivo ainda est√° carregando. Por favor, aguarde e clique novamente.");
                 return;
            }


            const novoComprovante = {
                id: Date.now(),
                tipoDespesa: tipoDespesaSelect.options[tipoDespesaSelect.selectedIndex].text,
                valor: parseFloat(valorInput.value),
                imagemBase64: imagemCustoTempBase64,
                mimeType: arquivoInput.files[0].type
            };

            comprovantesCustoTemp.push(novoComprovante);

            // Reset campos de adi√ß√£o
            tipoDespesaSelect.value = '';
            valorInput.value = '';
            arquivoInput.value = '';
            imagemCustoTempBase64 = '';
            document.getElementById('preview_custo_anexo_temp_container').style.display = 'none';

            renderizarComprovantesCustoTemp();
        }

        function adicionarCustoTransporte() {
            const modalidadeSelect = document.getElementById('inp_modalidade');
            const tipoViagemSelect = document.getElementById('inp_tipo_viagem_custo');
            
            const custoOrigemUF = document.getElementById('inp_custo_origem_uf');
            const custoOrigemCidade = document.getElementById('inp_custo_origem_select');
            const custoDestinoUF = document.getElementById('inp_custo_destino_uf');
            const custoDestinoCidade = document.getElementById('inp_custo_destino_select');

            // 1. Valida√ß√£o dos selects principais
            if (!modalidadeSelect.value) {
                alert("Por favor, selecione a Modalidade de Transporte (Item 2.1).");
                return;
            }
            if (!tipoViagemSelect.value) {
                alert("Por favor, selecione o Tipo de Rota (Item 2.2).");
                return;
            }
            
            // 2. Valida√ß√£o dos Comprovantes (Item 2.4)
            const valorTotalTrecho = calcularTotalComprovantesCustoTemp();
            if (comprovantesCustoTemp.length === 0 || valorTotalTrecho <= 0) {
                 alert("Pelo menos um comprovante (com valor maior que zero) deve ser anexado para este trecho (Item 2.4). O valor total √© R$ 0,00.");
                 document.getElementById('inp_custo_tipo_despesa').focus();
                 return;
            }
            
            // 3. Valida√ß√£o do Roteiro Espec√≠fico (2.3 OBRIGAT√ìRIO)
            if (!custoOrigemUF.value || !custoOrigemCidade.value || !custoDestinoUF.value || !custoDestinoCidade.value) {
                alert("Por favor, preencha todos os campos do Roteiro Espec√≠fico (Item 2.3 - UF e Cidade de Origem/Destino) para este custo.");
                return;
            }

            const modalidadeValue = modalidadeSelect.value;
            const modalidade = modalidadeSelect.options[modalidadeSelect.selectedIndex].text;
            const tipoViagem = tipoViagemSelect.options[tipoViagemSelect.selectedIndex].text;
            
            // Formata roteiro 2.3
            const custoOrigem = `${custoOrigemCidade.value}/${custoOrigemUF.value}`;
            const custoDestino = `${custoDestinoCidade.value}/${custoDestinoUF.value}`;
            let detalhes = `${tipoViagem} (${custoOrigem} -> ${custoDestino})`;
            
            // 4. TRATAMENTO DE DETALHES ESPEC√çFICOS
            if (modalidadeValue === 'CARRO_OFICIAL' || modalidadeValue === 'VEICULO_PROPRIO') {
                
                const calculos = calcularKmTotal();
                const kmTotal = calculos.kmTotal; 

                const inpKmTotal = document.getElementById('inp_custo_km_total');
                if (inpKmTotal) {
                    inpKmTotal.value = kmTotal.toFixed(2);
                }

                if (kmTotal <= 0) {
                     alert("A Quilometragem Final deve ser maior que a Inicial para calcular a KM Total.");
                     document.getElementById('inp_custo_km_ini').focus();
                     return;
                }
                
                const placa = document.getElementById('inp_custo_placa').value;
                const marca = document.getElementById('inp_custo_marca').value;
                const modelo = document.getElementById('inp_custo_modelo').value;
                const manual = document.getElementById('inp_custo_marca_modelo_manual')?.value.trim() || '';

                let marcaModeloFinal = '';
                if (manual) {
                    marcaModeloFinal = manual; // Manual always overrides
                } else if (marca === 'OUTRO') {
                    alert("Por favor, especifique a Marca e Modelo no campo manual.");
                    document.getElementById('inp_custo_marca_modelo_manual').focus();
                    return;
                } else if (modelo === 'OUTRO') {
                    alert("Por favor, especifique o Modelo no campo manual.");
                    document.getElementById('inp_custo_marca_modelo_manual').focus();
                    return;
                } else if (marca === 'SELECIONE') {
                    alert("Por favor, selecione a Marca do ve√≠culo.");
                    document.getElementById('inp_custo_marca').focus();
                    return;
                } else if (modelo === '') {
                    alert("Por favor, selecione o Modelo do ve√≠culo.");
                    document.getElementById('inp_custo_modelo').focus();
                    return;
                } else if (marca && modelo) {
                    marcaModeloFinal = `${marca} ${modelo}`;
                } 

                detalhes += ` | ${kmTotal.toFixed(2)} Km | Ve√≠culo: ${placa} - ${marcaModeloFinal}`;
                
            } else {
                 // Modalidades que usam detalhes avulsos
                const empresaApp = document.getElementById('inp_custo_empresa_app')?.value || '';
                const detalheCusto = document.getElementById('inp_custo_detalhe')?.value || '';
                detalhes += ` | Empresa: ${empresaApp}` + (detalheCusto ? ` | ${detalheCusto}` : '');
            }

            // 5. CRIA√á√ÉO DO ITEM
            const novoItem = {
                id: Date.now(),
                modalidade: modalidade,
                detalhes: detalhes,
                valor: valorTotalTrecho,
                comprovantes: [...comprovantesCustoTemp],
                tipo: 'Transporte'
            };

            listaCustosTransporte.push(novoItem);
            
            // Limpa o formul√°rio de adi√ß√£o
            document.getElementById('detalhes_custo_dinamico').innerHTML = '';
            
            custoOrigemUF.value = '';
            custoOrigemCidade.innerHTML = '<option value="">Selecione...</option>';
            custoOrigemCidade.disabled = true;
            custoDestinoUF.value = '';
            custoDestinoCidade.innerHTML = '<option value="">Selecione...</option>';
            custoDestinoCidade.disabled = true;
            
            modalidadeSelect.value = '';
            tipoViagemSelect.value = '';
            
            comprovantesCustoTemp = [];
            renderizarComprovantesCustoTemp(); 

            renderizarListaCustosTransporte();
            
            document.getElementById('dados_custo_transporte_container').style.display = 'none';
            document.getElementById('trigger_adicionar_custo').style.display = 'block';
        }

        function removerCustoTransporte(index) {
            listaCustosTransporte.splice(index, 1);
            renderizarListaCustosTransporte();
        }

        function calcularTotalCustosTransporte() {
            const total = listaCustosTransporte.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
            
            const elTotal = document.getElementById('totalizador_custos_transporte');
            document.getElementById('valor_total_custos_transporte').textContent = `R$ ${formatarMoeda(total)}`;
            
            if (total > 0) {
                elTotal.style.display = 'block';
            } else {
                elTotal.style.display = 'none';
            }
            
            // Atualiza o resumo
            atualizarResumoFinal();
            
            return total;
        }

        function renderizarListaCustosTransporte() {
            const container = document.getElementById('lista_custos_transporte_visual');
            container.innerHTML = "";

            listaCustosTransporte.forEach((item, index) => {
                
                const comprovantesResumo = item.comprovantes.map(c => 
                    `${c.tipoDespesa} (R$ ${formatarMoeda(c.valor)})`
                ).join('; ');

                const div = document.createElement('div');
                div.className = 'cost-list-item list-item'; 
                div.innerHTML = `
                    <div class="list-info">
                        <strong>${item.modalidade.toUpperCase()}</strong>
                        <span>${item.detalhes}</span>
                        <span style="font-size: 0.8em; color: #888; margin-top: 5px; display: block;">Comprovantes: ${comprovantesResumo}</span>
                        <span style="font-weight: 700; color: var(--primary-color); margin-top: 5px; display: block;">Valor Total Trecho: R$ ${formatarMoeda(item.valor)}</span>
                    </div>
                    <button class="btn-remove" onclick="removerCustoTransporte(${index})">Remover</button>
                `;
                container.appendChild(div);
            });
            
            calcularTotalCustosTransporte();
        }
        
        // ==================================================================
        // --- L√ìGICA DE OUTRAS DESPESAS (ITENS 3 e 4) ---
        // ==================================================================
        
        // --- FUN√á√ïES GERAIS DE PREVIEW PARA ITENS 3 E 4 ---
        
        /**
         * Fun√ß√£o gen√©rica para pr√©-visualiza√ß√£o de anexo, agora usando vari√°veis globais espec√≠ficas para 3 e 4.
         */
        function previewAnexoGenerico(event, containerId, imgId, textId, base64VarName) {
            const file = event.target.files[0];
            const container = document.getElementById(containerId);
            const img = document.getElementById(imgId);
            const text = document.getElementById(textId);
            
            // Limpa a vari√°vel global correta
            window[base64VarName] = ""; 

            if (!file) {
                container.style.display = 'none';
                return;
            }

            if (file.type.startsWith('image/')) {
                img.style.display = 'block';
                text.style.display = 'none';
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    window[base64VarName] = evt.target.result;
                    img.src = window[base64VarName];
                    container.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                img.style.display = 'none';
                text.style.display = 'block';
                text.textContent = `Arquivo PDF carregado: ${file.name}`;
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    window[base64VarName] = evt.target.result;
                    container.style.display = 'block';
                };
                reader.readAsDataURL(file);

            } else {
                 alert("Tipo de arquivo n√£o suportado. Use Imagem ou PDF.");
                 event.target.value = '';
                 container.style.display = 'none';
            }
        }
        
        // ------------------------------------------------------------------
        // ITEM 3: ALIMENTA√á√ÉO (Totalmente adaptado ao modelo Item 2)
        // ------------------------------------------------------------------
        
        function mostrarFormularioAlimentacao() {
             document.getElementById('trigger_adicionar_alimentacao').style.display = 'none';
             document.getElementById('dados_alimentacao_container').style.display = 'block';
             document.getElementById('inp_detalhe_alimentacao').focus();
        }
        
        function ocultarFormularioAlimentacao() {
             // Limpa o formul√°rio principal
             document.getElementById('inp_detalhe_alimentacao').value = '';
             
             // Limpa e reseta a lista tempor√°ria de comprovantes
             comprovantesAlimentacaoTemp = [];
             renderizarComprovantesAlimentacaoTemp(); // Redraws list and resets total
             
             // Reseta o formul√°rio de adi√ß√£o de comprovante
             document.getElementById('inp_alimentacao_tipo_despesa_temp').value = '';
             document.getElementById('inp_alimentacao_valor_temp').value = '';
             document.getElementById('input_alimentacao_arquivo_temp').value = '';
             imagemAlimentacaoComprovanteTempBase64 = '';
             document.getElementById('preview_alimentacao_anexo_temp_container').style.display = 'none';


             document.getElementById('dados_alimentacao_container').style.display = 'none';
             document.getElementById('trigger_adicionar_alimentacao').style.display = 'block';
        }
        
        function previewAlimentacaoAnexoTemp(event) {
            previewAnexoGenerico(event, 'preview_alimentacao_anexo_temp_container', 'preview_alimentacao_img_temp', 'preview_alimentacao_text_temp', 'imagemAlimentacaoComprovanteTempBase64');
        }
        
        function calcularTotalComprovantesAlimentacaoTemp() {
            const total = comprovantesAlimentacaoTemp.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
            document.getElementById('total_reembolsavel_alimentacao').textContent = `R$ ${formatarMoeda(total)}`;
            return total;
        }
        
        function renderizarComprovantesAlimentacaoTemp() {
            const container = document.getElementById('comprovantes_alimentacao_temp_list');
            container.innerHTML = "";

            if (comprovantesAlimentacaoTemp.length === 0) {
                container.innerHTML = `<p style="font-size: 0.9em; color: #888; text-align: center;">Nenhum comprovante de alimenta√ß√£o anexado.</p>`;
                calcularTotalComprovantesAlimentacaoTemp();
                return;
            }

            comprovantesAlimentacaoTemp.forEach((item, index) => {
                let thumbHtml = '';
                if (item.mimeType.startsWith('image/')) {
                    thumbHtml = `<img src="${item.imagemBase64}" class="comprovante-thumb" style="width: 40px; height: 40px;">`;
                } else if (item.mimeType === 'application/pdf') {
                    thumbHtml = `<div class="comprovante-thumb" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; background-color: #e8f4fd; font-size: 8px; color: #007bff;">PDF</div>`;
                }
                
                const div = document.createElement('div');
                div.className = 'list-item'; 
                div.style.backgroundColor = '#fff';
                div.innerHTML = `
                    ${thumbHtml}
                    <div class="list-info">
                        <strong style="font-size: 0.9rem; color: #007bff;">${item.tipoDespesa}</strong>
                        <span style="font-weight: bold; color: var(--success-color);">R$ ${formatarMoeda(item.valor)}</span>
                    </div>
                    <button class="btn-remove" onclick="removerComprovanteAlimentacaoTemp(${index})">Remover</button>
                `;
                container.appendChild(div);
            });
            
            calcularTotalComprovantesAlimentacaoTemp();
        }
        
        function removerComprovanteAlimentacaoTemp(index) {
             comprovantesAlimentacaoTemp.splice(index, 1);
             renderizarComprovantesAlimentacaoTemp();
        }

        function adicionarComprovanteAlimentacao() {
            const tipoDespesaSelect = document.getElementById('inp_alimentacao_tipo_despesa_temp');
            const valorInput = document.getElementById('inp_alimentacao_valor_temp');
            const arquivoInput = document.getElementById('input_alimentacao_arquivo_temp');

            if (!tipoDespesaSelect.value) {
                alert("Selecione a Descri√ß√£o do Comprovante (Ex: Almo√ßo).");
                tipoDespesaSelect.focus();
                return;
            }
            if ((parseFloat(valorInput.value) || 0) <= 0) {
                 alert("O Valor do comprovante deve ser maior que zero.");
                 valorInput.focus();
                 return;
            }
            if (!imagemAlimentacaoComprovanteTempBase64 || !arquivoInput.files[0]) {
                 alert("√â obrigat√≥rio anexar o comprovante (Imagem ou PDF).");
                 arquivoInput.focus();
                 return;
            }
            if (imagemAlimentacaoComprovanteTempBase64.length < 50) {
                 alert("O arquivo ainda est√° carregando. Por favor, aguarde e clique novamente.");
                 return;
            }


            const novoComprovante = {
                id: Date.now(),
                tipoDespesa: tipoDespesaSelect.options[tipoDespesaSelect.selectedIndex].text,
                valor: parseFloat(valorInput.value),
                imagemBase64: imagemAlimentacaoComprovanteTempBase64,
                mimeType: arquivoInput.files[0].type
            };

            comprovantesAlimentacaoTemp.push(novoComprovante);

            // Reset campos de adi√ß√£o
            tipoDespesaSelect.value = '';
            valorInput.value = '';
            arquivoInput.value = '';
            imagemAlimentacaoComprovanteTempBase64 = '';
            document.getElementById('preview_alimentacao_anexo_temp_container').style.display = 'none';

            renderizarComprovantesAlimentacaoTemp();
        }


        function adicionarDespesaAlimentacao() {
             const detalheInput = document.getElementById('inp_detalhe_alimentacao');
             const totalItem = calcularTotalComprovantesAlimentacaoTemp();
             
             // 1. Valida√ß√£o
             if (comprovantesAlimentacaoTemp.length === 0 || totalItem <= 0) {
                 alert("Adicione pelo menos um comprovante v√°lido de Alimenta√ß√£o (com valor maior que zero) para confirmar este item.");
                 document.getElementById('inp_alimentacao_tipo_despesa_temp').focus();
                 return;
             }

             let descricaoCompleta = 'Alimenta√ß√£o (Di√°ria)';
             if (detalheInput.value.trim()) {
                  descricaoCompleta += ` (${detalheInput.value.trim()})`;
             }

             const novaDespesa = {
                id: Date.now(),
                categoria: 'ALIMENTACAO', 
                descricao: descricaoCompleta,
                valor: totalItem,
                comprovantes: [...comprovantesAlimentacaoTemp], // Adiciona a lista de comprovantes
                tipo: 'Diarias/Outros'
             };

             listaOutrasDespesas.push(novaDespesa);
             
             ocultarFormularioAlimentacao();
             renderizarListaOutrasDespesas();
        }
        
        // ------------------------------------------------------------------
        // ITEM 4: HOSPEDAGEM E OUTROS (Totalmente adaptado ao modelo Item 2)
        // ------------------------------------------------------------------

        function mostrarFormularioHospedagem() {
             document.getElementById('trigger_adicionar_hospedagem').style.display = 'none';
             document.getElementById('dados_hospedagem_container').style.display = 'block';
             document.getElementById('inp_tipo_despesa_hosp_outros').focus();
        }
        
        function ocultarFormularioHospedagem() {
             // Limpa o formul√°rio principal
             document.getElementById('inp_tipo_despesa_hosp_outros').value = '';
             document.getElementById('inp_detalhe_hospedagem').value = '';
             
             // Limpa e reseta a lista tempor√°ria de comprovantes
             comprovantesHospedagemTemp = [];
             renderizarComprovantesHospedagemTemp(); // Redraws list and resets total
             
             // Reseta o formul√°rio de adi√ß√£o de comprovante
             document.getElementById('inp_hospedagem_tipo_despesa_temp').value = '';
             document.getElementById('inp_hospedagem_valor_temp').value = '';
             document.getElementById('input_hospedagem_arquivo_temp').value = '';
             imagemHospedagemComprovanteTempBase64 = '';
             document.getElementById('preview_hospedagem_anexo_temp_container').style.display = 'none';


             document.getElementById('dados_hospedagem_container').style.display = 'none';
             document.getElementById('trigger_adicionar_hospedagem').style.display = 'block';
        }
        
        function previewHospedagemAnexoTemp(event) {
            previewAnexoGenerico(event, 'preview_hospedagem_anexo_temp_container', 'preview_hospedagem_img_temp', 'preview_hospedagem_text_temp', 'imagemHospedagemComprovanteTempBase64');
        }
        
        function calcularTotalComprovantesHospedagemTemp() {
            const total = comprovantesHospedagemTemp.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
            document.getElementById('total_reembolsavel_hospedagem').textContent = `R$ ${formatarMoeda(total)}`;
            return total;
        }

        function renderizarComprovantesHospedagemTemp() {
            const container = document.getElementById('comprovantes_hospedagem_temp_list');
            container.innerHTML = "";

            if (comprovantesHospedagemTemp.length === 0) {
                container.innerHTML = `<p style="font-size: 0.9em; color: #888; text-align: center;">Nenhum comprovante anexado a este item.</p>`;
                calcularTotalComprovantesHospedagemTemp();
                return;
            }

            comprovantesHospedagemTemp.forEach((item, index) => {
                let thumbHtml = '';
                if (item.mimeType.startsWith('image/')) {
                    thumbHtml = `<img src="${item.imagemBase64}" class="comprovante-thumb" style="width: 40px; height: 40px;">`;
                } else if (item.mimeType === 'application/pdf') {
                    thumbHtml = `<div class="comprovante-thumb" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; background-color: #f0f7ff; font-size: 8px; color: #004a99;">PDF</div>`;
                }
                
                const div = document.createElement('div');
                div.className = 'list-item'; 
                div.style.backgroundColor = '#fff';
                div.innerHTML = `
                    ${thumbHtml}
                    <div class="list-info">
                        <strong style="font-size: 0.9rem; color: #004a99;">${item.tipoDespesa}</strong>
                        <span style="font-weight: bold; color: var(--success-color);">R$ ${formatarMoeda(item.valor)}</span>
                    </div>
                    <button class="btn-remove" onclick="removerComprovanteHospedagemTemp(${index})">Remover</button>
                `;
                container.appendChild(div);
            });
            
            calcularTotalComprovantesHospedagemTemp();
        }
        
        function removerComprovanteHospedagemTemp(index) {
             comprovantesHospedagemTemp.splice(index, 1);
             renderizarComprovantesHospedagemTemp();
        }

        function adicionarComprovanteHospedagem() {
            const tipoDespesaSelect = document.getElementById('inp_hospedagem_tipo_despesa_temp');
            const valorInput = document.getElementById('inp_hospedagem_valor_temp');
            const arquivoInput = document.getElementById('input_hospedagem_arquivo_temp');

            if (!tipoDespesaSelect.value) {
                alert("Selecione a Descri√ß√£o do Comprovante.");
                tipoDespesaSelect.focus();
                return;
            }
            if ((parseFloat(valorInput.value) || 0) <= 0) {
                 alert("O Valor do comprovante deve ser maior que zero.");
                 valorInput.focus();
                 return;
            }
            if (!imagemHospedagemComprovanteTempBase64 || !arquivoInput.files[0]) {
                 alert("√â obrigat√≥rio anexar o comprovante (Imagem ou PDF).");
                 arquivoInput.focus();
                 return;
            }
            if (imagemHospedagemComprovanteTempBase64.length < 50) {
                 alert("O arquivo ainda est√° carregando. Por favor, aguarde e clique novamente.");
                 return;
            }


            const novoComprovante = {
                id: Date.now(),
                tipoDespesa: tipoDespesaSelect.options[tipoDespesaSelect.selectedIndex].text,
                valor: parseFloat(valorInput.value),
                imagemBase64: imagemHospedagemComprovanteTempBase64,
                mimeType: arquivoInput.files[0].type
            };

            comprovantesHospedagemTemp.push(novoComprovante);

            // Reset campos de adi√ß√£o
            tipoDespesaSelect.value = '';
            valorInput.value = '';
            arquivoInput.value = '';
            imagemHospedagemComprovanteTempBase64 = '';
            document.getElementById('preview_hospedagem_anexo_temp_container').style.display = 'none';

            renderizarComprovantesHospedagemTemp();
        }

        function adicionarDespesaHospedagem() {
             const tipoDespesaSelect = document.getElementById('inp_tipo_despesa_hosp_outros');
             const detalheInput = document.getElementById('inp_detalhe_hospedagem');
             const totalItem = calcularTotalComprovantesHospedagemTemp();
             
             // 1. Valida√ß√£o de Categoria e Comprovantes
             if (!tipoDespesaSelect.value) {
                 alert("Selecione a Categoria Principal (Item 4.1).");
                 tipoDespesaSelect.focus();
                 return;
             }
             if (comprovantesHospedagemTemp.length === 0 || totalItem <= 0) {
                 alert("Adicione pelo menos um comprovante v√°lido (com valor maior que zero) para confirmar este item.");
                 document.getElementById('inp_hospedagem_tipo_despesa_temp').focus();
                 return;
             }


             const categoria = tipoDespesaSelect.value;
             const tipoPrincipal = tipoDespesaSelect.options[tipoDespesaSelect.selectedIndex].text;
             let descricaoCompleta = tipoPrincipal;
             
             if (detalheInput.value.trim()) {
                  descricaoCompleta += ` (${detalheInput.value.trim()})`;
             }

             const novaDespesa = {
                id: Date.now(),
                categoria: categoria, 
                descricao: descricaoCompleta,
                valor: totalItem,
                comprovantes: [...comprovantesHospedagemTemp], // Adiciona a lista de comprovantes
                tipo: 'Diarias/Outros'
             };

             listaOutrasDespesas.push(novaDespesa);
             
             ocultarFormularioHospedagem();
             renderizarListaOutrasDespesas();
        }


        
        /**
         * Remove uma despesa de di√°ria/outros da lista.
         */
        function removerOutraDespesa(index) {
            listaOutrasDespesas.splice(index, 1);
            renderizarListaOutrasDespesas();
        }

        /**
         * Calcula o total de outras despesas e atualiza o display.
         */
        function calcularTotalOutrasDespesas() {
            const total = listaOutrasDespesas.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
            
            const elTotal = document.getElementById('totalizador_outras_despesas');
            document.getElementById('valor_total_outras_despesas').textContent = `R$ ${formatarMoeda(total)}`;
            
            if (total > 0) {
                elTotal.style.display = 'block';
            } else {
                elTotal.style.display = 'none';
            }
            
            // Atualiza o resumo
            atualizarResumoFinal();
            
            return total;
        }
        
        /**
         * NOVO: Atualiza o bloco de resumo final (Item 5)
         */
        function atualizarResumoFinal() {
            // Separa√ß√£o de categorias para o resumo
            const alimentacao = listaOutrasDespesas.filter(d => d.categoria === 'ALIMENTACAO');
            const hospedagemOutros = listaOutrasDespesas.filter(d => d.categoria !== 'ALIMENTACAO');
            
            const totalTransp = listaCustosTransporte.reduce((sum, item) => sum + item.valor, 0);
            const totalAlim = alimentacao.reduce((sum, item) => sum + item.valor, 0);
            const totalHospOutros = hospedagemOutros.reduce((sum, item) => sum + item.valor, 0);
            
            const saldoFinal = totalTransp + totalAlim + totalHospOutros;
            
            // Atualiza os valores no Item 5
            document.getElementById('resumo_total_transporte').textContent = `R$ ${formatarMoeda(totalTransp)}`;
            document.getElementById('resumo_total_alimentacao').textContent = `R$ ${formatarMoeda(totalAlim)}`;
            document.getElementById('resumo_total_hospedagem_outros').textContent = `R$ ${formatarMoeda(totalHospOutros)}`;
            document.getElementById('resumo_saldo_final').textContent = `R$ ${formatarMoeda(saldoFinal)}`;
            
            // Controle de avisos
            const avisoZerado = document.getElementById('aviso_zerado');
            const avisoPendente = document.getElementById('aviso_pendente');

            if (saldoFinal === 0 && (totalTransp > 0 || totalAlim > 0 || totalHospOutros > 0)) {
                 avisoZerado.style.display = 'block';
                 avisoPendente.style.display = 'none';
            } else if (saldoFinal === 0 && totalTransp === 0 && totalAlim === 0 && totalHospOutros === 0) {
                 avisoPendente.style.display = 'block';
                 avisoZerado.style.display = 'none';
            } else {
                 avisoZerado.style.display = 'none';
                 avisoPendente.style.display = 'none';
            }

        }

        /**
         * Renderiza a lista de outras despesas na interface do usu√°rio (lista combinada).
         */
        function renderizarListaOutrasDespesas() {
            const container = document.getElementById('lista_outras_despesas_visual');
            container.innerHTML = "";

            // Separa as despesas em Alimenta√ß√£o e Hospedagem/Outros
            const alimentacao = listaOutrasDespesas.filter(d => d.categoria === 'ALIMENTACAO');
            const hospedagemOutros = listaOutrasDespesas.filter(d => d.categoria !== 'ALIMENTACAO');
            
            
            // Fun√ß√µes para renderizar os blocos espec√≠ficos de lista (Item 3 e Item 4)
            function renderizarBloco(items, title, containerId, bgColor, mainColor) {
                const container = document.getElementById(containerId);
                let html = `
                    <p style="font-size: 0.9rem; font-weight: 700; color: ${mainColor}; margin-top: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 5px;">
                        ${title} (${items.length} Item(s) Anexado(s)):
                    </p>
                `;

                if (items.length === 0) {
                    html += `<p style="font-size: 0.9em; color: #888; text-align: center;">Nenhum item adicionado.</p>`;
                    container.innerHTML = html;
                    return;
                }

                items.forEach((item, index) => {
                    // Soma dos comprovantes para mostrar na lista
                    const totalComprovantes = item.comprovantes.reduce((sum, c) => sum + c.valor, 0);
                    
                    const comprovantesResumo = item.comprovantes.map(c => 
                        `${c.tipoDespesa} (R$ ${formatarMoeda(c.valor)})`
                    ).join('; ');

                    const div = document.createElement('div');
                    div.className = 'cost-list-item list-item'; 
                    div.style.backgroundColor = bgColor;
                    
                    // Encontra o √≠ndice na lista principal para remo√ß√£o
                    const indexPrincipal = listaOutrasDespesas.findIndex(d => d.id === item.id);
                    
                    div.innerHTML = `
                        <div class="list-info">
                            <strong style="font-size: 0.9rem; color: ${mainColor};">
                                ${item.descricao.split('(')[0].trim().toUpperCase()}
                            </strong>
                            <span style="font-size: 0.8em; color: #666; margin-top: 2px; display: block;">
                                Detalhe: ${item.descricao.includes('(') ? item.descricao.split('(')[1].replace(')', '') : 'N/A'}
                            </span>
                            <span style="font-size: 0.8em; color: #888; margin-top: 5px; display: block;">
                                Comprovantes (${item.comprovantes.length}): ${comprovantesResumo}
                            </span>
                            <span style="font-weight: 700; color: var(--success-color); margin-top: 5px; display: block;">
                                Valor Total Item: R$ ${formatarMoeda(item.valor)}
                            </span>
                        </div>
                        <button class="btn-remove" onclick="removerOutraDespesa(${indexPrincipal})">Remover</button>
                    `;
                    container.appendChild(div);
                });
            }
            
            // Renderiza Alimenta√ß√£o no cont√™iner principal de Item 3
            renderizarBloco(alimentacao, 'Items de Alimenta√ß√£o Adicionados', 'lista_outras_despesas_visual', '#e8f4fd', '#007bff');
            
            // Renderiza Hospedagem/Outros no cont√™iner espec√≠fico de Item 4
            const containerHosp = document.getElementById('lista_outras_despesas_visual_hosp');
            containerHosp.innerHTML = "";
            renderizarBloco(hospedagemOutros, 'Items de Hospedagem/Outros Adicionados', 'lista_outras_despesas_visual_hosp', '#f0f7ff', '#004a99');


            // O totalizador global permanece no Item 3
            calcularTotalOutrasDespesas();
        }


        // ==================================================================
        // --- FUN√á√ÉO DE VALIDA√á√ÉO PRINCIPAL ---
        // ==================================================================
        
        function validarFormularioCompleto() {
            let formValido = true;
            
            // ... (Valida√ß√µes de Item 1 - Dados Pessoais e Banc√°rios) ...
            const nomeInput = document.getElementById('inp_nome');
            const cpfInput = document.getElementById('inp_cpf');
            const cargoSelect = document.getElementById('inp_cargo');
            const cargoManualInput = document.getElementById('inp_cargo_manual');
            const lotacaoSelect = document.getElementById('inp_lotacao');
            const lotacaoManualInput = document.getElementById('inp_lotacao_manual');
            
            // Valida√ß√µes principais vis√≠veis (Nome)
            if (!validarCampo(nomeInput, validarNomeCompleto)) {
                alert("Por favor, insira o Nome Completo (nome e sobrenome) no Item 1.");
                mostrarFormularioPessoais(); // Abre a se√ß√£o para o usu√°rio ver
                nomeInput.focus();
                formValido = false;
            }
            
            // Valida√ß√µes dos campos ocultos (agora checados se estiverem preenchidos/vis√≠veis)
            const detalhesVisiveis = document.getElementById('dados_pessoais_ocultos_container').style.display !== 'none';

            if (!detalhesVisiveis) {
                 // Se os detalhes estiverem ocultos, mas o Nome for v√°lido, for√ßamos a abertura para verificar o restante
                 mostrarFormularioPessoais();
                 alert("Por favor, preencha os detalhes do servidor e banc√°rios no Item 1.");
                 document.getElementById('inp_matricula').focus();
                 formValido = false;
            }

            if (detalhesVisiveis && formValido) {
                // Checagem completa se a se√ß√£o estiver aberta
                if (!validarCampo(cpfInput, validarCPF)) {
                    alert("O n√∫mero de CPF √© inv√°lido ou incompleto (Item 1.2).");
                    cpfInput.focus();
                    formValido = false;
                }
                else if (cargoSelect.value === 'OUTRO') {
                    if (cargoManualInput.value.trim().length < 3) {
                        alert("Selecione 'OUTRO', voc√™ deve especificar o cargo (Item 1.3).");
                        cargoManualInput.classList.add('input-error');
                        cargoManualInput.focus();
                        formValido = false;
                    } else { cargoManualInput.classList.remove('input-error'); }
                } else if (cargoSelect.value === '') {
                     alert("Por favor, selecione seu cargo (Item 1.3).");
                     cargoSelect.classList.add('input-error');
                     cargoSelect.focus();
                     formValido = false;
                }
                else if (lotacaoSelect.value === 'OUTRO' || lotacaoSelect.value === 'UBS/PSF') {
                    if (lotacaoManualInput.value.trim().length < 3) {
                        alert(`Selecione '${lotacaoSelect.value}', voc√™ deve especificar os detalhes da lota√ß√£o (Item 1.3).`);
                        lotacaoManualInput.classList.add('input-error');
                        lotacaoManualInput.focus();
                        formValido = false;
                    } else { lotacaoManualInput.classList.remove('input-error'); }
                } else if (lotacaoSelect.value === '') {
                     alert("Por favor, selecione a sua lota√ß√£o (onde trabalha) (Item 1.3).");
                     lotacaoSelect.classList.add('input-error');
                     lotacaoSelect.focus();
                     formValido = false;
                }
                // Valida√ß√£o m√≠nima de dados banc√°rios
                const banco = document.getElementById('inp_banco_nome').value;
                const agencia = document.getElementById('inp_agencia').value;
                const conta = document.getElementById('inp_conta').value;

                if (!banco || !agencia || !conta) {
                     alert("Por favor, preencha todos os Dados Banc√°rios (Item 1.4).");
                     document.getElementById('inp_banco_nome').focus();
                     formValido = false;
                }
            }
            
            // A valida√ß√£o de custos √© opcional, mas a falta de tudo √© um aviso.
            if (listaCustosTransporte.length === 0 && listaOutrasDespesas.length === 0 && formValido) {
                 const confirmar = window.confirm("Nenhum custo (Transporte, Alimenta√ß√£o ou Hospedagem/Outros) foi adicionado. Deseja gerar o relat√≥rio de presta√ß√£o de contas mesmo assim?");
                 if (!confirmar) {
                     formValido = false;
                 }
            }


            if (formValido) {
                // Remove a marca√ß√£o de erro se o formul√°rio for v√°lido para os campos principais
                cargoSelect.classList.remove('input-error');
                lotacaoSelect.classList.remove('input-error');
                gerarPDFFinal();
            }
        }


        // --- DEMAIS FUN√á√ïES (IBGE, FORMATOS) ---
        
        window.addEventListener('load', function() {
            // M√°scara CPF
             document.getElementById('inp_cpf').addEventListener('input', function(e) {
                e.target.classList.remove('input-error'); 
                let v = e.target.value.replace(/\D/g,""); 
                if(v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                else if(v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{3})/, "$1.$2.$3");
                else if(v.length > 3) v = v.replace(/(\d{3})(\d{3})/, "$1.$2");
                else if(v.length > 0) v = v.replace(/(\d{3})/, "$1");
                e.target.value = v;
            });
            
            carregarEstados(); // Carrega todos os selects de UF
            
            // Inicializa selects de custo de transporte (Item 2.3)
            carregarCidadesPorUF('inp_custo_origem_uf', 'inp_custo_origem_select');
            carregarCidadesPorUF('inp_custo_destino_uf', 'inp_custo_destino_select');
            
            // Inicializa listas de custos e comprovantes tempor√°rios
            calcularTotalCustosTransporte();
            renderizarListaCustosTransporte();
            renderizarComprovantesCustoTemp();
            
            // Inicializa Outras Despesas e suas listas tempor√°rias
            calcularTotalOutrasDespesas();
            renderizarListaOutrasDespesas();
            renderizarComprovantesAlimentacaoTemp(); // Garante o total zero inicial
            renderizarComprovantesHospedagemTemp(); // Garante o total zero inicial
            
            // Inicializa o Resumo Final (Item 5)
            atualizarResumoFinal();
            
            // Oculta detalhes do modal ao iniciar
            verificarModalidade(''); 
        });

        function carregarEstados() {
            fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados')
            .then(r=>r.json()).then(e=>{
                e.sort((a,b)=>a.sigla.localeCompare(b.sigla));
                // Atualiza APENAS os selects de UF para CUSTOS DE TRANSPORTE
                ['inp_custo_origem_uf', 'inp_custo_destino_uf'].forEach(id => {
                    let s = document.getElementById(id);
                    s.innerHTML=""; 
                    s.add(new Option('Selecione...', ''));
                    e.forEach(uf=>{
                        let opt=new Option(uf.sigla, uf.sigla); 
                        s.add(opt);
                    });
                     s.value = ''; // Come√ßa sem sele√ß√£o
                });
            });
        }
        
        function carregarCidadesPorUF(idUF, idCid, def="") {
            let uf = document.getElementById(idUF).value;
            let s = document.getElementById(idCid); 
            
            // Desabilita e limpa o select de cidade se nenhuma UF for selecionada
            if (uf === "") {
                s.innerHTML = '<option value="">Selecione...</option>';
                s.disabled = true; 
                return;
            }
            
            s.innerHTML='<option value="">Carregando...</option>';
            s.disabled = false; // Habilita o campo de cidade
            
            fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`)
            .then(r=>r.json()).then(c=>{
                s.innerHTML=""; s.add(new Option(def || "Selecione...", ""));
                c.sort((a,b)=>a.nome.localeCompare(b.nome));
                c.forEach(cid=>s.add(new Option(cid.nome, cid.nome)));
            });
        }
        
        function formatarDataHora(d) { if(!d)return""; return new Date(d).toLocaleString('pt-BR').slice(0,16).replace(',',''); }
        function formatarMoeda(v) { return parseFloat(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2}); }

        // --- GERAR PDF FINAL ---
        function gerarPDFFinal() {
            document.getElementById('status-msg').style.display = 'block';
            
            // 1. DADOS PESSOAIS
            const cargoSelect = document.getElementById('inp_cargo');
            let cargoFinal = (cargoSelect.value === 'OUTRO') ? document.getElementById('inp_cargo_manual').value : cargoSelect.value;
            const lotacaoSelect = document.getElementById('inp_lotacao');
            let lotacaoFinal = (lotacaoSelect.value === 'OUTRO' || lotacaoSelect.value === 'UBS/PSF') ? 
                                (lotacaoSelect.value === 'UBS/PSF' ? `UBS/PSF: ${document.getElementById('inp_lotacao_manual').value}` : document.getElementById('inp_lotacao_manual').value) : 
                                lotacaoSelect.value;
            const obsAdicional = document.getElementById('inp_obs_adicional').value.trim();

            // 2. CUSTOS DE TRANSPORTE (SUM√ÅRIO)
            let kmTotalViagem = 0;
            
            listaCustosTransporte.forEach(c => {
                 const matchKm = c.detalhes.match(/\| (\d+(\.\d+)?) Km/);
                 if (matchKm) {
                     kmTotalViagem += parseFloat(matchKm[1]);
                 }
            });
            
            let kmTotal = kmTotalViagem > 0 ? `${kmTotalViagem.toFixed(2)} Km` : 'N/A';
            
            // PREENCHE OS CAMPOS DO PDF
            document.getElementById('out_nome').textContent = document.getElementById('inp_nome').value.toUpperCase();
            document.getElementById('out_assinatura_nome').textContent = document.getElementById('inp_nome').value.toUpperCase();
            document.getElementById('out_matricula').textContent = document.getElementById('inp_matricula').value;
            document.getElementById('out_cpf').textContent = document.getElementById('inp_cpf').value;
            document.getElementById('out_cargo').textContent = cargoFinal; 
            document.getElementById('out_lotacao').textContent = lotacaoFinal; 
            
            let bancoStr = `${document.getElementById('inp_banco_nome').value} Ag:${document.getElementById('inp_agencia').value} CC:${document.getElementById('inp_conta').value}`;
            document.getElementById('out_banco').textContent = bancoStr; 
            
            const containerObsPdf = document.getElementById('container_obs_adicional_pdf');
            if (obsAdicional) {
                document.getElementById('out_obs_adicional').textContent = obsAdicional;
                containerObsPdf.style.display = 'block';
            } else {
                containerObsPdf.style.display = 'none';
            }

            document.getElementById('out_km_total').textContent = kmTotal;

            // VALORES FINANCEIROS
            let totalAnexos = 0; 
            let totalCustosTransporte = calcularTotalCustosTransporte();
            let totalOutrasDespesas = calcularTotalOutrasDespesas(); // Total geral

            // Separa√ß√£o de categorias para o PDF
            const alimentacao = listaOutrasDespesas.filter(d => d.categoria === 'ALIMENTACAO');
            const hospedagemOutros = listaOutrasDespesas.filter(d => d.categoria !== 'ALIMENTACAO');
            
            const totalAlimentacao = alimentacao.reduce((sum, item) => sum + item.valor, 0);
            const totalHospedagemOutros = hospedagemOutros.reduce((sum, item) => sum + item.valor, 0);

            
            // Zerar di√°rias fixas
            document.getElementById('out_qtd_diaria').textContent = 0;
            document.getElementById('out_vlr_diaria').textContent = formatarMoeda(0);
            document.getElementById('out_total_diarias').textContent = formatarMoeda(0);
            
            // Tabela de Detalhe de Custos de Transporte no PDF
            const tabelaCustosTransporte = document.getElementById('out_custos_transporte_tabela');
            if (listaCustosTransporte.length > 0) {
                 tabelaCustosTransporte.innerHTML = listaCustosTransporte.map((item, index) => {
                     // Lista de comprovantes dentro do item de transporte
                     const comprovantesHtml = item.comprovantes.map(c => `
                        <tr style="border-top: 1px dashed #ccc;">
                            <td style="font-size: 8pt; padding-left: 20px;">- ${c.tipoDespesa}</td>
                            <td style="text-align: center; font-size: 8pt;">1</td>
                            <td style="text-align: right; font-size: 8pt;">R$ ${formatarMoeda(c.valor)}</td>
                            <td style="text-align: right; font-size: 8pt;">R$ ${formatarMoeda(c.valor)}</td>
                        </tr>
                     `).join('');

                     return `
                        <tr>
                            <td colspan="4" style="background-color: #f7f7f7; font-weight: bold; border-top: 2px solid #ccc; font-size: 9pt;">
                                Trecho ${index + 1}: ${item.modalidade} (${item.detalhes.split('|')[0].trim()})
                            </td>
                        </tr>
                        ${comprovantesHtml}
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold; font-size: 9pt; background-color: #fff3cd;">SUBTOTAL TRECHO:</td>
                            <td style="text-align: right; font-weight: bold; font-size: 9pt; background-color: #fff3cd;">R$ ${formatarMoeda(item.valor)}</td>
                        </tr>
                     `;
                 }).join('');
            } else {
                 tabelaCustosTransporte.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; font-style: italic; border: 0; padding-top: 5px; padding-bottom: 5px;">Nenhum custo de transporte adicionado.</td>
                    </tr>
                `;
            }

            // Tabela de Detalhe de ALIMENTA√á√ÉO no PDF
            const tabelaAlimentacao = document.getElementById('out_alimentacao_tabela');
            if (alimentacao.length > 0) {
                tabelaAlimentacao.innerHTML = alimentacao.map((item, index) => {
                    // Lista de comprovantes dentro do item de alimenta√ß√£o
                    const comprovantesHtml = item.comprovantes.map(c => `
                        <tr style="border-top: 1px dashed #ccc;">
                            <td style="font-size: 8pt; padding-left: 20px;">- ${c.tipoDespesa} (Comprovante)</td>
                            <td style="text-align: center; font-size: 8pt;">1</td>
                            <td style="text-align: right; font-size: 8pt;">R$ ${formatarMoeda(c.valor)}</td>
                            <td style="text-align: right; font-size: 8pt;">R$ ${formatarMoeda(c.valor)}</td>
                        </tr>
                    `).join('');

                    return `
                        <tr>
                            <td colspan="4" style="background-color: #f7f7f7; font-weight: bold; border-top: 2px solid #ccc; font-size: 9pt;">
                                Item ${index + 1}: ${item.descricao.split('(')[0].trim()}
                            </td>
                        </tr>
                        ${comprovantesHtml}
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold; font-size: 9pt; background-color: #e8f4fd;">TOTAL ITEM ALIMENTA√á√ÉO:</td>
                            <td style="text-align: right; font-weight: bold; font-size: 9pt; background-color: #e8f4fd;">R$ ${formatarMoeda(item.valor)}</td>
                        </tr>
                    `;
                 }).join('');
                 
            } else {
                 tabelaAlimentacao.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; font-style: italic; border: 0; padding-top: 5px; padding-bottom: 5px;">Nenhuma despesa de alimenta√ß√£o adicionada.</td>
                    </tr>
                `;
            }

            // Tabela de Detalhe de HOSPEDAGEM E OUTROS no PDF
            const tabelaHospedagemOutros = document.getElementById('out_hospedagem_outros_tabela');
            if (hospedagemOutros.length > 0) {
                tabelaHospedagemOutros.innerHTML = hospedagemOutros.map((item, index) => {
                    // Lista de comprovantes dentro do item de hospedagem
                    const comprovantesHtml = item.comprovantes.map(c => `
                        <tr style="border-top: 1px dashed #ccc;">
                            <td style="font-size: 8pt; padding-left: 20px;">- ${c.tipoDespesa} (Comprovante)</td>
                            <td style="text-align: center; font-size: 8pt;">1</td>
                            <td style="text-align: right; font-size: 8pt;">R$ ${formatarMoeda(c.valor)}</td>
                            <td style="text-align: right; font-size: 8pt;">R$ ${formatarMoeda(c.valor)}</td>
                        </tr>
                    `).join('');

                    return `
                        <tr>
                            <td colspan="4" style="background-color: #f7f7f7; font-weight: bold; border-top: 2px solid #ccc; font-size: 9pt;">
                                Item ${index + 1}: ${item.descricao.split('(')[0].trim()}
                            </td>
                        </tr>
                        ${comprovantesHtml}
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold; font-size: 9pt; background-color: #f0f7ff;">TOTAL ITEM HOSPEDAGEM/OUTROS:</td>
                            <td style="text-align: right; font-weight: bold; font-size: 9pt; background-color: #f0f7ff;">R$ ${formatarMoeda(item.valor)}</td>
                        </tr>
                    `;
                 }).join('');
            } else {
                 tabelaHospedagemOutros.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; font-style: italic; border: 0; padding-top: 5px; padding-bottom: 5px;">Nenhuma despesa de hospedagem ou outra despesa adicionada.</td>
                    </tr>
                `;
            }

            // Totaliza√ß√£o no rodap√© da tabela principal
            document.getElementById('out_total_custos_transporte_pdf').textContent = formatarMoeda(totalCustosTransporte); 
            document.getElementById('out_total_outras_despesas_pdf').textContent = formatarMoeda(totalAlimentacao + totalHospedagemOutros); // Soma A + H/O
            document.getElementById('out_total_anexos_pdf').textContent = formatarMoeda(totalAnexos); // R$ 0,00

            let saldoFinal = totalCustosTransporte + totalOutrasDespesas + totalAnexos; 

            document.getElementById('out_adiantamento').textContent = formatarMoeda(0);
            document.getElementById('out_saldo_final').textContent = formatarMoeda(saldoFinal);

            document.getElementById('out_data_geracao').textContent = new Date().toLocaleString();
            document.getElementById('out_hash').textContent = Math.random().toString(36).substring(7).toUpperCase();

            // COLETANDO TODOS ANEXOS
            let todosAnexos = [];
            
            // 1. Anexos de CUSTO DE TRANSPORTE
            listaCustosTransporte.forEach((custo, custoIndex) => {
                custo.comprovantes.forEach(comprovante => {
                    todosAnexos.push({
                        descricao: `${comprovante.tipoDespesa} (Trecho ${custoIndex + 1}: ${custo.detalhes.split('|')[0].trim()})`,
                        valor: comprovante.valor,
                        imagem: comprovante.imagemBase64,
                        mimeType: comprovante.mimeType,
                        tipo: 'Transporte'
                    });
                });
            });
            
            // 2. Anexos de OUTRAS DESPESAS (ITENS 3 e 4)
            listaOutrasDespesas.forEach(item => {
                const itemCategoria = item.categoria === 'ALIMENTACAO' ? 'Alimenta√ß√£o' : (item.categoria === 'HOSPEDAGEM' ? 'Hospedagem' : 'Outros');
                
                item.comprovantes.forEach((comprovante, index) => {
                     todosAnexos.push({
                        descricao: `${comprovante.tipoDespesa} - ${item.descricao}`,
                        valor: comprovante.valor,
                        imagem: comprovante.imagemBase64,
                        mimeType: comprovante.mimeType,
                        tipo: `${itemCategoria} (C. ${index+1})`
                    });
                });
            });

            // RENDERIZA LISTA DE TODOS ANEXOS NO HTML DO PDF
            const containerPdf = document.getElementById('lista_anexos_pdf_conteudo');
            const sectionPdf = document.getElementById('container_anexos_pdf');
            containerPdf.innerHTML = "";
            
            if (todosAnexos.length > 0) {
                sectionPdf.style.display = 'block';
                todosAnexos.forEach((item, index) => {
                    let imageContent;
                    
                    if (item.mimeType.startsWith('image/')) {
                         imageContent = `<img src="${item.imagem}" class="pdf-comprovante-img">`;
                    } else if (item.mimeType.includes('pdf')) {
                        imageContent = `<div class="pdf-comprovante-img" style="display: flex; align-items: center; justify-content: center; height: 150px; background-color: #f7f7f7; border: 1px dashed #999;">
                                           <span style="font-size: 10pt;">[PDF Anexo: ${index + 1} - ${item.tipo}] Conte√∫do Digitalizado.</span>
                                        </div>`;
                    } else {
                         imageContent = `<div class="pdf-comprovante-img" style="display: flex; align-items: center; justify-content: center; height: 150px; background-color: #ffcccc; border: 1px dashed #999;">
                                           <span style="font-size: 10pt; color: #cc0000;">[Arquivo N√£o Suportado]</span>
                                        </div>`;
                    }

                    const div = document.createElement('div');
                    div.className = 'pdf-comprovante-box';
                    div.innerHTML = `
                        ${imageContent}
                        <div class="pdf-comprovante-data">
                            <p><strong>Despesa:</strong> ${item.descricao}</p>
                            <p><strong>Tipo:</strong> ${item.tipo}</p>
                            <p><strong>Valor Declarado:</strong> R$ ${formatarMoeda(item.valor)}</p>
                        </div>
                    `;
                    containerPdf.appendChild(div);
                });
            } else {
                sectionPdf.style.display = 'none';
            }

            // GERA PDF
            html2pdf().set({ margin:10, filename:'Prestacao_Contas.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'mm',format:'a4'} })
                .from(document.getElementById('report-container')).save()
                .then(()=> document.getElementById('status-msg').innerHTML="PDF Baixado com Sucesso!");
        }
    </script>
</body>
</html>
