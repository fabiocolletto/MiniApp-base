<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>Painel de Indicadores â€” i18n (i18next) + Templates (v1.0.10)</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- GH Pages-safe: relativo Ã  pasta miniapp-prefeito/ -->
  <link rel="stylesheet" href="../miniapp-base/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base@main/miniapp-base/styles.css" media="print" onload="this.media='all'">
  <style>
    .modal{position:fixed;inset:0;display:none}
    .modal:target{display:block}
    .kpi{position:relative}
    .kpi details.info{position:absolute;top:6px;right:6px}
    .kpi details.info summary{list-style:none;border:none;background:transparent;width:28px;height:28px;display:grid;place-items:center;padding:0}
    .kpi details.info[open] .panel{min-width:260px}
    .toolbar .chipbtn{display:inline-flex;align-items:center;gap:.5rem}
    .kpi-bar{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;align-items:stretch}
    .kpi-bar .kpi{display:flex;flex-direction:column}
    @media (max-width:700px){.kpi-bar{grid-auto-flow:column;grid-auto-columns:minmax(220px,1fr);overflow-x:auto;padding-bottom:4px}}
  </style>
  <script defer src="https://unpkg.com/i18next@23/dist/umd/i18next.min.js"></script>
  <script defer src="https://unpkg.com/i18next-http-backend@2/dist/umd/i18nextHttpBackend.min.js"></script>
</head>
<body>
  <header>
    <div class="title">
      <span class="material-symbols-rounded" aria-hidden="true">insights</span>
      <div>
        <h1 data-i18n="app.title">MunicÃ­pio de Curitiba â€” Painel de Indicadores</h1>
        <p class="subtitle" data-i18n="app.subtitle">VersÃ£o com i18n (i18next) e templates remotos</p>
      </div>
      <span class="version" aria-label="versÃ£o do arquivo">v1.0.10</span>
    </div>
    <div class="toolbar" role="group" aria-label="Controles de exibiÃ§Ã£o">
      <div class="split" id="toolbar-split"></div>
    </div>
  </header>

  <section id="persona-bar" class="kpi-bar" aria-label="Resumo de perfil da amostra"></section>
  <section id="kpi-bar" class="kpi-bar" aria-label="Indicadores-chave por setor"></section>

  <main id="cards" class="grid" aria-live="polite"></main>

  <section id="theme" class="modal" aria-labelledby="th1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="th1" data-i18n="theme.title">Tema do painel</h2>
        <a class="close" href="#" aria-label="Fechar">âœ•</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" id="theme-light-btn" href="#" data-theme="light"><span class="material-symbols-rounded">light_mode</span><span data-i18n="theme.light">Claro</span></a>
          <a class="chipbtn" id="theme-dark-btn" href="#" data-theme="dark"><span class="material-symbols-rounded">dark_mode</span><span data-i18n="theme.dark">Escuro</span></a>
          <a class="chipbtn" id="theme-auto-btn" href="#" data-theme="auto"><span class="material-symbols-rounded">autorenew</span><span data-i18n="theme.auto">AutomÃ¡tico</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="language" class="modal" aria-labelledby="lg1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="lg1" data-i18n="lang.title">Idioma do painel</h2>
        <a class="close" href="#" aria-label="Fechar">âœ•</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" id="lang-pt-btn" href="#" data-lang="pt-BR"><span class="flag">ðŸ‡§ðŸ‡·</span><span data-i18n="lang.pt">PortuguÃªs</span></a>
          <a class="chipbtn" id="lang-en-btn" href="#" data-lang="en-US"><span class="flag">ðŸ‡ºðŸ‡¸</span><span data-i18n="lang.en">English</span></a>
          <a class="chipbtn" id="lang-es-btn" href="#" data-lang="es-ES"><span class="flag">ðŸ‡ªðŸ‡¸</span><span data-i18n="lang.es">EspaÃ±ol</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="sync" class="modal" aria-labelledby="gd1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="gd1" data-i18n="sync.title">MÃºltiplos dispositivos</h2>
        <a class="close" href="#" aria-label="Fechar">âœ•</a>
      </header>
      <div class="sheet-body">
        <p style="margin-top:0;color:var(--muted)" data-i18n="sync.lead">Ative a sincronizaÃ§Ã£o via Google Drive para que suas pesquisas e preferÃªncias fiquem disponÃ­veis em todos os seus dispositivos. VocÃª verÃ¡ um pedido de permissÃ£o do Google.</p>
        <div class="subcard" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div style="display:flex;flex-direction:column;gap:4px">
            <strong data-i18n="sync.ctaTitle">Sincronizar com Google Drive</strong>
            <span style="font-size:12px;color:var(--muted)" data-i18n="sync.ctaHint">Armazena configuraÃ§Ãµes e catÃ¡logos de pesquisas no seu Drive, com consentimento.</span>
          </div>
          <button id="sync-toggle" class="btn" aria-pressed="false" title="Habilitar sincronizaÃ§Ã£o"><span class="material-symbols-rounded" aria-hidden="true">cloud_sync</span><span class="sync-label" data-i18n="sync.enable">Permitir e ativar</span></button>
        </div>
        <p id="sync-state" style="margin:10px 0 0;color:var(--muted)" data-i18n="sync.state.off">SincronizaÃ§Ã£o desativada</p>
        <div id="sync-tip" class="pill info" style="margin-top:10px;display:none"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:10px">
          <a id="sync-open-tab" class="btn" href="#" style="display:none" title="Abrir em nova aba"><span class="material-symbols-rounded">open_in_new</span><span data-i18n="sync.openTab">Abrir em nova aba</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="kpi-saude" class="modal" aria-labelledby="k1"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k1">SaÃºde â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o. Este painel replica o layout dos detalhes dos grÃ¡ficos, com foco no setor.</p></div></div></section>
  <section id="kpi-educacao" class="modal" aria-labelledby="k2"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k2">EducaÃ§Ã£o â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>
  <section id="kpi-transporte" class="modal" aria-labelledby="k3"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k3">Transporte â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>
  <section id="kpi-seguranca" class="modal" aria-labelledby="k4"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k4">SeguranÃ§a â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>
  <section id="kpi-meioambiente" class="modal" aria-labelledby="k5"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k5">Meio ambiente â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>

  <section id="info-modal" class="modal" aria-label="InformaÃ§Ãµes"></section>

  <footer data-i18n="app.footer">Base preparada para i18n (i18next) e templates externos versionados.</footer>

  <script>
    const I18N_NAMESPACES = ['common','kpi','charts','reports','miniapp_prefeito','system'];
    const THEME_STORAGE_KEY = 'miniapp-prefeito-theme';
    const LANG_STORAGE_KEY  = 'miniapp-prefeito-lang';

    // Garantia: candidatos definidos mesmo se o ambiente nÃ£o injetar variÃ¡veis globais
    window.__INDEXED_LIB_CANDIDATES__   = Array.isArray(window.__INDEXED_LIB_CANDIDATES__)   ? window.__INDEXED_LIB_CANDIDATES__   : [];
    window.__RELATORIO_LIB_CANDIDATES__ = Array.isArray(window.__RELATORIO_LIB_CANDIDATES__) ? window.__RELATORIO_LIB_CANDIDATES__ : [];

    function computeDocBase(){ return location.pathname.replace(/\/[^/]*$/, ''); }
    function buildCandidates(lng, ns){
      const DOC_BASE = computeDocBase();
      return [
        `${DOC_BASE}/i18n/locales/${lng}/${ns}.json`,
        `i18n/locales/${lng}/${ns}.json`
      ];
    }

    function applyI18n(root){
      try{
        (root||document).querySelectorAll('[data-i18n]').forEach(function(n){
          const key=n.getAttribute('data-i18n');
          const val=i18next.t(key);
          if(!val || val===key){ console.warn('i18n: traduÃ§Ã£o ausente para', key); return; }
          n.textContent=val;
        });
      }catch(_){ }
    }
    function $t(k){ try{ return i18next.t(k) || k; }catch(_){ return k; } }

    function applyTheme(theme){
      const html=document.documentElement; if(history.replaceState){history.replaceState(null,'',location.pathname+location.search);} else {window.location.hash='';}
      if(theme==='auto'){ html.removeAttribute('data-theme'); localStorage.removeItem(THEME_STORAGE_KEY); }
      else{ html.setAttribute('data-theme', theme); localStorage.setItem(THEME_STORAGE_KEY, theme); }
    }
    function loadInitialTheme(){
      const saved=localStorage.getItem(THEME_STORAGE_KEY); const html=document.documentElement;
      if(saved==='auto'){ html.removeAttribute('data-theme'); }
      else if(saved){ html.setAttribute('data-theme', saved); }
      else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ html.setAttribute('data-theme','dark'); }
      else{ html.setAttribute('data-theme','light'); }
    }
    function bindThemeToggles(){
      const m=document.getElementById('theme'); if(!m) return;
      m.querySelectorAll('.chipbtn').forEach(btn=>{ if(btn.dataset.bound) return; btn.dataset.bound='1';
        const v=btn.getAttribute('data-theme'); if(!v) return; btn.addEventListener('click',e=>{e.preventDefault();applyTheme(v);},{passive:true});
      });
    }

    function applyLanguage(lang){
      if(lang){ localStorage.setItem(LANG_STORAGE_KEY,lang);} else {localStorage.removeItem(LANG_STORAGE_KEY);} 
      if(history.replaceState){history.replaceState(null,'',location.pathname+location.search);} else {window.location.hash='';}
      if(window.i18next && i18next.isInitialized){ i18next.changeLanguage(lang||'pt-BR').then(()=>applyI18n(document)); }
      document.documentElement.lang=lang||'pt-BR';
    }
    function loadInitialLanguage(){ const saved=localStorage.getItem(LANG_STORAGE_KEY)||document.documentElement.lang||'pt-BR'; document.documentElement.lang=saved; return saved; }
    function bindLanguageToggles(){
      const m=document.getElementById('language'); if(!m) return;
      m.querySelectorAll('.chipbtn').forEach(btn=>{ if(btn.dataset.bound) return; btn.dataset.bound='1';
        const L=btn.getAttribute('data-lang'); if(!L) return; btn.addEventListener('click',e=>{e.preventDefault();applyLanguage(L);},{passive:true});
      });
    }

    (function loadScripts(){
      function loadOne(list, cb){
        if(!list||!list.length) return cb&&cb();
        var src=list.shift(); var s=document.createElement('script'); var done=false;
        var t=setTimeout(function(){ if(done) return; done=true; loadOne(list, cb); }, 5000);
        s.src=src; s.async=true;
        s.onload=function(){ if(done) return; done=true; clearTimeout(t); cb&&cb(true,src); };
        s.onerror=function(){ if(done) return; done=true; clearTimeout(t); loadOne(list, cb); };
        document.head.appendChild(s);
      }
      loadOne(window.__INDEXED_LIB_CANDIDATES__.slice(), function(){
        loadOne(window.__RELATORIO_LIB_CANDIDATES__.slice(), function(){ window.__libsReady__=true; tryInit(); });
      });
    })();

    function initI18n(){
      if(window.__i18nStarted__) return; window.__i18nStarted__=true;
      const initialLang=loadInitialLanguage();
      try{
        i18next
          .use(i18nextHttpBackend)
          .init({
            lng: initialLang,
            fallbackLng: 'pt-BR',
            ns: I18N_NAMESPACES,
            defaultNS: 'common',
            backend: {
              loadPath: '{{lng}}|{{ns}}',
              request: function(options, url, payload, callback){
                try{
                  var parts = url.split('|');
                  var lng = parts[0];
                  var ns  = parts[1];
                  var urls = buildCandidates(lng, ns);
                  var i = 0;
                  (function tryNext(){
                    if(i>=urls.length){ callback('not found', { status: 404 }); return; }
                    var u = urls[i++];
                    fetch(u, { cache:'no-store' })
                      .then(function(r){ if(!r.ok){ tryNext(); return; } return r.text().then(function(data){ callback(null, { status:200, data:data }); }); })
                      .catch(function(){ tryNext(); });
                  })();
                }catch(err){ callback(err && err.message ? err.message : 'request error', { status: 0 }); }
              }
            },
            interpolation: { escapeValue: false }
          })
          .then(function(){
            applyI18n(document);
            initPanel();
            (async function quickLangAudit(){
              const langs=['pt-BR','en-US','es-ES']; const misses=[];
              for(const L of langs){
                for(const ns of I18N_NAMESPACES){
                  const u=buildCandidates(L,ns)[0];
                  try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok){ misses.push(`${L}/${ns} â†’ HTTP ${r.status}`); } }
                  catch(err){ misses.push(`${L}/${ns} â†’ ${err&&err.message?err.message:'erro'}`); }
                }
              }
              if(misses.length){ console.warn('[i18n-audit] Ausentes/inacessÃ­veis:', misses); }
              else{ console.info('[i18n-audit] OK: idiomas e namespaces acessÃ­veis.'); }
            })();
          });
      }catch(e){ console.error('i18n init error', e); initPanel(); }
    }

    function report(kind,state,text){ try{ (window.relatorio||window.Relatorio)?.status?.(kind,state,text); }catch(_){} }
    function renderToolbar(){
      const host=document.getElementById('toolbar-split'); if(!host) return;
      host.innerHTML=`
        <a class="chipbtn" href="#theme" title="Tema"><span class="material-symbols-rounded">palette</span><span data-i18n="theme.title">Tema do painel</span></a>
        <a class="chipbtn" href="#language" title="Idioma"><span class="material-symbols-rounded">translate</span><span data-i18n="lang.title">Idioma do painel</span></a>
        <a class="chipbtn" href="#sync" title="SincronizaÃ§Ã£o"><span class="material-symbols-rounded">cloud_sync</span><span data-i18n="sync.title">MÃºltiplos dispositivos</span></a>`;
    }
    function renderPersona(){
      const host=document.getElementById('persona-bar'); if(!host) return;
      const demo=[{k:'GÃªnero',v:'53% mulheres'},{k:'Faixa etÃ¡ria',v:'34% 25â€“39'},{k:'Renda',v:'R$ 2kâ€“5k predominante'},{k:'Escolaridade',v:'Ensino mÃ©dio (48%)'}];
      host.innerHTML=demo.map(d=>`<span class="chip"><strong>${d.k}</strong> ${d.v}</span>`).join('');
    }
    function renderKPIs(){
      const host=document.getElementById('kpi-bar'); if(!host) return;
      const kpis=[
        {id:'saude',label:'SaÃºde',value:72,trend:+4,href:'#kpi-saude'},
        {id:'educacao',label:'EducaÃ§Ã£o',value:68,trend:+2,href:'#kpi-educacao'},
        {id:'transporte',label:'Transporte',value:41,trend:-3,href:'#kpi-transporte'},
        {id:'seguranca',label:'SeguranÃ§a',value:57,trend:+1,href:'#kpi-seguranca'},
        {id:'meioambiente',label:'Meio ambiente',value:63,trend:+5,href:'#kpi-meioambiente'}
      ];
      host.innerHTML=kpis.map(k=>{
        const t=k.trend>0?`<span class="pill success" title="VariaÃ§Ã£o">+${k.trend}pp</span>`:(k.trend<0?`<span class="pill warn" title="VariaÃ§Ã£o">${k.trend}pp</span>`:'');
        return `<a class="kpi" href="${k.href}" aria-label="${k.label}">
          <div class="meter" role="img" aria-label="${k.label} ${k.value}%"><span style="width:${k.value}%"></span></div>
          <div class="kpi-body"><strong>${k.label}</strong><span class="muted">${k.value}% satisfaÃ§Ã£o</span></div>
          ${t}
        </a>`;
      }).join('');
    }
    function renderIndicators(){
      const grid=document.getElementById('cards'); if(!grid) return;
      const sections=[
        {icon:'local_hospital', title:'SaÃºde', info:'Atendimento bÃ¡sico, tempo de espera, disponibilidade de medicamentos.', items:[
          {name:'Tempo de espera em UBS', scale:'1â€“5', good:[4,5], avg:3.7, n:812},
          {name:'Disponibilidade de medicamentos', scale:'1â€“5', good:[4,5], avg:3.4, n:799},
          {name:'SatisfaÃ§Ã£o geral', scale:'1â€“5', good:[4,5], avg:3.6, n:820}
        ]},
        {icon:'school', title:'EducaÃ§Ã£o', info:'Qualidade do ensino, infraestrutura e seguranÃ§a escolar.', items:[
          {name:'Qualidade do ensino', scale:'1â€“5', good:[4,5], avg:3.5, n:756},
          {name:'Infraestrutura', scale:'1â€“5', good:[4,5], avg:3.3, n:741},
          {name:'SatisfaÃ§Ã£o geral', scale:'1â€“5', good:[4,5], avg:3.4, n:770}
        ]},
        {icon:'directions_bus', title:'Transporte', info:'FrequÃªncia, lotaÃ§Ã£o e percepÃ§Ã£o de seguranÃ§a.', items:[
          {name:'FrequÃªncia dos Ã´nibus', scale:'1â€“5', good:[4,5], avg:2.8, n:934},
          {name:'LotaÃ§Ã£o', scale:'1â€“5', good:[4,5], avg:2.6, n:928},
          {name:'SatisfaÃ§Ã£o geral', scale:'1â€“5', good:[4,5], avg:2.9, n:940}
        ]},
        {icon:'shield_person', title:'SeguranÃ§a', info:'IluminaÃ§Ã£o pÃºblica, patrulhamento e sensaÃ§Ã£o de seguranÃ§a.', items:[
          {name:'IluminaÃ§Ã£o pÃºblica', scale:'1â€“5', good:[4,5], avg:3.1, n:680},
          {name:'Patrulhamento', scale:'1â€“5', good:[4,5], avg:3.0, n:672},
          {name:'SatisfaÃ§Ã£o geral', scale:'1â€“5', good:[4,5], avg:3.2, n:690}
        ]},
        {icon:'forest', title:'Meio ambiente', info:'Coleta seletiva, Ã¡reas verdes e limpeza urbana.', items:[
          {name:'Coleta seletiva', scale:'1â€“5', good:[4,5], avg:3.6, n:720},
          {name:'ConservaÃ§Ã£o de praÃ§as', scale:'1â€“5', good:[4,5], avg:3.3, n:702},
          {name:'SatisfaÃ§Ã£o geral', scale:'1â€“5', good:[4,5], avg:3.5, n:730}
        ]}
      ];
      function meter(p){ return `<div class="meter small"><span style="width:${Math.round(p*20)}%"></span></div>`; }
      function legend(scale,good){ return `<div class="legend muted">Escala ${scale}. Bom: ${good.join(' ou ')}. <em>Leitura:</em> 1â€“2 = ruim, 3â€“4 = mÃ©dio, 5 = bom.</div>`; }
      grid.innerHTML=sections.map(sec=>{
        const list=sec.items.map(it=>`<li class="row"><div class="row-main"><span>${it.name}</span>${meter(it.avg)}</div><span class="pill" title="amostra">n=${it.n}</span></li>`).join('');
        return `<article class="card"><header class="card-head">
          <span class="material-symbols-rounded" aria-hidden="true">${sec.icon}</span>
          <div><h3>${sec.title}</h3><p class="subtitle">${sec.info}</p></div>
          <details class="info"><summary class="btn icon" title="Ajuda">info</summary><div class="panel"><strong>Como ler:</strong><p>Usamos escala de 1â€“5. Para cada item, exibimos a mÃ©dia e a amostra (n). ${legend('1â€“5',['4','5'])}</p></div></details>
        </header><ul class="list kpi-list">${list}</ul><footer class="card-foot muted">${legend('1â€“5',['4','5'])}</footer></article>`;
      }).join('');
    }
    function showSyncTip(message,warn){ const el=document.getElementById('sync-tip'); if(!el) return; el.textContent=message||''; el.style.display=message?'block':'none'; el.classList.toggle('warn',!!warn); }
    function updateSyncUI(enabled){ const btn=document.getElementById('sync-toggle'); const st=document.getElementById('sync-state'); if(btn){ btn.setAttribute('aria-pressed', enabled?'true':'false'); btn.querySelector('.sync-label').textContent=enabled?($t('sync.disable')||'Desativar'):($t('sync.enable')||'Permitir e ativar'); } if(st){ st.textContent=enabled?($t('sync.state.on')||'SincronizaÃ§Ã£o ativada'):($t('sync.state.off')||'SincronizaÃ§Ã£o desativada'); } }
    async function setSyncEnabled(enabled){ updateSyncUI(enabled); return Promise.resolve(true); }

    async function initPanel(){
      bindThemeToggles();
      bindLanguageToggles();
      renderToolbar();
      renderPersona();
      renderKPIs();
      renderIndicators();
      applyI18n(document);
      const btn=document.getElementById('sync-toggle'); const openTab=document.getElementById('sync-open-tab');
      if(openTab){ openTab.style.display='none'; }
      if(btn){ btn.addEventListener('click', async function(){
        const on=btn.getAttribute('aria-pressed')==='true';
        if(on){ await setSyncEnabled(false); report('drive','off','sync desativada'); return; }
        showSyncTip('Solicitando permissÃ£o do Googleâ€¦'); setTimeout(async function(){ await setSyncEnabled(true); showSyncTip('SincronizaÃ§Ã£o ativada'); }, 500);
      }); }
      document.addEventListener('click', function(e){ document.querySelectorAll('details.info[open]').forEach(function(d){ if(!d.contains(e.target)) d.removeAttribute('open'); }); });
      document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ document.querySelectorAll('details.info[open]').forEach(function(d){ d.removeAttribute('open'); }); } });
    }
    function tryInit(){ if(!window.__libsReady__) return; if(document.readyState!=='loading') initI18n(); else document.addEventListener('DOMContentLoaded', initI18n, {once:true}); }
    loadInitialTheme();
    tryInit();

    // Testes rÃ¡pidos
    (function selfTests(){
      console.assert(!!window.i18next, '[test] i18next nÃ£o carregou');
      console.assert(Array.isArray(window.__INDEXED_LIB_CANDIDATES__), '[test] __INDEXED_LIB_CANDIDATES__ nÃ£o Ã© array');
      console.assert(Array.isArray(window.__RELATORIO_LIB_CANDIDATES__), '[test] __RELATORIO_LIB_CANDIDATES__ nÃ£o Ã© array');
      const check=['pt-BR','en-US','es-ES'].map(function(L){return `${computeDocBase()}/i18n/locales/${L}/system.json`;});
      console.log('[test] candidatos de caminho i18n:', check);
    })();
  </script>
</body>
</html>
