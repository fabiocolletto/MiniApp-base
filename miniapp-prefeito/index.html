<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel de Indicadores ‚Äî Vers√£o Est√°tica (6 indicadores)</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../miniapp-base/styles.css?v=0.9.4">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/styles.css?v=0.9.4" media="print" onload="this.media='all'">
</head>
<body>
  <header>
    <div class="title">
      <span class="material-symbols-rounded" aria-hidden="true">insights</span>
      <div>
        <h1 data-i18n="app.title">Munic√≠pio de Curitiba ‚Äî Painel de Indicadores</h1>
        <p class="subtitle" data-i18n="app.subtitle">Vers√£o est√°tica com bot√£o de permiss√£o para Google Drive</p>
      </div>
      <span class="version" aria-label="vers√£o do arquivo">v0.9.5</span>
    </div>
    <div class="toolbar" role="group" aria-label="Controles de exibi√ß√£o">
      <div class="split" id="toolbar-split"></div>
    </div>
  </header>

  <section id="persona-bar" class="kpi-bar" aria-label="Resumo de perfil da amostra"></section>
  <section id="kpi-bar" class="kpi-bar" aria-label="Indicadores-chave por setor"></section>

  <main id="cards" class="grid" aria-live="polite"></main>

  <section id="theme" class="modal" aria-labelledby="th1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="th1" data-i18n="theme.title">Tema do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" href="#" data-theme="light"><span class="material-symbols-rounded">light_mode</span><span data-i18n="theme.light">Claro</span></a>
          <a class="chipbtn" href="#" data-theme="dark"><span class="material-symbols-rounded">dark_mode</span><span data-i18n="theme.dark">Escuro</span></a>
          <a class="chipbtn" href="#" data-theme="auto"><span class="material-symbols-rounded">autorenew</span><span data-i18n="theme.auto">Autom√°tico</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="language" class="modal" aria-labelledby="lg1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="lg1" data-i18n="lang.title">Idioma do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" href="#" data-lang="pt-BR"><span class="flag">üáßüá∑</span><span data-i18n="lang.pt">Portugu√™s</span></a>
          <a class="chipbtn" href="#" data-lang="es-ES"><span class="flag">üá™üá∏</span><span data-i18n="lang.es">Espa√±ol</span></a>
          <a class="chipbtn" href="#" data-lang="en-US"><span class="flag">üá∫üá∏</span><span data-i18n="lang.en">English</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="sync" class="modal" aria-labelledby="gd1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="gd1" data-i18n="sync.title">M√∫ltiplos dispositivos</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <p style="margin-top:0;color:var(--muted)" data-i18n="sync.lead">Ative a sincroniza√ß√£o via Google Drive para que suas pesquisas e prefer√™ncias fiquem dispon√≠veis em todos os seus dispositivos. Voc√™ ver√° um pedido de permiss√£o do Google.</p>
        <div class="subcard" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div style="display:flex;flex-direction:column;gap:4px">
            <strong data-i18n="sync.ctaTitle">Sincronizar com Google Drive</strong>
            <span style="font-size:12px;color:var(--muted)" data-i18n="sync.ctaHint">Armazena configura√ß√µes e cat√°logos de pesquisas no seu Drive, com consentimento.</span>
          </div>
          <button id="sync-toggle" class="btn" aria-pressed="false" title="Permitir e ativar" data-i18n-attr="title:sync.enable"><span class="material-symbols-rounded" aria-hidden="true">cloud_sync</span><span class="sync-label" data-i18n="sync.enable">Permitir e ativar</span></button>
        </div>
        <p id="sync-state" style="margin:10px 0 0;color:var(--muted)" data-i18n="sync.state.off">Sincroniza√ß√£o desativada</p>
        <div id="sync-tip" class="pill info" style="margin-top:10px;display:none"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:10px">
          <a id="sync-open-tab" class="btn" href="#" style="display:none" title="Abrir em nova aba" data-i18n-attr="title:sync.openTab"><span class="material-symbols-rounded">open_in_new</span><span data-i18n="sync.openTab">Abrir em nova aba</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="kpi-saude" class="modal" aria-labelledby="k1"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k1">Sa√∫de ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o. Este painel replica o layout dos detalhes dos gr√°ficos, com foco no setor.</p></div></div></section>
  <section id="kpi-educacao" class="modal" aria-labelledby="k2"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k2">Educa√ß√£o ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-transporte" class="modal" aria-labelledby="k3"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k3">Transporte ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-seguranca" class="modal" aria-labelledby="k4"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k4">Seguran√ßa ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-meioambiente" class="modal" aria-labelledby="k5"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k5">Meio ambiente ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>

  <footer data-i18n="app.footer">Base preparada para pedir consentimento do Google e registrar no armazenamento local via IndexedDB. Nenhum gr√°fico ativo nesta vers√£o.</footer>

  <script id="i18n-pt-BR" type="application/json">
  {
    "app.title": "Munic√≠pio de Curitiba ‚Äî Painel de Indicadores",
    "app.subtitle": "Vers√£o com i18n (i18next) e templates remotos",
    "app.footer": "Base preparada para i18n (i18next) e templates externos versionados.",
    "toolbar.filters": "Filtros",
    "toolbar.studies": "Pesquisas",
    "toolbar.theme": "Tema",
    "toolbar.language": "Idioma",
    "toolbar.multidevice": "Multi-dispositivo",
    "theme.title": "Tema do painel",
    "theme.light": "Claro",
    "theme.dark": "Escuro",
    "theme.auto": "Autom√°tico",
    "lang.title": "Idioma do painel",
    "lang.pt": "Portugu√™s",
    "lang.es": "Espa√±ol",
    "lang.en": "English",
    "sector.saude": "Sa√∫de",
    "sector.educacao": "Educa√ß√£o",
    "sector.transporte": "Transporte",
    "sector.seguranca": "Seguran√ßa",
    "sector.meioambiente": "Meio ambiente",
    "delta.stable": "est√°vel",
    "delta.change": "{{value}} vs. m√™s anterior",
    "charts.avg_by_sector.title": "M√©dia de satisfa√ß√£o por setor",
    "charts.avg_by_sector.infoTitle": "Como ler",
    "charts.avg_by_sector.infoCopy": "Cada barra representa a nota m√©dia 1‚Äì5 por setor. 1‚Äì2 = ruim; 3‚Äì4 = regular; 5 = excelente.",
    "charts.avg_by_sector.placeholder": "Colunas (placeholder)",
    "charts.distribution.title": "Distribui√ß√£o de notas",
    "charts.distribution.infoTitle": "Como ler",
    "charts.distribution.infoCopy": "Propor√ß√£o de boas/m√©dias/ruins por setor ap√≥s filtros aplicados.",
    "charts.distribution.placeholder": "Barras empilhadas (placeholder)",
    "charts.trend_sector.title": "Tend√™ncia mensal por setor",
    "charts.trend_sector.infoTitle": "Como ler",
    "charts.trend_sector.infoCopy": "Evolu√ß√£o das m√©dias mensais por setor considerando apenas pesquisas ativas.",
    "charts.trend_sector.placeholder": "Linhas (placeholder)",
    "charts.reviews_month.title": "Avalia√ß√µes por m√™s",
    "charts.reviews_month.infoTitle": "Como ler",
    "charts.reviews_month.infoCopy": "Volume de respostas coletadas por m√™s ap√≥s filtros (setor/g√™nero/faixa et√°ria/per√≠odo).",
    "charts.reviews_month.placeholder": "Colunas agrupadas (placeholder)",
    "charts.map_neighborhoods.title": "Mapa do munic√≠pio ‚Äî pontos por bairro",
    "charts.map_neighborhoods.infoTitle": "Como ler",
    "charts.map_neighborhoods.infoCopy": "Distribui√ß√£o espacial com base nas geohashes/bairros informados nas pesquisas.",
    "charts.map_neighborhoods.placeholder": "Mapa (placeholder)",
    "charts.share_sector.title": "Participa√ß√£o por setor",
    "charts.share_sector.infoTitle": "Como ler",
    "charts.share_sector.infoCopy": "Percentual de participa√ß√£o de cada setor dentro do conjunto de pesquisas ativas.",
    "charts.share_sector.placeholder": "Pizza (placeholder)",
    "info.hint": "Toque no √≠cone novamente para fechar.",
    "info.summary": "Informa√ß√µes",
    "persona.title": "Perfil da amostra",
    "persona.gender": "Distribui√ß√£o por g√™nero",
    "persona.age": "Distribui√ß√£o por faixa et√°ria",
    "persona.neighborhood": "Bairros mais presentes",
    "persona.hintFilters": "Ap√≥s filtros",
    "persona.hintDominant": "Faixas dominantes",
    "persona.hintTop3": "Top 3",
    "kpi.labels.avg": "M√©dia",
    "kpi.labels.delta": "Varia√ß√£o",
    "kpi.labels.topMetrics": "Top m√©tricas",
    "kpi.moreInfo": "Mais informa√ß√µes",
    "sync.title": "M√∫ltiplos dispositivos",
    "sync.lead": "Ative a sincroniza√ß√£o via Google Drive para que suas pesquisas e prefer√™ncias fiquem dispon√≠veis em todos os seus dispositivos. Voc√™ ver√° um pedido de permiss√£o do Google.",
    "sync.ctaTitle": "Sincronizar com Google Drive",
    "sync.ctaHint": "Armazena configura√ß√µes e cat√°logos de pesquisas no seu Drive, com consentimento.",
    "sync.enable": "Permitir e ativar",
    "sync.disable": "Desativar",
    "sync.openTab": "Abrir em nova aba",
    "sync.tip.ok": "Sincroniza√ß√£o ok",
    "sync.tip.error": "Problema de sincroniza√ß√£o",
    "sync.state.on": "Sincroniza√ß√£o ativada",
    "sync.state.off": "Sincroniza√ß√£o desativada",
    "sync.state.pending": "Aguardando autoriza√ß√£o‚Ä¶"
  }
  </script>
  <script src="https://unpkg.com/i18next@23.10.1/dist/umd/i18next.min.js"></script>
  <script src="./js/i18n.js"></script>

  <script>
  window.__INDEXED_LIB_CANDIDATES__ = [
    'modules/indexed/indexed.min.js','modules/indexed/indexed.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.min.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.min.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.js'
  ];
  window.__RELATORIO_LIB_CANDIDATES__ = [
    'miniapp-base/relatorio_utils.js','/miniapp-base/relatorio_utils.js','modules/relatorio_utils.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/relatorio_utils.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/miniapp-base/relatorio_utils.js'
  ];

  function $t(key, options){
    if(window.I18nManager && typeof window.I18nManager.t === 'function'){
      return window.I18nManager.t(key, options);
    }
    if(window.i18next && typeof window.i18next.t === 'function'){
      var out = window.i18next.t(key, options);
      if(typeof out === 'string' && out !== key) return out;
    }
    return (options && options.defaultValue) || key;
  }

  (function loadScripts(){
    function loadOne(list, cb){
      if(!list || !list.length) return cb && cb();
      var src = list.shift();
      var s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = function(){ cb && cb(true, src); };
      s.onerror = function(){ loadOne(list, cb); };
      document.head.appendChild(s);
    }
    loadOne(window.__INDEXED_LIB_CANDIDATES__.slice(), function(){
      loadOne(window.__RELATORIO_LIB_CANDIDATES__.slice(), function(){
        initPanel();
      });
    });
  })();

  function report(kind, state, text){
    try{ (window.relatorio||window.Relatorio)?.status?.(kind, state, text); }catch(_){ }
  }

  function renderToolbar(){
    var el = document.getElementById('toolbar-split');
    if(!el) return;
    var items = [
      { href:'#filters', icon:'filter_list', key:'toolbar.filters' },
      { href:'#manage-studies', icon:'inventory_2', key:'toolbar.studies' },
      { href:'#theme', icon:'light_mode', key:'toolbar.theme' },
      { href:'#language', icon:'translate', key:'toolbar.language' },
      { href:'#sync', icon:'devices', key:'toolbar.multidevice', id:'toolbar-sync', extra:'<span id="toolbar-sync-dot" class="status-dot" aria-hidden="true"></span>' }
    ];
    el.innerHTML = items.map(function(item){
      var idAttr = item.id ? ' id="'+item.id+'"' : '';
      var title = $t(item.key);
      var extra = item.extra || '';
      return '<a class="btn" href="'+item.href+'"'+idAttr+' data-i18n-attr="title:'+item.key+'" title="'+title+'">'
        + '<span class="material-symbols-rounded" aria-hidden="true">'+item.icon+'</span>'
        + '<span data-i18n="'+item.key+'">'+title+'</span>'
        + extra
        + '</a>';
    }).join('');
  }

  function renderPersona(){
    var wrap = document.getElementById('persona-bar');
    if(!wrap) return;
    var cards = [
      { id:'p-genero', icon:'diversity_3', titleKey:'persona.gender', value:'‚ôÄ 54% ¬∑ ‚ôÇ 44% ¬∑ ‚ÅÑ 2%', hintKey:'persona.hintFilters' },
      { id:'p-idade', icon:'cake', titleKey:'persona.age', value:'25‚Äì34 (31%) ¬∑ 35‚Äì44 (27%)', hintKey:'persona.hintDominant' },
      { id:'p-bairro', icon:'location_city', titleKey:'persona.neighborhood', value:'Boqueir√£o, CIC, Bairro Novo', hintKey:'persona.hintTop3' }
    ];
    wrap.innerHTML = cards.map(function(card){
      var title = $t(card.titleKey);
      var hint = card.hintKey ? $t(card.hintKey) : '';
      var hintAttr = card.hintKey ? ' data-i18n="'+card.hintKey+'"' : '';
      return '<div class="kpi" role="group" aria-label="'+title+'">'
        + '<div class="label"><span class="material-symbols-rounded">'+card.icon+'</span><span data-i18n="'+card.titleKey+'">'+title+'</span></div>'
        + '<div class="value" style="font-size:18px">'+card.value+'</div>'
        + '<div class="delta neutral" style="opacity:.8"'+hintAttr+'>'+hint+'</div>'
        + '</div>';
    }).join('');
  }

  function renderKPIs(){
    var wrap = document.getElementById('kpi-bar');
    if(!wrap) return;
    var list = [
      { id:'saude', icon:'vaccines', labelKey:'sector.saude', value:'4,2', deltaKey:'delta.change', deltaValue:'+0,3', cls:'positive' },
      { id:'educacao', icon:'school', labelKey:'sector.educacao', value:'3,8', deltaKey:'delta.stable', cls:'neutral' },
      { id:'transporte', icon:'directions_bus', labelKey:'sector.transporte', value:'3,2', deltaKey:'delta.change', deltaValue:'-0,2', cls:'negative' },
      { id:'seguranca', icon:'shield_person', labelKey:'sector.seguranca', value:'4,0', deltaKey:'delta.stable', cls:'neutral' },
      { id:'meioambiente', icon:'eco', labelKey:'sector.meioambiente', value:'4,4', deltaKey:'delta.change', deltaValue:'+0,1', cls:'positive' }
    ];
    var summaryLabel = $t('kpi.moreInfo');
    wrap.innerHTML = list.map(function(item){
      var label = $t(item.labelKey);
      var delta = item.deltaKey ? $t(item.deltaKey, { value:item.deltaValue }) : (item.delta || '');
      return '<div class="kpi" role="group" aria-label="'+label+'">'
        + '<a class="kinfo" style="position:absolute;top:8px;right:8px;display:grid;place-items:center;width:28px;height:28px;border:none;background:transparent" href="#kpi-'+item.id+'" data-i18n-attr="aria-label:kpi.moreInfo" aria-label="'+summaryLabel+'"><span class="material-symbols-rounded">info</span></a>'
        + '<div class="label"><span class="material-symbols-rounded">'+item.icon+'</span><span data-i18n="'+item.labelKey+'">'+label+'</span></div>'
        + '<div class="value">'+item.value+'</div>'
        + '<div class="delta '+item.cls+'"><span class="material-symbols-rounded" aria-hidden="true" style="font-size:16px">'+(item.cls==='positive'?'trending_up':item.cls==='negative'?'trending_down':'trending_flat')+'</span>'+delta+'</div>'
        + '</div>';
    }).join('');
  }

  function renderIndicators(){
    var grid = document.getElementById('cards');
    if(!grid) return;
    var cards = [
      { id:'sector-avg', icon:'bar_chart_4_bars', titleKey:'charts.avg_by_sector.title', infoTitleKey:'charts.avg_by_sector.infoTitle', infoCopyKey:'charts.avg_by_sector.infoCopy', placeholderKey:'charts.avg_by_sector.placeholder' },
      { id:'distribution', icon:'stacked_bar_chart', titleKey:'charts.distribution.title', infoTitleKey:'charts.distribution.infoTitle', infoCopyKey:'charts.distribution.infoCopy', placeholderKey:'charts.distribution.placeholder' },
      { id:'trend-sector', icon:'show_chart', titleKey:'charts.trend_sector.title', infoTitleKey:'charts.trend_sector.infoTitle', infoCopyKey:'charts.trend_sector.infoCopy', placeholderKey:'charts.trend_sector.placeholder' },
      { id:'reviews-month', icon:'insert_chart', titleKey:'charts.reviews_month.title', infoTitleKey:'charts.reviews_month.infoTitle', infoCopyKey:'charts.reviews_month.infoCopy', placeholderKey:'charts.reviews_month.placeholder' },
      { id:'map-bairros', icon:'map', titleKey:'charts.map_neighborhoods.title', infoTitleKey:'charts.map_neighborhoods.infoTitle', infoCopyKey:'charts.map_neighborhoods.infoCopy', placeholderKey:'charts.map_neighborhoods.placeholder' },
      { id:'share-sector', icon:'pie_chart', titleKey:'charts.share_sector.title', infoTitleKey:'charts.share_sector.infoTitle', infoCopyKey:'charts.share_sector.infoCopy', placeholderKey:'charts.share_sector.placeholder' }
    ];
    var summaryLabel = $t('info.summary');
    var hint = $t('info.hint');
    grid.innerHTML = cards.map(function(card){
      var title = $t(card.titleKey);
      var infoTitle = $t(card.infoTitleKey);
      var infoCopy = $t(card.infoCopyKey);
      var placeholder = $t(card.placeholderKey);
      return '<section class="card" aria-labelledby="t-'+card.id+'">'
        + '<h3 id="t-'+card.id+'"><span class="material-symbols-rounded" aria-hidden="true">'+card.icon+'</span><span data-i18n="'+card.titleKey+'">'+title+'</span></h3>'
        + '<details class="info"><summary data-i18n-attr="aria-label:info.summary" aria-label="'+summaryLabel+'"><span class="material-symbols-rounded" aria-hidden="true">info</span></summary>'
        + '<div class="panel" role="dialog" aria-labelledby="t-'+card.id+'"><h4 data-i18n="'+card.infoTitleKey+'">'+infoTitle+'</h4><p data-i18n="'+card.infoCopyKey+'">'+infoCopy+'</p><p class="hint" data-i18n="info.hint">'+hint+'</p></div></details>'
        + '<div class="ph" data-i18n="'+card.placeholderKey+'">'+placeholder+'</div>'
        + '</section>';
    }).join('');
  }

  async function initPanel(){
    if(window.I18nManager && typeof window.I18nManager.ready === 'function'){
      await window.I18nManager.ready();
      if(!window.I18nManager.__panelHooked){
        window.I18nManager.__panelHooked = true;
        window.I18nManager.onChange(function(){
          renderToolbar();
          renderPersona();
          renderKPIs();
          renderIndicators();
          window.I18nManager.apply();
          var syncBtn = document.getElementById('sync-toggle');
          var isOn = !!(syncBtn && syncBtn.getAttribute('aria-pressed') === 'true');
          updateSyncUI(isOn);
        });
      }
    }

    renderToolbar();
    renderPersona();
    renderKPIs();
    renderIndicators();
    window.I18nManager?.apply?.();

    if(window.indexed && window.indexed.open){
      await window.indexed.open('PainelPrefeitoDB', 1, function(db, stores){
        window.indexed.stores = stores || window.indexed.stores || {};
        if(!window.indexed.stores.config){
          window.indexed.defineStore('config', {keyPath:'key'});
        }
      });
    }
    try{
      const flag = await (window.indexed?.get?.(window.indexed.stores?.config, 'sync_enabled'));
      updateSyncUI(!!(flag && flag.value));
    }catch(_){
      updateSyncUI(false);
    }

    const btn = document.getElementById('sync-toggle');
    const openTab = document.getElementById('sync-open-tab');
    const ready = canRequestGIS();
    if(openTab){
      openTab.style.display = ready.code === 'sandboxed' ? 'inline-flex' : 'none';
      openTab.addEventListener('click', function(e){
        e.preventDefault();
        openStandalone('#sync-consent');
      });
    }
    if(btn){
      btn.addEventListener('click', async function(){
        const on = btn.getAttribute('aria-pressed') === 'true';
        if(on){
          await setSyncEnabled(false);
          report('drive','off','sync desativada');
          return;
        }
        const chk = canRequestGIS();
        if(!chk.ok){
          if(chk.code==='sandboxed'){
            openStandalone('#sync-consent');
            return;
          }
          showSyncTip(chk.msg, true);
          report('drive','warn',chk.code||'ambiente-invalido');
          return;
        }
        try{
          report('drive','info','solicitando consentimento');
          const token = await requestGoogleDriveToken();
          if(token){
            await setSyncEnabled(true);
            report('drive','ok','consentimento concedido');
          } else {
            showSyncTip('N√£o foi poss√≠vel obter o token do Google.', true);
            report('drive','warn','sem-token');
          }
        }catch(err){
          showSyncTip('Falha ao solicitar permiss√£o Google. Verifique se o popup n√£o foi bloqueado.', true);
          report('drive','warn','falha-consentimento');
        }
      });
    }

    document.addEventListener('click', function(e){
      document.querySelectorAll('details.info[open]').forEach(function(d){
        if(!d.contains(e.target)) d.removeAttribute('open');
      });
    });
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){
        document.querySelectorAll('details.info[open]').forEach(function(d){
          d.removeAttribute('open');
        });
      }
    });
  }

  function showSyncTip(message, warn){
    var el = document.getElementById('sync-tip');
    if(!el) return;
    var text = message || '';
    el.textContent = text;
    el.style.display = text ? 'inline-flex' : 'none';
    el.classList.remove('ok','warn','info');
    el.classList.add(warn ? 'warn' : 'ok');
    if(!text){
      el.removeAttribute('data-i18n');
    }
    var dot = document.getElementById('toolbar-sync-dot');
    if(dot){
      var fallbackTitle = warn ? $t('sync.tip.error') : $t('sync.tip.ok');
      dot.className = 'status-dot ' + (warn ? 'err' : 'ok');
      dot.title = text || fallbackTitle;
    }
  }

  function updateSyncUI(enabled){
    var tbtn = document.getElementById('toolbar-sync');
    if(tbtn){
      tbtn.dataset.active = enabled ? 'true' : 'false';
      tbtn.setAttribute('title', $t('toolbar.multidevice'));
      tbtn.setAttribute('data-i18n-attr', 'title:toolbar.multidevice');
    }
    var dot = document.getElementById('toolbar-sync-dot');
    if(dot){
      dot.className = 'status-dot ' + (enabled ? 'ok' : 'warn');
      dot.title = $t(enabled ? 'sync.state.on' : 'sync.state.off');
    }
    var sbtn = document.getElementById('sync-toggle');
    var lab = sbtn ? sbtn.querySelector('.sync-label') : null;
    var labelKey = enabled ? 'sync.disable' : 'sync.enable';
    if(sbtn){
      sbtn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
      sbtn.setAttribute('title', $t(labelKey));
      sbtn.setAttribute('data-i18n-attr', 'title:'+labelKey);
    }
    if(lab){
      lab.textContent = $t(labelKey);
      lab.setAttribute('data-i18n', labelKey);
    }
    var st = document.getElementById('sync-state');
    if(st){
      var stateKey = enabled ? 'sync.state.on' : 'sync.state.off';
      st.textContent = $t(stateKey);
      st.setAttribute('data-i18n', stateKey);
    }
    window.I18nManager?.apply?.();
  }

  async function setSyncEnabled(enabled){
    if(!(window.indexed && window.indexed.put && window.indexed.stores && window.indexed.stores.config)){
      updateSyncUI(enabled);
      return;
    }
    await window.indexed.put(window.indexed.stores.config, {key:'sync_enabled', value:!!enabled, ts:Date.now()});
    updateSyncUI(enabled);
  }

  function getClientId(){
    var m = document.querySelector('meta[name="google-oauth-client-id"]');
    if(m && m.content) return m.content.trim();
    if(window.GOOGLE_CLIENT_ID) return window.GOOGLE_CLIENT_ID;
    return 'YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com';
  }

  function canRequestGIS(){
    if(self !== top){
      return {ok:false, code:'sandboxed', msg:'Abra em aba pr√≥pria (fora de iframe) para autorizar o Google.'};
    }
    var cid = getClientId();
    if(!cid || /^YOUR_/.test(cid)){
      return {ok:false, code:'clientid-missing', msg:'Client ID do Google n√£o configurado. Adicione a meta tag google-oauth-client-id.'};
    }
    if(!(window.google && google.accounts && google.accounts.oauth2)){
      return {ok:false, code:'gis-missing', msg:'Biblioteca de identidade Google n√£o carregou ainda. Tente novamente.'};
    }
    return {ok:true};
  }

  function openStandalone(hash){
    try{
      var url = new URL(window.location.href);
      url.hash = hash || '';
      window.open(url.toString(), '_blank', 'noopener,noreferrer');
    }catch(e){}
  }

  function requestGoogleDriveToken(){
    return new Promise(function(resolve, reject){
      try{
        var client = google.accounts.oauth2.initTokenClient({
          client_id: getClientId(),
          scope: 'https://www.googleapis.com/auth/drive.file',
          prompt: 'consent',
          callback: function(resp){
            if(resp && resp.access_token) return resolve(resp.access_token);
            reject(new Error('Sem token'));
          }
        });
        client.requestAccessToken();
      }catch(e){
        reject(e);
      }
    });
  }

  if(document.readyState!=='loading') initPanel(); else document.addEventListener('DOMContentLoaded', initPanel);
  </script>

</body>
</html>
