<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel de Indicadores ‚Äî Vers√£o Est√°tica (6 indicadores)</title>
  <link rel="stylesheet" href="../miniapp-base/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/styles.css" media="print" onload="this.media='all'">
  <style>
    header{margin:0 auto clamp(28px,6vw,48px);}
    .grid{display:flex;flex-direction:column;gap:clamp(18px,4vw,26px);}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <span class="app-icon" aria-hidden="true">üìä</span>
      <div>
        <h1 data-i18n="app.title">Munic√≠pio de Curitiba ‚Äî Painel de Indicadores</h1>
        <p class="subtitle" data-i18n="app.subtitle">Vers√£o est√°tica com bot√£o de permiss√£o para Google Drive</p>
      </div>
      <span class="version" aria-label="vers√£o do arquivo">v0.9.5</span>
    </div>
    <div class="toolbar" role="group" aria-label="Controles de exibi√ß√£o">
      <div class="split" id="toolbar-split"></div>
    </div>
  </header>

  <section id="persona-bar" class="kpi-bar" aria-label="Resumo de perfil da amostra"></section>
  <section id="kpi-bar" class="kpi-bar" aria-label="Indicadores-chave por setor"></section>

  <main id="cards" class="grid" aria-live="polite"></main>

  <section id="filters" class="modal" aria-labelledby="fl1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="fl1" data-i18n="filters.title">Filtros do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <form id="filters-form" class="modal-body-flow" aria-describedby="filters-hint">
          <p id="filters-hint" class="hint" data-i18n="filters.subtitle">Refine os resultados do painel para p√∫blicos e per√≠odos espec√≠ficos.</p>
          <div class="filters-grid">
            <div class="form-field">
              <label for="filter-gender" data-i18n="filters.gender.label">G√™nero</label>
              <select id="filter-gender" name="gender">
                <option value="all" data-i18n="filters.gender.all">Todos</option>
                <option value="female" data-i18n="filters.gender.female">Feminino</option>
                <option value="male" data-i18n="filters.gender.male">Masculino</option>
                <option value="nonbinary" data-i18n="filters.gender.nonbinary">N√£o bin√°rio</option>
                <option value="other" data-i18n="filters.gender.other">Outro</option>
              </select>
            </div>
            <div class="form-field">
              <label for="filter-age" data-i18n="filters.age.label">Faixa et√°ria</label>
              <select id="filter-age" name="age">
                <option value="all" data-i18n="filters.age.all">Todas as faixas</option>
                <option value="16_24" data-i18n="filters.age.16_24">16‚Äì24 anos</option>
                <option value="25_34" data-i18n="filters.age.25_34">25‚Äì34 anos</option>
                <option value="35_44" data-i18n="filters.age.35_44">35‚Äì44 anos</option>
                <option value="45_59" data-i18n="filters.age.45_59">45‚Äì59 anos</option>
                <option value="60_plus" data-i18n="filters.age.60_plus">60+ anos</option>
              </select>
            </div>
            <div class="form-field">
              <label for="filter-period" data-i18n="filters.period.label">Per√≠odo</label>
              <select id="filter-period" name="period">
                <option value="last30" data-i18n="filters.period.last30">√öltimos 30 dias</option>
                <option value="last90" data-i18n="filters.period.last90">√öltimos 90 dias</option>
                <option value="q1" data-i18n="filters.period.q1">1¬∫ trimestre</option>
                <option value="q2" data-i18n="filters.period.q2">2¬∫ trimestre</option>
                <option value="semester" data-i18n="filters.period.semester">√öltimo semestre</option>
              </select>
            </div>
            <div class="form-field">
              <label for="filter-sector" data-i18n="filters.sector.label">Setor</label>
              <select id="filter-sector" name="sector">
                <option value="all" data-i18n="filters.sector.all">Todos os setores</option>
                <option value="saude" data-i18n="sector.saude">Sa√∫de</option>
                <option value="educacao" data-i18n="sector.educacao">Educa√ß√£o</option>
                <option value="transporte" data-i18n="sector.transporte">Transporte</option>
                <option value="seguranca" data-i18n="sector.seguranca">Seguran√ßa</option>
                <option value="meioambiente" data-i18n="sector.meioambiente">Meio ambiente</option>
              </select>
            </div>
            <div class="form-field">
              <label for="filter-channel" data-i18n="filters.channel.label">Canal de coleta</label>
              <select id="filter-channel" name="channel">
                <option value="all" data-i18n="filters.channel.all">Todos os canais</option>
                <option value="online" data-i18n="filters.channel.online">Online</option>
                <option value="field" data-i18n="filters.channel.field">Em campo</option>
                <option value="phone" data-i18n="filters.channel.phone">Telefone</option>
              </select>
            </div>
          </div>
          <div class="togglebar" role="group" aria-label="Atalhos de filtros" data-i18n-attr="aria-label:filters.toggleGroup">
            <button type="button" class="chipbtn toggle" data-field="includeInactive" aria-pressed="false" data-i18n="filters.toggle.inactive">Incluir pesquisas inativas</button>
            <button type="button" class="chipbtn toggle" data-field="favoritesOnly" aria-pressed="false" data-i18n="filters.toggle.favorites">Somente favoritas</button>
            <button type="button" class="chipbtn toggle" data-field="comparePrevious" aria-pressed="false" data-i18n="filters.toggle.compare">Comparar per√≠odo anterior</button>
          </div>
          <div class="form-actions">
            <button type="button" class="btn ghost" id="filters-reset" data-i18n="filters.reset">Limpar filtros</button>
            <button type="submit" class="btn primary" data-i18n="filters.apply">Aplicar filtros</button>
          </div>
          <p class="meta" data-i18n="filters.hint">As prefer√™ncias ficam salvas localmente para acelerar an√°lises futuras.</p>
        </form>
      </div>
    </div>
  </section>

  <section id="manage-studies" class="modal" aria-labelledby="st1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="st1" data-i18n="studies.title">Gerenciar pesquisas</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="modal-body-flow">
          <p class="hint" data-i18n="studies.subtitle">Ative ou pause as pesquisas dispon√≠veis. Os indicadores respeitam apenas as pesquisas ativas.</p>
          <p class="meta" id="studies-summary" data-i18n="studies.loading">Carregando cat√°logos‚Ä¶</p>
          <p class="pill warn" id="studies-offline-hint" style="display:none" data-i18n="studies.offlineHint">Altera√ß√µes vis√≠veis apenas nesta sess√£o. Sincronize para persistir.</p>
          <ul id="studies-list" class="studies-list" role="list"></ul>
        </div>
      </div>
    </div>
  </section>

  <section id="theme" class="modal" aria-labelledby="th1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="th1" data-i18n="theme.title">Tema do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" href="#" data-theme="light"><span class="app-icon" aria-hidden="true">üåû</span><span data-i18n="theme.light">Claro</span></a>
          <a class="chipbtn" href="#" data-theme="dark"><span class="app-icon" aria-hidden="true">üåô</span><span data-i18n="theme.dark">Escuro</span></a>
          <a class="chipbtn" href="#" data-theme="auto"><span class="app-icon" aria-hidden="true">üåì</span><span data-i18n="theme.auto">Autom√°tico</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="language" class="modal" aria-labelledby="lg1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="lg1" data-i18n="lang.title">Idioma do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" href="#" data-lang="pt-BR"><span class="flag">üáßüá∑</span><span data-i18n="lang.pt">Portugu√™s</span></a>
          <a class="chipbtn" href="#" data-lang="es-ES"><span class="flag">üá™üá∏</span><span data-i18n="lang.es">Espa√±ol</span></a>
          <a class="chipbtn" href="#" data-lang="en-US"><span class="flag">üá∫üá∏</span><span data-i18n="lang.en">English</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="sync" class="modal" aria-labelledby="gd1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="gd1" data-i18n="sync.title">M√∫ltiplos dispositivos</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <p style="margin-top:0;color:var(--muted)" data-i18n="sync.lead">Ative a sincroniza√ß√£o via Google Drive para que suas pesquisas e prefer√™ncias fiquem dispon√≠veis em todos os seus dispositivos. Voc√™ ver√° um pedido de permiss√£o do Google.</p>
        <div class="subcard" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div style="display:flex;flex-direction:column;gap:4px">
            <strong data-i18n="sync.ctaTitle">Sincronizar com Google Drive</strong>
            <span style="font-size:12px;color:var(--muted)" data-i18n="sync.ctaHint">Armazena configura√ß√µes e cat√°logos de pesquisas no seu Drive, com consentimento.</span>
          </div>
          <button id="sync-toggle" class="btn" aria-pressed="false" title="Permitir e ativar" data-i18n-attr="title:sync.enable"><span class="app-icon" aria-hidden="true">‚òÅÔ∏è</span><span class="sync-label" data-i18n="sync.enable">Permitir e ativar</span></button>
        </div>
        <p id="sync-state" style="margin:10px 0 0;color:var(--muted)" data-i18n="sync.state.off">Sincroniza√ß√£o desativada</p>
        <div id="sync-tip" class="pill info" style="margin-top:10px;display:none"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:10px">
          <a id="sync-open-tab" class="btn" href="#" style="display:none" title="Abrir em nova aba" data-i18n-attr="title:sync.openTab"><span class="app-icon" aria-hidden="true">üîó</span><span data-i18n="sync.openTab">Abrir em nova aba</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="kpi-saude" class="modal" aria-labelledby="k1"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k1">Sa√∫de ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o. Este painel replica o layout dos detalhes dos gr√°ficos, com foco no setor.</p></div></div></section>
  <section id="kpi-educacao" class="modal" aria-labelledby="k2"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k2">Educa√ß√£o ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-transporte" class="modal" aria-labelledby="k3"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k3">Transporte ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-seguranca" class="modal" aria-labelledby="k4"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k4">Seguran√ßa ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-meioambiente" class="modal" aria-labelledby="k5"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k5">Meio ambiente ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>

  <footer data-i18n="app.footer">Base preparada para pedir consentimento do Google e registrar no armazenamento local via IndexedDB. Nenhum gr√°fico ativo nesta vers√£o.</footer>

  <script id="i18n-pt-BR" type="application/json">
  {
    "app.title": "Munic√≠pio de Curitiba ‚Äî Painel de Indicadores",
    "app.subtitle": "Vers√£o com i18n (i18next) e templates remotos",
    "app.footer": "Base preparada para i18n (i18next) e templates externos versionados.",
    "toolbar.filters": "Filtros",
    "toolbar.studies": "Pesquisas",
    "toolbar.theme": "Tema",
    "toolbar.language": "Idioma",
    "toolbar.multidevice": "Multi-dispositivo",
    "filters.title": "Filtros do painel",
    "filters.subtitle": "Refine os resultados do painel para p√∫blicos e per√≠odos espec√≠ficos.",
    "filters.gender.label": "G√™nero",
    "filters.gender.all": "Todos",
    "filters.gender.female": "Feminino",
    "filters.gender.male": "Masculino",
    "filters.gender.nonbinary": "N√£o bin√°rio",
    "filters.gender.other": "Outro",
    "filters.age.label": "Faixa et√°ria",
    "filters.age.all": "Todas as faixas",
    "filters.age.16_24": "16‚Äì24 anos",
    "filters.age.25_34": "25‚Äì34 anos",
    "filters.age.35_44": "35‚Äì44 anos",
    "filters.age.45_59": "45‚Äì59 anos",
    "filters.age.60_plus": "60+ anos",
    "filters.period.label": "Per√≠odo",
    "filters.period.last30": "√öltimos 30 dias",
    "filters.period.last90": "√öltimos 90 dias",
    "filters.period.q1": "1¬∫ trimestre",
    "filters.period.q2": "2¬∫ trimestre",
    "filters.period.semester": "√öltimo semestre",
    "filters.sector.label": "Setor",
    "filters.sector.all": "Todos os setores",
    "filters.channel.label": "Canal de coleta",
    "filters.channel.all": "Todos os canais",
    "filters.channel.online": "Online",
    "filters.channel.field": "Em campo",
    "filters.channel.phone": "Telefone",
    "filters.toggle.inactive": "Incluir pesquisas inativas",
    "filters.toggle.favorites": "Somente favoritas",
    "filters.toggle.compare": "Comparar per√≠odo anterior",
    "filters.toggleGroup": "Atalhos de filtros",
    "filters.apply": "Aplicar filtros",
    "filters.reset": "Limpar filtros",
    "filters.hint": "As prefer√™ncias ficam salvas localmente para acelerar an√°lises futuras.",
    "studies.title": "Gerenciar pesquisas",
    "studies.subtitle": "Ative ou pause as pesquisas dispon√≠veis. Os indicadores respeitam apenas as pesquisas ativas.",
    "studies.loading": "Carregando cat√°logos‚Ä¶",
    "studies.empty": "Nenhuma pesquisa cadastrada.",
    "studies.emptyTooltip": "Cadastre ou sincronize pesquisas para habilitar este painel.",
    "studies.offlineHint": "Altera√ß√µes vis√≠veis apenas nesta sess√£o. Sincronize para persistir.",
    "studies.summary": "Pesquisas ativas: {{count}}",
    "studies.status.active": "Ativa",
    "studies.status.inactive": "Inativa",
    "studies.status.primary": "Principal",
    "studies.actions.activate": "Ativar",
    "studies.actions.deactivate": "Desativar",
    "studies.meta.sector": "Setor",
    "studies.meta.period": "Per√≠odo",
    "studies.meta.channel": "Canal",
    "studies.channel.online": "Online",
    "studies.channel.field": "Em campo",
    "studies.channel.phone": "Telefone",
    "theme.title": "Tema do painel",
    "theme.light": "Claro",
    "theme.dark": "Escuro",
    "theme.auto": "Autom√°tico",
    "lang.title": "Idioma do painel",
    "lang.pt": "Portugu√™s",
    "lang.es": "Espa√±ol",
    "lang.en": "English",
    "sector.saude": "Sa√∫de",
    "sector.educacao": "Educa√ß√£o",
    "sector.transporte": "Transporte",
    "sector.seguranca": "Seguran√ßa",
    "sector.meioambiente": "Meio ambiente",
    "delta.stable": "est√°vel",
    "delta.change": "{{value}} vs. m√™s anterior",
    "charts.avg_by_sector.title": "M√©dia de satisfa√ß√£o por setor",
    "charts.avg_by_sector.infoTitle": "Como ler",
    "charts.avg_by_sector.infoCopy": "Cada barra representa a nota m√©dia 1‚Äì5 por setor. 1‚Äì2 = ruim; 3‚Äì4 = regular; 5 = excelente.",
    "charts.avg_by_sector.placeholder": "Colunas (placeholder)",
    "charts.distribution.title": "Distribui√ß√£o de notas",
    "charts.distribution.infoTitle": "Como ler",
    "charts.distribution.infoCopy": "Propor√ß√£o de boas/m√©dias/ruins por setor ap√≥s filtros aplicados.",
    "charts.distribution.placeholder": "Barras empilhadas (placeholder)",
    "charts.trend_sector.title": "Tend√™ncia mensal por setor",
    "charts.trend_sector.infoTitle": "Como ler",
    "charts.trend_sector.infoCopy": "Evolu√ß√£o das m√©dias mensais por setor considerando apenas pesquisas ativas.",
    "charts.trend_sector.placeholder": "Linhas (placeholder)",
    "charts.reviews_month.title": "Avalia√ß√µes por m√™s",
    "charts.reviews_month.infoTitle": "Como ler",
    "charts.reviews_month.infoCopy": "Volume de respostas coletadas por m√™s ap√≥s filtros (setor/g√™nero/faixa et√°ria/per√≠odo).",
    "charts.reviews_month.placeholder": "Colunas agrupadas (placeholder)",
    "charts.map_neighborhoods.title": "Mapa do munic√≠pio ‚Äî pontos por bairro",
    "charts.map_neighborhoods.infoTitle": "Como ler",
    "charts.map_neighborhoods.infoCopy": "Distribui√ß√£o espacial com base nas geohashes/bairros informados nas pesquisas.",
    "charts.map_neighborhoods.placeholder": "Mapa (placeholder)",
    "charts.share_sector.title": "Participa√ß√£o por setor",
    "charts.share_sector.infoTitle": "Como ler",
    "charts.share_sector.infoCopy": "Percentual de participa√ß√£o de cada setor dentro do conjunto de pesquisas ativas.",
    "charts.share_sector.placeholder": "Pizza (placeholder)",
    "charts.labels.sector": "Setor",
    "charts.labels.current": "Atual",
    "charts.labels.previous": "Anterior",
    "charts.labels.rating": "Nota m√©dia (1‚Äì5)",
    "charts.labels.category": "Categoria",
    "charts.labels.responses": "Respostas",
    "charts.labels.positive": "Positivas",
    "charts.labels.neutral": "Neutras",
    "charts.labels.negative": "Negativas",
    "charts.labels.month": "M√™s",
    "charts.labels.neighborhood": "Bairro",
    "charts.labels.share": "Participa√ß√£o",
    "info.hint": "Toque no √≠cone novamente para fechar.",
    "info.summary": "Informa√ß√µes",
    "persona.title": "Perfil da amostra",
    "persona.gender": "Distribui√ß√£o por g√™nero",
    "persona.age": "Distribui√ß√£o por faixa et√°ria",
    "persona.neighborhood": "Bairros mais presentes",
    "persona.hintFilters": "Ap√≥s filtros",
    "persona.hintDominant": "Faixas dominantes",
    "persona.hintTop3": "Top 3",
    "kpi.labels.avg": "M√©dia",
    "kpi.labels.delta": "Varia√ß√£o",
    "kpi.labels.topMetrics": "Top m√©tricas",
    "kpi.moreInfo": "Mais informa√ß√µes",
    "sync.title": "M√∫ltiplos dispositivos",
    "sync.lead": "Ative a sincroniza√ß√£o via Google Drive para que suas pesquisas e prefer√™ncias fiquem dispon√≠veis em todos os seus dispositivos. Voc√™ ver√° um pedido de permiss√£o do Google.",
    "sync.ctaTitle": "Sincronizar com Google Drive",
    "sync.ctaHint": "Armazena configura√ß√µes e cat√°logos de pesquisas no seu Drive, com consentimento.",
    "sync.enable": "Permitir e ativar",
    "sync.disable": "Desativar",
    "sync.openTab": "Abrir em nova aba",
    "sync.tip.ok": "Sincroniza√ß√£o ok",
    "sync.tip.error": "Problema de sincroniza√ß√£o",
    "sync.state.on": "Sincroniza√ß√£o ativada",
    "sync.state.off": "Sincroniza√ß√£o desativada",
    "sync.state.pending": "Aguardando autoriza√ß√£o‚Ä¶",
    "reports.loading": "Carregando indicadores‚Ä¶",
    "reports.error": "N√£o foi poss√≠vel carregar os indicadores.",
    "reports.empty": "Sem dados sincronizados."
  }
  </script>
  <script src="https://unpkg.com/i18next@23.10.1/dist/umd/i18next.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="./js/i18n.js"></script>

  <script>
  window.__INDEXED_LIB_CANDIDATES__ = [
    'modules/indexed/indexed.min.js','modules/indexed/indexed.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.min.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.min.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.js'
  ];
  window.__RELATORIO_LIB_CANDIDATES__ = [
    'miniapp-base/relatorio_utils.js','/miniapp-base/relatorio_utils.js','modules/relatorio_utils.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/relatorio_utils.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/miniapp-base/relatorio_utils.js'
  ];

  function $t(key, options){
    if(window.I18nManager && typeof window.I18nManager.t === 'function'){
      return window.I18nManager.t(key, options);
    }
    if(window.i18next && typeof window.i18next.t === 'function'){
      var out = window.i18next.t(key, options);
      if(typeof out === 'string' && out !== key) return out;
    }
    return (options && options.defaultValue) || key;
  }

  (function loadScripts(){
    function loadOne(list, cb){
      if(!list || !list.length) return cb && cb();
      var src = list.shift();
      var s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = function(){ cb && cb(true, src); };
      s.onerror = function(){ loadOne(list, cb); };
      document.head.appendChild(s);
    }
    loadOne(window.__INDEXED_LIB_CANDIDATES__.slice(), function(){
      loadOne(window.__RELATORIO_LIB_CANDIDATES__.slice(), function(){
        initPanel();
      });
    });
  })();

  function report(kind, state, text){
    try{ (window.relatorio||window.Relatorio)?.status?.(kind, state, text); }catch(_){ }
  }

  var FILTER_DEFAULTS = {
    gender:'all',
    age:'all',
    period:'last90',
    sector:'all',
    channel:'all',
    includeInactive:false,
    favoritesOnly:false,
    comparePrevious:false
  };
  var filterState = Object.assign({}, FILTER_DEFAULTS);
  var filterDraft = Object.assign({}, FILTER_DEFAULTS);
  var filtersDirty = false;

  var PERSONA_CARD_META = [
    { id:'p-genero', icon:'diversity_3', titleKey:'persona.gender', hintKey:'persona.hintFilters' },
    { id:'p-idade', icon:'cake', titleKey:'persona.age', hintKey:'persona.hintDominant' },
    { id:'p-bairro', icon:'location_city', titleKey:'persona.neighborhood', hintKey:'persona.hintTop3' }
  ];
  var KPI_CARD_META = [
    { id:'saude', icon:'vaccines', labelKey:'sector.saude' },
    { id:'educacao', icon:'school', labelKey:'sector.educacao' },
    { id:'transporte', icon:'directions_bus', labelKey:'sector.transporte' },
    { id:'seguranca', icon:'shield_person', labelKey:'sector.seguranca' },
    { id:'meioambiente', icon:'eco', labelKey:'sector.meioambiente' }
  ];
  var INDICATOR_CARD_META = [
    { id:'sector-avg', icon:'bar_chart_4_bars', titleKey:'charts.avg_by_sector.title', infoTitleKey:'charts.avg_by_sector.infoTitle', infoCopyKey:'charts.avg_by_sector.infoCopy', placeholderKey:'charts.avg_by_sector.placeholder', chartType:'ColumnChart' },
    { id:'distribution', icon:'stacked_bar_chart', titleKey:'charts.distribution.title', infoTitleKey:'charts.distribution.infoTitle', infoCopyKey:'charts.distribution.infoCopy', placeholderKey:'charts.distribution.placeholder', chartType:'BarChart' },
    { id:'trend-sector', icon:'show_chart', titleKey:'charts.trend_sector.title', infoTitleKey:'charts.trend_sector.infoTitle', infoCopyKey:'charts.trend_sector.infoCopy', placeholderKey:'charts.trend_sector.placeholder', chartType:'LineChart' },
    { id:'reviews-month', icon:'insert_chart', titleKey:'charts.reviews_month.title', infoTitleKey:'charts.reviews_month.infoTitle', infoCopyKey:'charts.reviews_month.infoCopy', placeholderKey:'charts.reviews_month.placeholder', chartType:'ColumnChart' },
    { id:'map-bairros', icon:'map', titleKey:'charts.map_neighborhoods.title', infoTitleKey:'charts.map_neighborhoods.infoTitle', infoCopyKey:'charts.map_neighborhoods.infoCopy', placeholderKey:'charts.map_neighborhoods.placeholder', chartType:'GeoChart' },
    { id:'share-sector', icon:'pie_chart', titleKey:'charts.share_sector.title', infoTitleKey:'charts.share_sector.infoTitle', infoCopyKey:'charts.share_sector.infoCopy', placeholderKey:'charts.share_sector.placeholder', chartType:'PieChart' }
  ];

  var ICON_SYMBOLS = {
    insights:'üìä',
    filter_list:'üéõÔ∏è',
    inventory_2:'üóÇÔ∏è',
    light_mode:'üåû',
    dark_mode:'üåô',
    autorenew:'üîÑ',
    translate:'üåê',
    devices:'üíª',
    cloud_sync:'‚òÅÔ∏è',
    open_in_new:'üîó',
    toggle_on:'‚úÖ',
    toggle_off:'üö´',
    category:'üóÇÔ∏è',
    calendar_month:'üóìÔ∏è',
    hub:'üîå',
    pause_circle:'‚è∏Ô∏è',
    play_circle:'‚ñ∂Ô∏è',
    info:'‚ÑπÔ∏è',
    diversity_3:'üë•',
    cake:'üéÇ',
    location_city:'üìç',
    vaccines:'ü©∫',
    school:'üéì',
    directions_bus:'üöå',
    shield_person:'üõ°Ô∏è',
    eco:'üå±',
    bar_chart_4_bars:'üìä',
    stacked_bar_chart:'üì∂',
    show_chart:'üìà',
    insert_chart:'üìù',
    map:'üó∫Ô∏è',
    pie_chart:'ü•ß',
    hourglass_empty:'‚è≥',
    error:'‚ö†Ô∏è',
    database:'üóÑÔ∏è',
    save:'üíæ',
    trending_up:'üìà',
    trending_down:'üìâ',
    trending_flat:'‚û°Ô∏è'
  };

  var GOOGLE_CHART_PACKAGES = ['corechart','bar','geochart'];
  var googleChartsLocale = null;
  var googleChartsPromise = null;
  var indicatorCharts = Object.create(null);

  function iconToEmoji(name){
    if(!name) return '‚ùî';
    return ICON_SYMBOLS[name] || name;
  }

  function renderIcon(name, options){
    var symbol = iconToEmoji(name);
    var className = 'app-icon';
    if(options && options.className){
      className += ' ' + options.className;
    }
    var ariaAttr = (options && options.ariaHidden === false) ? '' : ' aria-hidden="true"';
    return '<span class="'+className+'"'+ariaAttr+'>'+escapeHtml(symbol)+'</span>';
  }

  function resolveCssColor(varName, fallback){
    try{
      var root = document.documentElement;
      if(!root) return fallback;
      var value = getComputedStyle(root).getPropertyValue(varName);
      return value ? value.trim() || fallback : fallback;
    }catch(_){
      return fallback;
    }
  }

  function getChartPalette(){
    return {
      primary: resolveCssColor('--brand-secondary', '#2563eb'),
      accent: resolveCssColor('--brand-accent', '#16a34a'),
      warn: resolveCssColor('--brand-warn', '#f59e0b'),
      danger: resolveCssColor('--brand-danger', '#dc2626'),
      info: resolveCssColor('--brand-info', '#0ea5e9'),
      surface: resolveCssColor('--surface', '#ffffff'),
      border: resolveCssColor('--border', '#e2e8f0'),
      muted: resolveCssColor('--muted', '#64748b'),
      text: resolveCssColor('--text', '#0f172a')
    };
  }

  function resetIndicatorCharts(){
    indicatorCharts = Object.create(null);
    if(scheduleIndicatorRedraw._raf){
      cancelAnimationFrame(scheduleIndicatorRedraw._raf);
      scheduleIndicatorRedraw._raf = null;
    }
  }

  function scheduleIndicatorRedraw(){
    if(!indicatorCharts || !Object.keys(indicatorCharts).length) return;
    if(scheduleIndicatorRedraw._raf){
      cancelAnimationFrame(scheduleIndicatorRedraw._raf);
    }
    scheduleIndicatorRedraw._raf = requestAnimationFrame(function(){
      scheduleIndicatorRedraw._raf = null;
      Object.keys(indicatorCharts).forEach(function(key){
        var entry = indicatorCharts[key];
        if(entry && typeof entry.draw === 'function'){
          try{
            entry.draw();
          }catch(err){
            console.warn('Falha ao redesenhar gr√°fico', err);
          }
        }
      });
    });
  }

  function ensureIndicatorResizeListener(){
    if(ensureIndicatorResizeListener._bound) return;
    ensureIndicatorResizeListener._bound = true;
    window.addEventListener('resize', scheduleIndicatorRedraw);
    if(typeof window.matchMedia === 'function'){
      try{
        var mq = window.matchMedia('(orientation: portrait)');
        var handler = function(){ scheduleIndicatorRedraw(); };
        if(mq && typeof mq.addEventListener === 'function'){
          mq.addEventListener('change', handler);
        } else if(mq && typeof mq.addListener === 'function'){
          mq.addListener(handler);
        }
        ensureIndicatorResizeListener._mq = { query: mq, handler: handler };
      }catch(_){ }
    }
  }

  function ensureGoogleCharts(locale){
    if(!(window.google && google.charts)) return Promise.resolve(false);
    var lang = (locale || getCurrentLocale() || 'pt-BR').split('-')[0];
    if(googleChartsPromise && googleChartsLocale === lang){
      return googleChartsPromise;
    }
    googleChartsLocale = lang;
    googleChartsPromise = new Promise(function(resolve){
      try{
        google.charts.load('current', { packages:GOOGLE_CHART_PACKAGES, language:lang });
        google.charts.setOnLoadCallback(function(){ resolve(true); });
      }catch(err){
        console.error('Falha ao carregar Google Charts', err);
        resolve(false);
      }
    });
    return googleChartsPromise;
  }

  function computeChartOptions(dataset, container){
    if(!dataset || !container) return {};
    if(typeof dataset.buildOptions === 'function'){
      return dataset.buildOptions(container);
    }
    var base = Object.assign({}, dataset.baseOptions || {});
    var bounds = container.getBoundingClientRect();
    var width = Math.max(Math.round(bounds.width || container.offsetWidth || 320), dataset.minWidth || 240);
    var ratio = dataset.ratio || 0.6;
    var minHeight = dataset.minHeight || 240;
    var maxHeight = typeof dataset.maxHeight === 'number' ? dataset.maxHeight : null;
    var height = Math.max(minHeight, Math.round(width * ratio));
    if(maxHeight){ height = Math.min(height, maxHeight); }
    base.height = height;
    base.width = width;
    if(dataset.chartAreaDefaults !== false){
      var defaultArea = {
        left: width < 420 ? '12%' : '8%',
        top: 56,
        width: '82%',
        height: Math.max(120, height - 96)
      };
      base.chartArea = Object.assign(defaultArea, base.chartArea || {});
    }
    return base;
  }

  function createGoogleChartInstance(type, container){
    if(!(window.google && google.visualization)) return null;
    try{
      switch(type){
        case 'ColumnChart': return new google.visualization.ColumnChart(container);
        case 'BarChart': return new google.visualization.BarChart(container);
        case 'LineChart': return new google.visualization.LineChart(container);
        case 'PieChart': return new google.visualization.PieChart(container);
        case 'GeoChart': return new google.visualization.GeoChart(container);
        default: return null;
      }
    }catch(err){
      console.error('Falha ao instanciar gr√°fico', type, err);
      return null;
    }
  }

  function createChartRecord(id, chart, dataTable, dataset, card, container){
    return {
      id:id,
      chart:chart,
      dataTable:dataTable,
      dataset:dataset,
      card:card,
      container:container,
      draw:function(){
        var options = computeChartOptions(dataset, container);
        chart.draw(dataTable, options);
      }
    };
  }

  var reportState = { ready:false, loading:false, data:null, unsubscribe:null };

  var GENDER_SYMBOLS = { female:'‚ôÄ', male:'‚ôÇ', nonbinary:'‚ÅÑ', other:'‚àó' };
  var AGE_LABEL_FALLBACK = { '16_24':'16‚Äì24', '25_34':'25‚Äì34', '35_44':'35‚Äì44', '45_59':'45‚Äì59', '60_plus':'60+' };
  var KPI_DELTA_THRESHOLD = 0.05;

  function escapeHtml(value){
    return String(value ?? '').replace(/[&<>"']/g, function(ch){
      switch(ch){
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  function getCurrentLocale(){
    return (window.i18next && window.i18next.language) || document.documentElement.lang || 'pt-BR';
  }

  function formatScore(value, locale){
    if(!Number.isFinite(value)) return '‚Äî';
    var formatter = new Intl.NumberFormat(locale || getCurrentLocale(), { minimumFractionDigits:1, maximumFractionDigits:1 });
    return formatter.format(value);
  }

  function formatPercent(value, locale, fractionDigits){
    if(!Number.isFinite(value)) return '‚Äî';
    var digits = (typeof fractionDigits === 'number') ? fractionDigits : 0;
    var formatter = new Intl.NumberFormat(locale || getCurrentLocale(), { style:'percent', minimumFractionDigits:digits, maximumFractionDigits:digits });
    return formatter.format(value);
  }

  function formatSignedDelta(value, locale){
    if(!Number.isFinite(value)) return null;
    var formatter = new Intl.NumberFormat(locale || getCurrentLocale(), { minimumFractionDigits:1, maximumFractionDigits:1 });
    var abs = formatter.format(Math.abs(value));
    if(value > 0) return '+'+abs;
    if(value < 0) return '‚àí'+abs;
    return '¬±'+abs;
  }

  function formatAgeLabel(key){
    return AGE_LABEL_FALLBACK[key] || key;
  }

  function formatSectorLabel(key){
    var labelKey = 'sector.'+key;
    var translated = $t(labelKey, { defaultValue:'' });
    if(translated && translated !== labelKey) return translated;
    return key.charAt(0).toUpperCase() + key.slice(1);
  }

  function formatPeriodLabel(period, locale){
    if(!period) return '‚Äî';
    var parts = String(period).split('-');
    if(parts.length === 2){
      var year = Number(parts[0]);
      var month = Number(parts[1]);
      if(Number.isFinite(year) && Number.isFinite(month)){
        var date = new Date(Date.UTC(year, month - 1, 1));
        try{
          return new Intl.DateTimeFormat(locale || getCurrentLocale(), { month:'short', year:'numeric' }).format(date);
        }catch(_){
          return date.toISOString().slice(0,7);
        }
      }
    }
    return String(period);
  }

  async function hydrateReportData(options){
    var relatorio = window.relatorioUtils;
    if(!relatorio || typeof relatorio.getReportAggregates !== 'function'){
      reportState.ready = false;
      reportState.data = null;
      return null;
    }
    reportState.loading = true;
    try{
      var result = await relatorio.getReportAggregates({ forceRefresh: !!(options && options.forceRefresh) });
      reportState.data = result;
      reportState.ready = true;
      return result;
    }catch(err){
      reportState.ready = false;
      reportState.data = null;
      throw err;
    }finally{
      reportState.loading = false;
    }
  }

  function ensureReportSubscription(){
    var relatorio = window.relatorioUtils;
    if(!relatorio || typeof relatorio.subscribeToReportAggregates !== 'function') return;
    if(typeof reportState.unsubscribe === 'function') return;
    reportState.unsubscribe = relatorio.subscribeToReportAggregates(function(payload){
      if(payload){
        reportState.data = payload;
        reportState.ready = true;
        renderPersona();
        renderKPIs();
        renderIndicators();
      }
    });
    if(typeof window !== 'undefined'){
      window.addEventListener('beforeunload', function(){
        try{ reportState.unsubscribe?.(); }catch(_){ }
      }, { once:true });
    }
  }

  var STUDY_SEED = [
    { id:'survey-saude-2024', name:'Pesquisa de Satisfa√ß√£o Sa√∫de 2024', segmentKey:'sector.saude', period:'Jan‚ÄìAbr 2024', channelKey:'studies.channel.online', active:true, primary:true },
    { id:'survey-mobilidade-2024', name:'Mobilidade Urbana 2024', segmentKey:'sector.transporte', period:'Mar‚ÄìJun 2024', channelKey:'studies.channel.field', active:true },
    { id:'survey-educacao-2023', name:'Rede Escolar 2023', segmentKey:'sector.educacao', period:'Set‚ÄìDez 2023', channelKey:'studies.channel.phone', active:false }
  ];
  var studiesState = { list:[], ready:false, persisted:false };

  function getConfigStore(){
    return window.indexed?.stores?.config || null;
  }

  function cloneFilters(obj){
    return Object.assign({}, obj);
  }

  function areFiltersEqual(a, b){
    if(!a || !b) return false;
    var keys = Object.keys(FILTER_DEFAULTS);
    for(var i=0;i<keys.length;i++){
      var k = keys[i];
      if((a[k]||false) !== (b[k]||false)) return false;
    }
    return true;
  }

  function isFiltersDefault(state){
    return areFiltersEqual(state, FILTER_DEFAULTS);
  }

  function applyFilterDraftToForm(){
    var form = document.getElementById('filters-form');
    if(!form) return;
    var controls = form.elements || [];
    for(var i=0;i<controls.length;i++){
      var ctrl = controls[i];
      if(!ctrl || !ctrl.name) continue;
      if(Object.prototype.hasOwnProperty.call(filterDraft, ctrl.name)){
        if(ctrl.tagName === 'SELECT'){
          ctrl.value = filterDraft[ctrl.name];
        }
      }
    }
    form.querySelectorAll('.toggle[data-field]').forEach(function(btn){
      var field = btn.getAttribute('data-field');
      if(!field) return;
      var val = !!filterDraft[field];
      btn.setAttribute('aria-pressed', val ? 'true' : 'false');
    });
  }

  function updateFiltersDirtyFlag(){
    var previous = filtersDirty;
    filtersDirty = !areFiltersEqual(filterState, filterDraft);
    var form = document.getElementById('filters-form');
    if(form){
      form.dataset.dirty = filtersDirty ? 'true' : 'false';
    }
    var applyBtn = form ? form.querySelector('button[type="submit"]') : null;
    if(applyBtn){
      applyBtn.disabled = !filtersDirty;
      applyBtn.classList.toggle('is-disabled', !filtersDirty);
      if(!filtersDirty){
        applyBtn.setAttribute('aria-disabled', 'true');
      } else {
        applyBtn.removeAttribute('aria-disabled');
      }
    }
    if(previous !== filtersDirty){
      renderToolbar();
    }
  }

  async function loadFilterPreferences(){
    var store = getConfigStore();
    if(!(store && window.indexed?.get)) return null;
    try{
      var rec = await window.indexed.get(store, 'filters_prefs');
      return rec && rec.value ? cloneFilters(rec.value) : null;
    }catch(_){
      return null;
    }
  }

  async function saveFilterPreferences(state){
    var store = getConfigStore();
    if(!(store && window.indexed?.put)) return;
    try{
      await window.indexed.put(store, {key:'filters_prefs', value:cloneFilters(state), ts:Date.now()});
    }catch(_){ }
  }

  function setFilterDraftFromState(){
    filterDraft = cloneFilters(filterState);
    applyFilterDraftToForm();
    updateFiltersDirtyFlag();
  }

  async function initFiltersUI(){
    var form = document.getElementById('filters-form');
    if(!form) return;
    var saved = await loadFilterPreferences();
    if(saved){
      filterState = Object.assign({}, FILTER_DEFAULTS, saved);
    } else {
      filterState = cloneFilters(FILTER_DEFAULTS);
    }
    setFilterDraftFromState();

    form.addEventListener('change', function(e){
      var target = e.target;
      if(!target || target.tagName !== 'SELECT') return;
      if(!Object.prototype.hasOwnProperty.call(filterDraft, target.name)) return;
      filterDraft[target.name] = target.value;
      updateFiltersDirtyFlag();
    });

    form.querySelectorAll('.toggle[data-field]').forEach(function(btn){
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        var field = btn.getAttribute('data-field');
        if(!field) return;
        var next = !filterDraft[field];
        filterDraft[field] = next;
        btn.setAttribute('aria-pressed', next ? 'true' : 'false');
        updateFiltersDirtyFlag();
      });
    });

    var resetBtn = document.getElementById('filters-reset');
    if(resetBtn){
      resetBtn.addEventListener('click', function(){
        filterDraft = cloneFilters(FILTER_DEFAULTS);
        applyFilterDraftToForm();
        updateFiltersDirtyFlag();
        report('filters', 'reset', 'reset-filtros');
      });
    }

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      if(!filtersDirty){
        closeActiveModal();
        return;
      }
      filterState = cloneFilters(filterDraft);
      await saveFilterPreferences(filterState);
      updateFiltersDirtyFlag();
      renderToolbar();
      report('filters', 'apply', JSON.stringify(filterState));
      closeActiveModal();
    });
  }

  function cloneStudies(list){
    return (list || []).map(function(item){
      return Object.assign({}, item);
    });
  }

  async function loadStudiesCatalog(){
    var defaults = { list: cloneStudies(STUDY_SEED), persisted:false };
    var store = getConfigStore();
    if(!(store && window.indexed?.get && window.indexed?.put)){
      return defaults;
    }
    try{
      var rec = await window.indexed.get(store, 'studies_catalog');
      if(rec && Array.isArray(rec.value) && rec.value.length){
        return { list: cloneStudies(rec.value), persisted:true };
      }
      await window.indexed.put(store, {key:'studies_catalog', value:cloneStudies(STUDY_SEED), ts:Date.now()});
      return { list: cloneStudies(STUDY_SEED), persisted:true };
    }catch(_){
      return defaults;
    }
  }

  async function saveStudiesCatalog(list){
    var store = getConfigStore();
    if(!(store && window.indexed?.put)){
      studiesState.persisted = false;
      return;
    }
    try{
      await window.indexed.put(store, {key:'studies_catalog', value:cloneStudies(list), ts:Date.now()});
      studiesState.persisted = true;
    }catch(_){
      studiesState.persisted = false;
    }
  }

  function updateStudiesSummary(){
    var summary = document.getElementById('studies-summary');
    if(!summary) return;
    if(!studiesState.ready){
      summary.textContent = $t('studies.loading');
      summary.setAttribute('data-i18n', 'studies.loading');
      return;
    }
    var activeCount = (studiesState.list || []).filter(function(item){ return !!item.active; }).length;
    summary.textContent = $t('studies.summary', { count: activeCount });
    summary.removeAttribute('data-i18n');
  }

  function updateStudiesHint(){
    var hint = document.getElementById('studies-offline-hint');
    if(!hint) return;
    var shouldShow = studiesState.ready && !studiesState.persisted;
    hint.style.display = shouldShow ? 'inline-flex' : 'none';
  }

  function renderStudiesList(){
    var list = document.getElementById('studies-list');
    if(!list) return;
    if(!studiesState.ready){
      list.innerHTML = '<li class="empty" data-i18n="studies.loading">'+$t('studies.loading')+'</li>';
      window.I18nManager?.apply?.();
      updateStudiesSummary();
      updateStudiesHint();
      return;
    }
    var studies = studiesState.list || [];
    if(!studies.length){
      list.innerHTML = '<li class="empty" data-i18n="studies.empty">'+$t('studies.empty')+'</li>';
      window.I18nManager?.apply?.();
      updateStudiesSummary();
      updateStudiesHint();
      return;
    }
    list.innerHTML = studies.map(function(study){
      var statusKey = study.active ? 'studies.status.active' : 'studies.status.inactive';
      var statusIcon = study.active ? 'toggle_on' : 'toggle_off';
      var actionKey = study.active ? 'studies.actions.deactivate' : 'studies.actions.activate';
      var segmentLabel = study.segmentKey ? $t(study.segmentKey) : (study.segment || '');
      var channelLabel = study.channelKey ? $t(study.channelKey) : (study.channel || '');
      var segmentAttr = study.segmentKey ? ' data-i18n="'+study.segmentKey+'"' : '';
      var channelAttr = study.channelKey ? ' data-i18n="'+study.channelKey+'"' : '';
      return '<li class="study-item" data-id="'+study.id+'">'
        + '<div class="study-header">'
        +   '<div class="study-title">'
        +     '<span>'+study.name+'</span>'
        +     (study.primary ? '<span class="tag primary" data-i18n="studies.status.primary">'+$t('studies.status.primary')+'</span>' : '')
        +   '</div>'
        +   '<span class="study-status '+(study.active ? 'active' : 'inactive')+'">'
        +     renderIcon(statusIcon)
        +     '<span data-i18n="'+statusKey+'">'+$t(statusKey)+'</span>'
        +   '</span>'
        + '</div>'
        + '<div class="study-meta">'
        +   '<span class="meta" aria-label="'+$t('studies.meta.sector')+'" data-i18n-attr="aria-label:studies.meta.sector">'+renderIcon('category')+'<span'+segmentAttr+'>'+segmentLabel+'</span></span>'
        +   '<span class="meta" aria-label="'+$t('studies.meta.period')+'" data-i18n-attr="aria-label:studies.meta.period">'+renderIcon('calendar_month')+'<span>'+study.period+'</span></span>'
        +   '<span class="meta" aria-label="'+$t('studies.meta.channel')+'" data-i18n-attr="aria-label:studies.meta.channel">'+renderIcon('hub')+'<span'+channelAttr+'>'+channelLabel+'</span></span>'
        + '</div>'
        + '<div class="study-actions">'
        +   '<button type="button" class="btn inline" data-action="toggle" data-id="'+study.id+'">'+renderIcon(study.active?'pause_circle':'play_circle')+'<span data-i18n="'+actionKey+'">'+$t(actionKey)+'</span></button>'
        + '</div>'
        + '</li>';
    }).join('');
    list.querySelectorAll('button[data-action="toggle"]').forEach(function(btn){
      btn.addEventListener('click', function(){
        var id = btn.getAttribute('data-id');
        if(id) toggleStudyActive(id);
      });
    });
    window.I18nManager?.apply?.();
    updateStudiesSummary();
    updateStudiesHint();
  }

  async function toggleStudyActive(id){
    var updated = (studiesState.list || []).map(function(item){
      if(item.id !== id) return Object.assign({}, item);
      var next = Object.assign({}, item, { active: !item.active });
      report('studies', next.active ? 'on' : 'off', id);
      return next;
    });
    studiesState.list = updated;
    await saveStudiesCatalog(updated);
    renderStudiesList();
    renderToolbar();
  }

  async function initStudiesManager(){
    var host = document.getElementById('studies-list');
    if(!host) return;
    studiesState.ready = false;
    renderStudiesList();
    var loaded = await loadStudiesCatalog();
    studiesState.list = loaded.list;
    studiesState.ready = true;
    studiesState.persisted = loaded.persisted;
    renderStudiesList();
    renderToolbar();
  }

  function clearModalHash(){
    try{
      if(window.history && typeof window.history.replaceState === 'function'){
        var base = window.location.pathname + window.location.search;
        window.history.replaceState(null, '', base);
      } else {
        window.location.hash = '';
      }
    }catch(_){ window.location.hash = ''; }
  }

  function handleModalHashChange(){
    var hash = window.location.hash;
    if(hash === '#'){
      clearModalHash();
      hash = '';
    }
    var modal = null;
    if(hash && hash.charAt(0) === '#'){
      modal = document.querySelector(hash);
      if(modal && !modal.classList.contains('modal')){
        modal = null;
      }
    }
    if(hash === '#filters' && document.getElementById('filters-form')){
      setFilterDraftFromState();
    }
    document.body.classList.toggle('modal-open', !!modal);
    if(hash && !modal){
      clearModalHash();
    }
  }

  function closeActiveModal(){
    clearModalHash();
    handleModalHashChange();
  }

  function renderToolbar(){
    var el = document.getElementById('toolbar-split');
    if(!el) return;
    var items = [];
    if(document.getElementById('filters')){
      items.push({
        href:'#filters',
        icon:'filter_list',
        key:'toolbar.filters',
        id:'toolbar-filters',
        className: isFiltersDefault(filterState) ? '' : 'active',
        extra: filtersDirty ? '<span class="status-dot warn" aria-hidden="true"></span>' : ''
      });
    }
    if(document.getElementById('manage-studies')){
      var studiesDisabled = !studiesState.ready || !(studiesState.list && studiesState.list.length);
      items.push({
        href:'#manage-studies',
        icon:'inventory_2',
        key:'toolbar.studies',
        id:'toolbar-studies',
        disabled: studiesDisabled,
        disabledTitle:'studies.emptyTooltip'
      });
    }
    items.push(
      { href:'#theme', icon:'light_mode', key:'toolbar.theme' },
      { href:'#language', icon:'translate', key:'toolbar.language' },
      { href:'#sync', icon:'devices', key:'toolbar.multidevice', id:'toolbar-sync', extra:'<span id="toolbar-sync-dot" class="status-dot" aria-hidden="true"></span>' }
    );
    el.innerHTML = items.map(function(item){
      var idAttr = item.id ? ' id="'+item.id+'"' : '';
      var isDisabled = !!item.disabled;
      var titleKey = isDisabled && item.disabledTitle ? item.disabledTitle : item.key;
      var title = $t(titleKey);
      var dataAttr = ' data-i18n-attr="title:'+titleKey+'"';
      var extra = item.extra || '';
      var cls = 'btn' + (item.className ? ' '+item.className : '') + (isDisabled ? ' is-disabled' : '');
      var href = isDisabled ? '#' : item.href;
      var disabledAttr = isDisabled ? ' aria-disabled="true"' : '';
      return '<a class="'+cls+'" href="'+href+'"'+idAttr+dataAttr+disabledAttr+' title="'+title+'">'
        + renderIcon(item.icon)
        + '<span data-i18n="'+item.key+'">'+title+'</span>'
        + extra
        + '</a>';
    }).join('');
  }

  function getReportLoadingMessage(){
    return $t('reports.loading', { defaultValue:'Carregando indicadores‚Ä¶' });
  }

  function getReportErrorMessage(){
    return $t('reports.error', { defaultValue:'N√£o foi poss√≠vel carregar os indicadores.' });
  }

  function getReportEmptyMessage(){
    return $t('reports.empty', { defaultValue:'Sem dados sincronizados.' });
  }

  function buildPersonaCard(meta, value, options){
    options = options || {};
    var iconName = options.icon || meta.icon;
    var title = $t(meta.titleKey);
    var hintText;
    var hintAttr = '';
    if(Object.prototype.hasOwnProperty.call(options, 'hintText')){
      hintText = options.hintText;
    } else if(meta.hintKey){
      hintText = $t(meta.hintKey);
      hintAttr = ' data-i18n="'+meta.hintKey+'"';
    } else {
      hintText = '';
    }
    var extraClass = options.extraClass ? ' '+options.extraClass : '';
    return '<div class="kpi'+extraClass+'" role="group" aria-label="'+escapeHtml(title)+'">'
      + '<div class="label">'+renderIcon(iconName)+'<span data-i18n="'+meta.titleKey+'">'+escapeHtml(title)+'</span></div>'
      + '<div class="value" style="font-size:18px">'+escapeHtml(value || '‚Äî')+'</div>'
      + '<div class="delta neutral"'+hintAttr+'>'+escapeHtml(hintText || '')+'</div>'
      + '</div>';
  }

  function buildKpiCard(meta, config){
    config = config || {};
    var iconName = config.icon || meta.icon;
    var label = $t(meta.labelKey);
    var summaryLabel = config.summaryLabel || $t('kpi.moreInfo');
    var value = config.value !== undefined ? config.value : '‚Äî';
    var deltaClass = config.cls || 'neutral';
    var deltaIcon = deltaClass === 'positive' ? 'trending_up' : (deltaClass === 'negative' ? 'trending_down' : 'trending_flat');
    var deltaText = '‚Äî';
    if(config.deltaKey){
      var options = config.deltaValue != null ? { value: config.deltaValue } : undefined;
      deltaText = $t(config.deltaKey, options);
    } else if(config.deltaText){
      deltaText = config.deltaText;
    }
    var extraClass = config.extraClass ? ' '+config.extraClass : '';
    return '<div class="kpi'+extraClass+'" role="group" aria-label="'+escapeHtml(label)+'">'
      + '<a class="kinfo" style="position:absolute;top:8px;right:8px;display:grid;place-items:center;width:30px;height:30px;border:none;background:transparent" href="#kpi-'+meta.id+'" data-i18n-attr="aria-label:kpi.moreInfo" aria-label="'+escapeHtml(summaryLabel)+'">'+renderIcon('info')+'</a>'
      + '<div class="label">'+renderIcon(iconName)+'<span data-i18n="'+meta.labelKey+'">'+escapeHtml(label)+'</span></div>'
      + '<div class="value">'+escapeHtml(value)+'</div>'
      + '<div class="delta '+deltaClass+'">'+renderIcon(deltaIcon,{className:'delta-icon'})+escapeHtml(deltaText || '')+'</div>'
      + '</div>';
  }

  function buildIndicatorCard(meta, summaryText, options){
    options = options || {};
    var title = $t(meta.titleKey);
    var infoTitle = $t(meta.infoTitleKey);
    var infoCopy = $t(meta.infoCopyKey);
    var placeholder = $t(meta.placeholderKey);
    var summaryLabel = $t('info.summary');
    var hint = $t('info.hint');
    var extraClass = options.extraClass ? ' '+options.extraClass : '';
    var summaryHtml = summaryText ? '<p class="meta indicator-summary">'+escapeHtml(summaryText)+'</p>' : '';
    var attrs = ' data-card-id="'+meta.id+'"';
    if(meta.chartType){
      attrs += ' data-chart-type="'+meta.chartType+'"';
    }
    var chartHtml = '<div class="chart-area" data-chart-id="'+meta.id+'" aria-hidden="true"><div class="chart-canvas" id="chart-'+meta.id+'"></div></div>';
    return '<section class="card'+extraClass+'"'+attrs+' aria-labelledby="t-'+meta.id+'">'
      + '<h3 id="t-'+meta.id+'">'+renderIcon(meta.icon)+'<span data-i18n="'+meta.titleKey+'">'+escapeHtml(title)+'</span></h3>'
      + '<details class="info"><summary data-i18n-attr="aria-label:info.summary" aria-label="'+escapeHtml(summaryLabel)+'">'+renderIcon('info',{className:'info-icon'})+'</summary>'
      + '<div class="panel" role="dialog" aria-labelledby="t-'+meta.id+'"><h4 data-i18n="'+meta.infoTitleKey+'">'+escapeHtml(infoTitle)+'</h4><p data-i18n="'+meta.infoCopyKey+'">'+escapeHtml(infoCopy)+'</p><p class="hint" data-i18n="info.hint">'+escapeHtml(hint)+'</p></div></details>'
      + chartHtml
      + '<div class="ph" data-i18n="'+meta.placeholderKey+'">'+escapeHtml(placeholder)+'</div>'
      + summaryHtml
      + '</section>';
  }

  function showCardPlaceholder(card, key){
    if(!card) return;
    card.classList.remove('has-chart');
    var placeholder = card.querySelector('.ph');
    if(placeholder){
      if(key){
        placeholder.setAttribute('data-i18n', key);
        placeholder.textContent = $t(key);
      }
      placeholder.style.display = 'grid';
    }
    var canvas = card.querySelector('.chart-canvas');
    if(canvas){
      canvas.innerHTML = '';
    }
  }

  function prepareIndicatorDataset(metaId, data, locale){
    data = data || {};
    var persona = data.persona || {};
    var kpis = Array.isArray(data.kpis) ? data.kpis : [];
    var indicators = data.indicators || {};
    var localeRef = locale || getCurrentLocale();
    var palette = getChartPalette();
    var numberFormatter = new Intl.NumberFormat(localeRef);

    if(metaId === 'sector-avg'){
      var sectorRows = kpis.map(function(item){
        if(!item) return null;
        var avg = Number.isFinite(item.average) ? Number(item.average) : null;
        var prev = Number.isFinite(item.previousAverage) ? Number(item.previousAverage) : null;
        if(!Number.isFinite(avg) && !Number.isFinite(prev)) return null;
        return [formatSectorLabel(item.key), avg, prev];
      }).filter(Boolean);
      if(!sectorRows.length) return null;
      return {
        columns:[
          { type:'string', label:$t('charts.labels.sector') },
          { type:'number', label:$t('charts.labels.current') },
          { type:'number', label:$t('charts.labels.previous') }
        ],
        rows: sectorRows,
        ratio:0.6,
        minHeight:260,
        maxHeight:420,
        baseOptions:{
          legend:{ position:'top', alignment:'center', textStyle:{ color: palette.muted } },
          vAxis:{
            minValue:0,
            maxValue:5,
            viewWindow:{ min:0, max:5 },
            title:$t('charts.labels.rating'),
            titleTextStyle:{ color: palette.muted },
            textStyle:{ color: palette.muted },
            gridlines:{ color: palette.border },
            baselineColor: palette.border,
            format:'0.0'
          },
          hAxis:{ textStyle:{ color: palette.muted } },
          colors:[palette.primary, palette.info],
          focusTarget:'category',
          backgroundColor:{ fill:'transparent' }
        }
      };
    }

    if(metaId === 'distribution'){
      var distribution = indicators.distribution || {};
      var positive = Number(distribution.positive) || 0;
      var neutral = Number(distribution.neutral) || 0;
      var negative = Number(distribution.negative) || 0;
      var distTotal = positive + neutral + negative;
      if(!(distTotal > 0)) return null;
      return {
        columns:[
          { type:'string', label:$t('charts.labels.category') },
          { type:'number', label:$t('charts.labels.positive') },
          { type:'number', label:$t('charts.labels.neutral') },
          { type:'number', label:$t('charts.labels.negative') }
        ],
        rows:[[ $t('charts.labels.responses'), positive, neutral, negative ]],
        ratio:0.36,
        minHeight:220,
        maxHeight:300,
        chartAreaDefaults:false,
        baseOptions:{
          legend:{ position:'top', alignment:'center', textStyle:{ color: palette.muted } },
          isStacked:true,
          backgroundColor:{ fill:'transparent' },
          hAxis:{
            minValue:0,
            textStyle:{ color: palette.muted },
            title:$t('charts.labels.responses'),
            titleTextStyle:{ color: palette.muted },
            gridlines:{ color: palette.border },
            baselineColor: palette.border
          },
          vAxis:{ textPosition:'none', baselineColor: palette.border },
          bar:{ groupWidth:'70%' },
          colors:[palette.accent, palette.info, palette.danger],
          chartArea:{ top:56, left:'12%', width:'70%', height:'55%' }
        }
      };
    }

    if(metaId === 'trend-sector'){
      var trendRows = kpis.map(function(item){
        if(!item) return null;
        var current = Number.isFinite(item.average) ? Number(item.average) : null;
        var previous = Number.isFinite(item.previousAverage) ? Number(item.previousAverage) : null;
        if(current === null && previous === null) return null;
        return [formatSectorLabel(item.key), previous, current];
      }).filter(Boolean);
      if(!trendRows.length) return null;
      return {
        columns:[
          { type:'string', label:$t('charts.labels.sector') },
          { type:'number', label:$t('charts.labels.previous') },
          { type:'number', label:$t('charts.labels.current') }
        ],
        rows: trendRows,
        ratio:0.55,
        minHeight:260,
        maxHeight:420,
        baseOptions:{
          legend:{ position:'top', alignment:'center', textStyle:{ color: palette.muted } },
          backgroundColor:{ fill:'transparent' },
          curveType:'function',
          lineWidth:3,
          pointsVisible:true,
          vAxis:{
            minValue:0,
            maxValue:5,
            viewWindow:{ min:0, max:5 },
            title:$t('charts.labels.rating'),
            titleTextStyle:{ color: palette.muted },
            textStyle:{ color: palette.muted },
            gridlines:{ color: palette.border },
            baselineColor: palette.border,
            format:'0.0'
          },
          hAxis:{ textStyle:{ color: palette.muted } },
          colors:[palette.primary, palette.accent],
          focusTarget:'category'
        }
      };
    }

    if(metaId === 'reviews-month'){
      var monthly = Array.isArray(indicators.monthly) ? indicators.monthly : [];
      var monthRows = monthly.map(function(item){
        if(!item) return null;
        var count = Number(item.count);
        if(!Number.isFinite(count)) return null;
        return [formatPeriodLabel(item.period, localeRef), count];
      }).filter(Boolean);
      if(!monthRows.length) return null;
      var slanted = monthRows.length > 4;
      return {
        columns:[
          { type:'string', label:$t('charts.labels.month') },
          { type:'number', label:$t('charts.labels.responses') }
        ],
        rows: monthRows,
        ratio:0.6,
        minHeight:260,
        maxHeight:420,
        baseOptions:{
          legend:'none',
          backgroundColor:{ fill:'transparent' },
          bar:{ groupWidth:'60%' },
          colors:[palette.primary],
          vAxis:{
            minValue:0,
            textStyle:{ color: palette.muted },
            title:$t('charts.labels.responses'),
            titleTextStyle:{ color: palette.muted },
            gridlines:{ color: palette.border },
            baselineColor: palette.border
          },
          hAxis:{
            textStyle:{ color: palette.muted },
            slantedText: slanted,
            slantedTextAngle: monthRows.length > 8 ? 75 : 45
          }
        }
      };
    }

    if(metaId === 'map-bairros'){
      var neighborhoods = Array.isArray(persona.neighborhoods) ? persona.neighborhoods.slice(0, 10) : [];
      var mapRows = neighborhoods.map(function(item){
        if(!item || !item.label) return null;
        var count = Number(item.count);
        var percentage = Number(item.percentage);
        var normalizedPercentage = Number.isFinite(percentage) ? Math.max(percentage, 0) : null;
        var value = Number.isFinite(count) && count > 0 ? count : (normalizedPercentage !== null ? normalizedPercentage * 100 : null);
        if(!(value > 0)) return null;
        var tooltipParts = [item.label];
        if(normalizedPercentage !== null){
          tooltipParts.push(formatPercent(normalizedPercentage, localeRef, 0));
        }
        if(Number.isFinite(count) && count > 0){
          tooltipParts.push(numberFormatter.format(count));
        }
        return [item.label, value, tooltipParts.join(' ¬∑ ')];
      }).filter(Boolean);
      if(!mapRows.length) return null;
      var geoBase = {
        region:'BR',
        displayMode:'markers',
        legend:'none',
        backgroundColor:{ fill:'transparent' },
        datalessRegionColor: resolveCssColor('--surface-alt', '#f1f5f9'),
        colorAxis:{ colors:[palette.primary, palette.accent] },
        tooltip:{ textStyle:{ color: palette.text } },
        sizeAxis:{ minValue:0 }
      };
      return {
        columns:[
          { type:'string', label:$t('charts.labels.neighborhood') },
          { type:'number', label:$t('charts.labels.responses') },
          { type:'string', role:'tooltip' }
        ],
        rows: mapRows,
        ratio:0.62,
        minHeight:260,
        maxHeight:420,
        chartAreaDefaults:false,
        baseOptions: geoBase,
        buildOptions:function(container){
          var bounds = container.getBoundingClientRect();
          var width = Math.max(Math.round(bounds.width || container.offsetWidth || 320), 240);
          var height = Math.max(260, Math.min(420, Math.round(width * 0.62)));
          var options = Object.assign({}, geoBase);
          options.width = width;
          options.height = height;
          return options;
        }
      };
    }

    if(metaId === 'share-sector'){
      var share = Array.isArray(indicators.sectorShare) ? indicators.sectorShare : [];
      var shareRows = share.map(function(item){
        if(!item) return null;
        var percentage = Number(item.percentage);
        if(!Number.isFinite(percentage) || percentage <= 0) return null;
        var label = formatSectorLabel(item.key);
        var tooltip = label + ' ¬∑ ' + formatPercent(percentage, localeRef, 0);
        return [label, percentage, tooltip];
      }).filter(Boolean);
      if(!shareRows.length) return null;
      var paletteOrder = [palette.primary, palette.accent, palette.warn, palette.info, palette.danger];
      var sliceColors = shareRows.map(function(_, index){ return paletteOrder[index % paletteOrder.length]; });
      return {
        columns:[
          { type:'string', label:$t('charts.labels.sector') },
          { type:'number', label:$t('charts.labels.share') },
          { type:'string', role:'tooltip' }
        ],
        rows: shareRows,
        ratio:0.6,
        minHeight:260,
        maxHeight:420,
        chartAreaDefaults:false,
        baseOptions:{
          legend:{ position:'right', alignment:'center', textStyle:{ color: palette.muted } },
          pieHole:0.35,
          pieSliceText:'percentage',
          tooltip:{ text:'percentage', textStyle:{ color: palette.text } },
          colors: sliceColors,
          chartArea:{ left:'4%', top:32, width:'84%', height:'80%' },
          backgroundColor:{ fill:'transparent' }
        }
      };
    }

    return null;
  }

  function renderIndicatorCharts(grid, data, locale){
    if(!grid || !data || !(window.google && google.visualization)) return;
    resetIndicatorCharts();
    var hasRendered = false;
    INDICATOR_CARD_META.forEach(function(meta){
      var card = grid.querySelector('[data-card-id="'+meta.id+'"]');
      if(!card) return;
      var canvas = card.querySelector('.chart-canvas');
      if(!canvas) return;
      var dataset = prepareIndicatorDataset(meta.id, data, locale);
      if(!dataset || !Array.isArray(dataset.rows) || !dataset.rows.length){
        showCardPlaceholder(card, 'reports.empty');
        delete indicatorCharts[meta.id];
        return;
      }
      card.classList.add('has-chart');
      canvas.innerHTML = '';
      var dataTable = new google.visualization.DataTable();
      (dataset.columns || []).forEach(function(column){
        dataTable.addColumn(column);
      });
      dataTable.addRows(dataset.rows);
      if(Array.isArray(dataset.formatters)){
        dataset.formatters.forEach(function(formatter){
          try{ formatter(dataTable); }
          catch(err){ console.warn('Formatter error', err); }
        });
      }
      var chart = createGoogleChartInstance(meta.chartType, canvas);
      if(!chart){
        showCardPlaceholder(card, 'reports.error');
        return;
      }
      var record = createChartRecord(meta.id, chart, dataTable, dataset, card, canvas);
      indicatorCharts[meta.id] = record;
      hasRendered = true;
      google.visualization.events.addListener(chart, 'error', function(){
        showCardPlaceholder(card, 'reports.error');
      });
      google.visualization.events.addListener(chart, 'ready', function(){
        scheduleIndicatorRedraw();
      });
      requestAnimationFrame(function(){
        try{
          record.draw();
        }catch(err){
          console.error('Falha ao desenhar gr√°fico', err);
          showCardPlaceholder(card, 'reports.error');
        }
      });
    });
    if(hasRendered){
      ensureIndicatorResizeListener();
      scheduleIndicatorRedraw();
    }
  }

  function renderPersonaLoading(wrap){
    var message = getReportLoadingMessage();
    wrap.innerHTML = PERSONA_CARD_META.map(function(meta){
      return buildPersonaCard(meta, message, { icon:'hourglass_empty', extraClass:'is-loading' });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderPersonaError(wrap){
    var message = getReportErrorMessage();
    wrap.innerHTML = PERSONA_CARD_META.map(function(meta, index){
      return buildPersonaCard(meta, index === 0 ? message : '‚Äî', { icon:index === 0 ? 'error' : meta.icon, extraClass:index === 0 ? 'has-error' : '' });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderPersonaEmpty(wrap){
    var message = getReportEmptyMessage();
    wrap.innerHTML = PERSONA_CARD_META.map(function(meta, index){
      return buildPersonaCard(meta, index === 0 ? message : '‚Äî', { icon:index === 0 ? 'info' : meta.icon, extraClass:index === 0 ? 'is-empty' : '' });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderKpiLoading(wrap){
    var summaryLabel = $t('kpi.moreInfo');
    wrap.innerHTML = KPI_CARD_META.map(function(meta){
      return buildKpiCard(meta, { value:'‚Äî', deltaText:'‚Äî', cls:'neutral', icon:'hourglass_empty', extraClass:'is-loading', summaryLabel:summaryLabel });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderKpiError(wrap){
    var summaryLabel = $t('kpi.moreInfo');
    var message = getReportErrorMessage();
    wrap.innerHTML = KPI_CARD_META.map(function(meta, index){
      return buildKpiCard(meta, { value:index === 0 ? message : '‚Äî', deltaText:index === 0 ? message : '‚Äî', cls:index === 0 ? 'negative' : 'neutral', icon:index === 0 ? 'error' : meta.icon, extraClass:index === 0 ? 'has-error' : '', summaryLabel:summaryLabel });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderKpiEmpty(wrap){
    var summaryLabel = $t('kpi.moreInfo');
    var message = getReportEmptyMessage();
    wrap.innerHTML = KPI_CARD_META.map(function(meta, index){
      return buildKpiCard(meta, { value:index === 0 ? message : '‚Äî', deltaText:'‚Äî', cls:'neutral', icon:index === 0 ? 'info' : meta.icon, extraClass:index === 0 ? 'is-empty' : '', summaryLabel:summaryLabel });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderIndicatorsLoading(grid){
    resetIndicatorCharts();
    var message = getReportLoadingMessage();
    grid.setAttribute('aria-busy', 'true');
    grid.innerHTML = INDICATOR_CARD_META.map(function(meta){
      return buildIndicatorCard(meta, message, { extraClass:'is-loading' });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function renderIndicatorsError(grid){
    resetIndicatorCharts();
    var message = getReportErrorMessage();
    grid.removeAttribute('aria-busy');
    var used = false;
    grid.innerHTML = INDICATOR_CARD_META.map(function(meta){
      var summary = used ? '' : message;
      used = true;
      return buildIndicatorCard(meta, summary, { extraClass: summary ? 'has-error' : '' });
    }).join('');
    window.I18nManager?.apply?.();
  }

  function buildIndicatorSummaries(data, locale){
    var summaries = {};
    if(!data) return summaries;
    var persona = data.persona || {};
    var kpis = Array.isArray(data.kpis) ? data.kpis : [];
    var indicators = data.indicators || {};
    var localeRef = locale || getCurrentLocale();

    var bestSector = kpis.filter(function(item){ return Number.isFinite(item.average); }).sort(function(a, b){ return (b.average || 0) - (a.average || 0); })[0];
    if(bestSector){
      summaries['sector-avg'] = $t('charts.avg_by_sector.summary', {
        sector: formatSectorLabel(bestSector.key),
        value: formatScore(bestSector.average, localeRef)
      });
    }

    var distribution = indicators.distribution || {};
    if(Number.isFinite(distribution.total) && distribution.total > 0){
      summaries['distribution'] = $t('charts.distribution.summary', {
        positive: formatPercent(distribution.positive / distribution.total, localeRef, 0),
        neutral: formatPercent(distribution.neutral / distribution.total, localeRef, 0),
        negative: formatPercent(distribution.negative / distribution.total, localeRef, 0)
      });
    }

    var trending = kpis.filter(function(item){ return Number.isFinite(item.delta); }).sort(function(a, b){
      return Math.abs((b.delta || 0)) - Math.abs((a.delta || 0));
    })[0];
    if(trending && Math.abs(trending.delta) >= KPI_DELTA_THRESHOLD){
      summaries['trend-sector'] = $t('charts.trend_sector.summary', {
        sector: formatSectorLabel(trending.key),
        delta: formatSignedDelta(trending.delta, localeRef)
      });
    }

    var monthly = Array.isArray(indicators.monthly) ? indicators.monthly : [];
    if(monthly.length){
      var latest = monthly[monthly.length - 1];
      var countText = Number.isFinite(latest.count) ? new Intl.NumberFormat(localeRef).format(latest.count) : '‚Äî';
      summaries['reviews-month'] = $t('charts.reviews_month.summary', {
        month: formatPeriodLabel(latest.period, localeRef),
        count: countText
      });
    }

    var neighborhoods = Array.isArray(persona.neighborhoods) ? persona.neighborhoods : [];
    if(neighborhoods.length && Number.isFinite(neighborhoods[0].percentage)){
      summaries['map-bairros'] = $t('charts.map_neighborhoods.summary', {
        neighborhood: neighborhoods[0].label,
        share: formatPercent(neighborhoods[0].percentage, localeRef, 0)
      });
    }

    var sectorShare = Array.isArray(indicators.sectorShare) ? indicators.sectorShare : [];
    if(sectorShare.length){
      var sortedShare = sectorShare.slice().sort(function(a, b){ return (b.percentage || 0) - (a.percentage || 0); });
      var parts = sortedShare.slice(0, 3).map(function(item){
        return formatSectorLabel(item.key) + ' ' + formatPercent(item.percentage, localeRef, 0);
      }).filter(Boolean);
      if(parts.length){
        summaries['share-sector'] = $t('charts.share_sector.summary', { list: parts.join(' ¬∑ ') });
      }
    }

    return summaries;
  }

  async function renderPersona(options){
    var wrap = document.getElementById('persona-bar');
    if(!wrap) return;
    if(!reportState.ready || (options && options.forceRefresh)){
      renderPersonaLoading(wrap);
      try{
        await hydrateReportData(options);
      }catch(err){
        console.error('Falha ao carregar dados de persona', err);
        renderPersonaError(wrap);
        return;
      }
    }
    var data = reportState.data;
    if(!data || !data.persona || !(data.persona.total > 0)){
      renderPersonaEmpty(wrap);
      return;
    }
    var persona = data.persona;
    var locale = getCurrentLocale();
    var genders = Array.isArray(persona.genders) ? persona.genders.slice() : [];
    var genderParts = [];
    ['female','male','nonbinary','other'].forEach(function(key){
      var item = genders.find(function(entry){ return entry.key === key; });
      if(item && Number.isFinite(item.percentage) && item.percentage > 0){
        genderParts.push((GENDER_SYMBOLS[key] || key) + ' ' + formatPercent(item.percentage, locale, 0));
      }
    });
    if(!genderParts.length){
      genders.slice(0, 3).forEach(function(item){
        if(item && Number.isFinite(item.percentage)){
          genderParts.push((GENDER_SYMBOLS[item.key] || item.key) + ' ' + formatPercent(item.percentage, locale, 0));
        }
      });
    }

    var ages = Array.isArray(persona.ages) ? persona.ages.slice(0, 2) : [];
    var ageParts = ages.map(function(item){
      if(!item || !Number.isFinite(item.percentage)) return null;
      var labelKey = 'filters.age.'+item.key;
      var label = $t(labelKey, { defaultValue: formatAgeLabel(item.key) });
      return label + ' (' + formatPercent(item.percentage, locale, 0) + ')';
    }).filter(Boolean);

    var neighborhoodParts = (Array.isArray(persona.neighborhoods) ? persona.neighborhoods : []).slice(0, 3).map(function(item){
      return item && item.label ? item.label : null;
    }).filter(Boolean);

    var cardValues = {
      'p-genero': genderParts.length ? genderParts.join(' ¬∑ ') : '‚Äî',
      'p-idade': ageParts.length ? ageParts.join(' ¬∑ ') : '‚Äî',
      'p-bairro': neighborhoodParts.length ? neighborhoodParts.join(', ') : '‚Äî'
    };

    wrap.innerHTML = PERSONA_CARD_META.map(function(meta){
      return buildPersonaCard(meta, cardValues[meta.id] || '‚Äî');
    }).join('');
    window.I18nManager?.apply?.();
  }

  async function renderKPIs(options){
    var wrap = document.getElementById('kpi-bar');
    if(!wrap) return;
    if(!reportState.ready || (options && options.forceRefresh)){
      renderKpiLoading(wrap);
      try{
        await hydrateReportData(options);
      }catch(err){
        console.error('Falha ao carregar KPIs agregados', err);
        renderKpiError(wrap);
        return;
      }
    }
    var data = reportState.data;
    if(!data || !Array.isArray(data.kpis) || !data.kpis.length){
      renderKpiEmpty(wrap);
      return;
    }
    var locale = getCurrentLocale();
    var summaryLabel = $t('kpi.moreInfo');
    wrap.innerHTML = KPI_CARD_META.map(function(meta){
      var stats = data.kpis.find(function(item){ return item.key === meta.id; }) || null;
      var average = stats && Number.isFinite(stats.average) ? stats.average : null;
      var deltaRaw = stats && Number.isFinite(stats.delta) ? stats.delta : null;
      var value = average !== null ? formatScore(average, locale) : '‚Äî';
      var deltaKey = 'delta.stable';
      var deltaValue = null;
      var deltaClass = 'neutral';
      if(deltaRaw !== null){
        if(Math.abs(deltaRaw) >= KPI_DELTA_THRESHOLD){
          deltaKey = 'delta.change';
          deltaValue = formatSignedDelta(deltaRaw, locale);
          deltaClass = deltaRaw > 0 ? 'positive' : 'negative';
        }
      }
      return buildKpiCard(meta, {
        value: value,
        deltaKey: deltaKey,
        deltaValue: deltaValue,
        cls: deltaClass,
        summaryLabel: summaryLabel
      });
    }).join('');
    window.I18nManager?.apply?.();
  }

  async function renderIndicators(options){
    var grid = document.getElementById('cards');
    if(!grid) return;
    resetIndicatorCharts();
    if(!reportState.ready || (options && options.forceRefresh)){
      renderIndicatorsLoading(grid);
      try{
        await hydrateReportData(options);
      }catch(err){
        console.error('Falha ao carregar indicadores agregados', err);
        renderIndicatorsError(grid);
        return;
      }
    }
    var data = reportState.data;
    var locale = getCurrentLocale();
    var summaries = buildIndicatorSummaries(data, locale);
    var hasSummary = Object.keys(summaries).some(function(key){ return summaries[key]; });
    var fallbackSummary = (!hasSummary && data && data.meta && !(data.meta.totalEntries > 0)) ? getReportEmptyMessage() : '';
    var fallbackUsed = false;
    grid.removeAttribute('aria-busy');
    grid.innerHTML = INDICATOR_CARD_META.map(function(meta){
      var summary = summaries[meta.id];
      if((summary === undefined || summary === null || summary === '') && fallbackSummary && !fallbackUsed){
        summary = fallbackSummary;
        fallbackUsed = true;
      }
      return buildIndicatorCard(meta, summary || '');
    }).join('');
    window.I18nManager?.apply?.();

    var chartsReady = await ensureGoogleCharts(locale);
    if(chartsReady){
      try{
        renderIndicatorCharts(grid, data, locale);
      }catch(err){
        console.error('Falha ao renderizar gr√°ficos', err);
        grid.querySelectorAll('.card').forEach(function(card){
          showCardPlaceholder(card, 'reports.error');
        });
      }
    }
    window.I18nManager?.apply?.();
  }

  async function initPanel(){
    if(window.I18nManager && typeof window.I18nManager.ready === 'function'){
      await window.I18nManager.ready();
      if(!window.I18nManager.__panelHooked){
        window.I18nManager.__panelHooked = true;
        window.I18nManager.onChange(function(){
          renderToolbar();
          renderPersona();
          renderKPIs();
          renderIndicators();
          applyFilterDraftToForm();
          updateFiltersDirtyFlag();
          renderStudiesList();
          updateStudiesSummary();
          updateStudiesHint();
          window.I18nManager.apply();
          var syncBtn = document.getElementById('sync-toggle');
          var isOn = !!(syncBtn && syncBtn.getAttribute('aria-pressed') === 'true');
          updateSyncUI(isOn);
        });
      }
    }

    renderToolbar();
    try{
      await hydrateReportData();
    }catch(err){
      console.error('Falha inicial ao hidratar indicadores', err);
    }
    ensureReportSubscription();
    await renderPersona();
    await renderKPIs();
    await renderIndicators();
    window.I18nManager?.apply?.();

    if(window.indexed && window.indexed.open){
      await window.indexed.open('PainelPrefeitoDB', 1, function(db, stores){
        window.indexed.stores = stores || window.indexed.stores || {};
        if(!window.indexed.stores.config){
          window.indexed.defineStore('config', {keyPath:'key'});
        }
      });
    }
    try{
      const flag = await (window.indexed?.get?.(window.indexed.stores?.config, 'sync_enabled'));
      updateSyncUI(!!(flag && flag.value));
    }catch(_){
      updateSyncUI(false);
    }

    await initFiltersUI();
    await initStudiesManager();
    renderToolbar();

    const btn = document.getElementById('sync-toggle');
    const openTab = document.getElementById('sync-open-tab');
    const ready = canRequestGIS();
    if(openTab){
      openTab.style.display = ready.code === 'sandboxed' ? 'inline-flex' : 'none';
      openTab.addEventListener('click', function(e){
        e.preventDefault();
        openStandalone('#sync-consent');
      });
    }
    if(btn){
      btn.addEventListener('click', async function(){
        const on = btn.getAttribute('aria-pressed') === 'true';
        if(on){
          await setSyncEnabled(false);
          report('drive','off','sync desativada');
          return;
        }
        const chk = canRequestGIS();
        if(!chk.ok){
          if(chk.code==='sandboxed'){
            openStandalone('#sync-consent');
            return;
          }
          showSyncTip(chk.msg, true);
          report('drive','warn',chk.code||'ambiente-invalido');
          return;
        }
        try{
          report('drive','info','solicitando consentimento');
          const token = await requestGoogleDriveToken();
          if(token){
            await setSyncEnabled(true);
            report('drive','ok','consentimento concedido');
          } else {
            showSyncTip('N√£o foi poss√≠vel obter o token do Google.', true);
            report('drive','warn','sem-token');
          }
        }catch(err){
          showSyncTip('Falha ao solicitar permiss√£o Google. Verifique se o popup n√£o foi bloqueado.', true);
          report('drive','warn','falha-consentimento');
        }
      });
    }

    document.addEventListener('click', function(e){
      document.querySelectorAll('details.info[open]').forEach(function(d){
        if(!d.contains(e.target)) d.removeAttribute('open');
      });
    });
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){
        document.querySelectorAll('details.info[open]').forEach(function(d){
          d.removeAttribute('open');
        });
        if(window.location.hash){
          var modal = document.querySelector(window.location.hash);
          if(modal && modal.classList && modal.classList.contains('modal')){
            closeActiveModal();
          }
        }
      }
    });

    document.querySelectorAll('.modal .close, .modal .backdrop').forEach(function(node){
      node.addEventListener('click', function(ev){
        ev.preventDefault();
        closeActiveModal();
      });
    });

    window.addEventListener('hashchange', handleModalHashChange);
    handleModalHashChange();
  }

  function showSyncTip(message, warn){
    var el = document.getElementById('sync-tip');
    if(!el) return;
    var text = message || '';
    el.textContent = text;
    el.style.display = text ? 'inline-flex' : 'none';
    el.classList.remove('ok','warn','info');
    el.classList.add(warn ? 'warn' : 'ok');
    if(!text){
      el.removeAttribute('data-i18n');
    }
    var dot = document.getElementById('toolbar-sync-dot');
    if(dot){
      var fallbackTitle = warn ? $t('sync.tip.error') : $t('sync.tip.ok');
      dot.className = 'status-dot ' + (warn ? 'err' : 'ok');
      dot.title = text || fallbackTitle;
    }
  }

  function updateSyncUI(enabled){
    var tbtn = document.getElementById('toolbar-sync');
    if(tbtn){
      tbtn.dataset.active = enabled ? 'true' : 'false';
      tbtn.setAttribute('title', $t('toolbar.multidevice'));
      tbtn.setAttribute('data-i18n-attr', 'title:toolbar.multidevice');
    }
    var dot = document.getElementById('toolbar-sync-dot');
    if(dot){
      dot.className = 'status-dot ' + (enabled ? 'ok' : 'warn');
      dot.title = $t(enabled ? 'sync.state.on' : 'sync.state.off');
    }
    var sbtn = document.getElementById('sync-toggle');
    var lab = sbtn ? sbtn.querySelector('.sync-label') : null;
    var labelKey = enabled ? 'sync.disable' : 'sync.enable';
    if(sbtn){
      sbtn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
      sbtn.setAttribute('title', $t(labelKey));
      sbtn.setAttribute('data-i18n-attr', 'title:'+labelKey);
    }
    if(lab){
      lab.textContent = $t(labelKey);
      lab.setAttribute('data-i18n', labelKey);
    }
    var st = document.getElementById('sync-state');
    if(st){
      var stateKey = enabled ? 'sync.state.on' : 'sync.state.off';
      st.textContent = $t(stateKey);
      st.setAttribute('data-i18n', stateKey);
    }
    window.I18nManager?.apply?.();
  }

  async function setSyncEnabled(enabled){
    if(!(window.indexed && window.indexed.put && window.indexed.stores && window.indexed.stores.config)){
      updateSyncUI(enabled);
      return;
    }
    await window.indexed.put(window.indexed.stores.config, {key:'sync_enabled', value:!!enabled, ts:Date.now()});
    updateSyncUI(enabled);
  }

  function getClientId(){
    var m = document.querySelector('meta[name="google-oauth-client-id"]');
    if(m && m.content) return m.content.trim();
    if(window.GOOGLE_CLIENT_ID) return window.GOOGLE_CLIENT_ID;
    return 'YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com';
  }

  function canRequestGIS(){
    if(self !== top){
      return {ok:false, code:'sandboxed', msg:'Abra em aba pr√≥pria (fora de iframe) para autorizar o Google.'};
    }
    var cid = getClientId();
    if(!cid || /^YOUR_/.test(cid)){
      return {ok:false, code:'clientid-missing', msg:'Client ID do Google n√£o configurado. Adicione a meta tag google-oauth-client-id.'};
    }
    if(!(window.google && google.accounts && google.accounts.oauth2)){
      return {ok:false, code:'gis-missing', msg:'Biblioteca de identidade Google n√£o carregou ainda. Tente novamente.'};
    }
    return {ok:true};
  }

  function openStandalone(hash){
    try{
      var url = new URL(window.location.href);
      url.hash = hash || '';
      window.open(url.toString(), '_blank', 'noopener,noreferrer');
    }catch(e){}
  }

  function requestGoogleDriveToken(){
    return new Promise(function(resolve, reject){
      try{
        var client = google.accounts.oauth2.initTokenClient({
          client_id: getClientId(),
          scope: 'https://www.googleapis.com/auth/drive.file',
          prompt: 'consent',
          callback: function(resp){
            if(resp && resp.access_token) return resolve(resp.access_token);
            reject(new Error('Sem token'));
          }
        });
        client.requestAccessToken();
      }catch(e){
        reject(e);
      }
    });
  }

  if(document.readyState!=='loading') initPanel(); else document.addEventListener('DOMContentLoaded', initPanel);
  </script>

</body>
</html>
