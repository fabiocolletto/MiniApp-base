<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel de Indicadores ‚Äî i18next + Templates (v1.0.0)</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/miniapp-base/styles.css?v=1.0.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/styles.css?v=1.0.0" media="print" onload="this.media='all'">
  <style>
    .modal{position:fixed;inset:0;display:none}
    .modal:target{display:block}
    .kpi{position:relative}
    .kpi details.info{position:absolute;top:6px;right:6px}
    .kpi details.info summary{list-style:none;border:none;background:transparent;width:28px;height:28px;display:grid;place-items:center;padding:0}
    .kpi details.info[open] .panel{min-width:260px}
  </style>
  <script src="https://unpkg.com/i18next@23/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@2/dist/umd/i18nextHttpBackend.min.js"></script>
</head>
<body>
  <header>
    <div class="title">
      <span class="material-symbols-rounded" aria-hidden="true">insights</span>
      <div>
        <h1 data-i18n="app.title">Munic√≠pio de Curitiba ‚Äî Painel de Indicadores</h1>
        <p class="subtitle" data-i18n="app.subtitle">Vers√£o com i18n e templates remotos</p>
      </div>
      <span class="version" aria-label="vers√£o do arquivo">v1.0.0</span>
    </div>
    <div class="toolbar" role="group" aria-label="Controles de exibi√ß√£o">
      <div class="split" id="toolbar-split"></div>
    </div>
  </header>

  <section id="persona-bar" class="kpi-bar" aria-label="Resumo de perfil da amostra"></section>
  <section id="kpi-bar" class="kpi-bar" aria-label="Indicadores-chave por setor"></section>

  <main id="cards" class="grid" aria-live="polite"></main>

  <section id="theme" class="modal" aria-labelledby="th1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="th1" data-i18n="theme.title">Tema do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" href="#" data-theme="light"><span class="material-symbols-rounded">light_mode</span><span data-i18n="theme.light">Claro</span></a>
          <a class="chipbtn" href="#" data-theme="dark"><span class="material-symbols-rounded">dark_mode</span><span data-i18n="theme.dark">Escuro</span></a>
          <a class="chipbtn" href="#" data-theme="auto"><span class="material-symbols-rounded">autorenew</span><span data-i18n="theme.auto">Autom√°tico</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="language" class="modal" aria-labelledby="lg1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="lg1" data-i18n="lang.title">Idioma do painel</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <div class="quickbar" role="group">
          <a class="chipbtn" href="#" data-lang="pt-BR"><span class="flag">üáßüá∑</span><span data-i18n="lang.pt">Portugu√™s</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="sync" class="modal" aria-labelledby="gd1">
    <a class="backdrop" href="#" aria-hidden="true"></a>
    <div class="sheet compact" role="dialog" aria-modal="true">
      <header class="sheet-head">
        <h2 id="gd1" data-i18n="sync.title">M√∫ltiplos dispositivos</h2>
        <a class="close" href="#" aria-label="Fechar">‚úï</a>
      </header>
      <div class="sheet-body">
        <p style="margin-top:0;color:var(--muted)" data-i18n="sync.lead">Ative a sincroniza√ß√£o via Google Drive para que suas pesquisas e prefer√™ncias fiquem dispon√≠veis em todos os seus dispositivos. Voc√™ ver√° um pedido de permiss√£o do Google.</p>
        <div class="subcard" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div style="display:flex;flex-direction:column;gap:4px">
            <strong data-i18n="sync.ctaTitle">Sincronizar com Google Drive</strong>
            <span style="font-size:12px;color:var(--muted)" data-i18n="sync.ctaHint">Armazena configura√ß√µes e cat√°logos de pesquisas no seu Drive, com consentimento.</span>
          </div>
          <button id="sync-toggle" class="btn" aria-pressed="false" title="Habilitar sincroniza√ß√£o"><span class="material-symbols-rounded" aria-hidden="true">cloud_sync</span><span class="sync-label" data-i18n="sync.enable">Permitir e ativar</span></button>
        </div>
        <p id="sync-state" style="margin:10px 0 0;color:var(--muted)" data-i18n="sync.state.off">Sincroniza√ß√£o desativada</p>
        <div id="sync-tip" class="pill info" style="margin-top:10px;display:none"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:10px">
          <a id="sync-open-tab" class="btn" href="#" style="display:none" title="Abrir em nova aba"><span class="material-symbols-rounded">open_in_new</span><span data-i18n="sync.openTab">Abrir em nova aba</span></a>
        </div>
      </div>
    </div>
  </section>

  <section id="kpi-saude" class="modal" aria-labelledby="k1"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k1">Sa√∫de ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o. Este painel replica o layout dos detalhes dos gr√°ficos, com foco no setor.</p></div></div></section>
  <section id="kpi-educacao" class="modal" aria-labelledby="k2"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k2">Educa√ß√£o ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-transporte" class="modal" aria-labelledby="k3"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k3">Transporte ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-seguranca" class="modal" aria-labelledby="k4"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k4">Seguran√ßa ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>
  <section id="kpi-meioambiente" class="modal" aria-labelledby="k5"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k5">Meio ambiente ‚Äî resumo do setor</h2><a class="close" href="#" aria-label="Fechar">‚úï</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padr√£o.</p></div></div></section>

  <section id="info-modal" class="modal" aria-label="Informa√ß√µes"></section>

  <footer data-i18n="app.footer">Base preparada para i18n (i18next) e templates externos versionados.</footer>

  <script>
  const I18N_BACKEND_PATH = 'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/i18n/locales/{{lng}}/{{ns}}.json';
  const I18N_NAMESPACES = ['common','kpi','charts','reports'];

  window.__INDEXED_LIB_CANDIDATES__ = [
    'modules/indexed/indexed.min.js','modules/indexed/indexed.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.min.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.min.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.js'
  ];
  window.__RELATORIO_LIB_CANDIDATES__ = [
    'miniapp-base/relatorio_utils.js','/miniapp-base/relatorio_utils.js','modules/relatorio_utils.js',
    'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/relatorio_utils.js',
    'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/miniapp-base/relatorio_utils.js'
  ];

  function applyI18n(root){
    try{ (root||document).querySelectorAll('[data-i18n]').forEach(function(n){ var k=n.getAttribute('data-i18n'); if(k) n.textContent = i18next.t(k); }); }catch(_){ }
  }
  function $t(k){ try{ return i18next.t(k) || k; }catch(_){ return k; } }

  (function loadScripts(){
    function loadOne(list, cb){ if(!list||!list.length) return cb&&cb(); var src=list.shift(); var s=document.createElement('script'); s.src=src; s.async=true; s.onload=function(){ cb&&cb(true,src); }; s.onerror=function(){ loadOne(list, cb); }; document.head.appendChild(s); }
    loadOne(window.__INDEXED_LIB_CANDIDATES__.slice(), function(){ loadOne(window.__RELATORIO_LIB_CANDIDATES__.slice(), function(){ initI18n(); }); });
  })();

  function initI18n(){
    try{
      i18next.use(i18nextHttpBackend).init({
        lng: 'pt-BR',
        fallbackLng: 'pt-BR',
        ns: I18N_NAMESPACES,
        defaultNS: 'common',
        backend: { loadPath: I18N_BACKEND_PATH },
        interpolation: { escapeValue: false }
      }).then(function(){ initPanel(); });
    }catch(e){ initPanel(); }
  }

  function report(kind, state, text){ try{ (window.relatorio||window.Relatorio)?.status?.(kind, state, text); }catch(_){} }

  function renderToolbar(){
    var el=document.getElementById('toolbar-split');
    if(!el) return;
    el.innerHTML=''
      + '<a class="btn" href="#filters" title="Filtrar"><span class="material-symbols-rounded" aria-hidden="true">filter_list</span>'+$t('toolbar.filters')+'</a>'
      + '<a class="btn" href="#manage-studies" title="Pesquisas"><span class="material-symbols-rounded" aria-hidden="true">inventory_2</span>'+$t('toolbar.studies')+'</a>'
      + '<a class="btn" href="#theme" title="Tema"><span class="material-symbols-rounded" aria-hidden="true">light_mode</span>'+$t('toolbar.theme')+'</a>'
      + '<a class="btn" href="#language" title="Idioma"><span class="material-symbols-rounded" aria-hidden="true">translate</span>'+$t('toolbar.language')+'</a>'
      + '<a class="btn" href="#sync" id="toolbar-sync" title="Multi"><span class="material-symbols-rounded" aria-hidden="true">devices</span>'+$t('toolbar.multidevice')+'<span id="toolbar-sync-dot" class="status-dot" aria-hidden="true"></span></a>';
  }

  function renderPersona(){
    var wrap=document.getElementById('persona-bar');
    var cards=[
      {id:'p-genero', icon:'diversity_3', title:$t('persona.gender'), value:'‚ôÄ 54% ¬∑ ‚ôÇ 44% ¬∑ ‚ÅÑ 2%', hint:$t('persona.hint')||'Ap√≥s filtros'},
      {id:'p-idade', icon:'cake', title:$t('persona.age'), value:'25‚Äì34 (31%) ¬∑ 35‚Äì44 (27%)', hint:$t('persona.hint')||'Faixas dominantes'},
      {id:'p-bairro', icon:'location_city', title:$t('persona.neighborhood'), value:'Boqueir√£o, CIC, Bairro Novo', hint:$t('persona.hintTop')||'Top 3'}
    ];
    wrap.innerHTML=cards.map(function(c){
      return '<div class="kpi" role="group" aria-label="'+c.title+'">\
        <div class="label"><span class="material-symbols-rounded">'+c.icon+'</span><span>'+c.title+'</span></div>\
        <div class="value" style="font-size:18px">'+c.value+'</div>\
        <div class="delta neutral" style="opacity:.8">'+c.hint+'</div>\
      </div>';
    }).join('');
  }

  function renderKPIs(){
    var list=[
      {id:'saude', icon:'vaccines', label:$t('sector.saude'), val:'4,2', delta:'+0,3', cls:'positive', summaryKey:'reports.kpi.saude.summary'},
      {id:'educacao', icon:'school', label:$t('sector.educacao'), val:'3,8', delta:$t('delta.stable'), cls:'neutral', summaryKey:'reports.kpi.educacao.summary'},
      {id:'transporte', icon:'directions_bus', label:$t('sector.transporte'), val:'3,2', delta:'-0,2', cls:'negative', summaryKey:'reports.kpi.transporte.summary'},
      {id:'seguranca', icon:'shield_person', label:$t('sector.seguranca'), val:'4,0', delta:$t('delta.stable'), cls:'neutral', summaryKey:'reports.kpi.seguranca.summary'},
      {id:'meioambiente', icon:'eco', label:$t('sector.meioambiente'), val:'4,4', delta:'+0,1', cls:'positive', summaryKey:'reports.kpi.meioambiente.summary'}
    ];
    var wrap=document.getElementById('kpi-bar');
    wrap.innerHTML=list.map(function(s){
      return '<div class="kpi" role="group" aria-label="'+s.label+'">\
        <details class="info"><summary aria-label="Informa√ß√µes"><span class="material-symbols-rounded" aria-hidden="true">info</span></summary>\
          <div class="panel" role="dialog" aria-labelledby="kpi-'+s.id+'"><h4>'+s.label+'</h4><p data-i18n="'+s.summaryKey+'">'+i18next.t(s.summaryKey,{avg:s.val,delta:s.delta})+'</p><p class="hint" data-i18n="info.hint">Toque no √≠cone novamente para fechar.</p></div>\
        </details>\
        <div class="label"><span class="material-symbols-rounded">'+s.icon+'</span><span>'+s.label+'</span></div>\
        <div class="value">'+s.val+'</div>\
        <div class="delta '+s.cls+'"><span class="material-symbols-rounded" aria-hidden="true" style="font-size:16px">'+(s.cls==='positive'?'trending_up':s.cls==='negative'?'trending_down':'trending_flat')+'</span>'+s.delta+'</div>\
      </div>';
    }).join('');
  }

  function renderIndicators(){
    var cards=[
      {id:'sector-avg', icon:'bar_chart_4_bars', title:$t('charts.avg_by_sector'), infoTitle:$t('info.howto.title'), infoCopy:$t('info.howto.copy'), infoHint:$t('info.hint'), ph:'Colunas (placeholder)'},
      {id:'distribution', icon:'stacked_bar_chart', title:$t('charts.distribution'), infoTitle:$t('info.howto.title'), infoCopy:$t('charts.distributionDesc')||'Propor√ß√£o ap√≥s filtros.', infoHint:$t('info.hint'), ph:'Barras empilhadas (placeholder)'},
      {id:'trend-sector', icon:'show_chart', title:$t('charts.trendBySector')||'Tend√™ncia mensal por setor', infoTitle:$t('info.howto.title'), infoCopy:$t('charts.trendBySectorDesc')||'Evolu√ß√£o das m√©dias mensais.', infoHint:$t('info.hint'), ph:'Linhas (placeholder)'},
      {id:'reviews-month', icon:'insert_chart', title:$t('charts.reviewsByMonth')||'Avalia√ß√µes por m√™s', infoTitle:$t('info.howto.title'), infoCopy:$t('charts.reviewsByMonthDesc')||'Volume de respostas coletadas.', infoHint:$t('info.hint'), ph:'Colunas agrupadas (placeholder)'},
      {id:'map-bairros', icon:'map', title:$t('charts.mapByNeighborhood')||'Mapa do munic√≠pio ‚Äî pontos por bairro', infoTitle:$t('info.howto.title'), infoCopy:$t('charts.mapByNeighborhoodDesc')||'Distribui√ß√£o espacial.', infoHint:$t('info.hint'), ph:'Mapa (placeholder)'},
      {id:'share-sector', icon:'pie_chart', title:$t('charts.shareBySector')||'Participa√ß√£o por setor', infoTitle:$t('info.howto.title'), infoCopy:$t('charts.shareBySectorDesc')||'Percentual por setor.', infoHint:$t('info.hint'), ph:'Pizza (placeholder)'}
    ];
    var grid=document.getElementById('cards');
    grid.innerHTML=cards.map(function(c){ return '<section class="card" aria-labelledby="t-'+c.id+'">\
      <h3 id="t-'+c.id+'"><span class="material-symbols-rounded" aria-hidden="true">'+c.icon+'</span>'+c.title+'</h3>\
      <details class="info"><summary aria-label="Informa√ß√µes"><span class="material-symbols-rounded" aria-hidden="true">info</span></summary>\
      <div class="panel" role="dialog" aria-labelledby="t-'+c.id+'"><p>'+c.infoCopy+'</p><p class="hint">'+c.infoHint+'</p></div></details>\
      <div class="ph">'+c.ph+'</div></section>'; }).join('');
  }

  async function initPanel(){
    renderToolbar();
    renderPersona();
    renderKPIs();
    renderIndicators();
    applyI18n(document);

    if(window.indexed && window.indexed.open){
      await window.indexed.open('PainelPrefeitoDB', 1, function(db, stores){ window.indexed.stores = stores||window.indexed.stores||{}; if(!window.indexed.stores.config){ window.indexed.defineStore('config', {keyPath:'key'}); } if(!window.indexed.stores.tpl){ window.indexed.defineStore('tpl', {keyPath:'key'});} });
    }

    const btn = document.getElementById('sync-toggle');
    const openTab = document.getElementById('sync-open-tab');
    const ready = {ok:true};
    if(openTab){ openTab.style.display = 'none'; }
    if(btn){ btn.addEventListener('click', async function(){ const on = btn.getAttribute('aria-pressed')==='true'; if(on){ await setSyncEnabled(false); report('drive','off','sync desativada'); return;} showSyncTip('Solicitando permiss√£o do Google‚Ä¶'); setTimeout(async function(){ await setSyncEnabled(true); showSyncTip('Sincroniza√ß√£o ativada'); }, 500); }); }

    document.addEventListener('click', function(e){
      document.querySelectorAll('details.info[open]').forEach(function(d){ if(!d.contains(e.target)) d.removeAttribute('open'); });
    });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ document.querySelectorAll('details.info[open]').forEach(function(d){ d.removeAttribute('open'); }); } });
  }

  function showSyncTip(message, warn){ var el=document.getElementById('sync-tip'); if(!el) return; el.textContent = message || ''; el.style.display = message? 'inline-flex':'none'; el.classList.remove('ok','warn','info'); el.classList.add(warn? 'warn':'ok'); var dot=document.getElementById('toolbar-sync-dot'); if(dot){ dot.className = 'status-dot ' + (warn? 'err':'ok'); dot.title = message || (warn? 'Problema de sincroniza√ß√£o' : 'Sincroniza√ß√£o ok'); } }
  function updateSyncUI(enabled){ var tbtn=document.getElementById('toolbar-sync'); if(tbtn){ tbtn.dataset.active = enabled? 'true':'false'; } var dot=document.getElementById('toolbar-sync-dot'); if(dot){ dot.className = 'status-dot ' + (enabled? 'ok':'warn'); } var sbtn=document.getElementById('sync-toggle'); var lab=sbtn? sbtn.querySelector('.sync-label'):null; if(sbtn){ sbtn.setAttribute('aria-pressed', enabled? 'true':'false'); if(lab) lab.textContent = enabled? 'Ativado (clique para desligar)' : 'Permitir e ativar'; } var st=document.getElementById('sync-state'); if(st){ st.textContent = enabled? 'Sincroniza√ß√£o ativada' : 'Sincroniza√ß√£o desativada'; } }
  async function setSyncEnabled(enabled){ if(!(window.indexed && window.indexed.put && window.indexed.stores && window.indexed.stores.config)){ updateSyncUI(enabled); return; } await window.indexed.put(window.indexed.stores.config, {key:'sync_enabled', value:!!enabled, ts:Date.now()}); updateSyncUI(enabled); }

  if(document.readyState!=='loading') initI18n(); else document.addEventListener('DOMContentLoaded', initI18n);
  </script>
</body>
</html>
