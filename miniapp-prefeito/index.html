<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title>Painel de Indicadores â€” i18next + Templates (v1.0.0)</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;600&display=swap" rel="stylesheet">
  Â  <link rel="stylesheet" href="/miniapp-base/styles.css?v=1.0.0">
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/styles.css?v=1.0.0" media="print" onload="this.media='all'">
Â  <style>
Â  Â  .modal{position:fixed;inset:0;display:none}
Â  Â  .modal:target{display:block}
Â  Â  .kpi{position:relative}
Â  Â  .kpi details.info{position:absolute;top:6px;right:6px}
Â  Â  .kpi details.info summary{list-style:none;border:none;background:transparent;width:28px;height:28px;display:grid;place-items:center;padding:0}
Â  Â  .kpi details.info[open] .panel{min-width:260px}
Â  </style>
Â  <script src="https://unpkg.com/i18next@23/dist/umd/i18next.min.js"></script>
Â  <script src="https://unpkg.com/i18next-http-backend@2/dist/umd/i18nextHttpBackend.min.js"></script>
</head>
<body>
Â  <header>
Â  Â  <div class="title">
Â  Â  Â  <span class="material-symbols-rounded" aria-hidden="true">insights</span>
Â  Â  Â  <div>
Â  Â  Â  Â  <h1 data-i18n="app.title">MunicÃ­pio de Curitiba â€” Painel de Indicadores</h1>
Â  Â  Â  Â  <p class="subtitle" data-i18n="app.subtitle">VersÃ£o com i18n e templates remotos</p>
Â  Â  Â  </div>
Â  Â  Â  <span class="version" aria-label="versÃ£o do arquivo">v1.0.0</span>
Â  Â  </div>
Â  Â  <div class="toolbar" role="group" aria-label="Controles de exibiÃ§Ã£o">
Â  Â  Â  <div class="split" id="toolbar-split"></div>
Â  Â  </div>
Â  </header>

Â  <section id="persona-bar" class="kpi-bar" aria-label="Resumo de perfil da amostra"></section>
Â  <section id="kpi-bar" class="kpi-bar" aria-label="Indicadores-chave por setor"></section>

Â  <main id="cards" class="grid" aria-live="polite"></main>

Â  <section id="theme" class="modal" aria-labelledby="th1">
Â  Â  <a class="backdrop" href="#" aria-hidden="true"></a>
Â  Â  <div class="sheet compact" role="dialog" aria-modal="true">
Â  Â  Â  <header class="sheet-head">
Â  Â  Â  Â  <h2 id="th1" data-i18n="theme.title">Tema do painel</h2>
Â  Â  Â  Â  <a class="close" href="#" aria-label="Fechar">âœ•</a>
Â  Â  Â  </header>
Â  Â  Â  <div class="sheet-body">
Â  Â  Â  Â  <div class="quickbar" role="group">
          Â  Â  Â  Â  Â  <a class="chipbtn" id="theme-light-btn" href="#" data-theme="light"><span class="material-symbols-rounded">light_mode</span><span data-i18n="theme.light">Claro</span></a>
Â  Â  Â  Â  Â  <a class="chipbtn" id="theme-dark-btn" href="#" data-theme="dark"><span class="material-symbols-rounded">dark_mode</span><span data-i18n="theme.dark">Escuro</span></a>
Â  Â  Â  Â  Â  <a class="chipbtn" id="theme-auto-btn" href="#" data-theme="auto"><span class="material-symbols-rounded">autorenew</span><span data-i18n="theme.auto">AutomÃ¡tico</span></a>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  <section id="language" class="modal" aria-labelledby="lg1">
Â  Â  <a class="backdrop" href="#" aria-hidden="true"></a>
Â  Â  <div class="sheet compact" role="dialog" aria-modal="true">
Â  Â  Â  <header class="sheet-head">
Â  Â  Â  Â  <h2 id="lg1" data-i18n="lang.title">Idioma do painel</h2>
Â  Â  Â  Â  <a class="close" href="#" aria-label="Fechar">âœ•</a>
Â  Â  Â  </header>
Â  Â  Â  <div class="sheet-body">
Â  Â  Â  Â  <div class="quickbar" role="group">
          Â  Â  Â  Â  Â  <a class="chipbtn" id="lang-pt-btn" href="#" data-lang="pt-BR"><span class="flag">ðŸ‡§ðŸ‡·</span><span data-i18n="lang.pt">PortuguÃªs</span></a>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  <section id="sync" class="modal" aria-labelledby="gd1">
Â  Â  <a class="backdrop" href="#" aria-hidden="true"></a>
Â  Â  <div class="sheet compact" role="dialog" aria-modal="true">
Â  Â  Â  <header class="sheet-head">
Â  Â  Â  Â  <h2 id="gd1" data-i18n="sync.title">MÃºltiplos dispositivos</h2>
Â  Â  Â  Â  <a class="close" href="#" aria-label="Fechar">âœ•</a>
Â  Â  Â  </header>
Â  Â  Â  <div class="sheet-body">
Â  Â  Â  Â  <p style="margin-top:0;color:var(--muted)" data-i18n="sync.lead">Ative a sincronizaÃ§Ã£o via Google Drive para que suas pesquisas e preferÃªncias fiquem disponÃ­veis em todos os seus dispositivos. VocÃª verÃ¡ um pedido de permissÃ£o do Google.</p>
Â  Â  Â  Â  <div class="subcard" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
Â  Â  Â  Â  Â  <div style="display:flex;flex-direction:column;gap:4px">
Â  Â  Â  Â  Â  Â  <strong data-i18n="sync.ctaTitle">Sincronizar com Google Drive</strong>
Â  Â  Â  Â  Â  Â  <span style="font-size:12px;color:var(--muted)" data-i18n="sync.ctaHint">Armazena configuraÃ§Ãµes e catÃ¡logos de pesquisas no seu Drive, com consentimento.</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button id="sync-toggle" class="btn" aria-pressed="false" title="Habilitar sincronizaÃ§Ã£o"><span class="material-symbols-rounded" aria-hidden="true">cloud_sync</span><span class="sync-label" data-i18n="sync.enable">Permitir e ativar</span></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p id="sync-state" style="margin:10px 0 0;color:var(--muted)" data-i18n="sync.state.off">SincronizaÃ§Ã£o desativada</p>
Â  Â  Â  Â  <div id="sync-tip" class="pill info" style="margin-top:10px;display:none"></div>
Â  Â  Â  Â  <div style="display:flex;justify-content:flex-end;margin-top:10px">
Â  Â  Â  Â  Â  <a id="sync-open-tab" class="btn" href="#" style="display:none" title="Abrir em nova aba"><span class="material-symbols-rounded">open_in_new</span><span data-i18n="sync.openTab">Abrir em nova aba</span></a>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  <section id="kpi-saude" class="modal" aria-labelledby="k1"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k1">SaÃºde â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o. Este painel replica o layout dos detalhes dos grÃ¡ficos, com foco no setor.</p></div></div></section>
Â  <section id="kpi-educacao" class="modal" aria-labelledby="k2"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k2">EducaÃ§Ã£o â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>
Â  <section id="kpi-transporte" class="modal" aria-labelledby="k3"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k3">Transporte â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>
Â  <section id="kpi-seguranca" class="modal" aria-labelledby="k4"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k4">SeguranÃ§a â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>
Â  <section id="kpi-meioambiente" class="modal" aria-labelledby="k5"><a class="backdrop" href="#" aria-hidden="true"></a><div class="sheet compact" role="dialog" aria-modal="true"><header class="sheet-head"><h2 id="k5">Meio ambiente â€” resumo do setor</h2><a class="close" href="#" aria-label="Fechar">âœ•</a></header><div class="sheet-body"><p class="subtitle">15 indicadores conceituais padrÃ£o.</p></div></div></section>

Â  <section id="info-modal" class="modal" aria-label="InformaÃ§Ãµes"></section>

Â  <footer data-i18n="app.footer">Base preparada para i18n (i18next) e templates externos versionados.</footer>

Â  <script>
    // CORREÃ‡ÃƒO I18N
    // Usando caminho relativo para os JSONs locais do miniapp-prefeito/i18n/locales/
Â    const I18N_BACKEND_PATH = 'i18n/locales/{{lng}}/{{ns}}.json';
    // Adicionando namespaces especÃ­ficos do MiniApp
Â    const I18N_NAMESPACES = ['common','kpi','charts','reports', 'miniapp_prefeito', 'system'];
    
    // CONSTANTES DE PERSISTÃŠNCIA
    const THEME_STORAGE_KEY = 'miniapp-prefeito-theme';
    const LANG_STORAGE_KEY = 'miniapp-prefeito-lang';

Â  window.__INDEXED_LIB_CANDIDATES__ = [
Â  Â  'modules/indexed/indexed.min.js','modules/indexed/indexed.js',
Â  Â  'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.min.js',
Â  Â  'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/modules/indexed/indexed.js',
Â  Â  'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.min.js',
Â  Â  'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/modules/indexed/indexed.js'
Â  ];
Â  window.__RELATORIO_LIB_CANDIDATES__ = [
Â  Â  'miniapp-base/relatorio_utils.js','/miniapp-base/relatorio_utils.js','modules/relatorio_utils.js',
Â  Â  'https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base/miniapp-base/relatorio_utils.js',
Â  Â  'https://raw.githubusercontent.com/fabiocolletto/MiniApp-base/main/miniapp-base/relatorio_utils.js'
Â  ];

    // FUNÃ‡Ã•ES I18N E TEMA
Â  function applyI18n(root){
Â  Â  try{ (root||document).querySelectorAll('[data-i18n]').forEach(function(n){ var k=n.getAttribute('data-i18n'); if(k) n.textContent = i18next.t(k); }); }catch(_){ }
Â  }
Â  function $t(k){ try{ return i18next.t(k) || k; }catch(_){ return k; } }


    // --- LÃ“GICA DE TEMA ---
Â  function applyTheme(theme) {
Â  Â  Â  const html = document.documentElement;
Â  Â  Â  window.location.hash = ''; // Fecha o modal
Â  Â  Â Â 
Â  Â  Â  if (theme === 'auto') {
Â  Â  Â  Â  Â  html.removeAttribute('data-theme');
Â  Â  Â  Â  Â  localStorage.removeItem(THEME_STORAGE_KEY);
Â  Â  Â  } else {
Â  Â  Â  Â  Â  html.setAttribute('data-theme', theme);
Â  Â  Â  Â  Â  localStorage.setItem(THEME_STORAGE_KEY, theme);
Â  Â  Â  }
Â  }

Â  function loadInitialTheme() {
Â  Â  Â  const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
Â  Â  Â  const html = document.documentElement;

Â  Â  Â  if (savedTheme === 'auto') {
Â  Â  Â  Â  Â  html.removeAttribute('data-theme');
Â  Â  Â  } else if (savedTheme) {
Â  Â  Â  Â  Â  html.setAttribute('data-theme', savedTheme);
Â  Â  Â  } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
Â  Â  Â  Â  Â  html.setAttribute('data-theme', 'dark');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  html.setAttribute('data-theme', 'light');
Â  Â  Â  }
Â  }

Â  function bindThemeToggles() {
Â  Â  Â  const themeModal = document.getElementById('theme');
Â  Â  Â  if (!themeModal) return;

Â  Â  Â  themeModal.querySelectorAll('.chipbtn').forEach(button => {
Â  Â  Â  Â  Â  const theme = button.getAttribute('data-theme');
Â  Â  Â  Â  Â  if (theme) {
Â  Â  Â  Â  Â  Â  Â  button.addEventListener('click', function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  applyTheme(theme);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  }
    // --- FIM LÃ“GICA DE TEMA ---


    // --- LÃ“GICA DE IDIOMA ---
    function applyLanguage(lang) {
        // Guarda o idioma no localStorage e fecha o modal
        if (lang) {
            localStorage.setItem(LANG_STORAGE_KEY, lang);
        } else {
            localStorage.removeItem(LANG_STORAGE_KEY);
        }
        window.location.hash = '';

        // Se o i18next jÃ¡ estiver rodando, muda e re-renderiza
        if (window.i18next && i18next.isInitialized) {
            i18next.changeLanguage(lang || 'pt-BR').then(() => {
                applyI18n(document); // Chama a funÃ§Ã£o de renderizaÃ§Ã£o i18n
            });
        }
        // Atualiza o atributo lang para acessibilidade
        document.documentElement.lang = lang || 'pt-BR';
    }

    function loadInitialLanguage() {
        const savedLang = localStorage.getItem(LANG_STORAGE_KEY) || document.documentElement.lang || 'pt-BR';
        document.documentElement.lang = savedLang;
        return savedLang;
    }

    function bindLanguageToggles() {
        const langModal = document.getElementById('language');
        if (!langModal) return;

        langModal.querySelectorAll('.chipbtn').forEach(button => {
            const lang = button.getAttribute('data-lang');
            if (lang) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    applyLanguage(lang);
                });
            }
        });
    }
    // --- FIM LÃ“GICA DE IDIOMA ---


Â  (function loadScripts(){
Â  Â  function loadOne(list, cb){ if(!list||!list.length) return cb&&cb(); var src=list.shift(); var s=document.createElement('script'); s.src=src; s.async=true; s.onload=function(){ cb&&cb(true,src); }; s.onerror=function(){ loadOne(list, cb); }; document.head.appendChild(s); }
Â  Â  loadOne(window.__INDEXED_LIB_CANDIDATES__.slice(), function(){ loadOne(window.__RELATORIO_LIB_CANDIDATES__.slice(), function(){ initI18n(); }); });
Â  })();

Â  function initI18n(){
    const initialLang = loadInitialLanguage(); // Usa o idioma persistido ou padrÃ£o
Â  Â  try{
Â  Â  Â  i18next.use(i18nextHttpBackend).init({
Â  Â  Â  Â  lng: initialLang, // Usa o idioma inicial persistido
Â  Â  Â  Â  fallbackLng: 'pt-BR',
Â  Â  Â  Â  ns: I18N_NAMESPACES,
Â  Â  Â  Â  defaultNS: 'common',
Â  Â  Â  Â  backend: { loadPath: I18N_BACKEND_PATH },
Â  Â  Â  Â  interpolation: { escapeValue: false }
Â  Â  Â  }).then(function(){ initPanel(); });
Â  Â  }catch(e){ initPanel(); }
Â  }

  // ... (report, renderToolbar, renderPersona, renderKPIs, renderIndicators, showSyncTip, updateSyncUI, setSyncEnabled permanecem inalteradas, mas sÃ£o encurtadas aqui por espaÃ§o) ...

  // A FUNÃ‡ÃƒO initPanel FOI CORRIGIDA PARA CHAMAR AMBOS OS BINDINGS
Â  async function initPanel(){
Â  Â  // CONECTA OS EVENTOS DE TEMA E IDIOMA APÃ“S O DOM SER RENDERIZADO
Â  Â  bindThemeToggles();
    bindLanguageToggles();
Â  Â Â 
Â  Â  renderToolbar();
Â  Â  renderPersona();
Â  Â  renderKPIs();
Â  Â  renderIndicators();
Â  Â  applyI18n(document);

    // ... (LÃ³gica de IndexedDB e Sync permanece inalterada) ...

Â  Â  const btn = document.getElementById('sync-toggle');
Â  Â  const openTab = document.getElementById('sync-open-tab');
Â  Â  const ready = {ok:true};
Â  Â  if(openTab){ openTab.style.display = 'none'; }
Â  Â  if(btn){ btn.addEventListener('click', async function(){ const on = btn.getAttribute('aria-pressed')==='true'; if(on){ await setSyncEnabled(false); report('drive','off','sync desativada'); return;} showSyncTip('Solicitando permissÃ£o do Googleâ€¦'); setTimeout(async function(){ await setSyncEnabled(true); showSyncTip('SincronizaÃ§Ã£o ativada'); }, 500); }); }

Â  Â  document.addEventListener('click', function(e){
Â  Â  Â  document.querySelectorAll('details.info[open]').forEach(function(d){ if(!d.contains(e.target)) d.removeAttribute('open'); });
Â  Â  });
Â  Â  document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ document.querySelectorAll('details.info[open]').forEach(function(d){ d.removeAttribute('open'); }); } });
Â  }

  // ... (restante das funÃ§Ãµes que nÃ£o foram alteradas) ...

  function report(kind, state, text){ try{ (window.relatorio||window.Relatorio)?.status?.(kind, state, text); }catch(_){} }
  function renderToolbar(){ /* ... */ }
  function renderPersona(){ /* ... */ }
  function renderKPIs(){ /* ... */ }
  function renderIndicators(){ /* ... */ }
  function showSyncTip(message, warn){ /* ... */ }
  function updateSyncUI(enabled){ /* ... */ }
  async function setSyncEnabled(enabled){ /* ... */ }


Â  // Garante que o tema seja carregado antes de qualquer outra inicializaÃ§Ã£o, masÂ 
Â  // que o initI18n e initPanel sÃ³ rodem apÃ³s o DOM estar carregado.
Â  initThemeSystem();
Â  if(document.readyState!=='loading') initI18n(); else document.addEventListener('DOMContentLoaded', initI18n);
Â  </script>
</body>
</html>
