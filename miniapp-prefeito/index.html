<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Prefeito ‚Äî Design Modular</title>
  
  <!-- Carrega a biblioteca Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <!-- 1. VINCULA√á√ÉO DO STYLESHEET BASE (Design System) -->
  <!-- Tenta carregar a branch tempor√°ria primeiro: fabiocolletto-patch-1 -->
  <link rel="stylesheet" 
        href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base@fabiocolletto-patch-1/miniapp-base/styles.css"
        id="styles-temp"
        onerror="loadFallback('temp')">

  <!-- 2. Fallback para a branch principal (main) -->
  <link rel="stylesheet" 
        href="https://cdn.jsdelivr.net/gh/fabiocolletto/MiniApp-base@main/miniapp-base/styles.css" 
        id="styles-main"
        onerror="loadFallback('main')">

  <style>
    /* Estilos M√≠nimos: Apenas utilit√°rios e ajustes n√£o-estruturais. */
    body { 
      margin: 0; 
      padding: 0; 
      overflow-x: hidden; 
      background-color: var(--background-page); 
      color: var(--text-color-primary);
      font-family: 'Inter', sans-serif; /* Fallback font */
    }
    
    /* Garante que o container do gr√°fico ocupe o espa√ßo para o Google Charts */
    .chart-container { 
      height: 100%; 
    } 

    /* Estilos para os cards de KPI */
    .kpi-card p { margin: 0; }
    .kpi-card { 
      min-width: 260px; 
      display: flex; 
      flex-direction: column; 
      justify-content: space-between;
    }

    /* Estilo para o indicador de vers√£o (para que se pare√ßa com uma tag/pill) */
    .version-indicator {
        font-size: 0.75rem; /* var(--font-size-s) */
        padding: 4px 8px; /* var(--space-1) var(--space-2) */
        border-radius: 4px; /* var(--radius-s) */
        margin-left: 12px; /* var(--space-3) */
        font-weight: 500;
    }
    .version-indicator.temp {
        background-color: #f59e0b; /* Amarelo/Warn */
        color: #1f2937; /* Cor do texto escuro */
    }
    .version-indicator.main {
        background-color: #3b82f6; /* Azul/Info */
        color: white; 
    }
  </style>
</head>
<body>

  <div id="app-wrapper">
    
    <!-- SIDEBAR -->
    <aside id="sidebar" role="navigation">
      <button id="menu-toggle" class="btn-toggle" aria-label="Abrir e Fechar Menu">
        <span class="app-icon" id="menu-close-icon">‚úñÔ∏è</span>
        <span class="app-icon" id="menu-open-icon">‚ò∞</span>
      </button>

      <ul class="nav-list">
        <li><a href="#" class="nav-item active"><span class="app-icon">üè†</span> <span>In√≠cio</span></a></li>
        <li><a href="#" class="nav-item"><span class="app-icon">üìà</span> <span>Relat√≥rios</span></a></li>
        <li><a href="#" class="nav-item"><span class="app-icon">üó∫Ô∏è</span> <span>Geolocaliza√ß√£o</span></a></li>
        <li><a href="#" class="nav-item"><span class="app-icon">‚öôÔ∏è</span> <span>Configura√ß√µes</span></a></li>
      </ul>
      
      <div style="padding: 0 var(--space-4); font-size: var(--font-size-s); color: var(--text-color-muted);">
        v1.0.0
      </div>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <div id="main-content">
      
      <!-- HEADER FIXO -->
      <header>
        <div class="header-title-text">
          <h1>Painel de Indicadores</h1>
          <p class="subtitle-with-version">
            MiniApp Prefeito 
            <!-- INDICADOR DE VERS√ÉO (Ser√° preenchido pelo JS) -->
            <span id="version-status" class="version-indicator">Carregando...</span>
          </p>
        </div>
      </header>

      <!-- SE√á√ÉO DE CONTE√öDO (DEMONSTRA√á√ÉO DE CLASSES) -->
      
      <!-- CARROSSEL DE KPI'S - Usa classes 'carousel', 'card', 'kpi-value' e 'tag' -->
      <section class="carousel" style="min-height: 120px; margin-top: 24px; /* Ajuste para o padding-top do main-content */">
        <!-- Card 1: Primary Brand Color -->
        <article class="card kpi-card">
            <p class="subtitle" style="color: var(--text-color-muted);">Aprova√ß√£o M√©dia</p>
            <p class="kpi-value">78%</p> 
            <span class="tag success">Est√°vel</span>
        </article>
        <!-- Card 2: Warning Color -->
        <article class="card kpi-card">
            <p class="subtitle" style="color: var(--text-color-muted);">Tempo Resolu√ß√£o</p>
            <p class="kpi-value warn">4.2 dias</p>
            <span class="tag warn">Atraso</span>
        </article>
        <!-- Card 3: Danger Color -->
        <article class="card kpi-card">
            <p class="subtitle" style="color: var(--text-color-muted);">Reclama√ß√µes</p>
            <p class="kpi-value danger">1.250</p>
            <span class="tag danger">Alto Volume</span>
        </article>
      </section>
      
      <!-- GRID DE GR√ÅFICOS - Usa a classe 'grid' -->
      <main class="grid" aria-live="polite" style="margin-top: 24px;">
        
        <!-- Gr√°fico de Linha -->
        <article class="card chart-card">
          <div class="chart-header"><h3>Qualidade do Servi√ßo</h3></div>
          <div id="chart_line" class="chart-container"></div>
        </article>

        <!-- Gr√°fico de Barra -->
        <article class="card chart-card">
          <div class="chart-header"><h3>Tempo M√©dio de Resolu√ß√£o</h3></div>
          <div id="chart_bar" class="chart-container"></div>
        </article>
        
        <!-- A√ß√£o em Destaque -->
        <article class="card full-width app-card" style="min-height: auto; flex-direction: row; align-items: center; justify-content: space-between;">
          <h3>Relat√≥rio Detalhado de Resolu√ß√µes</h3>
          <a href="#" class="btn primary">Ver Planilha Completa</a>
        </article>
        
      </main>

    </div>
  </div>

  <!-- JAVASCRIPT: TOGGLE, GR√ÅFICOS E LOAD CSS -->
  <script>
    const VERSION_STATUS_ELEMENT = document.getElementById('version-status');
    let stylesLoaded = false;

    // Fun√ß√£o para atualizar o status de carregamento e o indicador visual
    function updateLoadStatus(version, success = true) {
        if (stylesLoaded) return; // Se j√° carregou, ignora outros eventos

        stylesLoaded = true;
        VERSION_STATUS_ELEMENT.textContent = `CSS: ${version}`;
        VERSION_STATUS_ELEMENT.classList.remove('temp', 'main');
        
        if (success) {
            VERSION_STATUS_ELEMENT.classList.add(version);
            if (version === 'temp') {
                console.log('Design System carregado da branch TEMPOR√ÅRIA.');
            } else {
                console.warn('Design System carregado da branch MAIN (Fallback).');
            }
        } else {
            VERSION_STATUS_ELEMENT.textContent = 'CSS: ERRO';
            VERSION_STATUS_ELEMENT.style.backgroundColor = 'red';
            console.error('Falha ao carregar o Design System de ambas as fontes.');
        }
        // Uma vez que o CSS est√° carregado, os gr√°ficos podem ser desenhados.
        google.charts.setOnLoadCallback(drawAllCharts);
    }
    
    // Configura listeners para o carregamento bem-sucedido
    document.getElementById('styles-temp').onload = () => updateLoadStatus('temp');
    document.getElementById('styles-main').onload = () => updateLoadStatus('main');


    // Fun√ß√£o que √© chamada em caso de erro no carregamento da branch tempor√°ria
    // Se o 'temp' falhar, garantimos que o 'main' tente carregar (j√° est√° no HTML)
    function loadFallback(failedVersion) {
        if (failedVersion === 'temp') {
            console.warn('Falha ao carregar branch TEMPOR√ÅRIA. Aguardando fallback MAIN...');
        } else if (failedVersion === 'main') {
            // Se at√© o main falhar, exibe erro final
            updateLoadStatus('main', false);
        }
    }


    // === L√≥gica do Toggle do Menu ===
    document.addEventListener('DOMContentLoaded', () => {
      const wrapper = document.getElementById('app-wrapper');
      const toggleButton = document.getElementById('menu-toggle');
      
      // Assume-se que o CSS da sidebar est√° carregado para definir o estado inicial
      wrapper.classList.remove('closed'); 
      
      toggleButton.addEventListener('click', () => {
        wrapper.classList.toggle('closed');
        // Redesenha os gr√°ficos para corrigir o tamanho ap√≥s o toggle
        drawAllCharts(); 
      });
    });

    // === L√≥gica dos Gr√°ficos (Google Charts) ===
    google.charts.load('current', {'packages':['corechart', 'bar']});
    // O callback principal agora √© chamado ap√≥s o carregamento bem-sucedido do CSS.

    // Helper para obter vari√°veis CSS, garantindo que as cores do tema sejam usadas nos gr√°ficos
    const getCssVar = (name) => {
        try {
            // Tenta obter do body, onde as vari√°veis do tema est√£o aplicadas
            return getComputedStyle(document.body).getPropertyValue(name).trim();
        } catch (e) {
            // Fallback para cores fixas se a vari√°vel n√£o estiver dispon√≠vel (CSS n√£o carregado)
            if (name === '--color-brand-secondary') return '#0b57d0'; 
            if (name === '--color-brand-primary') return '#ff7a00';
            if (name === '--color-accent-green') return '#16a34a'; 
            if (name === '--color-danger-red') return '#dc2626';
            if (name === '--color-warning-yellow') return '#f59e0b';
            if (name === '--text-color-muted') return '#64748b';
            if (name === '--text-color-primary') return '#0f172a';
            return '#000000'; 
        }
    };

    function drawAllCharts() {
        if (document.getElementById('chart_line')) drawLineChart();
        if (document.getElementById('chart_bar')) drawBarChart();
    }

    function drawLineChart() {
        const data = google.visualization.arrayToDataTable([
            ['M√™s', 'Sa√∫de', 'Educa√ß√£o', 'Transporte'],
            ['Abr', 68, 80, 55], ['Mai', 72, 85, 60], ['Jun', 75, 82, 65], 
            ['Jul', 79, 88, 70], ['Ago', 82, 90, 75], ['Set', 85, 92, 80]
        ]);
        
        const options = {
            hAxis: { title: 'M√™s', textStyle: { color: getCssVar('--text-color-muted') } },
            vAxis: { 
                title: 'Aprova√ß√£o (%)', 
                viewWindow: { min: 50, max: 100 }, 
                format: '#\'%\'', 
                textStyle: { color: getCssVar('--text-color-muted') } 
            },
            legend: { 
                position: 'bottom', 
                textStyle: { color: getCssVar('--text-color-primary')} 
            },
            // Usando cores da marca e feedback do Design System
            colors: [getCssVar('--color-brand-secondary'), getCssVar('--color-brand-primary'), getCssVar('--color-accent-green')],
            chartArea: { width: '90%', height: '70%' },
            backgroundColor: 'transparent',
            animation: { duration: 1000, easing: 'out', startup: true }
        };
        const chart = new google.visualization.LineChart(document.getElementById('chart_line'));
        chart.draw(data, options);
    }

    function drawBarChart() {
        const data = google.visualization.arrayToDataTable([
            ['Secretaria', 'Dias', { role: 'style' }],
            // Usando cores de feedback do Design System
            ['Sa√∫de', 3.5, getCssVar('--color-danger-red')],
            ['Educa√ß√£o', 2.1, getCssVar('--color-accent-green')], 
            ['Tr√¢nsito', 5.8, getCssVar('--color-warning-yellow')],
            ['Urbanismo', 4.2, getCssVar('--color-brand-secondary')]
        ]);

        const options = {
            title: 'Tempo de Resolu√ß√£o (Dias)',
            chartArea: { width: '70%', height: '80%' },
            hAxis: { 
                title: 'Dias para Conclus√£o', 
                minValue: 0, 
                textStyle: { color: getCssVar('--text-color-muted') } 
            },
            vAxis: { 
                textStyle: { color: getCssVar('--text-color-muted') } 
            },
            legend: { position: 'none' },
            backgroundColor: 'transparent',
            animation: { duration: 1000, easing: 'out', startup: true }
        };
        const chart = new google.visualization.BarChart(document.getElementById('chart_bar'));
        chart.draw(data, options);
    }
    
    // Garante que os gr√°ficos sejam redesenhados ao mudar o tamanho da janela
    window.addEventListener('resize', drawAllCharts, false);

    // Tenta for√ßar o fallback caso os eventos onload/onerror n√£o disparem imediatamente (iframe/cache issues)
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (!stylesLoaded) {
                const tempLink = document.getElementById('styles-temp');
                const mainLink = document.getElementById('styles-main');
                
                // Se o temp n√£o carregou, ele provavelmente falhou. For√ßa a verifica√ß√£o do main.
                // N√£o h√° uma maneira limpa de verificar se um stylesheet carregou via JS em todos os cen√°rios sem um evento.
                // A abordagem mais segura √© confiar nos eventos onload/onerror, mas adicionamos um timeout para tentar o fallback visual.
                if (mainLink.sheet) {
                   updateLoadStatus('main');
                } else if (tempLink.sheet) {
                   updateLoadStatus('temp');
                } else {
                   // √öltima chance: se nada carregou, for√ßa o status de erro
                   updateLoadStatus('main', false);
                }
            }
        }, 3000); // 3 segundos para o CSS carregar
    });

  </script>

</body>
</html>
