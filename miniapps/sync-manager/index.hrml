<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniApp - Teste de Sincroniza√ß√£o e Backup</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <link rel="stylesheet" href="../../docs/miniapp-global.css" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
  
  <script src="../../docs/components/app-shared-ui.js"></script>
  <script src="../../docs/components/app-modal-context.js"></script>
  <script src="../../docs/components/app-shared-footer.js"></script>

  <script src="./sync-manager.js"></script> 

  <script async defer src="https://apis.google.com/js/api.js" onload="handleGapiLoad()"></script>

  <meta name="theme-color" content="#020617" />
</head>
<body class="miniapp-shell">
  <main id="sync-test-root" class="miniapp-stage"></main>

  <app-shared-footer show-settings="true" active-tab="settings" state="collapsed"></app-shared-footer>

  <script type="module">
    // --- In√≠cio do C√≥digo JavaScript do Painel de Testes ---
    const ReactLib = window.React;
    const ReactDOMLib = window.ReactDOM;
    const Material = window.MaterialUI;
    const { AppCard, AppButton } = window.AppUI;
    const SyncManager = window.MiniAppSyncManager;

    if (!ReactLib || !ReactDOMLib || !Material || !AppCard || !SyncManager) {
      console.error('Depend√™ncias essenciais n√£o foram carregadas.');
      if (!SyncManager) {
          throw new Error('MiniAppSyncManager n√£o foi carregado. Verifique o caminho "./sync-manager.js".');
      }
      throw new Error('Depend√™ncias React/MUI n√£o carregadas.');
    }

    const {
      useCallback,
      useEffect,
      useMemo,
      useState,
    } = ReactLib;

    const {
      ThemeProvider,
      createTheme,
      CssBaseline,
      Box,
      Container,
      Stack,
      Grid,
      Typography,
      CircularProgress,
      Chip
    } = Material;

    const e = ReactLib.createElement;
    const SETTINGS_BACKUP_KEY = 'BACKUP_ENABLED';
    const SETTINGS_SYNC_KEY = 'SYNC_ENABLED';

    const LOCALE_COPY = Object.freeze({
      'pt-BR': {
        hero: {
          overline: 'MiniApp Teste',
          title: 'Controle de Sincroniza√ß√£o Google',
          description: 'Painel para testar e configurar o backup (upload) e sincroniza√ß√£o multi-dispositivo (download/merge) em sua conta Google.',
        },
        authCard: {
          title: 'Conex√£o Google',
          subtitle: 'Status da Autentica√ß√£o',
          helper: 'Use o bot√£o abaixo para conectar ou desconectar sua conta.',
          connect: 'Conectar Conta Google',
          disconnect: 'Desconectar Conta',
        },
        settingsCard: {
          title: 'Controles de Funcionalidades',
          subtitle: 'Backup e Sincroniza√ß√£o',
          helper: 'Backup apenas envia dados. Sincroniza√ß√£o tamb√©m baixa e mescla dados de outros dispositivos.',
          backup: 'Backup (Upload) Ativo',
          sync: 'Multi-Dispositivo (Download) Ativo',
          activate: 'Ativar',
          deactivate: 'Desativar',
          queue: 'Adicionar Item de Teste √† Fila'
        },
        status: {
            authenticated: '‚úÖ Conectado como: ',
            unauthenticated: '‚ùå Necessita de Conex√£o',
            syncing: 'üîÑ Sincronizando (Fila: ',
            synced: '‚úÖ Sincronizado (0 Pendentes)',
            offline: 'üîå Modo Offline',
            disabled: 'üõë Sincroniza√ß√£o Desativada',
            error: 'üö® Erro: ',
            pending: 'Pendentes na Fila: '
        }
      },
    });

    function getLocaleCopy(language) {
      return LOCALE_COPY[language] || LOCALE_COPY['pt-BR'];
    }

    function SyncControlCard({ copy, status }) {

      const handleAuthToggle = useCallback(() => {
        if (status.authenticated) {
          SyncManager.signOut();
        } else {
          SyncManager.signIn();
        }
      }, [status.authenticated]);
      
      const authButtonDisabled = status.syncState === 'syncing';
      
      const authButtonText = status.authenticated ? copy.disconnect : copy.connect;
      const authButtonTone = status.authenticated ? 'secondary' : 'primary';

      return e(
        AppCard,
        {
          title: copy.title,
          subtitle: copy.subtitle,
          helper: copy.helper,
          sx: { minHeight: 280, height: '100%' },
        },
        e(
          Stack,
          { spacing: 2 },
          e(
            Box,
            null,
            e(Typography, { variant: 'body2', color: 'text.secondary' }, copy.subtitle),
            e(
                Chip,
                {
                    label: status.authenticated 
                        ? `${copy.authenticated} ${status.userId}` 
                        : copy.unauthenticated,
                    color: status.authenticated ? 'success' : 'error',
                    icon: status.authenticated ? e('span', { className: 'material-icons-sharp' }, 'check_circle') : e('span', { className: 'material-icons-sharp' }, 'error')
                }
            )
          ),
          e(
            Stack,
            { direction: 'row', spacing: 1.5, alignItems: 'center' },
            e(AppButton, { 
                tone: authButtonTone, 
                onClick: handleAuthToggle,
                disabled: authButtonDisabled
            }, authButtonText),
            authButtonDisabled ? e(CircularProgress, { size: 24 }) : null
          ),
          e(Typography, { variant: 'caption', color: 'text.secondary' }, 
            `Status: ${status.message}`
          )
        )
      );
    }
    
    function SettingsControlCard({ copy, status, backupEnabled, syncEnabled }) {
        const handleToggle = useCallback(async (key) => {
            const current = (await SyncManager.getUserSetting(key))?.value === true;
            const next = !current;
            await SyncManager.saveUserSetting(key, next);
            // Chama a sincroniza√ß√£o para aplicar a nova regra
            SyncManager.syncPendingChanges();
        }, []);
        
        const handleQueueItem = useCallback(async () => {
            const item = {
                type: 'test-event',
                timestamp: new Date().toISOString(),
                payload: `Teste de fila ${Math.random().toFixed(4)}`
            };
            await SyncManager.queueForSync(item);
            // For√ßa a sincroniza√ß√£o
            SyncManager.syncPendingChanges();
        }, []);

        const controlsDisabled = !status.authenticated || status.syncState === 'syncing';

        return e(
            AppCard,
            {
                title: copy.title,
                subtitle: copy.subtitle,
                helper: copy.helper,
                sx: { minHeight: 280, height: '100%' },
            },
            e(
                Stack,
                { spacing: 2 },
                e(
                    Stack,
                    { direction: 'row', spacing: 1.5, alignItems: 'center' },
                    e(AppButton, { 
                        tone: backupEnabled ? 'success' : 'error', 
                        onClick: () => handleToggle(SETTINGS_BACKUP_KEY),
                        disabled: controlsDisabled
                    }, backupEnabled ? `${copy.deactivate} ${copy.backup}` : `${copy.activate} ${copy.backup}`),
                    e(Chip, { 
                        label: backupEnabled ? 'ATIVO' : 'INATIVO', 
                        color: backupEnabled ? 'success' : 'default',
                        size: 'small'
                    })
                ),
                e(
                    Stack,
                    { direction: 'row', spacing: 1.5, alignItems: 'center' },
                    e(AppButton, { 
                        tone: syncEnabled ? 'success' : 'error', 
                        onClick: () => handleToggle(SETTINGS_SYNC_KEY),
                        disabled: controlsDisabled
                    }, syncEnabled ? `${copy.deactivate} ${copy.sync}` : `${copy.activate} ${copy.sync}`),
                    e(Chip, { 
                        label: syncEnabled ? 'ATIVO' : 'INATIVO', 
                        color: syncEnabled ? 'success' : 'default',
                        size: 'small'
                    })
                ),
                e(
                    AppButton,
                    { tone: 'primary', onClick: handleQueueItem, disabled: controlsDisabled },
                    copy.queue
                ),
                e(Typography, { variant: 'caption', color: 'text.secondary' }, 
                    `${copy.pending} ${status.pending}`
                )
            )
        );
    }


    function SyncManagerTestLayout() {
      const [preferences] = useState(() => ({ theme: 'dark', language: 'pt-BR' }));
      const localeCopy = useMemo(() => getLocaleCopy(preferences.language), [preferences.language]);

      const [status, setStatus] = useState(() => SyncManager.getAuthStatus());
      const [backupEnabled, setBackupEnabled] = useState(false);
      const [syncEnabled, setSyncEnabled] = useState(false);

      const themeMode = preferences.theme === 'light' ? 'light' : 'dark';
      const appTheme = useMemo(
        () =>
          createTheme({
            palette: {
              mode: themeMode,
              primary: { main: '#f97316' },
              secondary: { main: '#0ea5e9' },
              background: {
                default: themeMode === 'light' ? '#f3f4f6' : '#020617',
                paper: themeMode === 'light' ? '#ffffff' : '#0f172a',
              },
            },
            typography: {
              fontFamily:
                '"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
            },
            shape: { borderRadius: 0 },
          }),
        [themeMode]
      );
      
      // Efeito para registrar o listener de status e ler as configura√ß√µes
      useEffect(() => {
          const unsubscribe = SyncManager.registerStatusListener((nextStatus) => {
              setStatus(nextStatus);
              
              // Atualiza os estados dos toggles a partir das configura√ß√µes salvas
              SyncManager.getUserSetting(SETTINGS_BACKUP_KEY).then(s => setBackupEnabled(s?.value === true));
              SyncManager.getUserSetting(SETTINGS_SYNC_KEY).then(s => setSyncEnabled(s?.value === true));
          });
          
          // Carrega os estados iniciais no mount
          SyncManager.getUserSetting(SETTINGS_BACKUP_KEY).then(s => setBackupEnabled(s?.value === true));
          SyncManager.getUserSetting(SETTINGS_SYNC_KEY).then(s => setSyncEnabled(s?.value === true));

          return () => unsubscribe();
      }, []);
      

      return e(
        ThemeProvider,
        { theme: appTheme },
        e(CssBaseline, null),
        e(
          AppModalProvider,
          null,
          e(
            Box,
            { className: 'miniapp-stage', sx: { flex: 1, display: 'flex' } },
            e(
              Container,
              {
                maxWidth: 'lg',
                disableGutters: true,
                sx: {
                  flex: 1,
                  display: 'flex',
                  flexDirection: 'column',
                  gap: 3,
                  py: { xs: 2, md: 3 },
                },
              },
              e(
                Stack,
                { spacing: 3, sx: { flex: 1 } },
                e(
                  Box,
                  { sx: { mb: 1 } },
                  e(
                    Typography,
                    {
                      variant: 'overline',
                      color: 'text.secondary',
                      sx: { letterSpacing: 1 },
                    },
                    localeCopy.hero.overline
                  ),
                  e(
                    Typography,
                    { variant: 'h5', sx: { mt: 0.5 } },
                    localeCopy.hero.title
                  ),
                  e(
                    Typography,
                    { variant: 'body2', color: 'text.secondary', sx: { mt: 0.5 } },
                    localeCopy.hero.description
                  )
                ),
                e(
                  Grid,
                  { container: true, spacing: 3 },
                  e(
                    Grid,
                    { item: true, xs: 12, md: 6 },
                    e(SyncControlCard, {
                      copy: { ...localeCopy.authCard, status: localeCopy.status },
                      status,
                    })
                  ),
                  e(
                    Grid,
                    { item: true, xs: 12, md: 6 },
                    e(SettingsControlCard, {
                      copy: { ...localeCopy.settingsCard, status: localeCopy.status },
                      status,
                      backupEnabled,
                      syncEnabled,
                    })
                  )
                ),
                e(
                    Box,
                    { sx: { minHeight: 24, mt: 3 } },
                    e(Typography, { variant: 'caption', color: 'text.secondary' }, 
                        `Status Geral: ${status.syncState} | √öltima Mensagem: ${status.message}`
                    )
                )
              )
            )
          )
        )
      );
    }

    ReactDOMLib.createRoot(document.getElementById('sync-test-root')).render(
      e(SyncManagerTestLayout)
    );
    // --- Fim do C√≥digo JavaScript do Painel de Testes ---
  </script>
</body>
</html>
