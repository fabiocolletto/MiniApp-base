<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniApp - Gestão de Catálogo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <link rel="stylesheet" href="../../docs/miniapp-global.css">
    <link rel="stylesheet" href="../../docs/miniapp-card.css">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
    <script src="../../docs/components/app-shared-ui.js"></script>
    <script src="../../docs/components/app-modal-context.js"></script>

    <meta name="theme-color" content="#f3f4f6">
</head>
<body class="miniapp-shell">
    <main id="catalog-root" class="miniapp-stage"></main>

    <script type="module">
        import { loadMiniAppData } from '../../js/miniapp-data-loader.js';

        const ReactLib = window.React;
        const ReactDOMLib = window.ReactDOM;
        const Material = window.MaterialUI;
        const { AppCard, AppButton, AppSection } = window.AppUI;
        const { AppModalProvider, useAppModal } = window.AppModalContext;

        if (!ReactLib || !ReactDOMLib || !Material || !AppCard || !AppModalProvider) {
            throw new Error('Dependências essenciais não foram carregadas para o MiniApp de Catálogo.');
        }

        const {
            useMemo,
            Fragment,
            useEffect,
            useState,
        } = ReactLib;
        const {
            ThemeProvider,
            createTheme,
            CssBaseline,
            Box,
            Button,
            Chip,
            Container,
            Grid,
            Stack,
            Typography,
            Avatar,
            Divider,
            List,
            ListItem,
            ListItemText,
            Snackbar,
            Alert,
            Skeleton,
        } = Material;

        const e = ReactLib.createElement;

        const STATUS_PROPS = {
            published: { label: 'Publicado', color: 'success' },
            draft: { label: 'Em rascunho', color: 'warning' },
            'em revisão': { label: 'Em revisão', color: 'info' },
            manutenção: { label: 'Manutenção', color: 'default' },
        };

        function CatalogCard({ app }) {
            const modal = useAppModal();
            const statusProps = STATUS_PROPS[app.status] || { label: app.status, color: 'default' };

            const openDetails = () => {
                modal.openDialog({
                    title: app.title,
                    maxWidth: 'sm',
                    content: () => e(
                        Stack,
                        { spacing: 2, sx: { pt: 1 } },
                        e(Typography, { variant: 'body2', color: 'text.secondary' }, app.description),
                        e(Divider, null),
                        e(List, { dense: true, disablePadding: true },
                            e(ListItem, { disableGutters: true },
                                e(ListItemText, { primary: 'Categoria', secondary: app.category })
                            ),
                            e(ListItem, { disableGutters: true },
                                e(ListItemText, { primary: 'Contrato', secondary: app.contract })
                            ),
                            e(ListItem, { disableGutters: true },
                                e(ListItemText, { primary: 'Responsável', secondary: app.owner })
                            )
                        )
                    ),
                    actions: ({ closeDialog }) => e(Fragment, null,
                        e(Button, { onClick: closeDialog }, 'Fechar')
                    ),
                });
            };

            return e(
                AppCard,
                {
                    title: app.title,
                    subtitle: app.category,
                    helper: app.description,
                    sx: { minHeight: 320 },
                    actions: e(Chip, { label: statusProps.label, color: statusProps.color === 'default' ? undefined : statusProps.color, variant: 'outlined' }),
                },
                e(
                    Stack,
                    { spacing: 2 },
                    e(Stack, { direction: 'row', spacing: 1.5, alignItems: 'center' },
                        e(Avatar, { children: app.title.slice(0, 1) }),
                        e('div', null,
                            e(Typography, { variant: 'body2', color: 'text.secondary' }, 'Contrato'),
                            e(Typography, { variant: 'h6' }, app.contract)
                        )
                    ),
                    e(Divider, null),
                    e(Stack, { direction: { xs: 'column', sm: 'row' }, spacing: 1.5 },
                        e(AppButton, { tone: 'primary', component: 'a', href: app.url }, 'Abrir MiniApp'),
                        e(AppButton, { tone: 'ghost', onClick: openDetails }, 'Detalhes')
                    )
                )
            );
        }

        function useCatalogData() {
            const [items, setItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');

            useEffect(() => {
                let isMounted = true;

                async function fetchData() {
                    setIsLoading(true);
                    try {
                        const data = await loadMiniAppData();
                        if (!isMounted) {
                            return;
                        }
                        if (Array.isArray(data)) {
                            setItems(data);
                        } else {
                            setItems([]);
                        }
                        setErrorMessage('');
                    } catch (error) {
                        console.error('Falha ao carregar miniapp-data.js', error);
                        if (!isMounted) {
                            return;
                        }
                        setItems([]);
                        setErrorMessage(error?.message || 'Não foi possível carregar o catálogo.');
                    } finally {
                        if (isMounted) {
                            setIsLoading(false);
                        }
                    }
                }

                fetchData();

                return () => {
                    isMounted = false;
                };
            }, []);

            return { items, isLoading, errorMessage, setErrorMessage };
        }

        function useIframeHeightBridge() {
            useEffect(() => {
                if (typeof window === 'undefined' || window.parent === window) {
                    return undefined;
                }

                const target = document.querySelector('.miniapp-stage');
                if (!target) {
                    return undefined;
                }

                let lastHeight = 0;
                let rafId = null;

                const postHeight = () => {
                    rafId = null;
                    const height = Math.ceil(target.scrollHeight);
                    if (!height || height === lastHeight) {
                        return;
                    }
                    lastHeight = height;
                    window.parent.postMessage({
                        type: 'catalog:height',
                        sourceId: 'catalog',
                        height,
                    }, '*');
                };

                const schedulePost = () => {
                    if (rafId !== null) {
                        return;
                    }
                    rafId = window.requestAnimationFrame(postHeight);
                };

                const observer = typeof ResizeObserver !== 'undefined'
                    ? new ResizeObserver(() => schedulePost())
                    : null;

                if (observer) {
                    observer.observe(target);
                }

                schedulePost();
                window.addEventListener('load', schedulePost);

                return () => {
                    window.removeEventListener('load', schedulePost);
                    if (observer) {
                        observer.disconnect();
                    }
                    if (rafId !== null) {
                        window.cancelAnimationFrame(rafId);
                    }
                };
            }, []);
        }

        function CatalogApp() {
            const theme = useMemo(() => createTheme({
                palette: {
                    mode: 'light',
                    primary: { main: '#f97316' },
                    secondary: { main: '#0ea5e9' },
                    background: {
                        default: '#f3f4f6',
                        paper: '#ffffff',
                    },
                },
                typography: {
                    fontFamily: '"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                },
                shape: { borderRadius: 24 },
            }), []);

            const { items, isLoading, errorMessage, setErrorMessage } = useCatalogData();
            useIframeHeightBridge();

            const loadingPlaceholders = useMemo(() => Array.from({ length: 6 }, (_, index) => index), []);

            let sectionContent;
            if (isLoading) {
                sectionContent = e(
                    Grid,
                    { container: true, spacing: 2 },
                    loadingPlaceholders.map((placeholder) => e(
                        Grid,
                        { item: true, xs: 12, sm: 6, md: 4, key: `placeholder-${placeholder}` },
                        e(
                            AppCard,
                            { title: '', subtitle: '', helper: '', sx: { minHeight: 320 } },
                            e(
                                Stack,
                                { spacing: 2 },
                                e(Skeleton, { variant: 'text', height: 32, width: '70%' }),
                                e(Skeleton, { variant: 'text', height: 20, width: '100%' }),
                                e(Skeleton, { variant: 'rectangular', height: 120, width: '100%', sx: { borderRadius: 3 } }),
                                e(Skeleton, { variant: 'rectangular', height: 48, width: '100%', sx: { borderRadius: 3 } })
                            )
                        )
                    ))
                );
            } else if (items.length === 0) {
                sectionContent = e(
                    Box,
                    { sx: { width: '100%', display: 'flex', justifyContent: 'center', py: 4 } },
                    e(
                        'div',
                        { className: 'miniapp-card empty-state', style: { maxWidth: 420, width: '100%' } },
                        e(
                            'div',
                            { className: 'placeholder-content' },
                            e('p', { className: 'placeholder-label' }, 'Catálogo em criação'),
                            e('p', { className: 'placeholder-description' }, 'Os MiniApps oficiais estão em desenvolvimento.')
                        )
                    )
                );
            } else {
                sectionContent = e(
                    Grid,
                    { container: true, spacing: 2 },
                    items.map((app) => e(Grid, { item: true, xs: 12, sm: 6, md: 4, key: app.id || app.title }, e(CatalogCard, { app })))
                );
            }

            const handleCloseError = (_, reason) => {
                if (reason === 'clickaway') {
                    return;
                }
                setErrorMessage('');
            };

            return e(
                ThemeProvider,
                { theme },
                e(CssBaseline, null),
                e(
                    AppModalProvider,
                    null,
                    e(
                        Box,
                        { className: 'miniapp-stage', sx: { flex: 1 } },
                        e(
                            Container,
                            { maxWidth: 'lg', sx: { py: { xs: 3, md: 5 }, display: 'flex', flexDirection: 'column', gap: 4 } },
                            e(
                                Stack,
                                { spacing: 1.25 },
                                e(Typography, { variant: 'overline', color: 'text.secondary' }, 'MiniApp Catálogo'),
                                e(Typography, { variant: 'h4', component: 'h1' }, 'Gestão de MiniApps em desenvolvimento'),
                                e(Typography, { color: 'text.secondary' }, 'Todos os cards abaixo utilizam o AppCard e seguem o grid responsivo do MUI.')
                            ),
                            e(
                                AppSection,
                                { title: 'MiniApps ativos', description: 'A lista reflete o estado atual do RodaPack.' },
                                sectionContent
                            )
                        )
                    )
                ),
                e(
                    Snackbar,
                    {
                        open: Boolean(errorMessage),
                        autoHideDuration: 6000,
                        onClose: handleCloseError,
                        anchorOrigin: { vertical: 'bottom', horizontal: 'center' },
                    },
                    errorMessage
                        ? e(Alert, { severity: 'error', variant: 'filled', onClose: handleCloseError }, errorMessage)
                        : null
                )
            );
        }

        ReactDOMLib.createRoot(document.getElementById('catalog-root')).render(e(CatalogApp));
    </script>
</body>
</html>
