<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniApp - Gestão de Catálogo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <link rel="stylesheet" href="../../docs/miniapp-global.css">
    <link rel="stylesheet" href="../../docs/miniapp-card.css">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
    <script src="../../docs/components/app-shared-ui.js"></script>
    <script src="../../docs/components/app-modal-context.js"></script>

    <meta name="theme-color" content="#f3f4f6">
</head>
<body class="miniapp-shell">
    <main id="catalog-root" class="miniapp-stage"></main>

    <script type="module">
        import { loadMiniAppData } from '../../js/miniapp-data-loader.js';

        const ReactLib = window.React;
        const ReactDOMLib = window.ReactDOM;
        const Material = window.MaterialUI;
        const { AppCard, AppButton, AppSection } = window.AppUI;
        const { AppModalProvider, useAppModal } = window.AppModalContext;

        if (!ReactLib || !ReactDOMLib || !Material || !AppCard || !AppModalProvider) {
            throw new Error('Dependências essenciais não foram carregadas para o MiniApp de Catálogo.');
        }

        const {
            useMemo,
            Fragment,
            useEffect,
            useState,
        } = ReactLib;
        const {
            ThemeProvider,
            createTheme,
            CssBaseline,
            Box,
            Button,
            Chip,
            Container,
            Grid,
            Stack,
            Typography,
            Avatar,
            Divider,
            List,
            ListItem,
            ListItemText,
            Snackbar,
            Alert,
            Skeleton,
        } = Material;

        const e = ReactLib.createElement;

        const GLOBAL_PREFERENCES_MESSAGE_TYPE = 'miniapp:global-preferences';
        const GLOBAL_PREFERENCES_STORAGE_KEY = 'miniapp:settings:global-preferences';
        const SUPPORTED_LANGUAGES = ['pt-BR', 'en-US', 'es-ES'];
        const DEFAULT_GLOBAL_PREFERENCES = Object.freeze({ theme: 'light', language: 'pt-BR' });
        const PREFERRED_COLOR_SCHEME_QUERY = '(prefers-color-scheme: dark)';
        const MINIAPP_SOURCE_ID = 'catalog';

        const CATALOG_COPY = Object.freeze({
            'pt-BR': Object.freeze({
                meta: Object.freeze({ pageTitle: 'MiniApp - Gestão de Catálogo' }),
                hero: Object.freeze({
                    overline: 'MiniApp Catálogo',
                    title: 'Gestão de MiniApps em desenvolvimento',
                    description: 'Todos os cards abaixo utilizam o AppCard e seguem o grid responsivo do MUI.'
                }),
                sections: Object.freeze({
                    activeTitle: 'MiniApps ativos',
                    activeDescription: 'A lista reflete o estado atual do RodaPack.'
                }),
                status: Object.freeze({
                    published: 'Publicado',
                    draft: 'Em rascunho',
                    review: 'Em revisão',
                    maintenance: 'Manutenção'
                }),
                fields: Object.freeze({
                    category: 'Categoria',
                    contract: 'Contrato',
                    owner: 'Responsável'
                }),
                buttons: Object.freeze({
                    open: 'Abrir MiniApp',
                    details: 'Detalhes',
                    close: 'Fechar'
                }),
                placeholders: Object.freeze({
                    emptyTitle: 'Catálogo em criação',
                    emptyDescription: 'Os MiniApps oficiais estão em desenvolvimento.'
                }),
                errors: Object.freeze({
                    load: 'Não foi possível carregar o catálogo.'
                })
            }),
            'en-US': Object.freeze({
                meta: Object.freeze({ pageTitle: 'MiniApp - Catalog Management' }),
                hero: Object.freeze({
                    overline: 'Catalog MiniApp',
                    title: 'Managing MiniApps in development',
                    description: 'All cards below use AppCard and follow the responsive MUI grid.'
                }),
                sections: Object.freeze({
                    activeTitle: 'Active MiniApps',
                    activeDescription: 'The list reflects the current RodaPack state.'
                }),
                status: Object.freeze({
                    published: 'Published',
                    draft: 'Draft',
                    review: 'In review',
                    maintenance: 'Maintenance'
                }),
                fields: Object.freeze({
                    category: 'Category',
                    contract: 'Contract',
                    owner: 'Owner'
                }),
                buttons: Object.freeze({
                    open: 'Open MiniApp',
                    details: 'Details',
                    close: 'Close'
                }),
                placeholders: Object.freeze({
                    emptyTitle: 'Catalog in progress',
                    emptyDescription: 'The official MiniApps are under development.'
                }),
                errors: Object.freeze({
                    load: 'Could not load the catalog.'
                })
            }),
            'es-ES': Object.freeze({
                meta: Object.freeze({ pageTitle: 'MiniApp - Gestión de Catálogo' }),
                hero: Object.freeze({
                    overline: 'MiniApp Catálogo',
                    title: 'Gestión de MiniApps en desarrollo',
                    description: 'Todas las tarjetas utilizan AppCard y siguen la cuadrícula responsiva de MUI.'
                }),
                sections: Object.freeze({
                    activeTitle: 'MiniApps activos',
                    activeDescription: 'La lista refleja el estado actual de RodaPack.'
                }),
                status: Object.freeze({
                    published: 'Publicado',
                    draft: 'En borrador',
                    review: 'En revisión',
                    maintenance: 'Mantenimiento'
                }),
                fields: Object.freeze({
                    category: 'Categoría',
                    contract: 'Contrato',
                    owner: 'Responsable'
                }),
                buttons: Object.freeze({
                    open: 'Abrir MiniApp',
                    details: 'Detalles',
                    close: 'Cerrar'
                }),
                placeholders: Object.freeze({
                    emptyTitle: 'Catálogo en creación',
                    emptyDescription: 'Los MiniApps oficiales están en desarrollo.'
                }),
                errors: Object.freeze({
                    load: 'No se pudo cargar el catálogo.'
                })
            }),
        });

        const STATUS_VARIANTS = {
            published: { color: 'success', matchers: ['published', 'publicado'] },
            draft: { color: 'warning', matchers: ['draft', 'em rascunho', 'rascunho'] },
            review: { color: 'info', matchers: ['review', 'em revisao', 'revisao', 'em revisão'] },
            maintenance: { color: 'default', matchers: ['maintenance', 'manutencao', 'manutenção'] },
        };

        function normalizeLanguage(language) {
            return SUPPORTED_LANGUAGES.includes(language) ? language : DEFAULT_GLOBAL_PREFERENCES.language;
        }

        function normalizeThemePreference(theme) {
            if (theme === 'dark') return 'dark';
            if (theme === 'system') return 'system';
            return 'light';
        }

        function normalizeResolvedTheme(theme) {
            return theme === 'dark' ? 'dark' : 'light';
        }

        function resolveEffectiveTheme(themePreference, systemTheme) {
            const normalized = normalizeThemePreference(themePreference);
            if (normalized === 'system') {
                return normalizeResolvedTheme(systemTheme);
            }
            return normalizeResolvedTheme(normalized);
        }

        function getSystemTheme() {
            if (typeof window === 'undefined' || typeof window.matchMedia !== 'function') {
                return 'light';
            }
            try {
                const media = window.matchMedia(PREFERRED_COLOR_SCHEME_QUERY);
                return media.matches ? 'dark' : 'light';
            } catch (error) {
                console.warn('Não foi possível identificar o tema do sistema. Aplicando tema claro.', error);
                return 'light';
            }
        }

        function safeParsePreferences(rawValue) {
            if (!rawValue) return null;
            try {
                return JSON.parse(rawValue);
            } catch (error) {
                console.warn('Preferências inválidas foram descartadas.', error);
                return null;
            }
        }

        function normalizePreferences(preferences) {
            if (!preferences) {
                return { ...DEFAULT_GLOBAL_PREFERENCES };
            }
            return {
                theme: normalizeThemePreference(preferences.theme),
                language: normalizeLanguage(preferences.language),
            };
        }

        function readStoredPreferences() {
            try {
                const rawValue = window.localStorage?.getItem(GLOBAL_PREFERENCES_STORAGE_KEY);
                const parsed = safeParsePreferences(rawValue);
                return normalizePreferences(parsed);
            } catch (error) {
                console.warn('Não foi possível ler preferências globais do armazenamento.', error);
                return { ...DEFAULT_GLOBAL_PREFERENCES };
            }
        }

        function getCatalogCopy(language) {
            return CATALOG_COPY[language] || CATALOG_COPY['pt-BR'];
        }

        function normalizeStatusText(status) {
            return (status || '')
                .toString()
                .toLowerCase()
                .trim()
                .normalize('NFD')
                .replace(/\p{Diacritic}/gu, '');
        }

        function resolveStatusProps(status, statusCopy) {
            const normalized = normalizeStatusText(status);
            const fallback = { label: status || '', color: 'default' };
            if (!normalized) {
                return fallback;
            }
            const matchedEntry = Object.entries(STATUS_VARIANTS).find(([, value]) =>
                value.matchers.some((matcher) => normalizeStatusText(matcher) === normalized)
            );
            if (!matchedEntry) {
                return fallback;
            }
            const [key, value] = matchedEntry;
            return {
                label: statusCopy?.[key] || fallback.label || key,
                color: value.color === 'default' ? undefined : value.color,
            };
        }

        function CatalogCard({ app, copy }) {
            const modal = useAppModal();
            const statusProps = resolveStatusProps(app.status, copy.status);

            const openDetails = () => {
                modal.openDialog({
                    title: app.title,
                    maxWidth: 'sm',
                    content: () => e(
                        Stack,
                        { spacing: 2, sx: { pt: 1 } },
                        e(Typography, { variant: 'body2', color: 'text.secondary' }, app.description),
                        e(Divider, null),
                        e(List, { dense: true, disablePadding: true },
                            e(ListItem, { disableGutters: true },
                                e(ListItemText, { primary: copy.fields.category, secondary: app.category })
                            ),
                            e(ListItem, { disableGutters: true },
                                e(ListItemText, { primary: copy.fields.contract, secondary: app.contract })
                            ),
                            e(ListItem, { disableGutters: true },
                                e(ListItemText, { primary: copy.fields.owner, secondary: app.owner })
                            )
                        )
                    ),
                    actions: ({ closeDialog }) => e(Fragment, null,
                        e(Button, { onClick: closeDialog }, copy.buttons.close)
                    ),
                });
            };

            return e(
                AppCard,
                {
                    title: app.title,
                    subtitle: app.category,
                    helper: app.description,
                    sx: { minHeight: 320 },
                    actions: e(Chip, { label: statusProps.label, color: statusProps.color === 'default' ? undefined : statusProps.color, variant: 'outlined' }),
                },
                e(
                    Stack,
                    { spacing: 2 },
                    e(Stack, { direction: 'row', spacing: 1.5, alignItems: 'center' },
                        e(Avatar, { children: app.title.slice(0, 1) }),
                        e('div', null,
                            e(Typography, { variant: 'body2', color: 'text.secondary' }, copy.fields.contract),
                            e(Typography, { variant: 'h6' }, app.contract)
                        )
                    ),
                    e(Divider, null),
                    e(Stack, { direction: { xs: 'column', sm: 'row' }, spacing: 1.5 },
                        e(AppButton, { tone: 'primary', component: 'a', href: app.url }, copy.buttons.open),
                        e(AppButton, { tone: 'ghost', onClick: openDetails }, copy.buttons.details)
                    )
                )
            );
        }

        function useCatalogData(fallbackErrorMessage) {
            const [items, setItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');
            const [usedFallbackMessage, setUsedFallbackMessage] = useState(false);

            useEffect(() => {
                let isMounted = true;

                async function fetchData() {
                    setIsLoading(true);
                    try {
                        const data = await loadMiniAppData();
                        if (!isMounted) {
                            return;
                        }
                        if (Array.isArray(data)) {
                        setItems(data);
                    } else {
                        setItems([]);
                    }
                    setErrorMessage('');
                    setUsedFallbackMessage(false);
                } catch (error) {
                    console.error('Falha ao carregar miniapp-data.js', error);
                    if (!isMounted) {
                        return;
                    }
                    const nextMessage = error?.message || fallbackErrorMessage || '';
                    setItems([]);
                    setErrorMessage(nextMessage);
                    setUsedFallbackMessage(!error?.message);
                } finally {
                    if (isMounted) {
                        setIsLoading(false);
                        }
                    }
                }

                fetchData();

                return () => {
                    isMounted = false;
                };
            }, []);

            useEffect(() => {
                if (usedFallbackMessage && errorMessage && fallbackErrorMessage) {
                    setErrorMessage(fallbackErrorMessage);
                }
            }, [fallbackErrorMessage, usedFallbackMessage, errorMessage]);

            return { items, isLoading, errorMessage, setErrorMessage };
        }

        function useIframeHeightBridge() {
            useEffect(() => {
                if (typeof window === 'undefined' || window.parent === window) {
                    return undefined;
                }

                const target = document.querySelector('.miniapp-stage');
                if (!target) {
                    return undefined;
                }

                let lastHeight = 0;
                let rafId = null;

                const postHeight = () => {
                    rafId = null;
                    const height = Math.ceil(target.scrollHeight);
                    if (!height || height === lastHeight) {
                        return;
                    }
                    lastHeight = height;
                    window.parent.postMessage({
                        type: 'catalog:height',
                        sourceId: MINIAPP_SOURCE_ID,
                        height,
                    }, '*');
                };

                const schedulePost = () => {
                    if (rafId !== null) {
                        return;
                    }
                    rafId = window.requestAnimationFrame(postHeight);
                };

                const observer = typeof ResizeObserver !== 'undefined'
                    ? new ResizeObserver(() => schedulePost())
                    : null;

                if (observer) {
                    observer.observe(target);
                }

                schedulePost();
                window.addEventListener('load', schedulePost);

                return () => {
                    window.removeEventListener('load', schedulePost);
                    if (observer) {
                        observer.disconnect();
                    }
                    if (rafId !== null) {
                        window.cancelAnimationFrame(rafId);
                    }
                };
            }, []);
        }

        function CatalogApp() {
            const [preferences, setPreferences] = useState(() => readStoredPreferences());
            const [systemTheme, setSystemTheme] = useState(() => getSystemTheme());

            const effectiveTheme = useMemo(
                () => resolveEffectiveTheme(preferences.theme, systemTheme),
                [preferences.theme, systemTheme]
            );

            const catalogCopy = useMemo(
                () => getCatalogCopy(preferences.language),
                [preferences.language]
            );

            const theme = useMemo(() => {
                const mode = effectiveTheme;
                const isDark = mode === 'dark';
                return createTheme({
                    palette: {
                        mode,
                        primary: { main: '#f97316' },
                        secondary: { main: '#0ea5e9' },
                        background: {
                            default: isDark ? '#020617' : '#f3f4f6',
                            paper: isDark ? '#0f172a' : '#ffffff',
                        },
                        text: {
                            primary: isDark ? '#f8fafc' : '#0f172a',
                            secondary: isDark ? '#94a3b8' : '#475569',
                        },
                    },
                    typography: {
                        fontFamily: '"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                    },
                    shape: { borderRadius: 24 },
                });
            }, [effectiveTheme]);

            const { items, isLoading, errorMessage, setErrorMessage } = useCatalogData(catalogCopy.errors.load);
            useIframeHeightBridge();

            useEffect(() => {
                const html = document.documentElement;
                if (html) {
                    html.setAttribute('data-theme', effectiveTheme);
                    html.setAttribute('lang', preferences.language);
                }
                const metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) {
                    metaTheme.setAttribute('content', effectiveTheme === 'dark' ? '#020617' : '#f3f4f6');
                }
                document.title = catalogCopy.meta.pageTitle;
            }, [effectiveTheme, preferences.language, catalogCopy.meta.pageTitle]);

            useEffect(() => {
                try {
                    window.localStorage?.setItem(GLOBAL_PREFERENCES_STORAGE_KEY, JSON.stringify(preferences));
                } catch (error) {
                    console.warn('Não foi possível salvar preferências locais do catálogo.', error);
                }
            }, [preferences]);

            useEffect(() => {
                if (typeof window === 'undefined' || typeof window.matchMedia !== 'function') {
                    return undefined;
                }
                const mediaQuery = window.matchMedia(PREFERRED_COLOR_SCHEME_QUERY);
                const handleSystemChange = (event) => {
                    const isDark = typeof event?.matches === 'boolean' ? event.matches : mediaQuery.matches;
                    setSystemTheme(isDark ? 'dark' : 'light');
                };
                handleSystemChange(mediaQuery);
                if (typeof mediaQuery.addEventListener === 'function') {
                    mediaQuery.addEventListener('change', handleSystemChange);
                    return () => mediaQuery.removeEventListener('change', handleSystemChange);
                }
                mediaQuery.addListener(handleSystemChange);
                return () => mediaQuery.removeListener(handleSystemChange);
            }, []);

            useEffect(() => {
                function handleIncomingPreferences(nextPreferences) {
                    const normalized = normalizePreferences(nextPreferences);
                    setPreferences((current) => {
                        if (current.theme === normalized.theme && current.language === normalized.language) {
                            return current;
                        }
                        return normalized;
                    });
                }

                function handleMessage(event) {
                    const payload = event.data;
                    if (!payload || typeof payload !== 'object' || payload.type !== GLOBAL_PREFERENCES_MESSAGE_TYPE) {
                        return;
                    }
                    handleIncomingPreferences(payload.detail?.preferences || payload.preferences);
                }

                function handleCustomEvent(event) {
                    const detail = event.detail || {};
                    handleIncomingPreferences(detail.preferences || detail);
                }

                function handleStorage(event) {
                    if (event.key !== GLOBAL_PREFERENCES_STORAGE_KEY) {
                        return;
                    }
                    const parsed = safeParsePreferences(event.newValue);
                    handleIncomingPreferences(parsed || DEFAULT_GLOBAL_PREFERENCES);
                }

                window.addEventListener('message', handleMessage);
                window.addEventListener(GLOBAL_PREFERENCES_MESSAGE_TYPE, handleCustomEvent);
                window.addEventListener('storage', handleStorage);
                return () => {
                    window.removeEventListener('message', handleMessage);
                    window.removeEventListener(GLOBAL_PREFERENCES_MESSAGE_TYPE, handleCustomEvent);
                    window.removeEventListener('storage', handleStorage);
                };
            }, []);

            const loadingPlaceholders = useMemo(() => Array.from({ length: 6 }, (_, index) => index), []);

            let sectionContent;
            if (isLoading) {
                sectionContent = e(
                    Grid,
                    { container: true, spacing: 2 },
                    loadingPlaceholders.map((placeholder) => e(
                        Grid,
                        { item: true, xs: 12, sm: 6, md: 4, key: `placeholder-${placeholder}` },
                        e(
                            AppCard,
                            { title: '', subtitle: '', helper: '', sx: { minHeight: 320 } },
                            e(
                                Stack,
                                { spacing: 2 },
                                e(Skeleton, { variant: 'text', height: 32, width: '70%' }),
                                e(Skeleton, { variant: 'text', height: 20, width: '100%' }),
                                e(Skeleton, { variant: 'rectangular', height: 120, width: '100%', sx: { borderRadius: 3 } }),
                                e(Skeleton, { variant: 'rectangular', height: 48, width: '100%', sx: { borderRadius: 3 } })
                            )
                        )
                    ))
                );
            } else if (items.length === 0) {
                sectionContent = e(
                    Box,
                    { sx: { width: '100%', display: 'flex', justifyContent: 'center', py: 4 } },
                    e(
                        'div',
                        { className: 'miniapp-card empty-state', style: { maxWidth: 420, width: '100%' } },
                        e(
                            'div',
                            { className: 'placeholder-content' },
                            e('p', { className: 'placeholder-label' }, catalogCopy.placeholders.emptyTitle),
                            e('p', { className: 'placeholder-description' }, catalogCopy.placeholders.emptyDescription)
                        )
                    )
                );
            } else {
                sectionContent = e(
                    Grid,
                    { container: true, spacing: 2 },
                    items.map((app) => e(Grid, { item: true, xs: 12, sm: 6, md: 4, key: app.id || app.title }, e(CatalogCard, { app, copy: catalogCopy })))
                );
            }

            const handleCloseError = (_, reason) => {
                if (reason === 'clickaway') {
                    return;
                }
                setErrorMessage('');
            };

            return e(
                ThemeProvider,
                { theme },
                e(CssBaseline, null),
                e(
                    AppModalProvider,
                    null,
                    e(
                        Box,
                        { className: 'miniapp-stage', sx: { flex: 1 } },
                        e(
                            Container,
                            { maxWidth: 'lg', sx: { py: { xs: 3, md: 5 }, display: 'flex', flexDirection: 'column', gap: 4 } },
                        e(
                            Stack,
                            { spacing: 1.25 },
                            e(Typography, { variant: 'overline', color: 'text.secondary' }, catalogCopy.hero.overline),
                            e(Typography, { variant: 'h4', component: 'h1' }, catalogCopy.hero.title),
                            e(Typography, { color: 'text.secondary' }, catalogCopy.hero.description)
                        ),
                        e(
                            AppSection,
                            { title: catalogCopy.sections.activeTitle, description: catalogCopy.sections.activeDescription },
                            sectionContent
                        )
                    )
                    )
                ),
                e(
                    Snackbar,
                    {
                        open: Boolean(errorMessage),
                        autoHideDuration: 6000,
                        onClose: handleCloseError,
                        anchorOrigin: { vertical: 'bottom', horizontal: 'center' },
                    },
                    errorMessage
                        ? e(Alert, { severity: 'error', variant: 'filled', onClose: handleCloseError }, errorMessage)
                        : null
                )
            );
        }

        ReactDOMLib.createRoot(document.getElementById('catalog-root')).render(e(CatalogApp));
    </script>
</body>
</html>
