<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniApp - Admin Mercado Pago</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />

  <link rel="stylesheet" href="../../docs/miniapp-global.css" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/react@11.11.1/dist/emotion-react.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>

  <script src="../../docs/components/app-shared-ui.js"></script>
  <script src="../../docs/components/app-modal-context.js"></script>
  <script type="module" src="../../docs/components/app-shared-footer.js"></script>

  <meta name="theme-color" content="#020617" />
</head>
<body class="miniapp-shell">
  <main id="payments-admin-root" class="miniapp-stage"></main>

  <app-shared-footer show-settings="true" active-tab="settings" state="collapsed"></app-shared-footer>

  <script type="module">
    const ReactLib = window.React;
    const ReactDOMLib = window.ReactDOM;
    const Material = window.MaterialUI;
    const { AppCard, AppButton } = window.AppUI;
    const { AppModalProvider } = window.AppModalContext;

    if (!ReactLib || !ReactDOMLib || !Material || !AppCard || !AppModalProvider) {
      throw new Error('Dependências essenciais não foram carregadas para o MiniApp Admin Mercado Pago.');
    }

    const {
      useCallback,
      useEffect,
      useMemo,
      useState,
      Fragment,
    } = ReactLib;

    const {
      ThemeProvider,
      createTheme,
      CssBaseline,
      Box,
      Container,
      Stack,
      Grid,
      Typography,
      TextField,
      Button,
      Chip,
      LinearProgress,
      Table,
      TableBody,
      TableCell,
      TableContainer,
      TableHead,
      TableRow,
      Paper,
    } = Material;

    const STORAGE_KEY = 'mp_admin_panel_config_v1';

    const LOCALE_COPY = Object.freeze({
      'pt-BR': {
        hero: {
          overline: 'MiniApp Admin',
          title: 'Painel financeiro Mercado Pago',
          description: 'Configure a planilha de pagamentos e acompanhe o fluxo financeiro gerado pelo gateway.',
        },
        configCard: {
          title: 'Configuração do painel',
          subtitle: 'Planilha de pagamentos',
          helper: 'Informe os dados da planilha do Google Sheets utilizada pelo Apps Script para registrar os pagamentos.',
          operatorLabel: 'Nome do operador / empresa',
          operatorPlaceholder: 'Ex.: 5 Horas – Pesquisa e Análise',
          sheetIdLabel: 'Sheet ID (Google Sheets)',
          sheetIdPlaceholder: 'ID da planilha (entre /d/ e /edit)',
          sheetNameLabel: 'Aba da planilha',
          sheetNamePlaceholder: 'Ex.: pagamentos',
          save: 'Salvar configuração',
          reload: 'Recarregar configuração',
          loadData: 'Atualizar dados',
          saved: 'Configuração salva com sucesso.',
          loaded: 'Configuração carregada.',
          missing: 'Informe o Sheet ID e salve a configuração antes de carregar os dados.',
        },
        metricsCard: {
          title: 'Resumo financeiro',
          subtitle: 'Visão geral dos registros',
          helper: 'Os dados são lidos diretamente da planilha configurada.',
          totalRecords: 'Total de registros',
          approvedCount: 'Pagamentos aprovados',
          approvedValue: 'Valor aprovado',
          pendingCount: 'Pendentes / em processamento',
          otherStatus: 'Outros status',
          lastUpdate: 'Atualizado em',
          noUpdate: 'Sem atualização ainda',
        },
        tableCard: {
          title: 'Histórico de pagamentos',
          subtitle: 'Dados brutos da planilha',
          empty: 'Nenhum dado encontrado na planilha.',
        },
        status: {
          loading: 'Carregando dados da planilha…',
          error: 'Erro ao carregar dados da planilha. Verifique se a planilha está compartilhada e se o ID está correto.',
        },
      },
    });

    const IDEAL_CARD_WIDTH = 320;
    const RESPONSIVE_GRID_SX = {
      display: 'grid',
      gridTemplateColumns: `repeat(auto-fit, minmax(${IDEAL_CARD_WIDTH}px, 1fr))`,
      gap: { xs: 2, sm: 2.5 },
      alignItems: 'stretch',
    };

    function getLocaleCopy(language) {
      return LOCALE_COPY[language] || LOCALE_COPY['pt-BR'];
    }

    function loadStoredConfig() {
      try {
        const raw = window.localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    function saveStoredConfig(config) {
      try {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      } catch (e) {
        // ignore
      }
    }

    function buildSheetUrl(sheetId, sheetName) {
      const encodedSheet = encodeURIComponent(sheetName || 'pagamentos');
      return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodedSheet}`;
    }

    function parseGvizJson(text) {
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1) {
        throw new Error('Resposta inválida da planilha.');
      }
      return JSON.parse(text.substring(start, end + 1));
    }

    function getStatusClass(status) {
      if (!status) return 'status-other';
      const s = String(status).toLowerCase();
      if (s === 'approved') return 'status-approved';
      if (s === 'pending' || s === 'in_process') return 'status-pending';
      if (s === 'rejected' || s === 'cancelled' || s === 'cancelado') return 'status-rejected';
      return 'status-other';
    }

    const e = ReactLib.createElement;

    function ConfigCard({ copy, config, onConfigChange, onLoadData, loading }) {
      const [localConfig, setLocalConfig] = useState(config);
      const [statusMessage, setStatusMessage] = useState('');

      useEffect(() => {
        setLocalConfig(config);
      }, [config]);

      const handleFieldChange = (field) => (event) => {
        const next = { ...localConfig, [field]: event.target.value };
        setLocalConfig(next);
      };

      const handleSave = useCallback(() => {
        const normalized = {
          operatorName: (localConfig.operatorName || '').trim(),
          sheetId: (localConfig.sheetId || '').trim(),
          sheetName: (localConfig.sheetName || 'pagamentos').trim() || 'pagamentos',
        };
        saveStoredConfig(normalized);
        onConfigChange(normalized);
        setStatusMessage(copy.saved);
      }, [localConfig, onConfigChange, copy.saved]);

      const handleReload = useCallback(() => {
        const stored = loadStoredConfig();
        if (stored) {
          setLocalConfig(stored);
          onConfigChange(stored);
          setStatusMessage(copy.loaded);
        } else {
          setStatusMessage(copy.missing);
        }
      }, [onConfigChange, copy.loaded, copy.missing]);

      const handleLoadData = useCallback(() => {
        if (!localConfig.sheetId) {
          setStatusMessage(copy.missing);
          return;
        }
        saveStoredConfig(localConfig);
        onConfigChange(localConfig);
        onLoadData();
      }, [localConfig, onConfigChange, onLoadData, copy.missing]);

      return e(
        AppCard,
        {
          title: copy.title,
          subtitle: copy.subtitle,
          helper: copy.helper,
          sx: { minHeight: 280, height: '100%' },
        },
        e(
          Stack,
          { spacing: 2 },
          e(
            Grid,
            { container: true, spacing: 2 },
            e(
              Grid,
              { item: true, xs: 12, md: 4 },
              e(TextField, {
                label: copy.operatorLabel,
                placeholder: copy.operatorPlaceholder,
                fullWidth: true,
                value: localConfig.operatorName,
                onChange: handleFieldChange('operatorName'),
              })
            ),
            e(
              Grid,
              { item: true, xs: 12, md: 4 },
              e(TextField, {
                label: copy.sheetIdLabel,
                placeholder: copy.sheetIdPlaceholder,
                fullWidth: true,
                value: localConfig.sheetId,
                onChange: handleFieldChange('sheetId'),
              })
            ),
            e(
              Grid,
              { item: true, xs: 12, md: 4 },
              e(TextField, {
                label: copy.sheetNameLabel,
                placeholder: copy.sheetNamePlaceholder,
                fullWidth: true,
                value: localConfig.sheetName,
                onChange: handleFieldChange('sheetName'),
              })
            ),
          ),
          e(
            Stack,
            { direction: { xs: 'column', sm: 'row' }, spacing: 1.5 },
            e(AppButton, { tone: 'primary', onClick: handleSave }, copy.save),
            e(AppButton, { tone: 'secondary', onClick: handleReload }, copy.reload),
            e(Button, { variant: 'outlined', onClick: handleLoadData, disabled: loading }, copy.loadData),
          ),
          e(Typography, { variant: 'caption', color: 'text.secondary', sx: { mt: 1 } }, statusMessage)
        )
      );
    }

    function MetricsCard({ copy, operatorName, headers, rows, lastUpdate }) {
      const idxStatus = headers.findIndex((h) => h.toLowerCase().includes('status'));
      const idxAmount = headers.findIndex((h) => {
        const lower = h.toLowerCase();
        return lower.includes('amount') || lower.includes('valor') || lower.includes('total');
      });

      let total = 0;
      let approved = 0;
      let pending = 0;
      let other = 0;
      let approvedValue = 0;

      rows.forEach((row) => {
        total += 1;
        const status = idxStatus >= 0 ? row[idxStatus] : '';
        const normalized = String(status || '').toLowerCase();
        if (normalized === 'approved') {
          approved += 1;
          if (idxAmount >= 0) {
            const v = Number(String(row[idxAmount]).replace(',', '.'));
            if (!Number.isNaN(v)) {
              approvedValue += v;
            }
          }
        } else if (normalized === 'pending' || normalized === 'in_process') {
          pending += 1;
        } else {
          other += 1;
        }
      });

      const lastUpdateLabel = lastUpdate
        ? `${copy.lastUpdate} ${lastUpdate.toLocaleString('pt-BR')}`
        : copy.noUpdate;

      return e(
        AppCard,
        {
          title: copy.title,
          subtitle: operatorName || copy.subtitle,
          helper: copy.helper,
          sx: { minHeight: 280, height: '100%' },
        },
        e(
          Stack,
          { spacing: 2 },
          e(
            Grid,
            { container: true, spacing: 2 },
            e(
              Grid,
              { item: true, xs: 12, sm: 6, md: 3 },
              e(Typography, { variant: 'body2', color: 'text.secondary' }, copy.totalRecords),
              e(Typography, { variant: 'h5' }, String(total))
            ),
            e(
              Grid,
              { item: true, xs: 12, sm: 6, md: 3 },
              e(Typography, { variant: 'body2', color: 'text.secondary' }, copy.approvedCount),
              e(Typography, { variant: 'h5' }, String(approved))
            ),
            e(
              Grid,
              { item: true, xs: 12, sm: 6, md: 3 },
              e(Typography, { variant: 'body2', color: 'text.secondary' }, copy.pendingCount),
              e(Typography, { variant: 'h5' }, String(pending))
            ),
            e(
              Grid,
              { item: true, xs: 12, sm: 6, md: 3 },
              e(Typography, { variant: 'body2', color: 'text.secondary' }, copy.otherStatus),
              e(Typography, { variant: 'h5' }, String(other))
            ),
          ),
          e(
            Stack,
            { direction: 'row', spacing: 1.5, alignItems: 'center', sx: { mt: 1 } },
            e(Chip, {
              label: approvedValue ? `${copy.approvedValue}: R$ ${approvedValue.toFixed(2)}` : copy.approvedValue,
              color: approvedValue ? 'success' : 'default',
              size: 'small',
            }),
            e(Typography, { variant: 'caption', color: 'text.secondary' }, lastUpdateLabel)
          ),
          e(
            Box,
            { sx: { mt: 2 } },
            e(LinearProgress, {
              variant: 'determinate',
              value: total ? (approved / total) * 100 : 0,
              sx: { height: 8, borderRadius: 999 },
            }),
            e(Typography, { variant: 'caption', color: 'text.secondary', sx: { mt: 0.5, display: 'block' } },
              'Taxa de aprovação entre os registros carregados.'
            )
          )
        )
      );
    }

    function TableCard({ copy, headers, rows }) {
      return e(
        AppCard,
        {
          title: copy.title,
          subtitle: copy.subtitle,
          helper: rows.length === 0 ? copy.empty : '',
          sx: { minHeight: 320, height: '100%' },
        },
        e(
          Box,
          { sx: { borderRadius: 0, border: '1px solid', borderColor: 'divider', overflow: 'hidden' } },
          e(
            TableContainer,
            { component: Paper, sx: { maxHeight: 420, backgroundColor: 'background.default' } },
            e(
              Table,
              { size: 'small', stickyHeader: true },
              e(
                TableHead,
                null,
                e(
                  TableRow,
                  null,
                  headers.map((h, idx) =>
                    e(TableCell, { key: idx }, h || '')
                  )
                )
              ),
              e(
                TableBody,
                null,
                rows.map((row, rowIndex) =>
                  e(
                    TableRow,
                    { key: rowIndex },
                    row.map((cell, cellIndex) => {
                      const header = headers[cellIndex] || '';
                      const isStatus = header.toLowerCase().includes('status');
                      const baseClass = 'status-pill ' + getStatusClass(cell);
                      return e(
                        TableCell,
                        { key: cellIndex },
                        isStatus
                          ? e('span', { className: baseClass }, cell || '')
                          : cell
                      );
                    })
                  )
                )
              )
            )
          )
        )
      );
    }

    function PaymentsAdminLayout() {
      const [preferences] = useState(() => ({ theme: 'dark', language: 'pt-BR' }));
      const localeCopy = useMemo(() => getLocaleCopy(preferences.language), [preferences.language]);

      const [config, setConfig] = useState(() => {
        const stored = loadStoredConfig();
        return stored || { operatorName: '', sheetId: '', sheetName: 'pagamentos' };
      });

      const [headers, setHeaders] = useState([]);
      const [rows, setRows] = useState([]);
      const [loading, setLoading] = useState(false);
      const [statusMessage, setStatusMessage] = useState('');
      const [lastUpdate, setLastUpdate] = useState(null);

      const themeMode = preferences.theme === 'light' ? 'light' : 'dark';
      const appTheme = useMemo(
        () =>
          createTheme({
            palette: {
              mode: themeMode,
              primary: { main: '#f97316' },
              secondary: { main: '#0ea5e9' },
              background: {
                default: themeMode === 'light' ? '#f3f4f6' : '#020617',
                paper: themeMode === 'light' ? '#ffffff' : '#0f172a',
              },
            },
            typography: {
              fontFamily:
                '"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
            },
            shape: { borderRadius: 0 },
          }),
        [themeMode]
      );

      const handleConfigChange = useCallback((nextConfig) => {
        setConfig(nextConfig);
      }, []);

      const loadData = useCallback(async () => {
        if (!config.sheetId) {
          setStatusMessage(localeCopy.configCard.missing);
          return;
        }

        setLoading(true);
        setStatusMessage(localeCopy.status.loading);

        try {
          const url = buildSheetUrl(config.sheetId, config.sheetName || 'pagamentos');
          const res = await fetch(url);
          const text = await res.text();
          const json = parseGvizJson(text);

          const gRows = json.table.rows || [];
          if (!gRows.length) {
            setHeaders([]);
            setRows([]);
            setStatusMessage(localeCopy.tableCard.empty);
            setLastUpdate(new Date());
            setLoading(false);
            return;
          }

          const headerCells = gRows[0].c.map((c) => (c && c.v ? String(c.v) : ''));
          const dataRows = gRows.slice(1).map((r) =>
            r.c.map((c) => (c && c.v !== null && c.v !== undefined ? c.v : ''))
          );

          setHeaders(headerCells);
          setRows(dataRows);
          setStatusMessage('');
          setLastUpdate(new Date());
        } catch (err) {
          console.error(err);
          setHeaders([]);
          setRows([]);
          setStatusMessage(localeCopy.status.error);
          setLastUpdate(new Date());
        } finally {
          setLoading(false);
        }
      }, [config.sheetId, config.sheetName, localeCopy]);

      useEffect(() => {
        const stored = loadStoredConfig();
        if (stored) {
          setConfig(stored);
        }
      }, []);

      return e(
        ThemeProvider,
        { theme: appTheme },
        e(CssBaseline, null),
        e(
          AppModalProvider,
          null,
          e(
            Box,
            { className: 'miniapp-stage', sx: { flex: 1, display: 'flex' } },
            e(
              Container,
              {
                maxWidth: 'lg',
                disableGutters: true,
                sx: {
                  flex: 1,
                  display: 'flex',
                  flexDirection: 'column',
                  gap: 3,
                  py: { xs: 2, md: 3 },
                },
              },
              e(
                Stack,
                { spacing: 3, sx: { flex: 1 } },
                e(
                  Box,
                  { sx: { mb: 1 } },
                  e(
                    Typography,
                    {
                      variant: 'overline',
                      color: 'text.secondary',
                      sx: { letterSpacing: 1 },
                    },
                    localeCopy.hero.overline
                  ),
                  e(
                    Typography,
                    { variant: 'h5', sx: { mt: 0.5 } },
                    localeCopy.hero.title
                  ),
                  e(
                    Typography,
                    { variant: 'body2', color: 'text.secondary', sx: { mt: 0.5 } },
                    localeCopy.hero.description
                  )
                ),
                e(
                  Box,
                  { sx: RESPONSIVE_GRID_SX },
                  e(
                    Box,
                    { sx: { minWidth: 0 } },
                    e(ConfigCard, {
                      copy: localeCopy.configCard,
                      config,
                      onConfigChange: handleConfigChange,
                      onLoadData: loadData,
                      loading,
                    })
                  ),
                  e(
                    Box,
                    { sx: { minWidth: 0 } },
                    e(MetricsCard, {
                      copy: localeCopy.metricsCard,
                      operatorName: config.operatorName,
                      headers,
                      rows,
                      lastUpdate,
                    })
                  )
                ),
                e(
                  Box,
                  { sx: RESPONSIVE_GRID_SX },
                  e(
                    Box,
                    { sx: { minWidth: 0 } },
                    e(TableCard, {
                      copy: localeCopy.tableCard,
                      headers,
                      rows,
                    })
                  )
                ),
                e(
                  Box,
                  { sx: { minHeight: 24 } },
                  e(
                    Typography,
                    { variant: 'caption', color: 'text.secondary' },
                    statusMessage
                  )
                )
              )
            )
          )
        )
      );
    }

    ReactDOMLib.createRoot(document.getElementById('payments-admin-root')).render(
      e(PaymentsAdminLayout)
    );
  </script>
</body>
</html>
