<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MiniApps — Catálogo</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0">
  <link rel="stylesheet" href="../miniapp-base/style/styles.css">
</head>
<body class="catalog-blank">
  <main class="catalog-board" aria-label="Catálogo de MiniApps" aria-live="polite">
    <section class="catalog-favorites">
      <header class="catalog-favorites__header">
        <h2>Favoritos</h2>
        <p>MiniApps fixos para acesso rápido.</p>
      </header>
      <div
        class="carousel"
        data-carousel="favorites"
        data-carousel-per-view="1 2 3 4 4"
        data-carousel-label="MiniApps favoritos"
      ></div>
    </section>

    <section class="catalog-favorites">
      <header class="catalog-favorites__header">
        <h2>Todos os MiniApps</h2>
        <p>Lista completa de MiniApps disponíveis.</p>
      </header>
      <div
        class="carousel"
        data-carousel="all"
        data-carousel-per-view="1 2 3 4 4"
        data-carousel-label="MiniApps disponíveis"
      ></div>
    </section>
  </main>

  <script src="../miniapp-base/components/carousel.js" defer></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', function () {
      var miniapps = [
        {
          id: 'miniapp-prefeito',
          name: 'Painel do Prefeito',
          description: 'Painel com KPIs, filtros e relatórios setoriais.',
          icon: 'monitoring',
          theme: 'prefeito',
          href: '../miniapp-prefeito/index.html',
          favorite: true
        },
        {
          id: 'miniapp-cadastro',
          name: 'Cadastro de Usuários',
          description: 'Fluxo guiado para cadastrar novos usuários e registrar aceite de termos.',
          icon: 'person_add',
          theme: 'cadastro',
          href: '../miniapp-cadastro/index.html',
          favorite: true
        },
        {
          id: 'miniapp-importador',
          name: 'Importador de Pesquisas',
          description: 'Fluxo para importar arquivos CSV de pesquisas e revisar resultados.',
          icon: 'cloud_upload',
          theme: 'importador',
          href: '../miniapp-importador/index.html',
          favorite: false
        },
        {
          id: 'miniapp-tts',
          name: 'Gerador de Roteiros TTS',
          description: 'Formulário guiado com prévias de áudio e exportação otimizada para locução.',
          icon: 'text_to_speech',
          theme: 'tts',
          href: '../miniapp-tts/index.html',
          favorite: false
        }
      ];

      function createCard(app) {
        var article = document.createElement('article');
        article.className = 'app-card catalog-card';
        article.setAttribute('data-miniapp-id', app.id);

        var link = document.createElement('a');
        link.className = 'catalog-card__link';
        link.href = app.href;
        link.target = 'miniapp-panel';
        link.setAttribute('data-miniapp-target', app.href);
        link.setAttribute('data-miniapp-name', app.name);
        link.setAttribute('data-miniapp-description', app.description);
        link.setAttribute('data-miniapp-icon-symbol', app.icon);
        link.setAttribute('data-miniapp-icon-theme', app.theme);

        var header = document.createElement('div');
        header.className = 'catalog-card__header';

        var icon = document.createElement('span');
        icon.className = 'material-symbols-rounded app-icon app-icon--theme-' + app.theme;
        icon.setAttribute('aria-hidden', 'true');
        icon.textContent = app.icon;

        var content = document.createElement('div');
        content.className = 'catalog-card__content';

        var title = document.createElement('h3');
        title.textContent = app.name;

        var description = document.createElement('p');
        description.textContent = app.description;

        content.appendChild(title);
        content.appendChild(description);
        header.appendChild(icon);
        header.appendChild(content);
        link.appendChild(header);
        article.appendChild(link);

        return article;
      }

      function mountCarousel(container, items) {
        if (!container) {
          return;
        }

        var section = container.closest('section');
        if (!Array.isArray(items) || !items.length) {
          if (section) {
            section.hidden = true;
          }
          return;
        }

        if (section) {
          section.hidden = false;
        }

        var fragment = document.createDocumentFragment();
        items.forEach(function (app) {
          fragment.appendChild(createCard(app));
        });

        container.innerHTML = '';
        container.appendChild(fragment);

        if (window.CarouselManager && typeof window.CarouselManager.mount === 'function') {
          window.CarouselManager.mount(container);
        }
      }

      var favoritesContainer = document.querySelector('[data-carousel="favorites"]');
      var allContainer = document.querySelector('[data-carousel="all"]');

      var favorites = miniapps.filter(function (app) {
        return app.favorite;
      });

      mountCarousel(favoritesContainer, favorites);
      mountCarousel(allContainer, miniapps);

      function notifyShell() {
        if (!window.parent || window.parent === window) {
          return;
        }

        var message = {
          action: 'miniapp-header',
          title: 'Catálogo de MiniApps',
          subtitle: 'Escolha um MiniApp para abrir.',
          icon: 'apps',
          iconTheme: 'catalog'
        };

        var targetOrigin = window.location.origin;
        if (!targetOrigin || targetOrigin === 'null') {
          targetOrigin = '*';
        }

        try {
          window.parent.postMessage(message, targetOrigin);
        } catch (error) {
          console.error('Não foi possível enviar o cabeçalho do miniapp para o shell.', error);
        }
      }

      notifyShell();
    });
  </script>
</body>
</html>
