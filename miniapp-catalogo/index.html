<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo de MiniApps</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estilos customizados para o Tailwind e fontes */
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
    .ma-card { transition: transform 0.2s, box-shadow 0.2s; }
    .ma-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
    .loading-spinner { border-top-color: #3b82f6; }
    
    /* Esconde a barra de rolagem horizontal em dispositivos menores, se necessário */
    .catalog-container { overflow-x: hidden; }
    
    /* Ajustes responsivos para a lista de cards */
    #catalog-list {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="p-4 md:p-8 catalog-container">

  <div class="max-w-7xl mx-auto">
    
    <!-- Cabeçalho Limpo (Apenas o Título do Catálogo) -->
    <header class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Seu Catálogo de MiniApps</h1>
      <p class="text-gray-600 mb-4">Explore os aplicativos disponíveis para uso.</p>
      
      <!-- Barra de Pesquisa e Filtro (Adicionada para usabilidade) -->
      <div class="flex flex-col sm:flex-row gap-4">
        <input 
            type="text" 
            id="searchBar" 
            placeholder="Buscar por nome, categoria ou descrição..."
            class="p-3 border border-gray-300 rounded-lg w-full sm:flex-1 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
        />
        <select id="categoryFilter" class="p-3 border border-gray-300 rounded-lg w-full sm:w-48 bg-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            <option value="">Todas as Categorias</option>
            <!-- Opções de categoria serão preenchidas via JS -->
        </select>
      </div>
      
      <p id="status-message" class="mt-4 text-sm text-gray-500">Inicializando...</p>
    </header>
    
    <!-- Seção do Catálogo -->
    <div id="catalog-list" class="grid gap-6">
      <!-- Cards do Catálogo serão injetados aqui -->
      <div class="col-span-full flex justify-center items-center h-40">
        <div class="loading-spinner w-8 h-8 border-4 border-gray-200 rounded-full animate-spin"></div>
      </div>
    </div>

  </div>

  <script>
    // Configurações do Firebase (Globais no ambiente Canvas)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
  </script>
  <!-- Importações do Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variáveis Globais para o Firebase
    let app, db, auth;
    
    // Lista de Apps Essenciais (Garantia de funcionamento do sistema)
    const ESSENTIAL_APPS = [
      { id: 'app_base', name: 'MiniApp Base', description: 'Ponto de partida e template para novos MiniApps.', icon_url: 'https://placehold.co/48x48/1e3a8a/ffffff?text=B', url: 'miniapp-base/index.html', category: 'Sistema', status: 'Essencial' },
      { id: 'app_catalog', name: 'Catálogo de MiniApps', description: 'Você está aqui! Interface de usuário final para navegação.', icon_url: 'https://placehold.co/48x48/059669/ffffff?text=C', url: 'miniapp-catalogo/index.html', category: 'Sistema', status: 'Essencial' },
      { id: 'app_manager', name: 'Gestor de Catálogos (Admin)', description: 'Ferramenta administrativa para importar e gerenciar o catálogo ativo.', icon_url: 'https://placehold.co/48x48/f97316/ffffff?text=G', url: 'miniapp-gestor-de-catalogo/index.html', category: 'Sistema', status: 'Essencial' },
    ];

    // Elementos do DOM
    const statusMessage = document.getElementById('status-message');
    const catalogList = document.getElementById('catalog-list');
    const searchBar = document.getElementById('searchBar');
    const categoryFilter = document.getElementById('categoryFilter');
    
    // Dados para uso no script
    let fullCatalogData = []; // Armazena todos os dados brutos do Firestore
    let filterOptions = {
        searchText: '',
        category: ''
    };

    // ----------------------------------------------------------------------
    // 1. FUNÇÕES DE UTILIDADE
    // ----------------------------------------------------------------------

    /**
     * Exibe uma mensagem de status.
     */
    function showStatus(message, type = 'info') {
      statusMessage.textContent = message;
      statusMessage.className = 'mt-4 text-sm';
      switch (type) {
        case 'success':
          statusMessage.classList.add('text-green-600');
          break;
        case 'error':
          statusMessage.classList.add('text-red-600');
          break;
        case 'info':
        default:
          statusMessage.classList.add('text-gray-500');
          break;
      }
    }

    /**
     * Cria e retorna o HTML para um único card de MiniApp.
     */
    function escapeHtml(value) {
      return String(value ?? '').replace(/[&<>"']/g, (char) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      })[char]);
    }

    function createCatalogCard(appItem) {
      const iconUrl = appItem.icon_url || 'https://placehold.co/48x48/cccccc/666666?text=APP';
      const statusClass = appItem.status === 'Ativo' ? 'bg-green-100 text-green-800' :
                          appItem.status === 'Beta' ? 'bg-yellow-100 text-yellow-800' :
                          appItem.status === 'Essencial' ? 'bg-indigo-100 text-indigo-800' :
                          'bg-blue-100 text-blue-800'; // Fallback

      const safeName = escapeHtml(appItem.name || 'MiniApp');
      const safeCategory = escapeHtml(appItem.category || 'Geral');
      const safeDescription = escapeHtml(appItem.description || '');
      const safeStatus = escapeHtml(appItem.status || 'Desconhecido');
      const safeUrl = escapeHtml(appItem.url || '#');

      return `
        <div class="ma-card bg-white p-5 rounded-xl shadow border border-gray-100 flex flex-col justify-between hover:shadow-xl">
          <div class="flex items-start space-x-4 mb-3">
            <img src="${iconUrl}" alt="${safeName} Ícone" class="w-10 h-10 rounded-lg object-cover border border-gray-200" onerror="this.onerror=null; this.src='https://placehold.co/48x48/cccccc/666666?text=APP';"/>
            <div class="flex-1">
              <h4 class="text-lg font-semibold text-gray-900">${safeName}</h4>
              <p class="text-xs font-medium text-gray-500">${safeCategory}</p>
            </div>
          </div>
          <p class="text-sm text-gray-700 mb-4 h-12 overflow-hidden">${safeDescription}</p>
          <div class="flex items-center justify-between mt-auto pt-2 border-t border-gray-100">
            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">
              ${safeStatus}
            </span>
            <a
              href="#"
              class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out"
              data-open-miniapp
              data-url="${safeUrl}"
              data-name="${safeName}"
              data-description="${safeDescription}"
            >
              Abrir <i class="fas fa-external-link-alt ml-1 text-xs"></i>
            </a>
          </div>
        </div>
      `;
    }

    // ----------------------------------------------------------------------
    // 2. FILTRAGEM E RENDERIZAÇÃO
    // ----------------------------------------------------------------------

    /**
     * Popula o dropdown de filtro de categorias.
     * @param {Array<Object>} data Lista completa de aplicativos.
     */
    function populateFilters(data) {
        // CORREÇÃO: Remove a exclusão da categoria 'Sistema' para que ela apareça no filtro.
        // 1. Coleta categorias únicas e ordena. Apenas filtra por categorias nulas/vazias.
        const categories = [...new Set(data.map(app => app.category).filter(c => c))].sort();
        
        // 2. Limpa e adiciona a opção padrão
        categoryFilter.innerHTML = '<option value="">Todas as Categorias</option>';
        
        // 3. Adiciona as categorias dinamicamente
        categories.forEach(category => {
            const option = document.createElement('option');
            // Mapeia o valor de volta para 'Sistema' (que é a categoria do Essencial)
            option.value = category; 
            option.textContent = category;
            categoryFilter.appendChild(option);
        });
        
        // 4. Garante que o filtro atualmente selecionado seja mantido
        categoryFilter.value = filterOptions.category;
    }

    /**
     * Aplica os filtros atuais aos dados e renderiza o catálogo.
     */
    function applyFiltersAndRender() {
        if (!fullCatalogData || fullCatalogData.length === 0) {
            catalogList.innerHTML = '<p class="text-gray-500 col-span-full p-4 text-center border border-dashed rounded-lg bg-gray-50">Nenhum MiniApp no catálogo. Carregando os essenciais...</p>';
            return;
        }

        const searchText = filterOptions.searchText.toLowerCase();
        const selectedCategory = filterOptions.category;

        const filteredData = fullCatalogData.filter((app, index) => {
            const rawName = typeof app.name === 'string' ? app.name : '';
            const safeName = rawName || `MiniApp ${index + 1}`;
            const rawDescription = typeof app.description === 'string' ? app.description : '';
            const rawCategory = typeof app.category === 'string' ? app.category : '';

            // 1. Filtrar por Categoria
            const matchesCategory = !selectedCategory || rawCategory === selectedCategory;

            // 2. Filtrar por Texto
            const matchesSearch = !searchText ||
                safeName.toLowerCase().includes(searchText) ||
                rawDescription.toLowerCase().includes(searchText) ||
                rawCategory.toLowerCase().includes(searchText);

            return matchesCategory && matchesSearch;
        });

        if (filteredData.length === 0) {
            catalogList.innerHTML = '<p class="text-gray-500 col-span-full p-4 text-center border border-dashed rounded-lg bg-gray-50">Nenhum MiniApp corresponde aos seus filtros de busca.</p>';
        } else {
            catalogList.innerHTML = filteredData.map(createCatalogCard).join('');
            attachMiniAppOpenHandlers();
        }
    }

    function mergeWithEssential(data = []) {
        const list = Array.isArray(data)
            ? data
                .map((item, index) => normalizeCatalogItem(item, index))
                .filter(Boolean)
            : [];
        const essentialIds = new Set(ESSENTIAL_APPS.map(app => app.id));
        const nonEssential = list.filter(item => !essentialIds.has(item.id));
        const combined = [...nonEssential, ...ESSENTIAL_APPS];
        const unique = [];
        const seen = new Set();

        combined.forEach(item => {
            if (!item || !item.id || seen.has(item.id)) return;
            seen.add(item.id);
            unique.push(item);
        });

        return unique;
    }

    function updateCatalogData(data = []) {
        fullCatalogData = mergeWithEssential(data);
        populateFilters(fullCatalogData);
        applyFiltersAndRender();
        return fullCatalogData;
    }

    function slugify(value) {
        return String(value || '')
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '') || 'miniapp';
    }

    function buildPlaceholderIcon(name, color = '0ea5e9') {
        const label = encodeURIComponent((name || '?').charAt(0).toUpperCase() || 'M');
        return `https://placehold.co/48x48/${color}/ffffff?text=${label}`;
    }

    function normalizeCatalogItem(item, index, options = {}) {
        if (!item) return null;

        const {
            defaultCategory = 'Geral',
            defaultStatus = 'Disponível',
            placeholderColor = '0ea5e9',
        } = options;

        const rawUrl = typeof item.url === 'string' ? item.url.trim() : '';
        if (!rawUrl) return null;

        const rawName = typeof item.name === 'string' ? item.name.trim() : '';
        const name = rawName || `MiniApp ${index + 1}`;
        const rawId = typeof item.id === 'string' ? item.id.trim() : '';
        const id = rawId || `miniapp_${slugify(`${name}_${index}`)}`;
        const category = typeof item.category === 'string' && item.category.trim()
            ? item.category.trim()
            : defaultCategory;
        const status = typeof item.status === 'string' && item.status.trim()
            ? item.status.trim()
            : defaultStatus;
        const description = typeof item.description === 'string' ? item.description : '';
        const iconUrl = item.icon_url || item.iconUrl;

        return {
            id,
            name,
            description,
            url: rawUrl,
            category,
            status,
            icon_url: iconUrl || buildPlaceholderIcon(name, placeholderColor),
        };
    }

    function normalizeFallbackItem(item, index) {
        return normalizeCatalogItem(item, index, {
            defaultCategory: 'Local',
            defaultStatus: 'Disponível',
            placeholderColor: '0ea5e9',
        });
    }

    async function loadLocalCatalogFallback(reason = '') {
        if (reason) {
            console.warn(reason);
        }

        let localItems = [];

        try {
            const response = await fetch('../catalog.json', { cache: 'no-store' });
            if (response.ok) {
                const json = await response.json();
                if (Array.isArray(json)) {
                    localItems = json.map(normalizeFallbackItem).filter(Boolean);
                }
            }
        } catch (error) {
            console.error('Erro ao carregar catalog.json:', error);
        }

        const updatedCatalog = updateCatalogData(localItems);

        if (updatedCatalog.length > ESSENTIAL_APPS.length) {
            showStatus(`${reason ? reason + ' ' : ''}Catálogo local carregado (${updatedCatalog.length} MiniApps).`, 'warning');
        } else {
            showStatus(`${reason ? reason + ' ' : ''}Exibindo apenas os MiniApps essenciais.`, 'warning');
        }

        return updatedCatalog;
    }

    // ----------------------------------------------------------------------
    // 3. LISTENERS DE FILTRO
    // ----------------------------------------------------------------------
    
    // Listener para a barra de pesquisa
    searchBar.addEventListener('input', (e) => {
        filterOptions.searchText = e.target.value;
        applyFiltersAndRender();
    });

    // Listener para o filtro de categoria
    categoryFilter.addEventListener('change', (e) => {
        filterOptions.category = e.target.value;
        applyFiltersAndRender();
    });


    // ----------------------------------------------------------------------
    // 4. INICIALIZAÇÃO E FIREBASE
    // ----------------------------------------------------------------------

    /**
     * Inicializa o Firebase e a autenticação de forma síncrona com await.
     */
    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            await loadLocalCatalogFallback('Configuração do Firebase ausente.');
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            showStatus('Firebase inicializado. Autenticando...', 'info');
            
            // 1. Configura o listener do Auth para monitorar mudanças (opcional)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log(`[AUTH] Usuário autenticado (UID: ${user.uid}).`); 
                } else {
                    console.log('[AUTH] Usuário deslogado/anônimo.');
                }
            });

            // 2. Tenta logar e ESPERA a conclusão com await. 
            // Isso garante que o estado de autenticação esteja ativo antes de ler o Firestore.
            if (initialAuthToken) {
                // Tenta com token customizado e faz fallback para anônimo
                await signInWithCustomToken(auth, initialAuthToken).catch(async e => {
                    console.error("Erro ao assinar com token customizado. Tentando login anônimo...", e);
                    await signInAnonymously(auth).catch(e => {
                        console.error("Erro fatal no Login Anônimo:", e);
                        // Re-lança para ser pego pelo bloco catch externo
                        throw new Error("Falha na autenticação. Verifique as credenciais.");
                    });
                });
            } else {
                // Tenta apenas login anônimo
                await signInAnonymously(auth).catch(e => {
                    console.error("Erro fatal no Login Anônimo:", e);
                    throw new Error("Falha na autenticação. Verifique as credenciais.");
                });
            }

            // 3. Autenticação concluída: Agora que o token está definitivamente definido, anexamos o listener do Firestore.
            showStatus('Autenticação concluída. Ouvindo catálogo...', 'info');
            setupCatalogListener();

        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            await loadLocalCatalogFallback(`Erro ao inicializar Firebase: ${error.message}.`);
        }
    }

    /**
     * Configura o listener em tempo real para o catálogo.
     */
    function setupCatalogListener() {
        // Referência ao documento público do catálogo
        const catalogRef = doc(db, `artifacts/${appId}/public/data/catalog/data`);

        onSnapshot(catalogRef, async (docSnapshot) => {
            let fetchedData = [];
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (Array.isArray(data.items) && data.items.length > 0) {
                    fetchedData = data.items;
                }
            }

            if (!fetchedData.length) {
                await loadLocalCatalogFallback('Nenhum MiniApp publicado no catálogo remoto.');
                return;
            }

            const updatedCatalog = updateCatalogData(fetchedData);
            showStatus(`Catálogo carregado: ${updatedCatalog.length} MiniApps disponíveis.`, 'success');
        }, async (error) => {
            console.error("Erro no listener do catálogo:", error);
            await loadLocalCatalogFallback(`Erro ao carregar catálogo remoto: ${error.message}.`);
        });
    }

    function attachMiniAppOpenHandlers() {
        const triggers = catalogList.querySelectorAll('[data-open-miniapp]');
        triggers.forEach(trigger => {
            trigger.addEventListener('click', (event) => {
                event.preventDefault();
                const { url, name, description } = trigger.dataset;
                if (!url) return;
                const metadata = {
                    title: name || undefined,
                    subtitle: description || undefined,
                };
                if (window.parent && typeof window.parent.postMessage === 'function') {
                    window.parent.postMessage({ action: 'load-miniapp', url, metadata }, '*');
                } else if (window.parent && typeof window.parent.loadMiniApp === 'function') {
                    window.parent.loadMiniApp(url, metadata);
                } else {
                    window.location.href = url;
                }
            });
        });
    }

    // Inicia tudo
    initializeFirebase();
    
    // Mostra o spinner inicial antes de o Firestore carregar os dados
    catalogList.innerHTML = `
        <div class="col-span-full flex flex-col justify-center items-center h-40 text-gray-500">
            <div class="loading-spinner w-8 h-8 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin mb-3"></div>
            Carregando catálogo...
        </div>`;
  </script>
</body>
</html>
